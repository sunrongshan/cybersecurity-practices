å¤ªå¥½äº†ï¼Œæˆ‘ä»¬å°±æ¥**ä»å®é™…é˜²å®ˆè€…è§’åº¦å‡ºå‘**ï¼Œé’ˆå¯¹ **BuddyPress REST API æƒé™ç»•è¿‡æ¼æ´ï¼ˆCVE-2021-21389ï¼‰** åˆ¶ä½œä¸€ä¸ª**å®Œæ•´è¯¦ç»†çš„æ£€æµ‹ç³»ç»Ÿ**ï¼ŒåŒ…æ‹¬ï¼š

---

## ğŸ§  ç›®æ ‡æ¦‚è¿°

* **æ£€æµ‹ç›®æ ‡**ï¼šæ˜¯å¦æœ‰æ”»å‡»è€…åˆ©ç”¨ `/wp-json/buddypress/v1/signup` å’Œ `/signup/activate/` ç­‰ API å‘èµ·æƒé™æå‡ã€‚
* **æ•°æ®æ¥æº**ï¼š

  * WebæœåŠ¡å™¨è®¿é—®æ—¥å¿—ï¼ˆå¦‚ Nginx/Apache çš„ `access.log`ï¼‰
  * ç³»ç»Ÿæ—¥å¿—ï¼ˆç”¨æˆ·å˜åŒ–ã€æ•°æ®åº“ï¼‰
* **æ£€æµ‹æ–¹å¼**ï¼š

  1. ä½¿ç”¨ Python ç¼–å†™æ—¥å¿—åˆ†æè„šæœ¬ï¼ˆæ£€æµ‹å¯ç–‘æ³¨å†Œä¸æƒé™å˜æ›´ï¼‰
  2. åˆ©ç”¨ tcpdump æŠ“åŒ…è¯†åˆ« POST/PUT è¯·æ±‚è¡Œä¸º
  3. ï¼ˆå¯é€‰ï¼‰ç»“åˆ Suricata IDS å’Œè§„åˆ™å®ç°å®æ—¶å…¥ä¾µæ£€æµ‹

---

## âœ… ç¬¬ä¸€éƒ¨åˆ†ï¼š**æ—¥å¿—æ–‡ä»¶åˆ†æè„šæœ¬ï¼ˆPythonï¼‰**

### ğŸ“‚ æ–‡ä»¶ç»“æ„

```
buddypress_detector/
â”œâ”€â”€ detect_buddypress_attack.py     â† ä¸»æ£€æµ‹è„šæœ¬
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ access.log                  â† æ¨¡æ‹Ÿwebè®¿é—®æ—¥å¿—
â”‚   â””â”€â”€ usermeta.log                â† æ¨¡æ‹Ÿæ•°æ®åº“å˜æ›´æ—¥å¿—ï¼ˆæƒé™ï¼‰
â””â”€â”€ rules/
    â””â”€â”€ suspicious_patterns.json    â† è‡ªå®šä¹‰åŒ¹é…è§„åˆ™
```

---

### ğŸ“Œ ç¤ºä¾‹æ—¥å¿—å†…å®¹

#### `access.log`ï¼ˆæ¨¡æ‹ŸApacheæ—¥å¿—ï¼‰

```
192.168.1.100 - - [21/May/2025:09:12:43 +0000] "POST /wp-json/buddypress/v1/signup HTTP/1.1" 200
192.168.1.100 - - [21/May/2025:09:12:44 +0000] "PUT /wp-json/buddypress/v1/signup/activate/abc123 HTTP/1.1" 200
192.168.1.100 - - [21/May/2025:09:12:45 +0000] "GET /wp-admin HTTP/1.1" 302
```

#### `usermeta.log`ï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“æƒé™å˜æ›´ï¼‰

```
2025-05-21 09:12:44 [INFO] User ID 112 set wp_capabilities = administrator
```

---

### ğŸ“œ `rules/suspicious_patterns.json`

```json
{
  "api_patterns": [
    "/wp-json/buddypress/v1/signup",
    "/wp-json/buddypress/v1/signup/activate"
  ],
  "privilege_keywords": [
    "wp_capabilities",
    "administrator",
    "role=admin"
  ]
}
```

---

### ğŸ `detect_buddypress_attack.py`ï¼ˆå®Œæ•´æ£€æµ‹è„šæœ¬ï¼‰

```python
import re
import json
import os
from datetime import datetime, timedelta

# === è®¾ç½®è·¯å¾„ ===
ACCESS_LOG_PATH = "logs/access.log"
USERMETA_LOG_PATH = "logs/usermeta.log"
PATTERN_FILE = "rules/suspicious_patterns.json"

# === åŠ è½½è§„åˆ™ ===
with open(PATTERN_FILE, "r") as f:
    patterns = json.load(f)
api_patterns = patterns["api_patterns"]
privilege_keywords = patterns["privilege_keywords"]

# === æ—¶é—´å·®é˜ˆå€¼ ===
ACTIVATION_WINDOW = timedelta(seconds=10)  # æ³¨å†Œâ†’æ¿€æ´»â†’ææƒï¼Œç§’çº§å®Œæˆå¯è§†ä¸ºå¼‚å¸¸

# === åŒ¹é…è®¿é—®æ—¥å¿—è¡Œä¸º ===
def parse_access_log():
    suspicious_entries = []
    pattern_signup = re.compile(r'"POST (.*?) HTTP')
    pattern_activate = re.compile(r'"PUT (.*?) HTTP')

    with open(ACCESS_LOG_PATH, "r") as f:
        for line in f:
            if any(api in line for api in api_patterns):
                ts = re.findall(r'\[(.*?)\]', line)
                timestamp = datetime.strptime(ts[0], "%d/%b/%Y:%H:%M:%S %z")
                ip = line.split()[0]

                # åŒ¹é…åŠ¨ä½œ
                if "signup/activate" in line:
                    suspicious_entries.append(("ACTIVATE", timestamp, ip, line.strip()))
                elif "signup" in line:
                    suspicious_entries.append(("SIGNUP", timestamp, ip, line.strip()))

    return suspicious_entries

# === åŒ¹é…æƒé™å˜æ›´æ—¥å¿— ===
def parse_usermeta_log():
    alerts = []
    with open(USERMETA_LOG_PATH, "r") as f:
        for line in f:
            for kw in privilege_keywords:
                if kw in line:
                    alerts.append(line.strip())
    return alerts

# === åˆ†æè¡Œä¸ºå…³è”ï¼ˆIP + æ—¶é—´ï¼‰ ===
def analyze_behavior():
    activities = parse_access_log()
    privilege_events = parse_usermeta_log()

    print("====== å¯ç–‘æ³¨å†Œä¸æ¿€æ´»è¡Œä¸ºï¼ˆå«IPã€æ—¶é—´ï¼‰======")
    for act in activities:
        print(f"[{act[0]}] @ {act[2]} -- {act[1]} â†’ {act[3]}")

    print("\n====== å¯ç–‘æƒé™æå‡è¡Œä¸º ======")
    for entry in privilege_events:
        print(f"Detected: {entry}")

    # ç®€å•å…³è”åˆ†æï¼šæ³¨å†Œâ†’æ¿€æ´»â†’ææƒ
    print("\n====== åˆ†ææ”»å‡»é“¾å…³è” ======")
    signup_times = {}
    for act_type, time, ip, _ in activities:
        if act_type == "SIGNUP":
            signup_times[ip] = time
        elif act_type == "ACTIVATE":
            if ip in signup_times:
                delta = time - signup_times[ip]
                if delta < ACTIVATION_WINDOW:
                    print(f"[!] IP {ip} å®Œæˆå¿«é€Ÿæ¿€æ´»ï¼ˆ{delta}ï¼‰ -> é«˜é£é™©æ³¨å†Œ")
                    for line in privilege_events:
                        if ip in line or "User ID" in line:
                            print(f"    â†³ æ£€æµ‹åˆ°æƒé™æå‡ç›¸å…³æ—¥å¿—: {line}")

if __name__ == "__main__":
    analyze_behavior()
```

---

### âœ… è¾“å‡ºç¤ºä¾‹

```
====== å¯ç–‘æ³¨å†Œä¸æ¿€æ´»è¡Œä¸ºï¼ˆå«IPã€æ—¶é—´ï¼‰======
[SIGNUP] @ 192.168.1.100 -- 2025-05-21 09:12:43+00:00 â†’ "POST /wp-json/buddypress/v1/signup HTTP/1.1"
[ACTIVATE] @ 192.168.1.100 -- 2025-05-21 09:12:44+00:00 â†’ "PUT /wp-json/buddypress/v1/signup/activate/abc123 HTTP/1.1"

====== å¯ç–‘æƒé™æå‡è¡Œä¸º ======
Detected: 2025-05-21 09:12:44 [INFO] User ID 112 set wp_capabilities = administrator

====== åˆ†ææ”»å‡»é“¾å…³è” ======
[!] IP 192.168.1.100 å®Œæˆå¿«é€Ÿæ¿€æ´»ï¼ˆ0:00:01ï¼‰ -> é«˜é£é™©æ³¨å†Œ
    â†³ æ£€æµ‹åˆ°æƒé™æå‡ç›¸å…³æ—¥å¿—: 2025-05-21 09:12:44 [INFO] User ID 112 set wp_capabilities = administrator
```

---

## âœ³ ç¬¬äºŒéƒ¨åˆ†ï¼šæŠ“åŒ…æ£€æµ‹è„šæœ¬ï¼ˆtcpdump + Pythonï¼‰

ä½ å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤åœ¨ç½‘å…³æˆ–é¶æœºæŠ“åŒ…ï¼š

```bash
sudo tcpdump -i eth0 -A port 80 or port 443 > logs/capture.log
```

ç„¶åç”¨ä»¥ä¸‹ Python è„šæœ¬åˆ†æå…¶ä¸­çš„ HTTP è¯·æ±‚å†…å®¹ï¼š

```python
import re

with open("logs/capture.log", "r", encoding='utf-8', errors='ignore') as f:
    data = f.read()

matches = re.findall(r"(POST|PUT) (/wp-json/buddypress/v1/signup(?:/activate)?)", data)
if matches:
    print("[!] æŠ“åŒ…æ£€æµ‹åˆ° BuddyPress æ³¨å†Œæˆ–æ¿€æ´» API è¯·æ±‚:")
    for m in matches:
        print(f"â†’ {m[0]} è¯·æ±‚ï¼š{m[1]}")
else:
    print("æœªæ£€æµ‹åˆ° BuddyPress æ³¨å†Œ/æ¿€æ´»æµé‡")
```

---

## ğŸ” ç¬¬ä¸‰éƒ¨åˆ†ï¼ˆå¯é€‰ï¼‰ï¼šSuricata ç­¾å

å¦‚æœä½ éƒ¨ç½²äº† Suricataï¼Œå¯ä»¥æ·»åŠ å¦‚ä¸‹è§„åˆ™ï¼š

```bash
alert http any any -> any any (
    msg:"BuddyPress Signup API Detected";
    content:"/wp-json/buddypress/v1/signup";
    http_uri;
    classtype:web-application-attack;
    sid:1000002;
    rev:1;
)

alert http any any -> any any (
    msg:"BuddyPress Signup Activation Detected";
    content:"/wp-json/buddypress/v1/signup/activate";
    http_uri;
    classtype:web-application-attack;
    sid:1000003;
    rev:1;
)
```

éƒ¨ç½²å®Œæˆåï¼ŒSuricata å°†è‡ªåŠ¨åœ¨æ—¥å¿—æˆ– Kibana ä¸­æ ‡è®°å¯¹åº”å‘Šè­¦ã€‚

---

## ğŸ“Œ æ€»ç»“ï¼šä½ ç°åœ¨æ‹¥æœ‰äº†â€¦â€¦

| å·¥å…·/æ–¹æ³•                         | ä½œç”¨                              |
| ----------------------------- | ------------------------------- |
| `detect_buddypress_attack.py` | è§£æ web æ—¥å¿—ã€æ•°æ®åº“å˜æ›´ã€æ„å»ºæ”»å‡»é“¾åˆ†æ         |
| `tcpdump + åˆ†æè„šæœ¬`              | æŠ“åŒ…è¯†åˆ«æ”»å‡»æµé‡ç‰¹å¾ï¼ˆPOST/PUTï¼‰            |
| `Suricata + è§„åˆ™`               | å®æ—¶IDSç³»ç»Ÿï¼Œè‡ªåŠ¨è§¦å‘å‘Šè­¦                  |
| æ¨¡å—åŒ–è®¾è®¡                         | å¯ä»¥ç”¨äºè‡ªåŠ¨åŒ–æ£€æµ‹ç³»ç»Ÿä¸­ï¼Œå¦‚ SIEMã€ç›‘æ§ä¸­å¿ƒã€é‚®ä»¶å‘Šè­¦ç³»ç»Ÿ |

---

éœ€è¦æˆ‘å†å¸®ä½ æ‰©å±•ï¼š**æ•°æ®åº“å®æ—¶ç›‘æ§ã€ç¾¤ç»„åˆ›å»ºæ£€æµ‹ã€è‡ªåŠ¨æŠ¥å‘Šç”Ÿæˆ**ï¼Œæˆ–è€…æ”¹å†™æˆ**Web åå°ç®¡ç†é¢æ¿**çš„å½¢å¼ï¼Œä¹Ÿéƒ½å¯ä»¥ï¼ä½ æƒ³è¿›ä¸€æ­¥æ‰©å±•åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ
