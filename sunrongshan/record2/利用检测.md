太好了，我们就来**从实际防守者角度出发**，针对 **BuddyPress REST API 权限绕过漏洞（CVE-2021-21389）** 制作一个**完整详细的检测系统**，包括：

---

## 🧠 目标概述

* **检测目标**：是否有攻击者利用 `/wp-json/buddypress/v1/signup` 和 `/signup/activate/` 等 API 发起权限提升。
* **数据来源**：

  * Web服务器访问日志（如 Nginx/Apache 的 `access.log`）
  * 系统日志（用户变化、数据库）
* **检测方式**：

  1. 使用 Python 编写日志分析脚本（检测可疑注册与权限变更）
  2. 利用 tcpdump 抓包识别 POST/PUT 请求行为
  3. （可选）结合 Suricata IDS 和规则实现实时入侵检测

---

## ✅ 第一部分：**日志文件分析脚本（Python）**

### 📂 文件结构

```
buddypress_detector/
├── detect_buddypress_attack.py     ← 主检测脚本
├── logs/
│   ├── access.log                  ← 模拟web访问日志
│   └── usermeta.log                ← 模拟数据库变更日志（权限）
└── rules/
    └── suspicious_patterns.json    ← 自定义匹配规则
```

---

### 📌 示例日志内容

#### `access.log`（模拟Apache日志）

```
192.168.1.100 - - [21/May/2025:09:12:43 +0000] "POST /wp-json/buddypress/v1/signup HTTP/1.1" 200
192.168.1.100 - - [21/May/2025:09:12:44 +0000] "PUT /wp-json/buddypress/v1/signup/activate/abc123 HTTP/1.1" 200
192.168.1.100 - - [21/May/2025:09:12:45 +0000] "GET /wp-admin HTTP/1.1" 302
```

#### `usermeta.log`（模拟数据库权限变更）

```
2025-05-21 09:12:44 [INFO] User ID 112 set wp_capabilities = administrator
```

---

### 📜 `rules/suspicious_patterns.json`

```json
{
  "api_patterns": [
    "/wp-json/buddypress/v1/signup",
    "/wp-json/buddypress/v1/signup/activate"
  ],
  "privilege_keywords": [
    "wp_capabilities",
    "administrator",
    "role=admin"
  ]
}
```

---

### 🐍 `detect_buddypress_attack.py`（完整检测脚本）

```python
import re
import json
import os
from datetime import datetime, timedelta

# === 设置路径 ===
ACCESS_LOG_PATH = "logs/access.log"
USERMETA_LOG_PATH = "logs/usermeta.log"
PATTERN_FILE = "rules/suspicious_patterns.json"

# === 加载规则 ===
with open(PATTERN_FILE, "r") as f:
    patterns = json.load(f)
api_patterns = patterns["api_patterns"]
privilege_keywords = patterns["privilege_keywords"]

# === 时间差阈值 ===
ACTIVATION_WINDOW = timedelta(seconds=10)  # 注册→激活→提权，秒级完成可视为异常

# === 匹配访问日志行为 ===
def parse_access_log():
    suspicious_entries = []
    pattern_signup = re.compile(r'"POST (.*?) HTTP')
    pattern_activate = re.compile(r'"PUT (.*?) HTTP')

    with open(ACCESS_LOG_PATH, "r") as f:
        for line in f:
            if any(api in line for api in api_patterns):
                ts = re.findall(r'\[(.*?)\]', line)
                timestamp = datetime.strptime(ts[0], "%d/%b/%Y:%H:%M:%S %z")
                ip = line.split()[0]

                # 匹配动作
                if "signup/activate" in line:
                    suspicious_entries.append(("ACTIVATE", timestamp, ip, line.strip()))
                elif "signup" in line:
                    suspicious_entries.append(("SIGNUP", timestamp, ip, line.strip()))

    return suspicious_entries

# === 匹配权限变更日志 ===
def parse_usermeta_log():
    alerts = []
    with open(USERMETA_LOG_PATH, "r") as f:
        for line in f:
            for kw in privilege_keywords:
                if kw in line:
                    alerts.append(line.strip())
    return alerts

# === 分析行为关联（IP + 时间） ===
def analyze_behavior():
    activities = parse_access_log()
    privilege_events = parse_usermeta_log()

    print("====== 可疑注册与激活行为（含IP、时间）======")
    for act in activities:
        print(f"[{act[0]}] @ {act[2]} -- {act[1]} → {act[3]}")

    print("\n====== 可疑权限提升行为 ======")
    for entry in privilege_events:
        print(f"Detected: {entry}")

    # 简单关联分析：注册→激活→提权
    print("\n====== 分析攻击链关联 ======")
    signup_times = {}
    for act_type, time, ip, _ in activities:
        if act_type == "SIGNUP":
            signup_times[ip] = time
        elif act_type == "ACTIVATE":
            if ip in signup_times:
                delta = time - signup_times[ip]
                if delta < ACTIVATION_WINDOW:
                    print(f"[!] IP {ip} 完成快速激活（{delta}） -> 高风险注册")
                    for line in privilege_events:
                        if ip in line or "User ID" in line:
                            print(f"    ↳ 检测到权限提升相关日志: {line}")

if __name__ == "__main__":
    analyze_behavior()
```

---

### ✅ 输出示例

```
====== 可疑注册与激活行为（含IP、时间）======
[SIGNUP] @ 192.168.1.100 -- 2025-05-21 09:12:43+00:00 → "POST /wp-json/buddypress/v1/signup HTTP/1.1"
[ACTIVATE] @ 192.168.1.100 -- 2025-05-21 09:12:44+00:00 → "PUT /wp-json/buddypress/v1/signup/activate/abc123 HTTP/1.1"

====== 可疑权限提升行为 ======
Detected: 2025-05-21 09:12:44 [INFO] User ID 112 set wp_capabilities = administrator

====== 分析攻击链关联 ======
[!] IP 192.168.1.100 完成快速激活（0:00:01） -> 高风险注册
    ↳ 检测到权限提升相关日志: 2025-05-21 09:12:44 [INFO] User ID 112 set wp_capabilities = administrator
```

---

## ✳ 第二部分：抓包检测脚本（tcpdump + Python）

你可以用如下命令在网关或靶机抓包：

```bash
sudo tcpdump -i eth0 -A port 80 or port 443 > logs/capture.log
```

然后用以下 Python 脚本分析其中的 HTTP 请求内容：

```python
import re

with open("logs/capture.log", "r", encoding='utf-8', errors='ignore') as f:
    data = f.read()

matches = re.findall(r"(POST|PUT) (/wp-json/buddypress/v1/signup(?:/activate)?)", data)
if matches:
    print("[!] 抓包检测到 BuddyPress 注册或激活 API 请求:")
    for m in matches:
        print(f"→ {m[0]} 请求：{m[1]}")
else:
    print("未检测到 BuddyPress 注册/激活流量")
```

---

## 🔐 第三部分（可选）：Suricata 签名

如果你部署了 Suricata，可以添加如下规则：

```bash
alert http any any -> any any (
    msg:"BuddyPress Signup API Detected";
    content:"/wp-json/buddypress/v1/signup";
    http_uri;
    classtype:web-application-attack;
    sid:1000002;
    rev:1;
)

alert http any any -> any any (
    msg:"BuddyPress Signup Activation Detected";
    content:"/wp-json/buddypress/v1/signup/activate";
    http_uri;
    classtype:web-application-attack;
    sid:1000003;
    rev:1;
)
```

部署完成后，Suricata 将自动在日志或 Kibana 中标记对应告警。

---

## 📌 总结：你现在拥有了……

| 工具/方法                         | 作用                              |
| ----------------------------- | ------------------------------- |
| `detect_buddypress_attack.py` | 解析 web 日志、数据库变更、构建攻击链分析         |
| `tcpdump + 分析脚本`              | 抓包识别攻击流量特征（POST/PUT）            |
| `Suricata + 规则`               | 实时IDS系统，自动触发告警                  |
| 模块化设计                         | 可以用于自动化检测系统中，如 SIEM、监控中心、邮件告警系统 |

---

需要我再帮你扩展：**数据库实时监控、群组创建检测、自动报告生成**，或者改写成**Web 后台管理面板**的形式，也都可以！你想进一步扩展到什么程度？
